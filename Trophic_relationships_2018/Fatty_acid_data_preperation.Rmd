---
title: "Fatty_acid_data_preperation"
author: "Wendel Raymond"
date: "September 24, 2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

# Fatty acid data preperation
This script will tranform the raw area and concentration data from the FA chromatograph to ready for analysis. This include combining raw files into a master tall dataframe, and preforming initioal proportion calculations.

```{r libraries, echo=FALSE}
library(tidyverse)
```

## Data
Import all FA area/concentration data and dry weight data. **NOTE** Batch 2 does not need to be imported. I transfered the samples in that batch to batch 1 because of weird values. 

### Area and concentration data
Naming will follow the convension of
batch#_type
example: b1_area is batch 1 area data

```{r data area conc, echo=FALSE}
## Batch 1 ##
b1_area <- read.csv("../ALL_DATA/Fatty_acid_RAW_data/Batch_1_Area_RAW.csv", stringsAsFactors = FALSE, header = TRUE)

b1_conc <- read.csv("../ALL_DATA/Fatty_acid_RAW_data/Batch_1_Conc_RAW.csv", stringsAsFactors = FALSE, header = TRUE)

## Batch 3 ##
b3_area <- read.csv("../ALL_DATA/Fatty_acid_RAW_data/Batch_3_Area_RAW.csv", stringsAsFactors = FALSE, header = TRUE)

b3_conc <- read.csv("../ALL_DATA/Fatty_acid_RAW_data/Batch_3_Conc_RAW.csv", stringsAsFactors = FALSE, header = TRUE)

## Batch 4 ##
b4_area <- read.csv("../ALL_DATA/Fatty_acid_RAW_data/Batch_4_Area_RAW.csv", stringsAsFactors = FALSE, header = TRUE)

b4_conc <- read.csv("../ALL_DATA/Fatty_acid_RAW_data/Batch_4_Conc_RAW.csv", stringsAsFactors = FALSE, header = TRUE)

## Batch 5 ##
b5_area <- read.csv("../ALL_DATA/Fatty_acid_RAW_data/Batch_5_Area_RAW.csv", stringsAsFactors = FALSE, header = TRUE)

b5_conc <- read.csv("../ALL_DATA/Fatty_acid_RAW_data/Batch_5_Conc_RAW.csv", stringsAsFactors = FALSE, header = TRUE)

## Batch 6 ##
b6_area <- read.csv("../ALL_DATA/Fatty_acid_RAW_data/Batch_6_Area_RAW.csv", stringsAsFactors = FALSE, header = TRUE)

b6_conc <- read.csv("../ALL_DATA/Fatty_acid_RAW_data/Batch_6_Conc_RAW.csv", stringsAsFactors = FALSE, header = TRUE)

## Batch 7 ##
b7_area <- read.csv("../ALL_DATA/Fatty_acid_RAW_data/Batch_7_Area_RAW.csv", stringsAsFactors = FALSE, header = TRUE)

b7_conc <- read.csv("../ALL_DATA/Fatty_acid_RAW_data/Batch_7_Conc_RAW.csv", stringsAsFactors = FALSE, header = TRUE)

## Batch 8 ##
b8_area <- read.csv("../ALL_DATA/Fatty_acid_RAW_data/Batch_8_Area_RAW.csv", stringsAsFactors = FALSE, header = TRUE)

b8_conc <- read.csv("../ALL_DATA/Fatty_acid_RAW_data/Batch_8_Conc_RAW.csv", stringsAsFactors = FALSE, header = TRUE)
```

Biomarker metadata
```{r dat biomarker, echo = FALSE}
bimrk <- read.csv("../ALL_DATA/Biomarker_collections_2018_RAW.csv", header = TRUE, stringsAsFactors = FALSE)
```


### Dry sample mass data
```{r data mass, echo = FALSE}
samp_mass <- read.csv("../ALL_DATA/Biomarker_extraction_mass_2018_RAW.csv", stringsAsFactors = FALSE, header = TRUE)
samp_mass$Weigh_date <- as.Date(samp_mass$Weigh_date, "%m/%d/%Y")
samp_mass$Extraction_date <- as.Date(samp_mass$Extraction_date, "%m/%d/%Y")

samp_mass_redu <- samp_mass %>% 
  filter(Notes != "error in extraction") %>% 
  filter(Biomarker_ID != "B_004" & sample_on_foil_mg != 22.67) %>% 
  filter(Biomarker_ID != "B_160")
```


## Compile area and concentration data to tall data
Combine all batch data and convert to tall format. Preserve batch number identity for claculations and figuring out any data issues. Clean up sample names.
```{r combine, echo = FALSE}
## Batch 1 ##
b1_ac <- gather(b1_area, key = "FA", value = "Area", 2:57)
b1_ac$Conc <- gather(b1_conc, key = "FA", value = "Conc", 2:57)[,3]
b1_ac$Batch <- as.character(1)

## Batch 3 ##
b3_ac <- gather(b3_area, key = "FA", value = "Area", 2:54)
b3_ac$Conc <- gather(b3_conc, key = "FA", value = "Conc", 2:54)[,3]
b3_ac$Batch <- as.character(3)

## Batch 4 ##
b4_ac <- gather(b4_area, key = "FA", value = "Area", 2:51)
b4_ac$Conc <- gather(b4_conc, key = "FA", value = "Conc", 2:51)[,3]
b4_ac$Batch <- as.character(4)

## Batch 5 ##
b5_ac <- gather(b5_area, key = "FA", value = "Area", 2:60)
b5_ac$Conc <- gather(b5_conc, key = "FA", value = "Conc", 2:60)[,3]
b5_ac$Batch <- as.character(5)

## Batch 6 ##
b6_ac <- gather(b6_area, key = "FA", value = "Area", 2:66)
b6_ac$Conc <- gather(b6_conc, key = "FA", value = "Conc", 2:66)[,3]
b6_ac$Batch <- as.character(6)

## Batch 7 ##
b7_ac <- gather(b7_area, key = "FA", value = "Area", 2:58)
b7_ac$Conc <- gather(b7_conc, key = "FA", value = "Conc", 2:58)[,3]
b7_ac$Batch <- as.character(7)

## Batch 8 ##
b8_ac <- gather(b8_area, key = "FA", value = "Area", 2:59)
b8_ac$Conc <- gather(b8_conc, key = "FA", value = "Conc", 2:59)[,3]
b8_ac$Batch <- as.character(8)

## Combine all batches together ##
FA_ac <- rbind(b1_ac, b3_ac, b4_ac, b5_ac, b6_ac, b7_ac, b8_ac)

## Add ID column ##
FA_ac$ID <- substr(FA_ac$Sample, 1, 5)

## Arrange ##
FA_ac <- cbind(FA_ac[, c(6,1,5,2,3,4)])

## To numeric ##
FA_ac$Area <- as.numeric(FA_ac$Area)
FA_ac$Conc <- as.numeric(FA_ac$Conc)
```

## Calculate proportion by area
For a sample, calculate the proportion of each unique FA as the area of that FA divided my the total area of all FAs of that sample. NOTE that C19 is removed for this calculation. NOTE any area and concentration data that is imported at a negative number will be converted to a zero.

1. Convert negative values to zero
2. Append metadata from biomarker data
3. Filter for tissue samples and remove C19 and calcualte total area by sample
4. Calcualte raw proportion
5. Calcualte mean proportion by tissue type
6. Filter data to include only mean proportions >= 1% by each tissue type
7. Extract unique FA from filtered dataset
8. Subset original full dataframe by FAs identified above
9. Re calculate proportion based of new total areas given subsetted dataset

```{r calc, prop, echo = FALSE}
## Convert neg to zero ##
FA_ac$Area <- ifelse(FA_ac$Area < 0, 0, FA_ac$Area) 
FA_ac$Conc <- ifelse(FA_ac$Conc < 0, 0, FA_ac$Conc) 

## Calculate proportion of total sample area of FA with mean >1% ##
# Append metadata #
FA_ac <- merge(FA_ac, bimrk[, 7:11], by.x = "ID", by.y = "Biomarker_ID")

# Calculate total area by sample #
FA_ac <- FA_ac %>% 
  filter(str_detect(ID, "^B_")) %>%
  filter(FA != "C19.0") %>% 
  group_by(ID) %>%
  mutate(Total_area = sum(Area))

FA_ac$Prop_area <- FA_ac$Area / FA_ac$Total_area

# Calcualte mean proportion my tissue #
FA_a <- FA_ac %>% 
  group_by(FA, Species_common) %>% 
  summarise(mean_prop = mean(Prop_area),
            sd_prop = sd(Prop_area),
            min_prop = min(Prop_area),
            max_prop = max(Prop_area))

# Filter those FAs < 1% #
FA_a_1.0 <- FA_a %>%
  filter(mean_prop >= 0.01)

# Unique FAs #
FAs <- unique(FA_a_1.0$FA)
FAs

# Filter Master FA data by unique FA >= 1% #
FA_ac_filt <- FA_ac %>%
  filter(FA %in% FAs) %>% 
  group_by(ID) %>%
  mutate(Total_filt_area = sum(Area))

FA_ac_filt$Prop_filt_area <- FA_ac_filt$Area / FA_ac_filt$Total_filt_area
```

## C19 standard data

### Extract C19 data 
Multiple C19 satandards were made for all the extractions. The concentration of theses standard will be extracted from the sample mass data and to make a new dataframe where standards can be assigned to extractions days.

```{r c19, echo = FALSE}
## filter C19 data ##
C19 <- samp_mass_redu %>% 
  filter(Species_common == "C19")

## Calcualte concentration ##
C19$C19_conc_mgL <- C19$sample_extracted_mass_mg / c(6.5, 10, 10)
```

### Assign C19 concentrations standards to extraction days
DIffernet C19 solutions were used on different extraction days. 

C19.2.25 was used on extraction days 2.25.2019 to 3.26.2019
C19.2.27 was used on extraction days 2.27.2019 to 3.9.2019
C19.3.10 was used on extraction days 3.10.2019 to 3.19.2019

```{r assign concentration, echo = FALSE}
samp_mass_redu$C19_conc <- NA
samp_mass_redu$C19_conc[which(samp_mass_redu$Extraction_date == "2019-02-25")] <- C19$C19_conc_mgL[C19$Biomarker_ID == "C19_2.25"]
samp_mass_redu$C19_conc[which(samp_mass_redu$Extraction_date > "2019-02-25" & samp_mass_redu$Extraction_date <= "2019-03-09")] <- C19$C19_conc_mgL[C19$Biomarker_ID == "C19_2.27"]
samp_mass_redu$C19_conc[which(samp_mass_redu$Extraction_date > "2019-03-09")] <- C19$C19_conc_mgL[C19$Biomarker_ID == "C19_3.10"]
```

### Calculate recovery
Using C19 data we will calcualte the proporiton recovered as a way to assess our extraction.
```{r recov, echo = FALSE}
FA_ac <- merge(FA_ac, samp_mass_redu[, c(1, 2,  7, 9)], by.x = "ID", by.y = "Biomarker_ID")

FA_C19_recov <- FA_ac %>% 
  filter(FA == "C19.0")

FA_C19_recov$Recovery <- (FA_C19_recov$Conc  / (((FA_C19_recov$C19_conc * 1000 * 70) / 1500) * 0.666667))
```

## Examine area proportion
Compute summary proporional data to identify outliers.

```{r prop exam, echo = FALSE}
sp_prop_summary_1.0 <- FA_ac_filt %>%
  group_by(Species_common, FA) %>% 
  summarise(n = n(),
            mean_prop_corr = mean(Prop_filt_area),
            sd_prop_corr = sd(Prop_filt_area),
            min_prop_corr = min(Prop_filt_area),
            max_prop_corr = max(Prop_filt_area))
```

## Prep for multivariate analysis
Convert tall data to wide for multivarite analysis. General structure will be sample data columns followed by FA columns with zeros filling instances when a sample did not have a FA that other samples did.

```{r tall to wide, echo = FALSE}
FA_prop <- spread(FA_ac_filt[, c(1, 3, 4, 7, 8, 9, 10, 14)], key = FA, value = Prop_filt_area)

FA_prop[is.na(FA_prop)] <- 0
```

New summary with zeros *throwing error?*
```{r wide to tall zero, echo=FALSE}
sp_prop_summary_1.0.2 <- FA_prop %>% 
  gather(key = "FA", value = "Prop", 6:38) %>% 
  group_by(Species_common, FA) %>% 
  summarise(n = n(),
            mean_prop_corr = mean(Prop),
            sd_prop_corr = sd(Prop),
            min_prop_corr = min(Prop),
            max_prop_corr = max(Prop))
```


### Export wide data
```{r export wide, echo = FALSE}
## 1.0% filter ##
write.csv(FA_prop, "../ALL_DATA/FA_proportions_1.0filter_2018_derived.csv", row.names = FALSE)
```

