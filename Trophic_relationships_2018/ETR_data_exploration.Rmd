---
title: "ETR_data_exploration_2018"
author: "Wendel Raymond"
date: "June 20, 2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

# Eelgrass community trophic relationships (ETR) data exploration
Here I will conduct exploratory analysis of 2018 eelgrass community data

```{r libraries, echo = FALSE, warning=FALSE, message = FALSE}
library(dplyr)
library(ggplot2)
library(DT)
library(cowplot)
library(RColorBrewer)
library(vegan)

theme_set(theme_classic())
```

## Load data
Load biomass/abundace data, stable isotope, and fatty acid data

Biomass and oceanography
```{r dat bio, echo=FALSE}
eg <- read.csv("../ALL_DATA/Eelgrass_biometrics_2018_derived.csv", header = TRUE, stringsAsFactors = FALSE)

crb <- read.csv("../ALL_DATA/crab_simple_site_2018_derived.csv", header = TRUE, stringsAsFactors = FALSE)

crb.sp <- read.csv("../ALL_DATA/crab_site_sp_2018_derived.csv", header = TRUE, stringsAsFactors = FALSE)

clm <- read.csv("../ALL_DATA/eelgrass_clam_2018_derived.csv", header = TRUE, stringsAsFactors = FALSE)

clm.sp <- read.csv("../ALL_DATA/eelgrass_clam_site_sp_2018.csv", header = TRUE, stringsAsFactors = FALSE)

fsh <- read.csv("../ALL_DATA/Fish_mass_site_2018_derived.csv", header = TRUE, stringsAsFactors = FALSE)

pom <- read.csv("../ALL_DATA/POM_2018_derived.csv", header = TRUE, stringsAsFactors = FALSE)

oce <- read.csv("../ALL_DATA/Site_oceanography_2018_RAW.csv", header = TRUE, stringsAsFactors = FALSE)
```

Stable Isotope - preliminary
```{r dat iso, echo = FALSE}
si <- read.csv("E:/wraymond2/My Documents/Graduate School/Eelgrass/Eelgrass trophic relationships/Data/SI_prelim_2018.csv", header = TRUE, stringsAsFactors = FALSE)

bm <- read.csv("E:/wraymond2/My Documents/Graduate School/Eelgrass/Eelgrass trophic relationships/Data/Biomarker_collections_2018_RAW.csv", header = TRUE, stringsAsFactors = FALSE)
```

Fatty Acid
```{r dat fa, echo = FALSE}
fa_0.5 <- read.csv("../ALL_DATA/FA_proportions_0.5filter_2018_derived.csv", header = TRUE, stringsAsFactors = FALSE)

fa_1.0 <- read.csv("../ALL_DATA/FA_proportions_1.0filter_2018_derived.csv", header = TRUE, stringsAsFactors = FALSE)
```

Biomarker metadata
```{r dat biomarker, echo = FLASE}
bimrk <- read.csv("../ALL_DATA/Biomarker_collections_2018_RAW.csv", header = TRUE, stringsAsFactors = FALSE)
```

### Complie biomass data
Merge all the different biomass data types into one data frame
```{r merge, echo = FALSE}
dat <- merge(eg, crb, by = c("site", "place_name"), all.x = TRUE)
dat <- merge(dat, clm[, c(1, 5:13)], by = "site")
dat <- merge(dat, fsh, by = "site")
dat <- merge(dat, oce[, c(1, 6:19)], by = "site")
```

## Data exploration
### Biomass
```{r exp plots, echo = FALSE}
## Eelgrass mass ##
ggplot(dat) +
  geom_col(aes(x = site, y  = eg_shoot_mass_m)) +
  geom_errorbar(aes(x = site, ymin = eg_shoot_mass_m - eg_shoot_mass_m_se, ymax = eg_shoot_mass_m + eg_shoot_mass_m_se), width = 0) +
  labs(x = "Site", y = "Eelgrass shoot mass (g/m2)")

## Macroalgae cover ##
ggplot(dat) +
  geom_col(aes(x = site, y  = macro_cover)) +
  geom_errorbar(aes(x = site, ymin = macro_cover - macro_cover_se, ymax = macro_cover + macro_cover_se), width = 0) +
  labs(x = "Site", y = "Macroalgae % cover")

## Diatom cover ##
ggplot(dat) +
  geom_col(aes(x = site, y  = diatom_cover)) +
  geom_errorbar(aes(x = site, ymin = diatom_cover - diatom_cover_se, ymax = diatom_cover + diatom_cover_se), width = 0) +
  labs(x = "Site", y = "Diatom % cover")

## Epiphyte load ##
ggplot(dat) +
  geom_col(aes(x = site, y  = epiph_load)) +
  geom_errorbar(aes(x = site, ymin = epiph_load - epiph_load_se, ymax = epiph_load + epiph_load_se), width = 0) +
  labs(x = "Site", y = "Epiphyte load (g/g eelgrass)")

## Grazer load ##
ggplot(dat) +
  geom_col(aes(x = site, y  = graz_load)) +
  geom_errorbar(aes(x = site, ymin = graz_load - graz_load_se, ymax = graz_load + graz_load_se), width = 0) +
  labs(x = "Site", y = "Grazer load (g/g eelgrass)")

## Idotea load ##
ggplot(dat) +
  geom_col(aes(x = site, y  = ido_load)) +
  geom_errorbar(aes(x = site, ymin = ido_load - ido_load_se, ymax = ido_load + ido_load_se), width = 0) +
  labs(x = "Site", y = "Idotea load (g/g eelgrass)")

## Limpet load ##
ggplot(dat) +
  geom_col(aes(x = site, y  = limp_load)) +
  geom_errorbar(aes(x = site, ymin = limp_load - limp_load_se, ymax = limp_load + limp_load_se), width = 0) +
  labs(x = "Site", y = "Limpet load (g/g eelgrass)")

## Clam mass ##
ggplot(dat) +
  geom_col(aes(x = site, y  = clm_mass_m)) +
  geom_errorbar(aes(x = site, ymin = clm_mass_m - clm_mass_m_se, ymax = clm_mass_m + clm_mass_m_se), width = 0) +
  labs(x = "Site", y = "Clam mass (g/m2)")

## Clam species ##
ggplot(clm.sp, aes(x = site, y = mass, fill = sp_code)) +
  geom_bar(position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(ymin = mass - mass_se, ymax = mass + mass_se), width = 0, position=position_dodge(0.9)) +
  labs(x = "Site", y = "Clam mass (g/m2)")

## Crab mass ##
ggplot(dat) +
  geom_col(aes(x = site, y = crab_mass)) +
  geom_errorbar(aes(x = site, ymin = crab_mass - crab_mass_se, ymax = crab_mass + crab_mass_se, width = 0)) +
  labs(x = "Site", y = "Crab mass (g/string)")

## Crab species mass ##
ggplot(crb.sp, aes(x = site, y = mass, fill = sp_code)) +
  geom_bar(position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(ymin = mass - mass_se, ymax = mass + mass_se), width = 0, position=position_dodge(0.9)) +
  labs(x = "Site", y = "Crab mass (g/string)")

## All Fish ##
ggplot(dat) +
  geom_col(aes(x = site, y = total_fish_mass / 1000)) +
  labs(x = "Site", y = "Fish mass (kg/site)")

## Shiner Perch ##
ggplot(dat) +
  geom_col(aes(x = site, y = PERCHSH / total_fish_mass)) +
  labs(x = "Site", y = "Proportion shiner perch mass")

## Staghorn Sculpin ##
ggplot(dat) +
  geom_col(aes(x = site, y = SCULPSTG / total_fish_mass)) +
  labs(x = "Site", y = "Proportion staghorn mass")

## Snake prickleback ##
ggplot(dat) +
  geom_col(aes(x = site, y = PRICKSN / total_fish_mass)) +
  labs(x = "Site", y = "Proportion snake prickleback mass")
```

### Oceanography
```{r oce, echo = false}
ggplot(dat) +
  geom_col(aes(x = site, y = X1m_temp_C))

ggplot(dat) +
  geom_col(aes(x = site, y = X5m_temp_C))
```


### Stable Isotopes
Merge species with si values
```{r si, echo = FALSE}
si <- merge(si, bm, by = "Biomarker_ID", all.x = TRUE)
```

Plots
```{r si plots, echo = FALSE}
pal <- colorRampPalette(brewer.pal(9, "Set1"))

ggplot(si) +
  geom_point(aes(x = del_C, y = del_N, color = Species_common), size = 2) +
  scale_color_manual(values = pal(19))

ggplot(si) +
  geom_point(aes(x = del_C, y = del_N, color = Sea_otter_region), size = 2)
```

```{r}
limp <- si %>% 
  filter(Species_common == "Limpet")

ggplot(limp) +
  geom_point(aes(x = n_pooled, y = del_C, color = Place_name), size = 2) +
  scale_color_manual(values = pal(6))

ggplot(limp) +
  geom_point(aes(x = Collection_Date, y = del_C, color = Place_name), size = 2) +
  scale_color_manual(values = pal(6))

ggplot(limp) +
  geom_point(aes(x = del_C, y = del_N, color = Place_name), size = 2) +
  scale_color_manual(values = pal(6))
```

### Fatty acids
The ultimate goal will be to look at some basic nmds plots of all species. Then overlay some depended variables like site and sea otter treatment.

#### Examine FAs
What FAs do we have here.
```{r}
FA_names <- colnames(fa_1.0)
```


First will will have to prep that data with some manipulations and transformations and standardizations.

#### Transformations and standardizations
Subsets
```{r subset, echo = FALSE}
## Aminals ##
fa_anm_1.0 <- fa_1.0 %>% 
  filter(Species_common != "Eelgrass" & Species_common != "Eelgrass diatoms" & Species_common != "Fucus" & Species_common != "Particulate organic matter" & Species_common != "Sugar kelp" & Species_common != "Ulva")

## Producers ##
fa_pro_1.0 <- fa_1.0 %>%
  filter(Species_common == "Eelgrass" | Species_common == "Eelgrass diatoms" | Species_common == "Fucus" | Species_common == "Particulate organic matter" | Species_common == "Sugar kelp" | Species_common == "Ulva")
```


I will use and arcsine sqrt transformation 
```{r trans std, echo = FALSE}
## Transformation ##
fa_0.5_trs <- asin(sqrt(fa_0.5[, 3:77]))

fa_all_1.0_trs <- asin(sqrt(fa_1.0[, 3: 67]))
fa_anm_1.0_trs <- asin(sqrt(fa_anm_1.0[, 3:67]))
fa_pro_1.0_trs <- asin(sqrt(fa_pro_1.0[, 3:67]))

## Standardization ##
fa_0.5_trs_std <- scale(fa_0.5_trs, center = FALSE, scale = apply(fa_0.5_trs, 2, max))

fa_all_1.0_trs_std <- scale(fa_all_1.0_trs, center = FALSE, scale = apply(fa_all_1.0_trs, 2, max))
fa_anm_1.0_trs_std <- scale(fa_anm_1.0_trs, center = FALSE, scale = apply(fa_anm_1.0_trs, 2, max))
fa_pro_1.0_trs_std <- scale(fa_pro_1.0_trs, center = FALSE, scale = apply(fa_pro_1.0_trs, 2, max))
```

#### NMDS
```{r fa nmds, echo = FALSE}
## Calculate distances ##
fa_all_1.0_dist <- vegdist(fa_1.0_trs_std, method = "bray")
fa_anm_1.0_dist <- vegdist(fa_anm_1.0_trs_std, method = "bray" )
fa_pro_1.0_dist <- vegdist(fa_pro_1.0_trs_std, method = "bray" )

fa_0.5_dist <- vegdist(fa_0.5_trs_std, method = "bray")

## nmds ##
fa_all_1.0_mds <- metaMDS(fa_all_1.0_dist)
fa_anm_1.0_mds <- metaMDS(fa_anm_1.0_dist)
fa_pro_1.0_mds <- metaMDS(fa_pro_1.0_dist)

fa_0.5_mds <- metaMDS(fa_0.5_dist, try = 50)
```

##### NMDS plots
```{r nmds plots, echo=FALSE}
## Color Pallatte ##
pal <- colorRampPalette(brewer.pal(9, "Set1"))

## Prep dataframe ##
# All data #
fa_all_1.0_mds_dat <- as.data.frame(scores(fa_all_1.0_mds))
fa_all_1.0_mds_dat$ID <- fa_1.0$ID 
fa_all_1.0_mds_dat$Species_common <- fa_1.0$Species_common
fa_all_1.0_mds_dat <- merge(fa_all_1.0_mds_dat, bimrk[, c(1:4, 7, 9, 10)], by.x = "ID", by.y = "Biomarker_ID")
fa_all_1.0_mds_dat$Species_common <- factor(fa_all_1.0_mds_dat$Species_common, levels = c("Shiner perch", "Snake prickleback", "Staghorn sculpin", "Dungeness crab", "Helmet crab", "Red rock crab", "Dock shrimp", "Macoma sp.", "Bentnose Macoma", "Pointed Macoma", "Butter clam", "Idotea", "Limpet", "Eelgrass", "Eelgrass diatoms", "Fucus", "Particulate organic matter", "Sugar kelp", "Ulva"))

# Animals #
fa_anm_1.0_mds_dat <- as.data.frame(scores(fa_anm_1.0_mds))
fa_anm_1.0_mds_dat$ID <- fa_anm_1.0$ID 
fa_anm_1.0_mds_dat$Species_common <- fa_anm_1.0$Species_common
fa_anm_1.0_mds_dat <- merge(fa_anm_1.0_mds_dat, bimrk[, c(1:4, 7, 9, 10)], by.x = "ID", by.y = "Biomarker_ID")
fa_anm_1.0_mds_dat$Species_common <- factor(fa_anm_1.0_mds_dat$Species_common, levels = c("Shiner perch", "Snake prickleback", "Staghorn sculpin", "Dungeness crab", "Helmet crab", "Red rock crab", "Dock shrimp", "Macoma sp.", "Bentnose Macoma", "Pointed Macoma", "Butter clam", "Idotea", "Limpet"))

# Producers #
fa_pro_1.0_mds_dat <- as.data.frame(scores(fa_pro_1.0_mds))
fa_pro_1.0_mds_dat$ID <- fa_pro_1.0$ID 
fa_pro_1.0_mds_dat$Species_common <- fa_pro_1.0$Species_common
fa_pro_1.0_mds_dat <- merge(fa_pro_1.0_mds_dat, bimrk[, c(1:4, 7, 9, 10)], by.x = "ID", by.y = "Biomarker_ID")
fa_pro_1.0_mds_dat$Species_common <- factor(fa_pro_1.0_mds_dat$Species_common, levels = c("Eelgrass", "Eelgrass diatoms", "Fucus", "Particulate organic matter", "Sugar kelp", "Ulva"))

fa_0.5_mds_dat <- as.data.frame(scores(fa_0.5_mds))
fa_0.5_mds_dat$ID <- fa_0.5$ID 
fa_0.5_mds_dat$Species_common <- fa_0.5$Species_common

## nmds species all ##
ggplot(fa_all_1.0_mds_dat) +
  geom_point(aes(x = NMDS1, y = NMDS2, color = Species_common, shape = Species_common), size = 3) +
  scale_color_manual(values = pal(19)) +
  scale_shape_manual(values = rep(c(15:19), 4))

## nmds species animals ##
ggplot(fa_anm_1.0_mds_dat) +
  geom_point(aes(x = NMDS1, y = NMDS2, color = Species_common, shape = Species_common), size = 3) +
  scale_color_manual(values = pal(13)) +
  scale_shape_manual(values = rep(c(15:19), 3))

## nmds species prodecers ##
ggplot(fa_pro_1.0_mds_dat) +
  geom_point(aes(x = NMDS1, y = NMDS2, color = Species_common, shape = Species_common), size = 3) +
  scale_color_manual(values = pal(6)) +
  scale_shape_manual(values = rep(c(15:19), 2))

## nmds sites and species ##
ggplot(fa_1.0_mds_dat) +
  geom_point(aes(x = NMDS1, y = NMDS2, shape = Place_name, color = Species_common), size = 3) +
  scale_color_manual(values = pal(19)) +
  scale_shape_manual(values = c(0, 15, 16, 17, 18, 6))

## nmds sea otter and species ##
ggplot(fa_1.0_mds_dat) +
  geom_point(aes(x = NMDS1, y = NMDS2, shape = Sea_otter_region, color = Species_common), size = 3) +
  scale_color_manual(values = pal(19)) +
  scale_shape_manual(values = c(16, 1))
```


