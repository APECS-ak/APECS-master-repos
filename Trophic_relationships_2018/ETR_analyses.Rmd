---
title: "ETR_analyses"
author: "Wendel Raymond"
date: "October 22, 2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

# Eelgrass trophic relationships - analyses
*Question:* Do sea otters effects the tropic structure of eelgrass communities in Southeast Alaska? From my 2017 data we found that sea otters have a large negative effect on crabs and are positively related to eelgrass biomass, suggesting that sea otter are influencing the eelgrass community. Furthermore we did not find evidence for all the hypothesized links between major community members necessary to complete the full trophic cascade. Notable we found no evidence of a relationship between crabs and grazer and fish and grazers. To this end we further investigated the dynamics of this community by measuring the biomass, stable isotopes, and fatty acids of key eelgrass community constituents.

*Some opening notes* There is a lot of data. There could be multiple papers here. Some more exploratory analysis is definitely warranted but the original goal was to look at the whole community. Crafting analyses so that we answer questions from that perspective should be the priority. However, if interesting stories arise maybe the approach will change. Just sayin. 

```{r libraries, echo = FALSE, warning = FALSE, message = FALSE}
library(dplyr)
library(ggplot2)
library(DT)
library(cowplot)
library(RColorBrewer)
library(vegan)
library(DT)
theme_set(theme_classic())
```

```{r st.er, echo = FALSE}
st.er <- function(x, na.rm = TRUE) {
  stopifnot(is.numeric(x))
  return(sd(x, na.rm = na.rm)/sqrt(length(x)))
}
```


## Data
Data falls under three broad categories. Biomass, stable isotopes, and fatty acids. Biomass data files are broken up by sampling type but can easily be combined. In addition, biomarker (SI and FA) metadata is useful to match those data with site, date, treatment, etc. data.
Biomass and oceanography
```{r dat bio, echo=FALSE}
eg <- read.csv("../ALL_DATA/Eelgrass_biometrics_all_2018_derived.csv", header = TRUE, stringsAsFactors = FALSE)

crb <- read.csv("../ALL_DATA/crab_all_2018_derived.csv", header = TRUE, stringsAsFactors = FALSE)

clm <- read.csv("../ALL_DATA/eelgrass_clam_all_2018_derived.csv", header = TRUE, stringsAsFactors = FALSE)

fsh <- read.csv("../ALL_DATA/Fish_mass_site_2018_derived.csv", header = TRUE, stringsAsFactors = FALSE)

site <- read.csv("../ALL_DATA/Eelgrass_trophic_relationships_site_metadata_2018.csv", header = TRUE, stringsAsFactors = FALSE)
```

Stable Isotope - preliminary
```{r dat iso, echo = FALSE}
si <- read.csv("E:/wraymond2/My Documents/Graduate School/Eelgrass/Eelgrass trophic relationships/Data/SI_prelim_2018.csv", header = TRUE, stringsAsFactors = FALSE)
```

Fatty Acid
```{r dat fa, echo = FALSE}
#fa_0.5 <- read.csv("../ALL_DATA/FA_proportions_0.5filter_2018_derived.csv", header = TRUE, stringsAsFactors = FALSE)

fa_1.0 <- read.csv("../ALL_DATA/FA_proportions_1.0filter_2018_derived.csv", header = TRUE, stringsAsFactors = FALSE)
```

Biomarker metadata
```{r dat biomarker, echo = FALSE}
bimrk <- read.csv("../ALL_DATA/Biomarker_collections_2018_RAW.csv", header = TRUE, stringsAsFactors = FALSE)
```

### Data managemnet
Clean up files. Make sure appropriate columns are there.
```{r data clean up, echo=FALSE}
eg <- merge(eg, site[, c(1, 5)], by = "site")

## Clams! ##
clm <- merge(clm, site[, c(1, 5)], by = "site")
clm$quadrat <- as.factor(clm$quadrat)
clm$species_common <- ifelse(clm$species_common == "Macoma", "Macoma sp.", clm$species_common)

clm$species_common <- ifelse(clm$species_common == "Pointed macoma", "Macoma sp.", clm$species_common)

clm$species_common <- ifelse(clm$species_common == "Bentnose macoma", "Macoma sp.", clm$species_common)

clm.site.quad <- clm %>%
  group_by(site, quadrat) %>% 
  summarize(mass_g = sum(mass_g))
clm.site.quad <- merge(clm.site.quad, site[, c(1, 5)], by = "site")

clm.site.quad.sp <- clm %>%
  group_by(site, quadrat, species_common) %>% 
  summarize(mass_g = sum(mass_g))
```


## Analyses
A critical piece for all analyses is testing the effect of site and sea otter treatment. Within each sea otter treatment three different sites were sampled.

### Biomass
Compare biomass of community members between sea otter treatments

#### ANOVAS of sites and treatment
##### Eelgrass - biomass and shoot density tests
Eelgrass
```{r eg site x treatment, echo = FALSE}
mod.eg.1 <- lm(shoot_mass_m ~ sea_otter_tr + sea_otter_tr/site, data = eg)
anova(mod.eg.1)

t.eg.1 <- t.test(eg$shoot_mass_m[eg$sea_otter_tr == "high"], eg$shoot_mass_m[eg$sea_otter_tr == "low"])

mod.eg.2 <- lm(eelgrass_shoots_m ~ sea_otter_tr * site, data = eg)
anova(mod.eg.2)
```

Epiphytes
```{r epi site X treatment, echo = FALSE}
mod.ep.1 <- lm(epi_load ~ sea_otter_tr + sea_otter_tr/site, data = eg)
anova(mod.ep.1)

t.ep.1 <- t.test(eg$epi_load[eg$sea_otter_tr == "high"],  eg$epi_load[eg$sea_otter_tr == "low"])
t.ep.1
```

Grazers
```{r grz site X treatment, echo = FALSE}
## All Grazers ##
mod.gr.1 <- lm(grazer_load ~ sea_otter_tr + sea_otter_tr/site, data = eg)
anova(mod.gr.1)

t.gr.1 <- t.test(eg$grazer_load[eg$sea_otter_tr == "high"],  eg$grazer_load[eg$sea_otter_tr == "low"])
t.gr.1

## Idotea ##
mod.id.1 <- lm(idotea_load ~ sea_otter_tr + sea_otter_tr/site, data = eg)
anova(mod.id.1)

t.id.1 <- t.test(eg$idotea_load[eg$sea_otter_tr == "high"],  eg$idotea_load[eg$sea_otter_tr == "low"])
t.id.1

## Limpet ##
mod.lp.1 <- lm(limpet_load ~ sea_otter_tr + sea_otter_tr/site, data = eg)
anova(mod.lp.1)

t.lp.1 <- t.test(eg$limpet_load[eg$sea_otter_tr == "high"],  eg$limpet_load[eg$sea_otter_tr == "low"])
t.lp.1
```

##### Crabs
Sum total crab mass by string. Insert 0 data for strings with no crabs so averages are correct. Append site metadata
```{r}
crb <- merge(crb, site[, c(1,5)])

## Summarize ##
crb.sum <- crb %>%
  group_by(site, string) %>% 
  summarise(string_mass_g = sum(mass_g))

crb.sum.sp <- crb %>% 
  group_by(sea_otter_tr, string, species_common) %>% 
  summarise(mass_g = sum(mass_g))

## Insert zero data ## only missing one string
crb.sum[24,] <- c(as.character("2018_H_01"), 4.0, 0.0)

## Site data ##
crb.sum <- merge(crb.sum, site[, c(1,5)], by = "site")

crb.sum$string_mass_g <- as.numeric(crb.sum$string_mass_g)
```

```{r crb site x treatment, echo = FLASE}
## Nested Anova ##
mod.crb.1 <- lm(string_mass_g ~ sea_otter_tr + sea_otter_tr:site, data = crb.sum)
anova(mod.crb.1)

## Strait Anova ##
mod.crb.2 <- lm(string_mass_g ~ sea_otter_tr, data = crb.sum)
anova(mod.crb.2)
```

##### Clams
We also have species to think about...
```{r clm site}
## All Clams ##
mod.clm.1 <- lm(mass_g ~ sea_otter_tr + site %in% sea_otter_tr, data = clm.site.quad)
anova(mod.clm.1)

mod.clm.2 <-lm(mass_g ~ sea_otter_tr + species_common %in% sea_otter_tr, data = clm)
anova(mod.clm.2)

## Butter Clams ##
clm.but <- filter(clm, species_common == "Butter clam")
mod.but.1 <- lm(mass_g ~ sea_otter_tr + site %in% sea_otter_tr, data = clm.but)
anova(mod.but.1)
```


#### Plots
##### Data prep
Eelgrass
```{r eg site X treatment summaries, echo = FALSE}
eg.sum <- eg %>% 
  group_by(sea_otter_tr, site) %>% 
  summarise(shoot_mass_m_mean = mean(shoot_mass_m),
            shoot_mass_m_se = st.er(shoot_mass_m),
            epi_load_mean = mean(epi_load),
            epi_load_se = st.er(epi_load),
            grz_load_mean = mean(grazer_load),
            grz_load_se = st.er(grazer_load),
            ido_load_mean = mean(idotea_load),
            ido_load_se = st.er(idotea_load ),
            lmp_load_mean = mean(limpet_load),
            lmp_load_se = st.er(limpet_load))
```

Crabs
```{r}
## All Species ##
crb.sum2 <- crb.sum %>%
  group_by(site) %>% 
  summarise(mass_m = mean(string_mass_g),
            mass_se = sd(string_mass_g) / sqrt(length(string_mass_g)))

crb.sum2 <- merge(crb.sum2, site[, c(1, 2, 5)])

ggplot(crb.sum2) +
  geom_col(aes(x = site, y = mass_m / 1000, fill = sea_otter_tr)) +
  geom_errorbar(aes(x = site, ymin = (mass_m / 1000) - (mass_se / 1000), ymax = (mass_m / 1000) + (mass_se / 1000)), width = 0, size = 1) +
  scale_fill_manual(name = "Sea otters", values = c("red", "deepskyblue3")) +
  labs(x = "Site", y = "Crab mass (kg)")

## By species ##
crb.sum.2 <- crb.sum.sp %>% 
  group_by(sea_otter_tr, species_common) %>% 
  summarise(mass_m = mean(mass_g),
            mass_se = sd(mass_g) / sqrt(length(mass_g)))

crb.sum.2[5,] <- c(as.character("high"), as.character("Red rock crab"), 0.0, 0.0)
crb.sum.2[6,] <- c(as.character("low"), as.character("Helmet crab"), 0.0, 0.0)
crb.sum.2$mass_m <- as.numeric(crb.sum.2$mass_m)
crb.sum.2$mass_se <- as.numeric(crb.sum.2$mass_se)

ggplot(crb.sum.2, aes(x = sea_otter_tr, y = mass_m/1000, fill = species_common)) +
  geom_bar(position = position_dodge(), stat = "identity") +
  scale_fill_manual(values = c("chocolate4", "springgreen4", "firebrick")) +
  geom_errorbar(aes(ymin = (mass_m / 1000) - (mass_se / 1000), ymax = (mass_m / 1000) + (mass_se / 1000)), size = 1, width = 0, position = position_dodge(0.9)) +
  labs(x = "Site", y = "Crab mass (kg)") +
  scale_y_continuous(limits = c(0, 5))
```

##### Plots
```{r}
## Eelgrass ##
ggplot(eg.sum) +
  geom_bar(aes(x = site, y = shoot_mass_m_mean, fill = sea_otter_tr), position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(x = site, ymin = shoot_mass_m_mean - shoot_mass_m_se, ymax = shoot_mass_m_mean + shoot_mass_m_se), width = 0) +
  scale_fill_manual(values = c("red", "deepskyblue3")) +
  scale_y_continuous(limits = c(0, 300), breaks = seq(0, 300, by = 100))

## Epiphyte Load ##
ggplot(eg.sum) +
  geom_bar(aes(x = site, y = epi_load_mean, fill = sea_otter_tr), position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(x = site, ymin = epi_load_mean - epi_load_se, ymax = epi_load_mean + epi_load_se), width = 0) +
  scale_fill_manual(values = c("red", "deepskyblue3")) +
  scale_y_continuous(limits = c(0, 0.01), breaks = seq(0, 0.01, by = 0.0025))

## Grazer Load ##
ggplot(eg.sum) +
  geom_bar(aes(x = site, y = grz_load_mean, fill = sea_otter_tr), position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(x = site, ymin = grz_load_mean - grz_load_se, ymax = grz_load_mean + grz_load_se), width = 0) +
  scale_fill_manual(values = c("red", "deepskyblue3")) +
  scale_y_continuous(limits = c(0, 0.25), breaks = seq(0, 0.25, by = 0.05))

## Idotea Load ##
ggplot(eg.sum) +
  geom_bar(aes(x = site, y = ido_load_mean, fill = sea_otter_tr), position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(x = site, ymin = ido_load_mean - ido_load_se, ymax = ido_load_mean + ido_load_se), width = 0) +
  scale_fill_manual(values = c("red", "deepskyblue3")) +
  scale_y_continuous(limits = c(0, 0.15), breaks = seq(0, 0.15, by = 0.03))

## Limpet Load ##
ggplot(eg.sum) +
  geom_bar(aes(x = site, y = lmp_load_mean, fill = sea_otter_tr), position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(x = site, ymin = lmp_load_mean - lmp_load_se, ymax = lmp_load_mean + lmp_load_se), width = 0) +
  scale_fill_manual(values = c("red", "deepskyblue3")) +
  scale_y_continuous(limits = c(0, 0.03), breaks = seq(0, 0.03, by = 0.01))
```


### Stable Isotopes
There are two perspectives in analysis. 1) The whole community (all data) comparisons and 2) by species comparisons.

#### Whole community
Convex hulls

#### Species specific
Convex hulls

Trophic level

### Fatty Acids
Similar to SI data there are two perspectives to analysis. 1) The whole community and 2) by species comparisons. Along these lines I will run a nested PERMANOVA for the effects of species and sea otter treatment. Then species that appear to have a strong sea otter effect will be analyzed seperatly

#### FA data prep
Subsets
```{r fa subsets, echo = FALSE}
## Producers ##
fa_pro_1.0 <- fa_1.0 %>%
  filter(Species_common == "Eelgrass" | Species_common == "Eelgrass diatoms" | Species_common == "Fucus" | Species_common == "Particulate organic matter" | Species_common == "Sugar kelp" | Species_common == "Ulva")

## Consumers ##
fa_con_1.0 <- fa_1.0 %>% 
  filter(Species_common != "Eelgrass" & Species_common != "Eelgrass diatoms" & Species_common != "Fucus" & Species_common != "Particulate organic matter" & Species_common != "Sugar kelp" & Species_common != "Ulva")

## Crabs ##
fa_crb_1.0 <- fa_1.0 %>% 
  filter(Species_common == "Helmet crab" | Species_common == "Dungeness crab" | Species_common == "Red rock crab")

# Crabs - Dungeness #
fa_dun_1.0 <- fa_1.0 %>% 
  filter(Species_common == "Dungeness crab")

# Crabs - Helmet #
fa_hel_1.0 <- fa_1.0 %>% 
  filter(Species_common == "Helmet crab")

## Primary consumers ##
fa_pcon_1.0 <- fa_1.0 %>% 
  filter(Species_common == "Butter clam" | Species_common == "Idotea" | Species_common == "Limpet" | Species_common == "Macoma sp." | Species_common == "Pointed Macoma" | Species_common == "Bentnose Macoma")
```

Append metadata
```{r}
## Producers ##
fa_pro_1.0 <- merge(fa_pro_1.0, bimrk, by.x = "ID", by.y = "Biomarker_ID")
fa_pro_1.0 <- cbind(fa_pro_1.0[,c(69:76, 1, 3:67)])
colnames(fa_pro_1.0)[6] <- "Species_common"
colnames(fa_pro_1.0)[3] <- "Sea_otter_tr"

## Consumers ##
fa_con_1.0 <- merge(fa_con_1.0, bimrk, by.x = "ID", by.y = "Biomarker_ID")
fa_con_1.0 <- cbind(fa_con_1.0[,c(82:89, 1, 3:80)])
colnames(fa_con_1.0)[6] <- "Species_common"
colnames(fa_con_1.0)[3] <- "Sea_otter_tr"

## Crabs ##
fa_crb_1.0 <- merge(fa_crb_1.0, bimrk, by.x = "ID", by.y = "Biomarker_ID")
fa_crb_1.0 <- cbind(fa_crb_1.0[,c(69:76, 1, 3:67)])
colnames(fa_crb_1.0)[6] <- "Species_common"
colnames(fa_crb_1.0)[3] <- "Sea_otter_tr"

# Crabs - Dungeness #
fa_dun_1.0 <- merge(fa_dun_1.0, bimrk, by.x = "ID", by.y = "Biomarker_ID")
fa_dun_1.0 <- cbind(fa_dun_1.0[,c(69:76, 1, 3:67)])
colnames(fa_dun_1.0)[6] <- "Species_common"
colnames(fa_dun_1.0)[3] <- "Sea_otter_tr"

# Crabs - Helmet #
fa_hel_1.0 <- merge(fa_hel_1.0, bimrk, by.x = "ID", by.y = "Biomarker_ID")
fa_hel_1.0 <- cbind(fa_hel_1.0[,c(69:76, 1, 3:67)])
colnames(fa_hel_1.0)[6] <- "Species_common"
colnames(fa_hel_1.0)[3] <- "Sea_otter_tr"

# Primary consumers #
fa_pcon_1.0 <- merge(fa_pcon_1.0, bimrk, by.x = "ID", by.y = "Biomarker_ID")
fa_pcon_1.0 <- cbind(fa_pcon_1.0[,c(69:76, 1, 3:67)])
colnames(fa_pcon_1.0)[6] <- "Species_common"
colnames(fa_pcon_1.0)[3] <- "Sea_otter_tr"
```

Transformations and standardizations
I will use and arcsine sqrt transformation and standardize to FA (column) maximum
```{r fa trans std, echo = FALSE}
## Transformation ##
fa_con_1.0_trs <- asin(sqrt(fa_con_1.0[, 10:74]))
fa_pro_1.0_trs <- asin(sqrt(fa_pro_1.0[, 10:74]))
fa_crb_1.0_trs <- asin(sqrt(fa_crb_1.0[, 10:74]))
fa_dun_1.0_trs <- asin(sqrt(fa_dun_1.0[, 10:74]))
fa_hel_1.0_trs <- asin(sqrt(fa_hel_1.0[, 10:74]))
fa_pcon_1.0_trs <- asin(sqrt(fa_pcon_1.0[, 10:74]))

## Standardization ##
fa_con_1.0_trs_std <- scale(fa_con_1.0_trs, center = FALSE, scale = apply(fa_con_1.0_trs, 2, max))
fa_pro_1.0_trs_std <- scale(fa_pro_1.0_trs, center = FALSE, scale = apply(fa_pro_1.0_trs, 2, max))
fa_crb_1.0_trs_std <- scale(fa_crb_1.0_trs, center = FALSE, scale = apply(fa_crb_1.0_trs, 2, max))
fa_dun_1.0_trs_std <- scale(fa_dun_1.0_trs, center = FALSE, scale = apply(fa_dun_1.0_trs, 2, max))
fa_hel_1.0_trs_std <- scale(fa_hel_1.0_trs, center = FALSE, scale = apply(fa_hel_1.0_trs, 2, max))
fa_pcon_1.0_trs_std <- scale(fa_pcon_1.0_trs, center = FALSE, scale = apply(fa_pcon_1.0_trs, 2, max))
```

#### Ordination
Calculate distances
```{r dist, echo = FALSE}
## Producers ##
fa_pro_1.0_dist <- vegdist(fa_pro_1.0_trs_std, method = "euclidean")

## Consumers ##
fa_con_1.0_dist <- vegdist(fa_con_1.0_trs_std, method = "euclidean")

## All Crabs ##
fa_crb_1.0_dist <- vegdist(fa_crb_1.0_trs_std, method = "euclidean")

## Dungeness crabs ##
fa_dun_1.0_dist <- vegdist(fa_dun_1.0_trs_std, method = "euclidean")

## Helmet crabs ##
fa_hel_1.0_dist <- vegdist(fa_hel_1.0_trs_std, method = "euclidean")

## Primary consumers ##
fa_pcon_1.0_dist <- vegdist(fa_pcon_1.0_trs_std, method = "euclidean")
```

Calculate NMDS 
```{r MDS, echo = FALSE}
## Producers ##
fa_pro_1.0_mds <- metaMDS(fa_pro_1.0_dist)

## Consumers ##
fa_con_1.0_mds <- metaMDS(fa_con_1.0_dist)

## All Crabs ##
fa_crb_1.0_mds <- metaMDS(fa_crb_1.0_dist)

## Dungeness crabs ##
fa_dun_1.0_mds <- metaMDS(fa_dun_1.0_dist)

## Helmet crabs ##
fa_hel_1.0_mds <- metaMDS(fa_hel_1.0_dist)

## Primary consumers ##
fa_pcon_1.0_mds <- metaMDS(fa_pcon_1.0_dist)
```

#### PERMANOVA
Test for the effect of sea otter nested by species. Also include tests of multivariate dispersion 'betadisper'. 
```{r permanova, echo = FLASE}
## Producers ##
perm.pro <- adonis2(fa_pro_1.0_dist ~ Sea_otter_tr / sp_code, data = fa_pro_1.0, perm = 9999) 
perm.pro

## Consumers ##
perm.con <- adonis2(fa_con_1.0_dist ~ Sea_otter_tr / sp_code, data = fa_con_1.0, perm = 9999) 
perm.con

## All Crabs ##
disper.crb <- betadisper(fa_crb_1.0_dist, fa_crb_1.0$Sea_otter_tr, type = "centroid")
anova(disper.crb)

perm.crb.1 <- adonis2(fa_crb_1.0_dist ~  sp_code, data = fa_crb_1.0, perm = 9999) 
perm.crb.1

perm.crb.2 <- adonis2(fa_crb_1.0_dist ~ Sea_otter_tr / sp_code, data = fa_crb_1.0, perm = 9999) 
perm.crb.2

## Dungeness crabs ##
perm.dun <- adonis2(fa_dun_1.0_dist ~ Sea_otter_tr, data = fa_dun_1.0, perm = 9999)
perm.dun

## Helmet crabs ##
perm.hel <- adonis2(fa_hel_1.0_dist ~ Sea_otter_tr, data = fa_hel_1.0, perm = 9999)
perm.hel

## Primary Comsumers ##
perm.pcon <- adonis2(fa_pcon_1.0_dist ~ Sea_otter_tr / Site, data = fa_pcon_1.0, perm = 9999)
perm.pcon
```

#### SIMPER
Calcualte on untransformed data

Dungeness Crabs
```{r}
simp.dun <- simper(fa_dun_1.0[, 10:74], fa_dun_1.0$Sea_otter_tr, permutations = 9999)
simp.dun.dat <- summary(simp.dun, ordered = TRUE, digits = 4)
simp.dun.dat <- data.frame(simp.dun.dat$Low_High)
simp.dun.dat$FA <- row.names(simp.dun.dat)
simp.dun.dat$average_scaled <- simp.dun.dat$average / sum(simp.dun.dat$average)

datatable(filter(simp.dun.dat, p < 0.05))
```

Helmet crabs
```{r}
simp.hel <- simper(fa_hel_1.0[, 10:74], fa_hel_1.0$Sea_otter_tr, permutations = 9999)
simp.hel.dat <- summary(simp.hel, ordered = TRUE, digits = 4)
simp.hel.dat <- data.frame(simp.hel.dat$Low_High)
simp.hel.dat$FA <- row.names(simp.hel.dat)
simp.hel.dat$average_scaled <- simp.hel.dat$average / sum(simp.hel.dat$average)

datatable(filter(simp.hel.dat, p < 0.05))
```

#### NMDS Plots
##### Data Prep
```{r}
## Producers ##
fa_pro_1.0_mds_dat <- as.data.frame(scores(fa_pro_1.0_mds))
fa_pro_1.0_mds_dat$ID <- fa_pro_1.0$ID 
fa_pro_1.0_mds_dat <- merge(fa_pro_1.0_mds_dat, bimrk[, c(1:4, 7:10)], by.x = "ID", by.y = "Biomarker_ID")
fa_pro_1.0_mds_dat$Species_common <- factor(fa_pro_1.0_mds_dat$Species_common, levels = c("Eelgrass", "Eelgrass diatoms", "Fucus", "Particulate organic matter", "Sugar kelp", "Ulva"))

## Consumers ##
fa_con_1.0_mds_dat <- as.data.frame(scores(fa_con_1.0_mds))
fa_con_1.0_mds_dat$ID <- fa_con_1.0$ID 
fa_con_1.0_mds_dat <- merge(fa_con_1.0_mds_dat, bimrk[, c(1:4, 7:10)], by.x = "ID", by.y = "Biomarker_ID")
fa_con_1.0_mds_dat$Species_common <- factor(fa_con_1.0_mds_dat$Species_common, levels = c("Shiner perch", "Snake prickleback", "Staghorn sculpin", "Dungeness crab", "Helmet crab", "Red rock crab", "Dock shrimp", "Macoma sp.", "Bentnose Macoma", "Pointed Macoma", "Butter clam", "Idotea", "Limpet"))

## Crabs ##
fa_crb_1.0_mds_dat <- as.data.frame(scores(fa_crb_1.0_mds))
fa_crb_1.0_mds_dat$ID <- fa_crb_1.0$ID 
fa_crb_1.0_mds_dat$Species_common <- fa_crb_1.0$Species_common
fa_crb_1.0_mds_dat <- merge(fa_crb_1.0_mds_dat, bimrk[, c(1:4, 7, 9, 10)], by.x = "ID", by.y = "Biomarker_ID")
fa_crb_1.0_mds_dat$Species_common <- factor(fa_crb_1.0_mds_dat$Species_common, levels = c("Dungeness crab", "Helmet crab", "Red rock crab"))

# Dungeness crabs #
fa_dun_1.0_mds_dat <- as.data.frame(scores(fa_dun_1.0_mds))
fa_dun_1.0_mds_dat$ID <- fa_dun_1.0$ID 
fa_dun_1.0_mds_dat$Species_common <- fa_dun_1.0$Species_common
fa_dun_1.0_mds_dat <- merge(fa_dun_1.0_mds_dat, bimrk[, c(1:4, 7, 9, 10)], by.x = "ID", by.y = "Biomarker_ID")
fa_dun_1.0_mds_dat$Species_common <- factor(fa_dun_1.0_mds_dat$Species_common, levels = c("Dungeness crab"))

# Crabs - Helmet #
fa_hel_1.0_mds_dat <- as.data.frame(scores(fa_hel_1.0_mds))
fa_hel_1.0_mds_dat$ID <- fa_hel_1.0$ID 
fa_hel_1.0_mds_dat$Species_common <- fa_hel_1.0$Species_common
fa_hel_1.0_mds_dat <- merge(fa_hel_1.0_mds_dat, bimrk[, c(1:4, 7, 9, 10)], by.x = "ID", by.y = "Biomarker_ID")
fa_hel_1.0_mds_dat$Species_common <- factor(fa_hel_1.0_mds_dat$Species_common, levels = c("Helmet crab"))

# Primary consumers #
fa_pcon_1.0_mds_dat <- as.data.frame(scores(fa_pcon_1.0_mds))
fa_pcon_1.0_mds_dat$ID <- fa_pcon_1.0$ID 
fa_pcon_1.0_mds_dat$Species_common <- fa_pcon_1.0$Species_common
fa_pcon_1.0_mds_dat <- merge(fa_pcon_1.0_mds_dat, bimrk[, c(1:4, 7, 9, 10)], by.x = "ID", by.y = "Biomarker_ID")
fa_pcon_1.0_mds_dat$Species_common <- factor(fa_pcon_1.0_mds_dat$Species_common, levels = c("Butter clam" , "Idotea" ,"Limpet" , "Macoma sp." , "Pointed Macoma" , "Bentnose Macoma"))
```

##### FA Vectors
```{r fa vector, echo = FALSE, eval = FALSE}
## Primary producer Vectors ##
vec.pro <- envfit(fa_pro_1.0_mds$points, fa_pro_1.0[, 10:74], perm = 9999)
vec.pro.arrows <- scores(vec.pro, display = "vectors")
vec.pro.dat <- data.frame(vec.pro.arrows)
vec.pro.dat$pvals <- vec.pro$vectors$pvals
vec.pro.dat$FA <- row.names(vec.pro.dat)
vec.pro.dat$r2 <- vec.pro$vectors$r

scalefactor <- min(max(fa_pro_1.0_mds_dat$NMDS1) - min(fa_pro_1.0_mds_dat$NMDS1), max(fa_pro_1.0_mds_dat$NMDS2) - min(fa_pro_1.0_mds_dat$NMDS2))
vec.pro.dat$MDS1_sc <- vec.pro.dat$MDS1 * (scalefactor * vec.pro.dat$r2)
vec.pro.dat$MDS2_sc <- vec.pro.dat$MDS2 * (scalefactor * vec.pro.dat$r2)

vec.pro.dat.sig <- vec.pro.dat %>% 
  filter(pvals < 0.001)

arrow_angle <- 90 - ((atan2(vec.pro.dat.sig$MDS1_sc, vec.pro.dat.sig$MDS2_sc)* 180)/pi)
arrow_angle <- ifelse(arrow_angle > 90 & arrow_angle < 270, arrow_angle + 180, arrow_angle)
arrow_hjust <- ifelse(arrow_angle > 90, 1, 0)


## Crabs vectors ##
# All crabs #
vec.crb <- envfit(fa_crb_1.0_mds$points, fa_crb_1.0[, 10:74], perm = 9999)
vec.crb.arrows <- scores(vec.crb, display = "vectors")
vec.crb.dat <- data.frame(vec.crb.arrows)
vec.crb.dat$pvals <- vec.crb$vectors$pvals
vec.crb.dat$FA <- row.names(vec.crb.dat)
vec.crb.dat$r2 <- vec.crb$vectors$r

scalefactor <- min(max(fa_crb_1.0_mds_dat$NMDS1) - min(fa_crb_1.0_mds_dat$NMDS1), max(fa_crb_1.0_mds_dat$NMDS2) - min(fa_crb_1.0_mds_dat$NMDS2))
vec.crb.dat$MDS1_sc <- vec.crb.dat$MDS1 * scalefactor
vec.crb.dat$MDS2_sc <- vec.crb.dat$MDS2 * scalefactor 

vec.crb.dat.sig <- vec.crb.dat %>% 
  filter(pvals < 0.005)

arrow_angle <- 90 - ((atan2(vec.crb.dat.sig$MDS1_sc, vec.crb.dat.sig$MDS2_sc)* 180)/pi)
arrow_angle <- ifelse(arrow_angle > 90 & arrow_angle < 270, arrow_angle + 180, arrow_angle)
arrow_hjust <- ifelse(arrow_angle > 90, 1, 0)

# Dungeness Crabs #
vec.dun <- envfit(fa_dun_1.0_mds$points, fa_dun_1.0[, 10:74], perm = 9999)
vec.dun.arrows <- scores(vec.dun, display = "vectors")
vec.dun.dat <- data.frame(vec.dun.arrows)
vec.dun.dat$pvals <- vec.dun$vectors$pvals
vec.dun.dat$FA <- row.names(vec.dun.dat)
vec.dun.dat$r2 <- vec.dun$vectors$r

scalefactor <- min(max(fa_dun_1.0_mds_dat$NMDS1) - min(fa_dun_1.0_mds_dat$NMDS1), max(fa_dun_1.0_mds_dat$NMDS2) - min(fa_dun_1.0_mds_dat$NMDS2))
vec.dun.dat$MDS1_sc <- vec.dun.dat$MDS1 * scalefactor
vec.dun.dat$MDS2_sc <- vec.dun.dat$MDS2 * scalefactor

vec.dun.dat.sig <- vec.dun.dat %>% 
  filter(pvals < 0.05)

arrow_angle <- 90 - ((atan2(vec.dun.dat.sig$MDS1_sc, vec.dun.dat.sig$MDS2_sc)* 180)/pi)
arrow_angle <- ifelse(arrow_angle > 90 & arrow_angle < 270, arrow_angle + 180, arrow_angle)
arrow_hjust <- ifelse(arrow_angle > 90, 1, 0)

# Helmet Crabs #
vec.hel <- envfit(fa_hel_1.0_mds$points, fa_hel_1.0[, 10:74], perm = 9999)
vec.hel.arrows <- scores(vec.hel, display = "vectors")
vec.hel.dat <- data.frame(vec.hel.arrows)
vec.hel.dat$pvals <- vec.hel$vectors$pvals
vec.hel.dat$FA <- row.names(vec.hel.dat)
vec.hel.dat$r2 <- vec.hel$vectors$r

scalefactor <- min(max(fa_hel_1.0_mds_dat$NMDS1) - min(fa_hel_1.0_mds_dat$NMDS1), max(fa_hel_1.0_mds_dat$NMDS2) - min(fa_hel_1.0_mds_dat$NMDS2))
vec.hel.dat$MDS1_sc <- vec.hel.dat$MDS1 * scalefactor
vec.hel.dat$MDS2_sc <- vec.hel.dat$MDS2 * scalefactor

vec.hel.dat.sig <- vec.hel.dat %>% 
  filter(pvals < 0.05)

arrow_angle <- 90 - ((atan2(vec.hel.dat.sig$MDS1_sc, vec.hel.dat.sig$MDS2_sc)* 180)/pi)
arrow_angle <- ifelse(arrow_angle > 90 & arrow_angle < 270, arrow_angle + 180, arrow_angle)
arrow_hjust <- ifelse(arrow_angle > 90, 1, 0)
```

##### Plots
```{r}
## Producers ##
ggplot(fa_pro_1.0_mds_dat) +
  geom_point(aes(x = NMDS1, y = NMDS2, color = Sea_otter_region, shape = Species_common), size = 3) +
  scale_color_manual(values = c("red", "deepskyblue3")) +
  geom_text(aes(x = NMDS1, y = NMDS2), label = fa_pro_1.0_mds_dat$ID)

ggplot(fa_pro_1.0_mds_dat) +
  geom_point(aes(x = NMDS1, y = NMDS2, color = Sea_otter_region, shape = Species_common), size = 3) +
  scale_color_manual(values = c("red", "deepskyblue3")) +
  geom_segment(data = vec.pro.dat.sig, aes(x = 0, xend = MDS1_sc, y = 0, yend = MDS2_sc)) +
  geom_text(data = vec.pro.dat.sig, aes(x = MDS1_sc, y = MDS2_sc, label = FA), size = 4, angle = arrow_angle, hjust = arrow_hjust)
  
## Consumers ##
ggplot(fa_con_1.0_mds_dat) +
  geom_point(aes(x = NMDS1, y = NMDS2, color = Sea_otter_region, shape = Species_common), size = 3) +
  scale_shape_manual(values = c(15:19, 1:8)) +
  scale_color_manual(values = c("red", "deepskyblue3"))

## Crabs ##
ggplot(fa_crb_1.0_mds_dat) +
  geom_point(aes(x = NMDS1, y = NMDS2, shape = Species_common), size = 3.5) +
  scale_shape_manual(values = c(15, 16, 17)) +
  #stat_ellipse(aes(x = NMDS1, y = NMDS2, color = Sea_otter_region)) +
  #scale_color_manual(values = c("red", "deepskyblue3")) +
  scale_x_continuous(limits = c(-2.5, 2.2), breaks = seq(-2, 2, by = 1)) +
  scale_y_continuous(limits = c(-2.2, 2.2), breaks = seq(-2, 2, by = 1))

ggplot(fa_crb_1.0_mds_dat) +
  geom_point(aes(x = NMDS1, y = NMDS2, color = Sea_otter_region, shape = Species_common), size = 3.5, alpha = 0.5) +
  scale_shape_manual(values = c(15:19, 1:8)) +
  stat_ellipse(aes(x = NMDS1, y = NMDS2, color = Sea_otter_region)) +
  scale_color_manual(values = c("red", "deepskyblue3")) +
  geom_segment(data = vec.crb.dat.sig, aes(x = 0, xend = MDS1_sc, y = 0, yend = MDS2_sc)) +
  geom_text(data = vec.crb.dat.sig, aes(x = MDS1_sc, y = MDS2_sc, label = FA), size = 4, angle = arrow_angle, hjust = arrow_hjust) +
  scale_x_continuous(limits = c(-2.2, 2.2), breaks = seq(-2, 2, by = 1)) +
  scale_y_continuous(limits = c(-2.2, 2.2), breaks = seq(-2, 2, by = 1))

# Dungeness crabs #
ggplot(fa_dun_1.0_mds_dat) +
  geom_point(aes(x = NMDS1, y = NMDS2, color = Sea_otter_region, shape = Species_common), size = 3.5) +
  scale_shape_manual(values = 15) +
  stat_ellipse(aes(x = NMDS1, y = NMDS2, color = Sea_otter_region), type = "t") +
  scale_color_manual(values = c("red", "deepskyblue3")) +
  scale_x_continuous(limits = c(-2.5, 4), breaks = seq(-2, 4, by = 1)) +
  scale_y_continuous(limits = c(-3, 3), breaks = seq(-3, 3, by = 1))

ggplot(fa_dun_1.0_mds_dat) +
  geom_point(aes(x = NMDS1, y = NMDS2, color = Sea_otter_region, shape = Species_common), size = 3.5, alpha = 0.5) +
  scale_shape_manual(values = 15) +
  stat_ellipse(aes(x = NMDS1, y = NMDS2, color = Sea_otter_region)) +
  scale_color_manual(values = c("red", "deepskyblue3")) +
  geom_segment(data = vec.dun.dat.sig, aes(x = 0, xend = MDS1_sc, y = 0, yend = MDS2_sc)) +
  geom_text(data = vec.dun.dat.sig, aes(x = MDS1_sc, y = MDS2_sc, label = FA), size = 4, angle = arrow_angle, hjust = arrow_hjust) +
  scale_x_continuous(limits = c(-2.5, 3.2), breaks = seq(-2, 3, by = 1)) +
  scale_y_continuous(limits = c(-3, 2.2), breaks = seq(-3, 2, by = 1))

# Helmet crabs #
ggplot(fa_hel_1.0_mds_dat) +
  geom_point(aes(x = NMDS1, y = NMDS2, color = Sea_otter_region, shape = Species_common), size = 3.5) +
  scale_shape_manual(values = 16) +
  stat_ellipse(aes(x = NMDS1, y = NMDS2, color = Sea_otter_region), type = "t") +
  scale_color_manual(values = c("red", "deepskyblue3")) +
  scale_x_continuous(limits = c(-3, 2.5), breaks = seq(-3, 2, by = 1)) +
  scale_y_continuous(limits = c(-4, 3.5), breaks = seq(-4, 3, by = 1))

ggplot(fa_hel_1.0_mds_dat) +
  geom_point(aes(x = NMDS1, y = NMDS2, color = Sea_otter_region, shape = Species_common), size = 3.5, alpha = 0.5) +
  scale_shape_manual(values = 16) +
  stat_ellipse(aes(x = NMDS1, y = NMDS2, color = Sea_otter_region)) +
  scale_color_manual(values = c("red", "deepskyblue3")) +
  geom_segment(data = vec.hel.dat.sig, aes(x = 0, xend = MDS1_sc, y = 0, yend = MDS2_sc)) +
  geom_text(data = vec.hel.dat.sig, aes(x = MDS1_sc, y = MDS2_sc, label = FA), size = 4, angle = arrow_angle, hjust = arrow_hjust) +
  scale_x_continuous(limits = c(-3, 3), breaks = seq(-3, 3, by = 1)) +
  scale_y_continuous(limits = c(-4, 4), breaks = seq(-4, 4, by = 1))

## Primary Consumers ##
ggplot(fa_pcon_1.0_mds_dat) +
  geom_point(aes(x = NMDS1, y = NMDS2, color = Sea_otter_region, shape = Species_common), size = 3.5) +
  scale_shape_manual(values = c(1:6)) +
  scale_color_manual(values = c("red", "deepskyblue3")) 
```