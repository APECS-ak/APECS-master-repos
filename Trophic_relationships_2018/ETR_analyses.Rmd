---
title: "ETR_analyses"
author: "Wendel Raymond"
date: "October 22, 2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

# Eelgrass trophic relationships - analyses
*Question:* Do sea otters effects the tropic structure of eelgrass communities in Southeast Alaska? From my 2017 data we found that sea otters have a large negative effect on crabs and are positively related to eelgrass biomass, suggesting that sea otter are influencing the eelgrass community. Furthermore we did not find evidence for all the hypothesized links between major community members necessary to complete the full trophic cascade. Notable we found no evidence of a relationship between crabs and grazer and fish and grazers. To this end we further investigated the dynamics of this community by measuring the biomass, stable isotopes, and fatty acids of key eelgrass community constituents.

*Some opening notes* There is a lot of data. There could be multiple papers here. Some more exploratory analysis is definitely warranted but the original goal was to look at the whole community. Crafting analyses so that we answer questions from that perspective should be the priority. However, if interesting stories arise maybe the approach will change. Just sayin. 

```{r libraries, echo = FALSE, warning = FALSE, message = FALSE}
library(dplyr)
library(tidyr)
library(ggplot2)
library(DT)
library(cowplot)
library(RColorBrewer)
library(vegan)
library(stringr)
library(siar)

theme_set(theme_classic())
```

```{r st.er, echo = FALSE}
st.er <- function(x, na.rm = TRUE) {
  stopifnot(is.numeric(x))
  return(sd(x, na.rm = na.rm)/sqrt(length(x)))
}
```

```{r}
shape.pal <- c(15, 16, 17)
so.pal <- (c("red3", "deepskyblue3"))
```

## Data
Data falls under three broad categories. Biomass, stable isotopes, and fatty acids. Biomass data files are broken up by sampling type but can easily be combined. In addition, biomarker (SI and FA) metadata is useful to match those data with site, date, treatment, etc. data.
Biomass and oceanography
```{r dat bio, echo=FALSE}
eg <- read.csv("../ALL_DATA/Eelgrass_biometrics_all_2018_derived.csv", header = TRUE, stringsAsFactors = FALSE)

crb <- read.csv("../ALL_DATA/crab_all_2018_derived.csv", header = TRUE, stringsAsFactors = FALSE)

clm <- read.csv("../ALL_DATA/eelgrass_clam_all_2018_derived.csv", header = TRUE, stringsAsFactors = FALSE)

fsh <- read.csv("../ALL_DATA/Fish_mass_site_2018_derived.csv", header = TRUE, stringsAsFactors = FALSE)

site <- read.csv("../ALL_DATA/Eelgrass_trophic_relationships_site_metadata_2018.csv", header = TRUE, stringsAsFactors = FALSE)
```

Stable Isotope
```{r dat iso, echo = FALSE}
si <- read.csv("../ALL_DATA/Isotopes_eelgrass_comm_2018_RAW.csv", header = TRUE, stringsAsFactors = FALSE)
```

Fatty Acid
```{r dat fa, echo = FALSE}
fa <- read.csv("../ALL_DATA/FA_proportions_1.0filter_2018_derived.csv", header = TRUE, stringsAsFactors = FALSE)
```

Biomarker metadata
```{r dat biomarker, echo = FALSE}
bimrk <- read.csv("../ALL_DATA/Biomarker_collections_2018_RAW.csv", header = TRUE, stringsAsFactors = FALSE)
```

### Data managemnet
Clean up files. Make sure appropriate columns are there.
```{r data clean up, echo=FALSE}
## Eelgrass Transect #3
eg <- merge(eg, site[, c(1, 5)], by = "site")

## Crabs ##
crb <- merge(crb, site[, c(1,5)])

# site and string #
crb.site.string <- crb %>%
  group_by(site, string) %>% 
  summarise(mass_g = sum(mass_g))

# Insert zero data ## only missing one string
crb.site.string[24,] <- c(as.character("2018_H_01"), 4.0, 0.0)
crb.site.string <- merge(crb.site.string, site[, c(1,5)], by = "site")
crb.site.string$mass_g <- as.numeric(crb.site.string$mass_g)

crb.site.string <- merge(crb.site.string, site[, c(1, 5)], by = "site")

# Site string and sp #
d <- expand.grid(species_common = c("Dungeness crab", "Graceful crab", "Helmet crab", "Red rock crab"), site = unique(crb$site), string = unique(crb$string))

crb.site.string.sp <- crb %>% 
  group_by(site, string, species_common) %>% 
  summarise(mass_g = sum(mass_g))

crb.site.string.sp <- merge(d, crb.site.string.sp, by = c("site", "string", "species_common"), all.x  = TRUE)

crb.site.string.sp[is.na(crb.site.string.sp)] <- 0

crb.site.string.sp <- merge(crb.site.string.sp, site[, c(1,5)], by = "site")

## Clams! ##
clm <- merge(clm, site[, c(1, 5)], by = "site")
clm$quadrat <- as.factor(clm$quadrat)

# clean up species #
clm$species_common <- ifelse(clm$species_common == "Macoma", "Macoma sp.", clm$species_common)

clm$species_common <- ifelse(clm$species_common == "Pointed macoma", "Macoma sp.", clm$species_common)

clm$species_common <- ifelse(clm$species_common == "Bentnose macoma", "Macoma sp.", clm$species_common)

# site and quadrat summary #
clm.site.quad <- clm %>%
  group_by(site, quadrat) %>% 
  summarize(mass_g = sum(mass_g))
clm.site.quad <- merge(clm.site.quad, site[, c(1, 5)], by = "site")

# site quadrat and species summary #
d <- expand.grid(species_common = c("Butter clam", "Cockle", "Macoma sp.", "Soft-shell clam", "Steamer clam"), site = unique(clm$site), quadrat = unique(clm$quadrat))

clm.site.quad.sp <- clm %>%
  group_by(site, quadrat, species_common) %>% 
  summarize(mass_g = sum(mass_g))

clm.site.quad.sp <- merge(d, clm.site.quad.sp, by = c("site", "quadrat", "species_common"), all.x  = TRUE)

clm.site.quad.sp[is.na(clm.site.quad.sp)] <- 0

clm.site.quad.sp <- merge(clm.site.quad.sp, site[, c(1,5)], by = "site")

## Fish ##
fsh <- merge(fsh, site[, c(1, 5)], by = "site")
```

## Analyses
A critical piece for all analyses is testing the effect of site and sea otter treatment. Within each sea otter treatment three different sites were sampled.

### Biomarker Metadata
```{r bimrk metadata, echo = FALSE}
## Filter out ones we did not use ##
bimrk_redu <- merge(bimrk, si[ 1], by = "Biomarker_ID")

## Mean size by sample ##
bimrk_redu$size_mm_mean <-rowMeans(bimrk_redu[, 12:25], na.rm = TRUE)

bimrk.sum <- bimrk_redu %>% 
  group_by(Sea_otter_region, Species_common) %>% 
  summarise(size_mean = mean(size_mm_mean),
            size_sd = sd(size_mm_mean))
```

### Biomass
Compare biomass of community members between sea otter treatments

#### Assess normality
```{r norm, echo = FALSE}
## eelgrass mass ##
hist(eg$shoot_mass_m)
shapiro.test(eg$shoot_mass_m)

hist(log(eg$shoot_mass_m))
shapiro.test(log(eg$shoot_mass_m))

## epiphyte load ##
hist(eg$epi_load)
shapiro.test(eg$epi_load)

hist(sqrt(eg$epi_load))
shapiro.test(sqrt(eg$epi_load))

## Idotea load ##
hist(eg$idotea_load)

## limpet load ##
hist(sqrt(eg$limpet_load))

## butter clams ##
hist(clm.site.quad.sp$mass_g[clm.site.quad.sp$species_common == "Butter clam"])

## macoma sp clams ##
hist(clm.site.quad.sp$mass_g[clm.site.quad.sp$species_common == "Macoma sp."])

## helmet crabs ##
hist(crb.site.string.sp$mass_g[crb.site.string.sp$species_common == "Helmet crab"])

## Gracilis crabs ##
hist(crb.site.string.sp$mass_g[crb.site.string.sp$species_common == "Graceful crab"])

## Red rock crab ##
hist(crb.site.string.sp$mass_g[crb.site.string.sp$species_common == "Red rock crab"], breaks = 10)

## Shiner perch ##
hist(fsh$PERCHSH)

## Snake pricklebakc ##
hist(fsh$PRICKSN)

## Staghorn ##
hist(fsh$SCULPSTG)
```

#### ANOVAS of sites and treatment
##### Eelgrass - biomass and shoot density tests
Eelgrass
```{r eg site x treatment, echo = FALSE}
mod.eg.1 <- lm(log(shoot_mass_m) ~ sea_otter_tr + sea_otter_tr %in% site, data = eg)
anova(mod.eg.1)

t.eg.1 <- t.test(eg$shoot_mass_m[eg$sea_otter_tr == "high"], eg$shoot_mass_m[eg$sea_otter_tr == "low"])

mod.eg.2 <- lm(eelgrass_shoots_m ~ sea_otter_tr * site, data = eg)
anova(mod.eg.2)
```

Epiphytes
```{r epi site X treatment, echo = FALSE}
mod.ep.1 <- lm(sqrt(epi_load) ~ sea_otter_tr + sea_otter_tr %in% site, data = eg)
anova(mod.ep.1)

t.ep.1 <- t.test(eg$epi_load[eg$sea_otter_tr == "high"],  eg$epi_load[eg$sea_otter_tr == "low"])
t.ep.1
```

Grazers
```{r grz site X treatment, echo = FALSE}
## All Grazers ##
mod.gr.1 <- lm(grazer_load ~ sea_otter_tr + sea_otter_tr/site, data = eg)
anova(mod.gr.1)

t.gr.1 <- t.test(eg$grazer_load[eg$sea_otter_tr == "high"],  eg$grazer_load[eg$sea_otter_tr == "low"])
t.gr.1

## Idotea ##
mod.id.1 <- lm(idotea_load ~ sea_otter_tr + sea_otter_tr %in% site, data = eg)
anova(mod.id.1)

t.id.1 <- t.test(eg$idotea_load[eg$sea_otter_tr == "high"],  eg$idotea_load[eg$sea_otter_tr == "low"])
t.id.1

## Limpet ##
mod.lp.1 <- lm(limpet_load ~ sea_otter_tr + sea_otter_tr %in% site, data = eg)
anova(mod.lp.1)

t.lp.1 <- t.test(eg$limpet_load[eg$sea_otter_tr == "high"],  eg$limpet_load[eg$sea_otter_tr == "low"])
t.lp.1
```

##### Crabs
Sum total crab mass by string. Insert 0 data for strings with no crabs so averages are correct. Append site metadata
```{r crb site x treatment, echo = FLASE}
## Nested Anova ##
mod.crb.1 <- lm(mass_g ~ sea_otter_tr + sea_otter_tr:site, data = crb.site.string)
anova(mod.crb.1)

## Strait Anova ##
mod.crb.2 <- lm(mass_g ~ sea_otter_tr, data = crb.sum)
anova(mod.crb.2)

## By species ##
# Overall #
mod.crb.3 <- lm(mass_g ~ sea_otter_tr + species_common %in% sea_otter_tr, data = crb.site.string.sp)
anova(mod.crb.3)

# Graceful #
mod.dun.1 <- lm(mass_g / 1000 ~ sea_otter_tr + site %in% sea_otter_tr, data = subset(crb.site.string.sp, species_common == "Graceful crab"))
anova(mod.dun.1)

# Helmet #
mod.hel.1 <- lm(mass_g / 1000 ~ sea_otter_tr + site %in% sea_otter_tr, data = subset(crb.site.string.sp, species_common == "Helmet crab"))
anova(mod.hel.1)

# Red rock #
mod.roc.1 <- lm(mass_g / 1000 ~ sea_otter_tr + site %in% sea_otter_tr, data = subset(crb.site.string.sp, species_common == "Red rock crab"))
anova(mod.roc.1)
```

##### Clams
We also have species to think about...
```{r clm site}
## All Clams ##
mod.clm.1 <- lm(mass_g ~ sea_otter_tr + site %in% sea_otter_tr, data = clm.site.quad)
anova(mod.clm.1)

## By species ##
# Overall #
mod.clm.2 <-lm(mass_g ~ sea_otter_tr + species_common %in% sea_otter_tr, data = clm.site.quad.sp)
anova(mod.clm.2)

# Butter clams #
mod.but.1 <- lm(mass_g/1000 ~ sea_otter_tr + site %in% sea_otter_tr, data = subset(clm.site.quad.sp, species_common == "Butter clam"))
anova(mod.but.1)

# Macoma sp. ##
mod.mac.1 <- lm(mass_g/1000 ~ sea_otter_tr + site %in% sea_otter_tr, data = subset(clm.site.quad.sp, species_common == "Macoma sp."))
anova(mod.mac.1)
```

##### Fish
```{r}
## Total mass ##
mod.fsh.1 <- lm(total_fish_mass ~ sea_otter_tr, data = fsh)
anova(mod.fsh.1)

## Stags ##
mod.stg.1 <- lm(SCULPSTG / 1000 ~ sea_otter_tr, data = fsh)
anova(mod.stg.1)

## Shiners ##
mod.shn.1 <- lm(PERCHSH / 1000 ~ sea_otter_tr, data = fsh)
anova(mod.shn.1)

## Snake Prickle bach ##
mod.snk.1 <- lm(PRICKSN / 1000 ~ sea_otter_tr, data = fsh)
anova(mod.snk.1)
```

#### Plots
##### Data prep
Eelgrass
```{r eg site X treatment summaries, echo = FALSE}
eg.sum <- eg %>% 
  group_by(sea_otter_tr, site) %>% 
  summarise(shoot_mass_m_mean = mean(shoot_mass_m),
            shoot_mass_m_se = st.er(shoot_mass_m),
            epi_load_mean = mean(epi_load),
            epi_load_se = st.er(epi_load),
            grz_load_mean = mean(grazer_load),
            grz_load_se = st.er(grazer_load),
            ido_load_mean = mean(idotea_load),
            ido_load_se = st.er(idotea_load ),
            lmp_load_mean = mean(limpet_load),
            lmp_load_se = st.er(limpet_load))
```

Crabs
```{r}
## All Species ##
crb.sum <- crb.site.string.sp %>%
  group_by(site) %>% 
  summarise(mass_m = mean(mass_g),
            mass_se = sd(mass_g) / sqrt(length(mass_g)))

crb.sum2 <- merge(crb.sum2, site[, c(1, 2, 5)])

ggplot(crb.sum2) +
  geom_col(aes(x = site, y = mass_m / 1000, fill = sea_otter_tr)) +
  geom_errorbar(aes(x = site, ymin = (mass_m / 1000) - (mass_se / 1000), ymax = (mass_m / 1000) + (mass_se / 1000)), width = 0, size = 1) +
  scale_fill_manual(name = "Sea otters", values = c("red", "deepskyblue3")) +
  labs(x = "Site", y = "Crab mass (kg)")

## By species ##
crb.sum.2 <-  crb.site.string.sp %>% 
  group_by(site, species_common) %>% 
  summarise(mass_m = mean(mass_g),
            mass_se = st.er(mass_g))

crb.sum.2 <- merge(crb.sum.2, site[, c(1, 5)], by = "site")
```

Clams
```{r}
clm.sum.1 <- clm.site.quad %>% 
  group_by(site) %>% 
  summarise(mass_g_mean = mean(mass_g),
            mass_g_se = st.er(mass_g))
clm.sum.1 <- merge(clm.sum.1, site[, c(1, 5)], by = "site")

clm.sum.2 <- clm.site.quad.sp %>% 
  group_by(site, species_common) %>% 
  summarise(mass_g_mean = mean(mass_g),
            mass_g_se = st.er(mass_g))
clm.sum.2 <- merge(clm.sum.2, site[, c(1, 5)], by = "site")
```

Fish
```{r}
fsh.sum.1 <- fsh %>%
  group_by(sea_otter_tr) %>% 
  summarise(mass_kg_mean = mean(total_fish_mass / 1000),
           mass_kg_se = st.er(total_fish_mass / 1000))

stg.sum.1 <- fsh %>%
  group_by(sea_otter_tr) %>% 
  summarise(mass_kg_mean = mean(SCULPSTG / 1000),
            mass_kg_se = st.er(SCULPSTG  / 1000))

shn.sum.1 <- fsh %>%
  group_by(sea_otter_tr) %>% 
  summarise(mass_kg_mean = mean(PERCHSH / 1000),
            mass_kg_se = st.er(PERCHSH / 1000))

snk.sum.1 <- fsh %>%
  group_by(sea_otter_tr) %>% 
  summarise(mass_kg_mean = mean(PRICKSN / 1000),
            mass_kg_se = st.er(PRICKSN / 1000))
```


##### Plots
```{r}
so.pal <- (c("red3", "deepskyblue3"))

## Eelgrass ##
elg.m <- ggplot(eg.sum) +
  geom_bar(aes(x = site, y = shoot_mass_m_mean, fill = sea_otter_tr), position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(x = site, ymin = shoot_mass_m_mean - shoot_mass_m_se, ymax = shoot_mass_m_mean + shoot_mass_m_se), width = 0) +
  scale_fill_manual("Sea otter region", labels = c("High", "Low"), values = so.pal) +
  scale_x_discrete(labels = c("H1", "H2", "H3", "L1", "L2", "L3")) +
  scale_y_continuous(limits = c(0, 300), breaks = seq(0, 300, by = 100)) +
  ylab(bquote("Eelgrass mass" ~(g/m^-2))) +
  xlab("Site") +
  theme(legend.position = c(0.8, 0.8), text = element_text(size = 8))

## Epiphyte Load ##
epi.m <- ggplot(eg.sum) +
  geom_bar(aes(x = site, y = epi_load_mean, fill = sea_otter_tr), position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(x = site, ymin = epi_load_mean - epi_load_se, ymax = epi_load_mean + epi_load_se), width = 0) +
  scale_fill_manual("Sea otter region", labels = c("High", "Low"), values = so.pal) +
  scale_x_discrete(labels = c("H1", "H2", "H3", "L1", "L2", "L3")) +
  scale_y_continuous(limits = c(0, 0.01), breaks = seq(0, 0.01, by = 0.0025)) +
  ylab("Epiphyte load (g/g)") +
  xlab("Site") +
  theme(legend.position = "none", text = element_text(size = 8))

## Grazer Load ##
ggplot(eg.sum) +
  geom_bar(aes(x = site, y = grz_load_mean, fill = sea_otter_tr), position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(x = site, ymin = grz_load_mean - grz_load_se, ymax = grz_load_mean + grz_load_se), width = 0) +
  scale_fill_manual(values = c("red", "deepskyblue3")) +
  scale_y_continuous(limits = c(0, 0.25), breaks = seq(0, 0.25, by = 0.05))

## Idotea Load ##
ido.m <- ggplot(eg.sum) +
  geom_bar(aes(x = site, y = ido_load_mean, fill = sea_otter_tr), position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(x = site, ymin = ido_load_mean - ido_load_se, ymax = ido_load_mean + ido_load_se), width = 0) +
  scale_fill_manual("Sea otter region", labels = c("High", "Low"), values = so.pal) +
  scale_x_discrete(labels = c("H1", "H2", "H3", "L1", "L2", "L3")) +
  scale_y_continuous(limits = c(0, 0.15), breaks = seq(0, 0.15, by = 0.03)) +
  ylab("Idotea load (g/g)") +
  xlab("Site") +
  theme(legend.position = "none", text = element_text(size = 8))

## Limpet Load ##
lmp.m <- ggplot(eg.sum) +
  geom_bar(aes(x = site, y = lmp_load_mean, fill = sea_otter_tr), position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(x = site, ymin = lmp_load_mean - lmp_load_se, ymax = lmp_load_mean + lmp_load_se), width = 0) +
  scale_fill_manual("Sea otter region", labels = c("High", "Low"), values = so.pal) +
  scale_x_discrete(labels = c("H1", "H2", "H3", "L1", "L2", "L3")) +
  scale_y_continuous(limits = c(0, 0.03), breaks = seq(0, 0.03, by = 0.01)) +
  ylab("Limpet load (g/g)") +
  xlab("Site") +
  theme(legend.position = "none", text = element_text(size = 8))

## Clams site ##
ggplot(clm.sum.1) +
  geom_bar(aes(x = site, y = mass_g_mean, fill = sea_otter_tr), position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(x = site, ymin = mass_g_mean - mass_g_se, ymax = mass_g_mean + mass_g_se), width = 0) +
  scale_fill_manual(values = c("red", "deepskyblue3")) +
  scale_y_continuous(limits = c(0, 700), breaks = seq(0, 700, by = 100))

## Clams site sp ##
ggplot(clm.sum.2, aes(x = site, y = mass_g_mean, fill = species_common)) +
  geom_bar(position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(ymin = mass_g_mean - mass_g_se, ymax = mass_g_mean + mass_g_se), width = 0, position=position_dodge(.9)) +
  scale_fill_brewer(palette = "Set1") +
  scale_y_continuous(limits = c(0, 500), breaks = seq(0, 500, by = 100))

## Butter clams ##
but.m <- ggplot(subset(clm.sum.2, species_common == "Butter clam")) +
  geom_bar(aes(x = site, y = mass_g_mean / 1000, fill = sea_otter_tr), position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(x = site, ymin = mass_g_mean / 1000 - mass_g_se / 1000, ymax = mass_g_mean / 1000 + mass_g_se / 1000), width = 0) +
  scale_fill_manual("Sea otter region", labels = c("High", "Low"), values = so.pal) +
  scale_x_discrete(labels = c("H1", "H2", "H3", "L1", "L2", "L3")) +
  ylab(bquote("Butter clam" ~(kg/m^-2))) +
  xlab("Site") +
  theme(legend.position = "none", text = element_text(size = 8))

## Macoma sp. clams ##
mac.m <- ggplot(subset(clm.sum.2, species_common == "Macoma sp.")) +
  geom_bar(aes(x = site, y = mass_g_mean / 1000, fill = sea_otter_tr), position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(x = site, ymin = mass_g_mean / 1000 - mass_g_se / 1000, ymax = mass_g_mean / 1000 + mass_g_se / 1000), width = 0) +
  scale_fill_manual("Sea otter region", labels = c("High", "Low"), values = so.pal) +
  scale_x_discrete(labels = c("H1", "H2", "H3", "L1", "L2", "L3")) +
  ylab(bquote("Macoma sp. clams" ~(kg/m^-2))) +
  xlab("Site") +
  theme(legend.position = "none", text = element_text(size = 8))

## Crabs site sp ##
ggplot(crb.sum.2, aes(x = sea_otter_tr, y = mass_m/1000, fill = species_common)) +
  geom_bar(position = position_dodge(), stat = "identity") +
  scale_fill_manual(values = c("chocolate4", "springgreen4", "firebrick")) +
  geom_errorbar(aes(ymin = (mass_m / 1000) - (mass_se / 1000), ymax = (mass_m / 1000) + (mass_se / 1000)), size = 1, width = 0, position = position_dodge(0.9)) +
  labs(x = "Site", y = "Crab mass (kg)") +
  scale_y_continuous(limits = c(0, 5))

## Gracefuil crabs ##
grc.m <- ggplot(subset(crb.sum.2, species_common == "Graceful crab")) +
  geom_bar(aes(x = site, y = mass_m / 1000, fill = sea_otter_tr), position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(x = site, ymin = mass_m / 1000 - mass_se / 1000, ymax = mass_m / 1000 + mass_se / 1000), width = 0) +
  scale_fill_manual("Sea otter region", labels = c("High", "Low"), values = so.pal) +
  scale_x_discrete(labels = c("H1", "H2", "H3", "L1", "L2", "L3")) +
  scale_y_continuous(limits = c(0, 0.5), breaks = seq(0, 0.5, by = 0.1)) +
  ylab("Graceful crab (kg/string)") +
  xlab("Site") +
  theme(legend.position = "none", text = element_text(size = 8))

## Helmet crabs ##
hel.m <- ggplot(subset(crb.sum.2, species_common == "Helmet crab")) +
  geom_bar(aes(x = site, y = mass_m / 1000, fill = sea_otter_tr), position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(x = site, ymin = mass_m / 1000 - mass_se / 1000, ymax = mass_m / 1000 + mass_se / 1000), width = 0) +
  scale_fill_manual("Sea otter region", labels = c("High", "Low"), values = so.pal) +
  scale_x_discrete(labels = c("H1", "H2", "H3", "L1", "L2", "L3")) +
  scale_y_continuous(limits = c(0, 0.2), breaks = seq(0, 0.2, by = 0.05)) +
  ylab("Helmet crab (kg/string)") +
  xlab("Site") +
  theme(legend.position = "none" , text = element_text(size = 8))

## Red rock crabs ##
rrc.m <- ggplot(subset(crb.sum.2, species_common == "Red rock crab")) +
  geom_bar(aes(x = site, y = mass_m / 1000, fill = sea_otter_tr), position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(x = site, ymin = mass_m / 1000 - mass_se / 1000, ymax = mass_m / 1000 + mass_se / 1000), width = 0) +
  scale_fill_manual("Sea otter region", labels = c("High", "Low"), values = so.pal) +
  scale_x_discrete(labels = c("H1", "H2", "H3", "L1", "L2", "L3")) +
  scale_y_continuous(limits = c(0, 2.0), breaks = seq(0, 2.0, by = 0.5)) +
  ylab("Red rock crab (kg/string)") +
  xlab("Site") +
  theme(legend.position = "none", text = element_text(size = 8))

## Fish site ##
ggplot(fsh.sum.1) +
  geom_bar(aes(x = sea_otter_tr, y = mass_kg_mean, fill = sea_otter_tr), position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(x = sea_otter_tr, ymin = mass_kg_mean - mass_kg_se, ymax = mass_kg_mean + mass_kg_se), width = 0) +
  scale_fill_manual(values = c("red", "deepskyblue3"))
  
## Staghorn ##
stg.m <- ggplot(stg.sum.1) +
  geom_bar(aes(x = sea_otter_tr, y = mass_kg_mean, fill = sea_otter_tr), position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(x = sea_otter_tr, ymin = mass_kg_mean - mass_kg_se, ymax = mass_kg_mean + mass_kg_se), width = 0) +
  scale_fill_manual(values = so.pal) +
  scale_x_discrete(labels = c("High", "Low")) +
  scale_y_continuous(limits = c(0, 2), breaks = seq(0, 2, by = 0.5)) +
  ylab("Staghorn sculpin (kg/set)") +
  xlab("Site") +
  theme(legend.position = "none", text = element_text(size = 8))

## Shiner ##
shn.m <- ggplot(shn.sum.1) +
  geom_bar(aes(x = sea_otter_tr, y = mass_kg_mean, fill = sea_otter_tr), position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(x = sea_otter_tr, ymin = mass_kg_mean - mass_kg_se, ymax = mass_kg_mean + mass_kg_se), width = 0) +
  scale_fill_manual(values = so.pal) +
  scale_x_discrete(labels = c("High", "Low")) +
  scale_y_continuous(limits = c(0, 16), breaks = seq(0, 16, by = 4)) +
  ylab("Shiner perch (kg/set)") +
  xlab("Site") +
  theme(legend.position = "none", text = element_text(size = 8))

## Snake prickleback ##
snk.m <- ggplot(snk.sum.1) +
  geom_bar(aes(x = sea_otter_tr, y = mass_kg_mean, fill = sea_otter_tr), position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(x = sea_otter_tr, ymin = mass_kg_mean - mass_kg_se, ymax = mass_kg_mean + mass_kg_se), width = 0) +
  scale_fill_manual(values = so.pal) +
  scale_x_discrete(labels = c("High", "Low")) +
  scale_y_continuous(limits = c(0, 12), breaks = seq(0, 12, by = 3)) +
  ylab("Snake prickleback (kg/set)") +
  xlab("Site") +
  theme(legend.position = "none", text = element_text(size = 8))
```

##### Panel - biomass
```{r}
cowplot::plot_grid(elg.m, epi.m, ido.m, lmp.m, but.m, mac.m, grc.m, hel.m, rrc.m, stg.m, shn.m, snk.m, labels = c("a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l"), nrow = 4, ncol = 3, label_size = 10)
```

### Stable Isotopes
There are two perspectives in analysis. 1) The whole community (all data) comparisons and 2) by species comparisons.

#### SI data prep
Filter out NA data duplicate QA/QC samples
```{r si data prep, echo = FALSE}
si <- si %>% 
  na.omit() %>% 
  filter(!str_detect(Biomarker_ID, "_B"))
```

Calculate C:N ratio
```{r c:n ratio, echo = FALSE}
si$C_N <- si$percent_C / si$percent_N
```

Append metadata etc. Convert all Macoma to Macoma sp. Then filter OUT limpets and B_226 the coccolithophore POM sample .... for now
```{r si metadata, echo = FALSE}
si <- merge(si, bimrk, by = "Biomarker_ID")
colnames(si)[11] <- "Sea_otter_tr"

si <- si %>% 
  filter(Species_common != "Limpet") %>% 
  filter(Biomarker_ID != "B_226")

si$Species_common <- ifelse(str_detect(si$Species_common, "Macoma"), "Macoma sp.", si$Species_common)
```

#### Whole community
Convex hulls. First calcualte mean values by species by sea otter treatment
```{r c hulls all, echo = FALSE}
si.sum <- si %>% 
  group_by(Sea_otter_tr, Species_common) %>% 
  summarise(Species_scientific = first(Species_scientific),
            sp_code = first(sp_code),
            sp_group = first(sp_group),
            n = n(),
            del_N_mean = mean(del_N),
            del_N_sd = sd(del_N),
            del_C_mean = mean(del_C),
            del_C_sd = sd(del_C))

si.sum$sp_code <- ifelse(si.sum$Species_common == "Macoma sp.", "CLMMAC", si.sum$sp_code)

si.sum$del_N_ord_high <- sort(si.sum$del_N_mean)

## High sea otter ##
high.c.area <- convexhull(si.sum$del_C_mean[si.sum$Sea_otter_tr == "High"], si.sum$del_N_mean[si.sum$Sea_otter_tr == "High"])

## Low sea otter ##
low.c.area <- convexhull(si.sum$del_C_mean[si.sum$Sea_otter_tr == "Low"], si.sum$del_N_mean[si.sum$Sea_otter_tr == "Low"])
```


##### Plots
```{r plots si all, echo = FALSE}
## All data ##
ggplot(si) +
  geom_point(aes(x = del_C, y = del_N, color = Sea_otter_tr), size = 3)

## Mean values and hulls ##
ggplot() +
  geom_point(aes(x = si.sum$del_C_mean, y = si.sum$del_N_mean, shape = si.sum$sp_group, color = si.sum$Sea_otter_tr), size = 3) +
  scale_color_manual(values = so.pal, "Sea otter region") +
  scale_shape_manual(values = shape.pal, "Trophic position", labels = c("Primary consumer", "Primary producer", "Secondary Consumer")) +
  geom_polygon(aes(x = high.c.area$xcoords, y = high.c.area$ycoords), fill = so.pal[1], alpha = 0.5) +
  geom_polygon(aes(x = low.c.area$xcoords, y = low.c.area$ycoords), fill = so.pal[2], alpha = 0.5) +
  scale_x_continuous(limits = c(-20, -6), breaks = seq(-20, -6, by = 2)) +
  scale_y_continuous(limits = c(5, 15), breaks = seq(5, 15, by = 2)) +
  geom_text(aes(x = si.sum$del_C_mean, y = si.sum$del_N_mean, label = si.sum$sp_code), size = 3, vjust = -0.8, hjust = -0.1) +
  xlab(expression({delta}^13*C~'\u2030')) +
  ylab(expression({delta}^15*N~'\u2030'))
```

#### Species specific
Convex hulls

Trophic level

### Fatty Acids
Similar to SI data there are two perspectives to analysis. 1) The whole community and 2) by species comparisons. Along these lines I will run a nested PERMANOVA for the effects of species and sea otter treatment. Then species that appear to have a strong sea otter effect will be analyzed seperatly

#### FA data prep
Subsets

##### Primary Producers
```{r fa subsets, echo = FALSE}
## All Producers ##
fa_pro <- fa %>%
  filter(Species_common == "Eelgrass" | Species_common == "Eelgrass diatoms" | Species_common == "Fucus" | Species_common == "Particulate organic matter" | Species_common == "Sugar kelp" | Species_common == "Ulva")

# Eelgrass #
fa_eg <- fa %>%
  filter(Species_common == "Eelgrass")

# Eelgrass diatoms / epiphytes #
fa_ep <- fa %>%
  filter(Species_common == "Eelgrass diatoms")

# Fucus #
fa_fu <- fa %>%
  filter(Species_common == "Fucus")

# POM #
fa_pm <- fa %>%
  filter(Species_common == "Particulate organic matter")

# Sugar Kelp #
fa_sk <- fa %>%
  filter(Species_common == "Sugar kelp")

# Ulva #
fa_ul <- fa %>%
  filter(Species_common == "Ulva")
```

Append metadata
```{r}
## All producers ##
fa_pro <- merge(fa_pro, bimrk[, c(1, 2, 3, 4, 7)], by.x = "ID", by.y = "Biomarker_ID")
fa_pro <- cbind(fa_pro[, c(1, 38:41, 2:37)])
colnames(fa_pro)[5] <- "Sea_otter_tr"

# Eelgrass #
fa_eg <- merge(fa_eg, bimrk[, c(1, 2, 3, 4, 7)], by.x = "ID", by.y = "Biomarker_ID")
fa_eg <- cbind(fa_eg[, c(1, 38:41, 2:37)])
colnames(fa_eg)[5] <- "Sea_otter_tr"

# Eelgrass diatoms / epiphytes #
fa_ep <- merge(fa_ep, bimrk[, c(1, 2, 3, 4, 7)], by.x = "ID", by.y = "Biomarker_ID")
fa_ep <- cbind(fa_ep[, c(1, 38:41, 2:37)])
colnames(fa_ep)[5] <- "Sea_otter_tr"

# Fucus #
fa_fu <- merge(fa_fu, bimrk[, c(1, 2, 3, 4, 7)], by.x = "ID", by.y = "Biomarker_ID")
fa_fu <- cbind(fa_fu[, c(1, 38:41, 2:37)])
colnames(fa_fu)[5] <- "Sea_otter_tr"

# POM #
fa_pm <- merge(fa_pm, bimrk[, c(1, 2, 3, 4, 7)], by.x = "ID", by.y = "Biomarker_ID")
fa_pm <- cbind(fa_pm[, c(1, 38:41, 2:37)])
colnames(fa_pm)[5] <- "Sea_otter_tr"

# Sugar Kelp #
fa_sk <- merge(fa_sk, bimrk[, c(1, 2, 3, 4, 7)], by.x = "ID", by.y = "Biomarker_ID")
fa_sk <- cbind(fa_sk[, c(1, 38:41, 2:37)])
colnames(fa_sk)[5] <- "Sea_otter_tr"

# Ulva #
fa_ul <- merge(fa_ul, bimrk[, c(1, 2, 3, 4, 7)], by.x = "ID", by.y = "Biomarker_ID")
fa_ul <- cbind(fa_ul[, c(1, 38:41, 2:37)])
colnames(fa_ul)[5] <- "Sea_otter_tr"
```

##### Primary Consumers
```{r}
## Primary consumers ##
fa_pcon <- fa %>% 
  filter(Species_common == "Butter clam" | Species_common == "Idotea" | Species_common == "Limpet" | Species_common == "Macoma sp." | Species_common == "Pointed Macoma" | Species_common == "Bentnose Macoma")

# Idotea #
fa_ido <- fa %>% 
  filter(Species_common == "Idotea")

# Limpet #
fa_lmp <- fa %>% 
  filter(Species_common == "Limpet")

# Butter Clams ##
fa_but <- fa %>% 
  filter(Species_common == "Butter clam")

# Macoma Clams #
fa_mac <- fa %>% 
  filter(Species_common == "Macoma sp." | Species_common == "Pointed Macoma" | Species_common == "Bentnose Macoma")
```

Append metadata
```{r}
# Primary consumers #
fa_pcon <- merge(fa_pcon, bimrk[, c(1, 2, 3, 4, 7)], by.x = "ID", by.y = "Biomarker_ID")
fa_pcon <- cbind(fa_pcon[, c(1, 38:41, 2:37)])
colnames(fa_pcon)[5] <- "Sea_otter_tr"

# Idotea #
fa_ido <- merge(fa_ido, bimrk[, c(1, 2, 3, 4, 7)], by.x = "ID", by.y = "Biomarker_ID")
fa_ido <- cbind(fa_ido[, c(1, 38:41, 2:37)])
colnames(fa_ido)[5] <- "Sea_otter_tr"

# Limpet #
fa_lmp <- merge(fa_lmp, bimrk[, c(1, 2, 3, 4, 7)], by.x = "ID", by.y = "Biomarker_ID")
fa_lmp <- cbind(fa_lmp[, c(1, 38:41, 2:37)])
colnames(fa_lmp)[5] <- "Sea_otter_tr"

# Butter Clams #
fa_but <- merge(fa_but, bimrk[, c(1, 2, 3, 4, 7)], by.x = "ID", by.y = "Biomarker_ID")
fa_but <- cbind(fa_but[, c(1, 38:41, 2:37)])
colnames(fa_but)[5] <- "Sea_otter_tr"

# Macoma clams #
fa_mac <- merge(fa_mac, bimrk[, c(1, 2, 3, 4, 7)], by.x = "ID", by.y = "Biomarker_ID")
fa_mac <- cbind(fa_mac[, c(1, 38:41, 2:37)])
colnames(fa_mac)[5] <- "Sea_otter_tr"
```

##### Secondary Consumers
Omitting B_271 - Shiner and B_277 Staghorn due to strange values.
```{r}
## All Secondary Consumers ##
fa_scon <- fa %>% 
  filter(Species_common == "Dock shrimp" | Species_common == "Helmet crab" | Species_common == "Graceful crab" | Species_common == "Shiner perch" | Species_common == "Snake prickleback" | Species_common == "Staghorn sculpin") %>% 
  filter(ID != "B_271") %>% 
  filter(ID != "B_277")

# Dock Shrimp #
fa_dsh <- fa %>% 
  filter(Species_common == "Dock shrimp")

# Helmet crabs #
fa_hel <- fa %>% 
  filter(Species_common == "Helmet crab")

# Graceful crabs #
fa_grc <- fa %>% 
  filter(Species_common == "Graceful crab")

# Shiner Perch #
fa_shn <- fa %>% 
  filter(Species_common == "Shiner perch" & ID != "B_271")

# Snake prickleback #
fa_snk <- fa %>% 
  filter(Species_common == "Snake prickleback")

# Staghorn sculpin #
fa_stg <- fa %>% 
  filter(Species_common == "Staghorn sculpin" & ID != "B_277")
```

```{r}
## All secondary consumers ##
fa_scon <- merge(fa_scon, bimrk[, c(1, 2, 3, 4, 7)], by.x = "ID", by.y = "Biomarker_ID")
fa_scon <- cbind(fa_scon[, c(1, 38:41, 2:37)])
colnames(fa_scon)[5] <- "Sea_otter_tr"

# Doch shrimp #
fa_dsh <- merge(fa_dsh, bimrk[, c(1, 2, 3, 4, 7)], by.x = "ID", by.y = "Biomarker_ID")
fa_dsh <- cbind(fa_dsh[, c(1, 38:41, 2:37)])
colnames(fa_dsh)[5] <- "Sea_otter_tr"

# Helmet crabs #
fa_hel <- merge(fa_hel, bimrk[, c(1, 2, 3, 4, 7)], by.x = "ID", by.y = "Biomarker_ID")
fa_hel <- cbind(fa_hel[, c(1, 38:41, 2:37)])
colnames(fa_hel)[5] <- "Sea_otter_tr"

# Graceful crabs #
fa_grc <- merge(fa_grc, bimrk[, c(1, 2, 3, 4, 7)], by.x = "ID", by.y = "Biomarker_ID")
fa_grc <- cbind(fa_grc[, c(1, 38:41, 2:37)])
colnames(fa_grc)[5] <- "Sea_otter_tr"

# Shiner Perch #
fa_shn <- merge(fa_shn, bimrk[, c(1, 2, 3, 4, 7)], by.x = "ID", by.y = "Biomarker_ID")
fa_shn <- cbind(fa_shn[, c(1, 38:41, 2:37)])
colnames(fa_shn)[5] <- "Sea_otter_tr"

# Snake pricklback #
fa_snk <- merge(fa_snk, bimrk[, c(1, 2, 3, 4, 7)], by.x = "ID", by.y = "Biomarker_ID")
fa_snk <- cbind(fa_snk[, c(1, 38:41, 2:37)])
colnames(fa_snk)[5] <- "Sea_otter_tr"

# Staghorn sculpin #
fa_stg <- merge(fa_stg, bimrk[, c(1, 2, 3, 4, 7)], by.x = "ID", by.y = "Biomarker_ID")
fa_stg <- cbind(fa_stg[, c(1, 38:41, 2:37)])
colnames(fa_stg)[5] <- "Sea_otter_tr"
```

###### Transformations
I will use and arcsine sqrt transformation.
```{r fa trans std, echo = FALSE}
## Primary Producers ##
fa_pro_trs <- asin(sqrt(fa_pro[, 11:41]))
fa_eg_trs <- asin(sqrt(fa_eg[, 11:41]))
fa_ep_trs <- asin(sqrt(fa_ep[, 11:41]))
fa_fu_trs <- asin(sqrt(fa_fu[, 11:41]))
fa_pm_trs <- asin(sqrt(fa_pm[, 11:41]))
fa_sk_trs <- asin(sqrt(fa_sk[, 11:41]))
fa_ul_trs <- asin(sqrt(fa_ul[, 11:41]))

## Primary Consumers ##
fa_pcon_trs <- asin(sqrt(fa_pcon[, 11:41]))
fa_ido_trs <- asin(sqrt(fa_ido[, 11:41]))
fa_lmp_trs <- asin(sqrt(fa_lmp[, 11:41]))
fa_but_trs <- asin(sqrt(fa_but[, 11:41]))
fa_mac_trs <- asin(sqrt(fa_mac[, 11:41]))

## Secondary consumers ##
fa_scon_trs <- asin(sqrt(fa_scon[, 11:41]))
fa_dsh_trs <- asin(sqrt(fa_dsh[, 11:41]))
fa_hel_trs <- asin(sqrt(fa_hel[, 11:41]))
fa_grc_trs <- asin(sqrt(fa_grc[, 11:41]))
fa_shn_trs <- asin(sqrt(fa_shn[, 11:41]))
fa_snk_trs <- asin(sqrt(fa_snk[, 11:41]))
fa_stg_trs <- asin(sqrt(fa_stg[, 11:41]))
```

#### Ordination
Calculate distances
```{r dist, echo = FALSE}
## Primary Producers ##
fa_pro_dist <- vegdist(fa_pro_trs, method = "euclidean")
fa_eg_dist <- vegdist(fa_eg_trs, method = "euclidean")
fa_ep_dist <- vegdist(fa_ep_trs, method = "euclidean")
fa_fu_dist <- vegdist(fa_fu_trs, method = "euclidean")
fa_pm_dist <- vegdist(fa_pm_trs, method = "euclidean")
fa_sk_dist <- vegdist(fa_sk_trs, method = "euclidean")
fa_ul_dist <- vegdist(fa_ul_trs, method = "euclidean")

## Primary Consumers ##
fa_pcon_dist <- vegdist(fa_pcon_trs, method = "euclidean")
fa_ido_dist <- vegdist(fa_ido_trs, method = "euclidean")
fa_lmp_dist <- vegdist(fa_lmp_trs, method = "euclidean")
fa_but_dist <- vegdist(fa_but_trs, method = "euclidean")
fa_mac_dist <- vegdist(fa_mac_trs, method = "euclidean")

## Secondary Consumers ##
fa_scon_dist <- vegdist(fa_scon_trs, method = "euclidean")
fa_dsh_dist <- vegdist(fa_dsh_trs, method = "euclidean")
fa_hel_dist <- vegdist(fa_hel_trs, method = "euclidean")
fa_grc_dist <- vegdist(fa_grc_trs, method = "euclidean")
fa_shn_dist <- vegdist(fa_shn_trs, method = "euclidean")
fa_snk_dist <- vegdist(fa_snk_trs, method = "euclidean")
fa_stg_dist <- vegdist(fa_stg_trs, method = "euclidean")
```

#### PERMANOVA
Test for the effect of sea otter nested by species. Then within species sea otter tests.

##### Primary Producers
```{r permanova, echo = FLASE}
## Producers ##
perm.pro <- adonis2(fa_pro_dist ~ Sea_otter_tr + sp_code %in% Sea_otter_tr, data = fa_pro, perm = 9999) 
perm.pro

# Eelgrass #
perm.eg <- adonis2(fa_eg_dist ~ Sea_otter_tr, data = fa_eg, perm = 9999) 
perm.eg

# Epiphytes #
perm.ep <- adonis2(fa_ep_dist ~ Sea_otter_tr, data = fa_ep, perm = 9999) 
perm.ep

# Fucus #
perm.fu <- adonis2(fa_fu_dist ~ Sea_otter_tr, data = fa_fu, perm = 9999)
perm.fu

# POM #
perm.pm <- adonis2(fa_pm_dist ~ Sea_otter_tr, data = fa_pm, perm = 9999)
perm.pm

# Sugar kelp #
perm.sk <- adonis2(fa_sk_dist ~ Sea_otter_tr, data = fa_sk, perm = 9999)
perm.sk

# Ulva #
perm.ul <- adonis2(fa_ul_dist ~ Sea_otter_tr, data = fa_ul, perm = 9999)
perm.ul
```

##### Primary Consumers
```{r}
## All primary consumers ##
perm.pcon <- adonis2(fa_pcon_dist ~ Sea_otter_tr + sp_code %in% Sea_otter_tr, data = fa_pcon, perm = 9999)
perm.pcon

# Idotea #
perm.ido <- adonis2(fa_ido_dist ~ Sea_otter_tr, data = fa_ido, perm = 9999)
perm.ido

# Limpet #
perm.lmp <- adonis2(fa_lmp_dist ~ Sea_otter_tr, data = fa_lmp, perm = 9999)
perm.lmp

# Butter clam #
perm.but <- adonis2(fa_but_dist ~ Sea_otter_tr, data = fa_but, perm = 9999)
perm.but

# Macoma clam #
perm.mac <- adonis2(fa_mac_dist ~ Sea_otter_tr, data = fa_mac, perm = 9999)
perm.mac
```

##### Secondary Consumers
```{r}
## All secondary consumers ##
perm.scon <- adonis2(fa_scon_dist ~ Sea_otter_tr + sp_code %in% Sea_otter_tr, data = fa_scon, perm = 9999) 
perm.scon

# Dock shrimp #
perm.dsh <- adonis2(fa_dsh_dist ~ Sea_otter_tr, data = fa_dsh, perm = 9999)
perm.dsh

# Helmet crabs #
perm.hel <- adonis2(fa_hel_dist ~ Sea_otter_tr, data = fa_hel, perm = 9999)
perm.hel

# Graceful crabs #
perm.grc <- adonis2(fa_grc_dist ~ Sea_otter_tr, data = fa_grc, perm = 9999)
perm.grc

# Shiner perch #
perm.shn <- adonis2(fa_shn_dist ~ Sea_otter_tr, data = fa_shn, perm = 9999)
perm.shn

# Snake prickleback
perm.snk <- adonis2(fa_snk_dist ~ Sea_otter_tr, data = fa_snk, perm = 9999)
perm.snk

# Staghorn sculpin #
perm.stg <- adonis2(fa_stg_dist ~ Sea_otter_tr, data = fa_stg, perm = 9999)
perm.stg
```

#### SIMPER
Calcualte on untransformed data. Also remove the undetermined FAs because the are sums of multiple FAs.

Identify any undetermined FAs
```{r}
colnames(fa[, 7:37])
```


Dungeness Crabs
-- remove undetermined FA
```{r}
dun_simp <- fa_dun_1.0[, c(10:15, 17:19, 21:23, 25:26, 28:29, 31:32, 34:35, 37:38, 40:41, 43, 45:46, 51, 53:57, 59, 61:63, 65:74)]
```

```{r}
simp.dun <- simper(dun_simp, fa_dun_1.0$Sea_otter_tr, permutations = 9999)
simp.dun.dat <- summary(simp.dun, ordered = TRUE, digits = 4)
simp.dun.dat <- data.frame(simp.dun.dat$Low_High)
simp.dun.dat$FA <- row.names(simp.dun.dat)
simp.dun.dat$average_scaled <- simp.dun.dat$average / sum(simp.dun.dat$average)

datatable(filter(simp.dun.dat, p < 0.05))
```

Helmet crabs
-- remove undetermined FA
```{r}
hel_simp <- fa_hel_1.0[, c(10:15, 17:19, 21:23, 25:26, 28:29, 31:32, 34:35, 37:38, 40:41, 43, 45:46, 51, 53:57, 59, 61:63, 65:74)]
```
```{r}
simp.hel <- simper(hel_simp, fa_hel_1.0$Sea_otter_tr, permutations = 9999)
simp.hel.dat <- summary(simp.hel, ordered = TRUE, digits = 4)
simp.hel.dat <- data.frame(simp.hel.dat$Low_High)
simp.hel.dat$FA <- row.names(simp.hel.dat)
simp.hel.dat$average_scaled <- simp.hel.dat$average / sum(simp.hel.dat$average)

datatable(filter(simp.hel.dat, p < 0.05))
```

#### NMDS Plots
##### Ordination
Calculate NMDS 
```{r MDS, echo = FALSE}
## Primary Producers ##
fa_pro_mds <- metaMDS(fa_pro_dist)
fa_ul_mds <- metaMDS(fa_ul_dist)
fa_eg_mds <- metaMDS(fa_eg_dist)
fa_sk_mds <- metaMDS(fa_sk_dist)

## Primary Consumers
fa_pcon_mds <- metaMDS(fa_pcon_dist)
fa_lmp_mds <- metaMDS(fa_lmp_dist)

## Secondary consumers ##
fa_scon_mds <- metaMDS(fa_scon_dist)
fa_stg_mds <- metaMDS(fa_stg_dist)
fa_shn_mds <- metaMDS(fa_shn_dist)
fa_snk_mds <- metaMDS(fa_snk_dist)
```

##### Data Prep
```{r}
## Producers ##
fa_pro_mds_dat <- as.data.frame(scores(fa_pro_mds))
fa_pro_mds_dat$ID <- fa_pro$ID 
fa_pro_mds_dat <- merge(fa_pro_mds_dat, bimrk[, c(1:4, 7:10)], by.x = "ID", by.y = "Biomarker_ID")
fa_pro_mds_dat$Species_common <- factor(fa_pro_mds_dat$Species_common, levels = c("Eelgrass", "Eelgrass diatoms", "Fucus", "Particulate organic matter", "Sugar kelp", "Ulva"))

fa_ul_mds_dat <- as.data.frame(scores(fa_ul_mds))
fa_ul_mds_dat$ID <- fa_ul$ID 
fa_ul_mds_dat <- merge(fa_ul_mds_dat, bimrk[, c(1:4, 7:10)], by.x = "ID", by.y = "Biomarker_ID")

fa_eg_mds_dat <- as.data.frame(scores(fa_eg_mds))
fa_eg_mds_dat$ID <- fa_eg$ID 
fa_eg_mds_dat <- merge(fa_eg_mds_dat, bimrk[, c(1:4, 7:10)], by.x = "ID", by.y = "Biomarker_ID")

fa_sk_mds_dat <- as.data.frame(scores(fa_sk_mds))
fa_sk_mds_dat$ID <- fa_sk$ID 
fa_sk_mds_dat <- merge(fa_sk_mds_dat, bimrk[, c(1:4, 7:10)], by.x = "ID", by.y = "Biomarker_ID")

# Primary consumers #
fa_pcon_mds_dat <- as.data.frame(scores(fa_pcon_mds))
fa_pcon_mds_dat$ID <- fa_pcon$ID 
fa_pcon_mds_dat$Species_common <- fa_pcon$Species_common
fa_pcon_mds_dat <- merge(fa_pcon_mds_dat, bimrk[, c(1:4, 7, 9, 10)], by.x = "ID", by.y = "Biomarker_ID")
fa_pcon_mds_dat$Species_common <- factor(fa_pcon_mds_dat$Species_common, levels = c("Butter clam" , "Idotea" ,"Limpet" , "Macoma sp." , "Pointed Macoma" , "Bentnose Macoma"))

fa_lmp_mds_dat <- as.data.frame(scores(fa_lmp_mds))
fa_lmp_mds_dat$ID <- fa_lmp$ID 
fa_lmp_mds_dat <- merge(fa_lmp_mds_dat, bimrk[, c(1:4, 7:10)], by.x = "ID", by.y = "Biomarker_ID")

## Secondary Consumers ##
fa_scon_mds_dat <- as.data.frame(scores(fa_scon_mds))
fa_scon_mds_dat$ID <- fa_scon$ID 
fa_scon_mds_dat <- merge(fa_scon_mds_dat, bimrk[, c(1:4, 7:10)], by.x = "ID", by.y = "Biomarker_ID")
fa_scon_mds_dat$Species_common <- factor(fa_scon_mds_dat$Species_common, levels = c("Shiner perch", "Snake prickleback", "Staghorn sculpin", "Dungeness crab", "Helmet crab", "Red rock crab", "Dock shrimp", "Macoma sp.", "Bentnose Macoma", "Pointed Macoma", "Butter clam", "Idotea", "Limpet"))

fa_shn_mds_dat <- as.data.frame(scores(fa_shn_mds))
fa_shn_mds_dat$ID <- fa_shn$ID 
fa_shn_mds_dat <- merge(fa_shn_mds_dat, bimrk[, c(1:4, 7:10)], by.x = "ID", by.y = "Biomarker_ID")

fa_stg_mds_dat <- as.data.frame(scores(fa_stg_mds))
fa_stg_mds_dat$ID <- fa_stg$ID 
fa_stg_mds_dat <- merge(fa_stg_mds_dat, bimrk[, c(1:4, 7:10)], by.x = "ID", by.y = "Biomarker_ID")

fa_snk_mds_dat <- as.data.frame(scores(fa_snk_mds))
fa_snk_mds_dat$ID <- fa_snk$ID 
fa_snk_mds_dat <- merge(fa_snk_mds_dat, bimrk[, c(1:4, 7:10)], by.x = "ID", by.y = "Biomarker_ID")

## Crabs ##
fa_crb_1.0_mds_dat <- as.data.frame(scores(fa_crb_1.0_mds))
fa_crb_1.0_mds_dat$ID <- fa_crb_1.0$ID 
fa_crb_1.0_mds_dat$Species_common <- fa_crb_1.0$Species_common
fa_crb_1.0_mds_dat <- merge(fa_crb_1.0_mds_dat, bimrk[, c(1:4, 7, 9, 10)], by.x = "ID", by.y = "Biomarker_ID")
fa_crb_1.0_mds_dat$Species_common <- factor(fa_crb_1.0_mds_dat$Species_common, levels = c("Dungeness crab", "Helmet crab", "Red rock crab"))

# Graceful crabs #
fa_grc_mds_dat <- as.data.frame(scores(fa_grc_mds))
fa_grc_mds_dat$ID <- fa_grc$ID 
fa_grc_mds_dat$Species_common <- fa_grc$Species_common
fa_grc_mds_dat <- merge(fa_grc_mds_dat, bimrk[, c(1:4, 7, 9, 10)], by.x = "ID", by.y = "Biomarker_ID")
fa_grc_mds_dat$Species_common <- factor(fa_grc_mds_dat$Species_common, levels = c("Graceful crab"))

# Crabs - Helmet #
fa_hel_1.0_mds_dat <- as.data.frame(scores(fa_hel_1.0_mds))
fa_hel_1.0_mds_dat$ID <- fa_hel_1.0$ID 
fa_hel_1.0_mds_dat$Species_common <- fa_hel_1.0$Species_common
fa_hel_1.0_mds_dat <- merge(fa_hel_1.0_mds_dat, bimrk[, c(1:4, 7, 9, 10)], by.x = "ID", by.y = "Biomarker_ID")
fa_hel_1.0_mds_dat$Species_common <- factor(fa_hel_1.0_mds_dat$Species_common, levels = c("Helmet crab"))



# Idotea #
fa_ido_1.0_mds_dat <- as.data.frame(scores(fa_ido_1.0_mds))
fa_ido_1.0_mds_dat$ID <- fa_ido_1.0$ID 
fa_ido_1.0_mds_dat$Species_common <- fa_ido_1.0$Species_common
fa_ido_1.0_mds_dat <- merge(fa_ido_1.0_mds_dat, bimrk[, c(1:4, 7, 9, 10)], by.x = "ID", by.y = "Biomarker_ID")
fa_ido_1.0_mds_dat$Species_common <- factor(fa_ido_1.0_mds_dat$Species_common, levels = c("Idotea"))

```

##### FA Vectors
```{r fa vector, echo = FALSE, eval = FALSE}
## Primary producer Vectors ##
vec.pro <- envfit(fa_pro_1.0_mds$points, fa_pro_1.0[, 10:74], perm = 9999)
vec.pro.arrows <- scores(vec.pro, display = "vectors")
vec.pro.dat <- data.frame(vec.pro.arrows)
vec.pro.dat$pvals <- vec.pro$vectors$pvals
vec.pro.dat$FA <- row.names(vec.pro.dat)
vec.pro.dat$r2 <- vec.pro$vectors$r

scalefactor <- min(max(fa_pro_1.0_mds_dat$NMDS1) - min(fa_pro_1.0_mds_dat$NMDS1), max(fa_pro_1.0_mds_dat$NMDS2) - min(fa_pro_1.0_mds_dat$NMDS2))
vec.pro.dat$MDS1_sc <- vec.pro.dat$MDS1 * (scalefactor * vec.pro.dat$r2)
vec.pro.dat$MDS2_sc <- vec.pro.dat$MDS2 * (scalefactor * vec.pro.dat$r2)

vec.pro.dat.sig <- vec.pro.dat %>% 
  filter(pvals < 0.01)

arrow_angle <- 90 - ((atan2(vec.pro.dat.sig$MDS1_sc, vec.pro.dat.sig$MDS2_sc)* 180)/pi)
arrow_angle <- ifelse(arrow_angle > 90 & arrow_angle < 270, arrow_angle + 180, arrow_angle)
arrow_hjust <- ifelse(arrow_angle > 90, 1, 0)


## Crabs vectors ##
# All crabs #
vec.crb <- envfit(fa_crb_1.0_mds$points, fa_crb_1.0[, 10:74], perm = 9999)
vec.crb.arrows <- scores(vec.crb, display = "vectors")
vec.crb.dat <- data.frame(vec.crb.arrows)
vec.crb.dat$pvals <- vec.crb$vectors$pvals
vec.crb.dat$FA <- row.names(vec.crb.dat)
vec.crb.dat$r2 <- vec.crb$vectors$r

scalefactor <- min(max(fa_crb_1.0_mds_dat$NMDS1) - min(fa_crb_1.0_mds_dat$NMDS1), max(fa_crb_1.0_mds_dat$NMDS2) - min(fa_crb_1.0_mds_dat$NMDS2))
vec.crb.dat$MDS1_sc <- vec.crb.dat$MDS1 * scalefactor
vec.crb.dat$MDS2_sc <- vec.crb.dat$MDS2 * scalefactor 

vec.crb.dat.sig <- vec.crb.dat %>% 
  filter(pvals < 0.005)

arrow_angle <- 90 - ((atan2(vec.crb.dat.sig$MDS1_sc, vec.crb.dat.sig$MDS2_sc)* 180)/pi)
arrow_angle <- ifelse(arrow_angle > 90 & arrow_angle < 270, arrow_angle + 180, arrow_angle)
arrow_hjust <- ifelse(arrow_angle > 90, 1, 0)

# Dungeness Crabs #
vec.dun <- envfit(fa_dun_1.0_mds$points, fa_dun_1.0[, 10:74], perm = 9999)
vec.dun.arrows <- scores(vec.dun, display = "vectors")
vec.dun.dat <- data.frame(vec.dun.arrows)
vec.dun.dat$pvals <- vec.dun$vectors$pvals
vec.dun.dat$FA <- row.names(vec.dun.dat)
vec.dun.dat$r2 <- vec.dun$vectors$r

scalefactor <- min(max(fa_dun_1.0_mds_dat$NMDS1) - min(fa_dun_1.0_mds_dat$NMDS1), max(fa_dun_1.0_mds_dat$NMDS2) - min(fa_dun_1.0_mds_dat$NMDS2))
vec.dun.dat$MDS1_sc <- vec.dun.dat$MDS1 * scalefactor
vec.dun.dat$MDS2_sc <- vec.dun.dat$MDS2 * scalefactor

vec.dun.dat.sig <- vec.dun.dat %>% 
  filter(pvals < 0.05)

arrow_angle <- 90 - ((atan2(vec.dun.dat.sig$MDS1_sc, vec.dun.dat.sig$MDS2_sc)* 180)/pi)
arrow_angle <- ifelse(arrow_angle > 90 & arrow_angle < 270, arrow_angle + 180, arrow_angle)
arrow_hjust <- ifelse(arrow_angle > 90, 1, 0)

# Helmet Crabs #
vec.hel <- envfit(fa_hel_1.0_mds$points, fa_hel_1.0[, 10:74], perm = 9999)
vec.hel.arrows <- scores(vec.hel, display = "vectors")
vec.hel.dat <- data.frame(vec.hel.arrows)
vec.hel.dat$pvals <- vec.hel$vectors$pvals
vec.hel.dat$FA <- row.names(vec.hel.dat)
vec.hel.dat$r2 <- vec.hel$vectors$r

scalefactor <- min(max(fa_hel_1.0_mds_dat$NMDS1) - min(fa_hel_1.0_mds_dat$NMDS1), max(fa_hel_1.0_mds_dat$NMDS2) - min(fa_hel_1.0_mds_dat$NMDS2))
vec.hel.dat$MDS1_sc <- vec.hel.dat$MDS1 * scalefactor
vec.hel.dat$MDS2_sc <- vec.hel.dat$MDS2 * scalefactor

vec.hel.dat.sig <- vec.hel.dat %>% 
  filter(pvals < 0.05)

arrow_angle <- 90 - ((atan2(vec.hel.dat.sig$MDS1_sc, vec.hel.dat.sig$MDS2_sc)* 180)/pi)
arrow_angle <- ifelse(arrow_angle > 90 & arrow_angle < 270, arrow_angle + 180, arrow_angle)
arrow_hjust <- ifelse(arrow_angle > 90, 1, 0)
```

##### Plots
```{r}
## Producers ##
ggplot(fa_pro_mds_dat) +
  geom_point(aes(x = NMDS1, y = NMDS2, color = Sea_otter_region, shape = Species_common), size = 3) +
  scale_color_manual(values = c("red3", "deepskyblue3")) +
  geom_text(aes(x = NMDS1, y = NMDS2, label = ID))

ggplot(fa_ul_mds_dat) +
  geom_point(aes(x = NMDS1, y = NMDS2, color = Sea_otter_region, shape = Species_common), size = 3) +
  scale_color_manual(values = c("red3", "deepskyblue3")) +
  geom_text(aes(x = NMDS1, y = NMDS2, label = ID))

ggplot(fa_eg_mds_dat) +
  geom_point(aes(x = NMDS1, y = NMDS2, color = Sea_otter_region, shape = Species_common), size = 3) +
  scale_color_manual(values = c("red3", "deepskyblue3")) +
  geom_text(aes(x = NMDS1, y = NMDS2, label = ID))

ggplot(fa_sk_mds_dat) +
  geom_point(aes(x = NMDS1, y = NMDS2, color = Sea_otter_region, shape = Species_common), size = 3) +
  scale_color_manual(values = c("red3", "deepskyblue3")) +
  geom_text(aes(x = NMDS1, y = NMDS2, label = ID))

ggplot(fa_pro_mds_dat) +
  geom_point(aes(x = NMDS1, y = NMDS2, color = Sea_otter_region, shape = Species_common), size = 3) +
  scale_color_manual(values = c("red", "deepskyblue3")) +
  geom_segment(data = vec.pro.dat.sig, aes(x = 0, xend = MDS1_sc, y = 0, yend = MDS2_sc)) +
  geom_text(data = vec.pro.dat.sig, aes(x = MDS1_sc, y = MDS2_sc, label = FA), size = 4, angle = arrow_angle, hjust = arrow_hjust)
  
## Primary Consumers ##
ggplot(fa_pcon_mds_dat) +
  geom_point(aes(x = NMDS1, y = NMDS2, color = Sea_otter_region, shape = Species_common), size = 3) +
  scale_color_manual(values = c("red", "deepskyblue3")) +
  geom_text(aes(x = NMDS1, y = NMDS2, label = ID))

ggplot(fa_lmp_mds_dat) +
  geom_point(aes(x = NMDS1, y = NMDS2, color = Sea_otter_region, shape = Species_common), size = 3) +
  scale_color_manual(values = c("red", "deepskyblue3")) +
  geom_text(aes(x = NMDS1, y = NMDS2, label = ID))

## Secondary consumers ##
ggplot(fa_scon_mds_dat) +
  geom_point(aes(x = NMDS1, y = NMDS2, color = Sea_otter_region, shape = Species_common), size = 3) +
  scale_color_manual(values = c("red", "deepskyblue3")) +
  geom_text(aes(x = NMDS1, y = NMDS2, label = ID))

ggplot(fa_shn_mds_dat) +
  geom_point(aes(x = NMDS1, y = NMDS2, color = Sea_otter_region, shape = Species_common), size = 3) +
  scale_color_manual(values = c("red", "deepskyblue3")) +
  geom_text(aes(x = NMDS1, y = NMDS2, label = ID))

ggplot(fa_stg_mds_dat) +
  geom_point(aes(x = NMDS1, y = NMDS2, color = Sea_otter_region, shape = Species_common), size = 3) +
  scale_color_manual(values = c("red", "deepskyblue3")) +
  geom_text(aes(x = NMDS1, y = NMDS2, label = ID))

ggplot(fa_snk_mds_dat) +
  geom_point(aes(x = NMDS1, y = NMDS2, color = Sea_otter_region, shape = Species_common), size = 3) +
  scale_color_manual(values = c("red", "deepskyblue3")) +
  geom_text(aes(x = NMDS1, y = NMDS2, label = ID))
```