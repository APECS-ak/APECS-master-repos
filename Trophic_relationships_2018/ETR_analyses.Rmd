---
title: "ETR_analyses"
author: "Wendel Raymond"
date: "October 22, 2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

# Eelgrass trophic relationships - analyses
*Question:* Do sea otters effects the tropic structure of eelgrass communities in Southeast Alaska? From my 2017 data we found that sea otters have a large negative effect on crabs and are positively related to eelgrass biomass, suggesting that sea otter are influencing the eelgrass community. Furthermore we did not find evidence for all the hypothesized links between major community members necessary to complete the full trophic cascade. Notable we found no evidence of a relationship between crabs and grazer and fish and grazers. To this end we further investigated the dynamics of this community by measuring the biomass, stable isotopes, and fatty acids of key eelgrass community constituents.

*Some opening notes* There is a lot of data. There could be multiple papers here. Some more exploratory analysis is definitely warranted but the original goal was to look at the whole community. Crafting analyses so that we answer questions from that perspective should be the priority. However, if interesting stories arise maybe the approach will change. Just sayin. 

```{r libraries, echo = FALSE, warning = FALSE, message = FALSE}
library(dplyr)
library(tidyr)
library(ggplot2)
library(DT)
library(cowplot)
library(RColorBrewer)
library(vegan)
library(stringr)
library(siar)
library(ggrepel)
library(broom)
library(cplm)

theme_set(theme_classic())
```

```{r st.er, echo = FALSE}
st.er <- function(x, na.rm = TRUE) {
  stopifnot(is.numeric(x))
  return(sd(x, na.rm = na.rm)/sqrt(length(x)))
}
```

```{r}
shape.pal <- c(15, 16, 17)
so.pal <- (c("red3", "deepskyblue3"))
```

## Data
Data falls under three broad categories. Biomass, stable isotopes, and fatty acids. Biomass data files are broken up by sampling type but can easily be combined. In addition, biomarker (SI and FA) metadata is useful to match those data with site, date, treatment, etc. data.
Biomass and oceanography
```{r dat bio, echo=FALSE}
eg <- read.csv("../ALL_DATA/Eelgrass_biometrics_all_2018_derived.csv", header = TRUE, stringsAsFactors = FALSE)

crb <- read.csv("../ALL_DATA/crab_all_2018_derived.csv", header = TRUE, stringsAsFactors = FALSE)

clm <- read.csv("../ALL_DATA/eelgrass_clam_all_2018_derived.csv", header = TRUE, stringsAsFactors = FALSE)

fsh <- read.csv("../ALL_DATA/Fish_mass_site_2018_derived.csv", header = TRUE, stringsAsFactors = FALSE)

nut <- read.csv("../ALL_DATA/Water_nutrients_eelgrass_2018_RAW.csv", header = TRUE, stringsAsFactors = FALSE)

pom <- read.csv("../ALL_DATA/POM_filter_mass_RAW.csv", header = TRUE, stringsAsFactors = FALSE)

oce <- read.csv("../ALL_DATA/Site_oceanography_2018_RAW.csv", header = TRUE, stringsAsFactors = FALSE)

site <- read.csv("../ALL_DATA/Eelgrass_trophic_relationships_site_metadata_2018.csv", header = TRUE, stringsAsFactors = FALSE)
```

Stable Isotope
```{r dat iso, echo = FALSE}
si <- read.csv("../ALL_DATA/Isotopes_eelgrass_comm_2018_RAW.csv", header = TRUE, stringsAsFactors = FALSE)
```

Fatty Acid
```{r dat fa, echo = FALSE}
fa <- read.csv("../ALL_DATA/FA_proportions_1.0filter_2018_derived.csv", header = TRUE, stringsAsFactors = FALSE)

famrk <- read.csv("../ALL_DATA/Marker_FA_RAW.csv", header = TRUE, stringsAsFactors = FALSE)
```

Biomarker metadata
```{r dat biomarker, echo = FALSE}
bimrk <- read.csv("../ALL_DATA/Biomarker_collections_2018_RAW.csv", header = TRUE, stringsAsFactors = FALSE)
```

### Data managemnet
Clean up files. Make sure appropriate columns are there.
```{r data clean up, echo=FALSE}
## Eelgrass Transect #3
eg <- merge(eg, site[, c(1, 5)], by = "site")

## Crabs ##
crb <- merge(crb, site[, c(1,5)])

# site and string #
crb.site.string <- crb %>%
  group_by(site, string) %>% 
  summarise(mass_g = sum(mass_g))

# Insert zero data ## only missing one string
crb.site.string[24,] <- c(as.character("2018_H_01"), 4.0, 0.0)
crb.site.string <- merge(crb.site.string, site[, c(1,5)], by = "site")
crb.site.string$mass_g <- as.numeric(crb.site.string$mass_g)

# Site string and sp #
d <- expand.grid(species_common = c("Dungeness crab", "Graceful crab", "Helmet crab", "Red rock crab"), site = unique(crb$site), string = unique(crb$string))

crb.site.string.sp <- crb %>% 
  group_by(site, string, species_common) %>% 
  summarise(mass_g = sum(mass_g))

crb.site.string.sp <- merge(d, crb.site.string.sp, by = c("site", "string", "species_common"), all.x  = TRUE)

crb.site.string.sp[is.na(crb.site.string.sp)] <- 0

crb.site.string.sp <- merge(crb.site.string.sp, site[, c(1,5)], by = "site")

## Clams! ##
clm <- merge(clm, site[, c(1, 5)], by = "site")
clm$quadrat <- as.factor(clm$quadrat)

# clean up species #
clm$species_common <- ifelse(clm$species_common == "Macoma", "Macoma sp.", clm$species_common)

clm$species_common <- ifelse(clm$species_common == "Pointed macoma", "Macoma sp.", clm$species_common)

clm$species_common <- ifelse(clm$species_common == "Bentnose macoma", "Macoma sp.", clm$species_common)

# site and quadrat summary #
clm.site.quad <- clm %>%
  group_by(site, quadrat) %>% 
  summarize(mass_g = sum(mass_g))
clm.site.quad <- merge(clm.site.quad, site[, c(1, 5)], by = "site")

# site quadrat and species summary #
d <- expand.grid(species_common = c("Butter clam", "Cockle", "Macoma sp.", "Soft-shell clam", "Steamer clam"), site = unique(clm$site), quadrat = unique(clm$quadrat))

clm.site.quad.sp <- clm %>%
  group_by(site, quadrat, species_common) %>% 
  summarize(mass_g = sum(mass_g))

clm.site.quad.sp <- merge(d, clm.site.quad.sp, by = c("site", "quadrat", "species_common"), all.x  = TRUE)

clm.site.quad.sp[is.na(clm.site.quad.sp)] <- 0

clm.site.quad.sp <- merge(clm.site.quad.sp, site[, c(1,5)], by = "site")

# total clam mass by species #
clm.total <- clm.site.quad.sp %>% 
  group_by(site, species_common) %>% 
  summarize(total = sum(mass_g))

## Fish ##
fsh <- merge(fsh, site[, c(1, 5)], by = "site")

## POM ##
pom$dry_POM <- pom$dry_mass_g - (pom$pan_mass_g + pom$pre_dry_mass_g)
pom$burn_POM <- pom$burn_dry_mass_g - (pom$pan_mass_g + pom$pre_dry_mass_g)
pom$om_POM <- pom$dry_mass_g - pom$burn_dry_mass_g
pom$pc_om_POM <- (pom$om_POM / pom$dry_mass_g) * 100 
pom <- merge(pom, site[, c(1, 5)], by = "site")
```

## Analyses
A critical piece for all analyses is testing the effect of site and sea otter treatment. Within each sea otter treatment three different sites were sampled.

### Environmental Data
Nutrients, oceanography, sediment

#### Nurtients
```{r nuts, echo = FALSE}
## Nutrients ##
# Add some metadata #
nut <- merge(nut, site[, c(1, 5)], by.x = "Site", by.y = "site")
nut$Depth_m <- as.character(nut$Depth_m)

# Convert neg values to 0 #
nut$Nitrate_um.L <- ifelse(nut$Nitrate_um.L < 0 , 0, nut$Nitrate_um.L)

# Summarise #
nut.sum <- nut %>% 
  filter(Replicate != "C") %>% 
  group_by(Site, Depth_m) %>% 
  summarise(Nitrate_m = mean(Nitrate_um.L),
            Nitrate_sd = sd(Nitrate_um.L),
            Nrate_Nrite_m = mean(NitrateNitrite_um.L),
            Nrate_Nrite_sd = sd(NitrateNitrite_um.L),
            Phos_m = mean(Phos_um.L),
            Phos_sd = sd(Phos_um.L))

nut.sum.tr <- nut %>%
  filter(Replicate != "C") %>% 
  group_by(sea_otter_tr, Depth_m) %>% 
  summarise(Nitrate_m = mean(Nitrate_um.L),
            Nitrate_sd = sd(Nitrate_um.L),
            Nrate_Nrite_m = mean(NitrateNitrite_um.L),
            Nrate_Nrite_sd = sd(NitrateNitrite_um.L),
            Phos_m = mean(Phos_um.L),
            Phos_sd = sd(Phos_um.L))
```

#### Oceanography
```{r}
oce <- merge(oce, site[, c(1, 5)], by.x = "site", by.y = "site")
oce$Depth_m <- as.character(oce$Depth_m)

oce$light_percent <- oce$X5m_PAR / oce$X1m_PAR * 100

oce.sum.tr <- oce %>% 
  group_by(sea_otter_tr, Depth_m) %>% 
  summarise(DO_m = mean(DO_mgl),
            DO_sd = sd(DO_mgl),
            sal_m = mean(sal_ppt),
            sal_sd = sd(sal_ppt),
            temp_m = mean(temp_C),
            temp_sd = sd(temp_C))

light.sum.tr <- oce %>% 
  filter(Depth_m == "1") %>% 
  group_by(sea_otter_tr) %>% 
  summarise(light_pr_m = mean(light_percent),
            light_pr_sd = sd(light_percent))
```

#### Sediment
```{r}
sed <- eg %>% 
  group_by(sea_otter_tr) %>% 
  summarise(sed_m = mean(primary_sediment_score),
            sed_sd = sd(primary_sediment_score))
```

#### Plots
```{r}
# Nitrate #
nox.tr <- ggplot(nut.sum.tr, aes(x = sea_otter_tr, y = Nitrate_m, fill = sea_otter_tr, alpha = Depth_m)) +
  geom_bar(position = position_dodge(), stat = "identity") +
  scale_fill_manual("Depth", labels = c("1m", "5m"), values = so.pal) +
  scale_alpha_discrete(range = c(0.5, 1)) +
  geom_errorbar(aes(ymin = Nitrate_m - Nitrate_sd, ymax = Nitrate_m + Nitrate_sd), position = position_dodge(.9), width = 0) +
  scale_y_continuous(limits = c(-0.01, 0.06)) +
  scale_x_discrete(labels = c("High", "Low")) +
  ylab("Nitrate u/L") +
  xlab("Sea otter region") +
  theme(legend.position = "none")

# Phosphate #
pho.tr <- ggplot(nut.sum.tr, aes(x = sea_otter_tr, y = Phos_m, fill = sea_otter_tr, alpha = Depth_m)) +
  geom_bar(position = position_dodge(), stat = "identity") +
  scale_fill_manual("Depth", labels = c("1m", "5m"), values = so.pal) +
  scale_alpha_discrete(range = c(0.5, 1)) +
  geom_errorbar(aes(ymin = Phos_m - Phos_sd, ymax = Phos_m + Phos_sd), position = position_dodge(.9), width = 0) +
  scale_y_continuous(limits = c(-0.0, 0.4)) +
  scale_x_discrete(labels = c("High", "Low")) +
  ylab("Phosphate u/L") +
  xlab("Sea otter region") +
  theme(legend.position = "none")

# Temp #
tmp.tr <- ggplot(oce.sum.tr, aes(x = sea_otter_tr, y = temp_m, fill = sea_otter_tr, alpha = Depth_m)) +
  geom_bar(position = position_dodge(), stat = "identity") +
  scale_fill_manual("Depth", labels = c("1m", "5m"), values = so.pal) +
  scale_alpha_discrete(range = c(0.5, 1)) +
  geom_errorbar(aes(ymin = temp_m - temp_sd, ymax = temp_m + temp_sd), position = position_dodge(.9), width = 0) +
  scale_y_continuous(limits = c(0.0, 16)) +
  scale_x_discrete(labels = c("High", "Low")) +
  ylab("Temperature") +
  xlab("Sea otter region") +
  theme(legend.position = "none")

# Sal #
sal.tr <- ggplot(oce.sum.tr, aes(x = sea_otter_tr, y = sal_m, fill = sea_otter_tr, alpha = Depth_m)) +
  geom_bar(position = position_dodge(), stat = "identity") +
  scale_fill_manual("Depth", labels = c("1m", "5m"), values = so.pal) +
  scale_alpha_discrete(range = c(0.5, 1)) +
  geom_errorbar(aes(ymin = sal_m - sal_sd, ymax = sal_m + sal_sd), position = position_dodge(.9), width = 0) +
  scale_y_continuous(limits = c(0.0, 34)) +
  scale_x_discrete(labels = c("High", "Low")) +
  ylab("Salinity (ppt)") +
  xlab("Sea otter region") +
  theme(legend.position = "none")

# DO #
do.tr <- ggplot(oce.sum.tr, aes(x = sea_otter_tr, y = DO_m, fill = sea_otter_tr, alpha = Depth_m)) +
  geom_bar(position = position_dodge(), stat = "identity") +
  scale_fill_manual("Depth", labels = c("1m", "5m"), values = so.pal) +
  scale_alpha_discrete(range = c(0.5, 1)) +
  geom_errorbar(aes(ymin = DO_m - DO_sd, ymax = DO_m + DO_sd), position = position_dodge(.9), width = 0) +
  scale_y_continuous(limits = c(0.0, 12), breaks = seq(0, 12, by = 4)) +
  scale_x_discrete(labels = c("High", "Low")) +
  ylab("Dissolved oxygen (mg/L)") +
  xlab("Sea otter region") +
  theme(legend.position = "none")

# light #
li.tr <- ggplot(light.sum.tr, aes(x = sea_otter_tr, y = light_pr_m, fill = sea_otter_tr)) +
  geom_bar(position = position_dodge(), stat = "identity") +
  scale_fill_manual("Sea otter region", labels = c("High", "low"), values = so.pal) +
  geom_errorbar(aes(ymin = light_pr_m - light_pr_sd, ymax = light_pr_m + light_pr_sd), position = position_dodge(.9), width = 0) +
  scale_y_continuous(limits = c(0.0, 24), breaks = seq(0, 24, by = 4)) +
  scale_x_discrete(labels = c("High", "Low")) +
  ylab("Light transmittance (%)") +
  xlab("Sea otter region") +
  theme(legend.position = "none")

# Sediment #
sed.tr <- ggplot(sed, aes(x = sea_otter_tr, y = sed_m, fill = sea_otter_tr)) +
  geom_bar(position = position_dodge(), stat = "identity") +
  scale_fill_manual("Sea otter region", labels = c("High", "low"), values = so.pal) +
  geom_errorbar(aes(ymin = sed_m - sed_sd, ymax = sed_m + sed_sd), position = position_dodge(.9), width = 0) +
  scale_y_continuous(limits = c(0.0, 4), breaks = seq(0, 4, by = 1)) +
  scale_x_discrete(labels = c("High", "Low")) +
  ylab("Sediemnt score") +
  xlab("Sea otter region") +
  theme(legend.position = "none")
```

##### Environmental Panel
```{r}
plot_grid(tmp.tr, sal.tr, do.tr, nox.tr, pho.tr, li.tr, sed.tr, nrow = 4, ncol = 2, labels = c("a", "b", "c", "d", "e", "f", "g"), label_size = 10)
```


### Biomarker Metadata
```{r bimrk metadata, echo = FALSE}
## Filter out ones we did not use ##
bimrk_redu <- merge(bimrk, si[ 1], by = "Biomarker_ID")

## Mean size by sample ##
bimrk_redu$size_mm_mean <-rowMeans(bimrk_redu[, 12:25], na.rm = TRUE)

bimrk.sum <- bimrk_redu %>% 
  group_by(Sea_otter_region, Species_common) %>% 
  summarise(size_mean = mean(size_mm_mean),
            size_sd = sd(size_mm_mean))

## Mean size Macoma sp. ##
bimrk.mac <- bimrk_redu %>% 
  filter(str_detect(Species_scientific, "^Macoma")) %>% 
  group_by(Sea_otter_region) %>% 
  summarise(size_mean = mean(size_mm_mean),
            size_sd = sd(size_mm_mean))
```

### Biomass
Compare biomass of community members between sea otter treatments

#### Assess normality
```{r norm, echo = FALSE}
## eelgrass mass ##
hist(eg$shoot_mass_m)
shapiro.test(eg$shoot_mass_m)

hist(log(eg$shoot_mass_m))
shapiro.test(log(eg$shoot_mass_m))

ggplot(eg) +
  geom_histogram(aes(log(shoot_mass_m)), binwidth = 0.5) +
  xlab(bquote("Log eelgrass mass" ~(g/m^-2))) +
  ylab("Count")

## epiphyte load ##
hist(eg$epi_load)
shapiro.test(eg$epi_load)

hist(sqrt(eg$epi_load))
shapiro.test(sqrt(eg$epi_load))

ggplot(eg) +
  geom_histogram(aes(sqrt(epi_load)), binwidth = 0.01) +
  xlab("sqrt epiphyte load g/g") +
  ylab("Count") +
  scale_y_continuous(limits = c(0, 8))

## POM ##
hist(pom$pc_om_POM)
shapiro.test(pom$pc_om_POM)

## Epifauna ##
hist(sqrt(eg$grazer_load))
shapiro.test(sqrt(eg$grazer_load))

ggplot(eg) +
  geom_histogram(aes(sqrt(grazer_load)), binwidth = 0.1) +
  xlab("Log grazer load g/g") +
  ylab("Count")

## Idotea load ##
hist(eg$idotea_load)
hist((eg$idotea_load)^0.33)
shapiro.test((eg$idotea_load)^0.33)

## limpet load ##
hist(eg$limpet_load)

## Clams ##
hist(clm.site.quad$mass_g)
hist((clm.site.quad$mass_g)^0.33)
shapiro.test((clm.site.quad$mass_g)^0.33)

## Butter clams ##
hist(clm.site.quad.sp$mass_g[clm.site.quad.sp$species_common == "Butter clam"])

## macoma sp clams ##
hist(clm.site.quad.sp$mass_g[clm.site.quad.sp$species_common == "Macoma sp."])

## Crabs ##
hist(log(crb.site.string$mass_g))
shapiro.test(log(crb.site.string$mass_g))

## helmet crabs ##
hist(crb.site.string.sp$mass_g[crb.site.string.sp$species_common == "Helmet crab"])

## Gracilis crabs ##
hist(crb.site.string.sp$mass_g[crb.site.string.sp$species_common == "Graceful crab"])

## Red rock crab ##
hist(crb.site.string.sp$mass_g[crb.site.string.sp$species_common == "Red rock crab"], breaks = 10)

## All fish ##
hist(log(fsh$total_fish_mass), breaks = 5)
shapiro.test(log(fsh$total_fish_mass))

## Shiner perch ##
hist(log(fsh$PERCHSH))
shapiro.test(log(fsh$PERCHSH))

## Snake pricklebakc ##
hist(sqrt(fsh$PRICKSN))
shapiro.test(log(fsh$PRICKSN))

## Staghorn ##
hist(log(fsh$SCULPSTG))
shapiro.test(log(fsh$SCULPSTG))
```

Biomass normality plots
```{r}
ggplot(eg) +
  geom_histogram(aes(y = ))
```

#### ANOVAS of sites and treatment
##### Eelgrass things
Eelgrass
```{r eg site x treatment, echo = FALSE}
mod.eg.1 <- lm(log(shoot_mass_m) ~ sea_otter_tr + sea_otter_tr %in% site, data = eg)
anova(mod.eg.1)
```

Epiphytes
```{r epi site X treatment, echo = FALSE}
mod.ep.1 <- lm(sqrt(epi_load) ~ sea_otter_tr + sea_otter_tr %in% site, data = eg)
anova(mod.ep.1)
```

POM
```{r}
mod.pm.1 <- lm(pc_om_POM ~ sea_otter_tr + sea_otter_tr %in% site, data = pom)
anova(mod.pm.1)
```

Grazers
```{r grz site X treatment, echo = FALSE}
## All Grazers ##
mod.gr.1 <- lm(sqrt(grazer_load) ~ sea_otter_tr + sea_otter_tr %in% site, data = eg)
anova(mod.gr.1)

## Idotea ##
mod.id.1 <- lm((idotea_load^0.33) ~ sea_otter_tr + sea_otter_tr %in% site, data = eg)
anova(mod.id.1)

## Limpet ##
mod.lp.1 <- lm(limpet_load ~ sea_otter_tr + sea_otter_tr %in% site, data = eg)
anova(mod.lp.1)
```

##### Crabs
Sum total crab mass by string. Insert 0 data for strings with no crabs so averages are correct. Append site metadata
```{r crb site x treatment, echo = FLASE}
## Nested Anova ##
mod.crb.1 <- lm(log(mass_g + 1 / 1000) ~ sea_otter_tr + sea_otter_tr %in% site, data = crb.site.string)
anova(mod.crb.1)

## Strait Anova ##
mod.crb.2 <- lm(mass_g ~ sea_otter_tr, data = crb.sum)
anova(mod.crb.2)

## By species ##
# Overall #
mod.crb.3 <- lm(mass_g / 1000 ~ sea_otter_tr + species_common %in% sea_otter_tr, data = crb.site.string.sp)
anova(mod.crb.3)

# Graceful #
mod.dun.1 <- lm(mass_g  ~ sea_otter_tr + site %in% sea_otter_tr, data = subset(crb.site.string.sp, species_common == "Graceful crab"))
anova(mod.dun.1)

# Helmet #
mod.hel.1 <- lm(mass_g / 1000 ~ sea_otter_tr + site %in% sea_otter_tr, data = subset(crb.site.string.sp, species_common == "Helmet crab"))
anova(mod.hel.1)

# Red rock #
mod.roc.1 <- lm(mass_g / 1000 ~ sea_otter_tr + site %in% sea_otter_tr, data = subset(crb.site.string.sp, species_common == "Red rock crab"))
anova(mod.roc.1)
```

##### Clams
We also have species to think about...
```{r clm site}
## All Clams ##
mod.clm.1 <- lm((mass_g / 1000)^0.33 ~ sea_otter_tr + site %in% sea_otter_tr, data = clm.site.quad)
anova(mod.clm.1)

## By species ##
# Overall #
mod.clm.2 <-lm(mass_g/1000 ~ sea_otter_tr + species_common %in% sea_otter_tr, data = clm.site.quad.sp)
anova(mod.clm.2)

# Butter clams #
mod.but.1 <- lm(mass_g/1000 ~ sea_otter_tr + site %in% sea_otter_tr, data = subset(clm.site.quad.sp, species_common == "Butter clam"))
anova(mod.but.1)

# Macoma sp. ##
mod.mac.1 <- lm(mass_g/1000 ~ sea_otter_tr + site %in% sea_otter_tr, data = subset(clm.site.quad.sp, species_common == "Macoma sp."))
anova(mod.mac.1)
```

##### Fish
```{r}
## Total mass ##
t.fsh.1 <- t.test(log(total_fish_mass / 1000) ~ sea_otter_tr, data = fsh)
t.fsh.1

mean(fsh$total_fish_mass[fsh$sea_otter_tr == "high"])
sd(fsh$total_fish_mass[fsh$sea_otter_tr == "high"])

mean(fsh$total_fish_mass[fsh$sea_otter_tr == "low"])
sd(fsh$total_fish_mass[fsh$sea_otter_tr == "low"])

## Stags ##
t.stg.1 <- t.test(SCULPSTG / 1000 ~ sea_otter_tr, data = fsh)
t.stg.1

mean(fsh$SCULPSTG[fsh$sea_otter_tr == "high"])
sd(fsh$SCULPSTG[fsh$sea_otter_tr == "high"])

mean(fsh$SCULPSTG[fsh$sea_otter_tr == "low"])
sd(fsh$SCULPSTG[fsh$sea_otter_tr == "low"])

## Shiners ##
t.shn.1 <- t.test(log(PERCHSH / 1000) ~ sea_otter_tr, data = fsh)
t.shn.1

mean(fsh$PERCHSH[fsh$sea_otter_tr == "high"])
sd(fsh$PERCHSH[fsh$sea_otter_tr == "high"])

mean(fsh$PERCHSH[fsh$sea_otter_tr == "low"])
sd(fsh$PERCHSH[fsh$sea_otter_tr == "low"])

## Snake Prickleback ##
t.snk.1 <- t.test(log(PRICKSN / 1000) ~ sea_otter_tr, data = fsh)
t.snk.1

mean(fsh$PRICKSN[fsh$sea_otter_tr == "high"])
sd(fsh$PRICKSN[fsh$sea_otter_tr == "high"])

mean(fsh$PRICKSN[fsh$sea_otter_tr == "low"])
sd(fsh$PRICKSN[fsh$sea_otter_tr == "low"])
```

#### Plots
##### Data prep
Eelgrass
```{r eg site X treatment summaries, echo = FALSE}
eg.sum <- eg %>% 
  group_by(sea_otter_tr, site) %>% 
  summarise(shoot_mass_m_mean = mean(shoot_mass_m),
            shoot_mass_m_se = st.er(shoot_mass_m),
            epi_load_mean = mean(epi_load),
            epi_load_se = st.er(epi_load),
            grz_load_mean = mean(grazer_load),
            grz_load_se = st.er(grazer_load),
            ido_load_mean = mean(idotea_load),
            ido_load_se = st.er(idotea_load ),
            lmp_load_mean = mean(limpet_load),
            lmp_load_se = st.er(limpet_load))
```

POM
```{r}
pom.sum <- pom %>%
  group_by(sea_otter_tr, site) %>% 
  summarise(pc_om_m = mean(pc_om_POM),
            pc_om_se = st.er(pc_om_POM))
```

Crabs
```{r}
## All Species ##
crb.sum <- crb.site.string.sp %>%
  group_by(site) %>% 
  summarise(mass_m = mean(mass_g),
            mass_se = sd(mass_g) / sqrt(length(mass_g)))

crb.sum <- merge(crb.sum, site[, c(1, 2, 5)])

## By species ##
crb.sum.2 <-  crb.site.string.sp %>% 
  group_by(site, species_common) %>% 
  summarise(mass_m = mean(mass_g),
            mass_se = st.er(mass_g))

crb.sum.2 <- merge(crb.sum.2, site[, c(1, 5)], by = "site")
```

Clams
```{r}
clm.sum.1 <- clm.site.quad %>% 
  group_by(site) %>% 
  summarise(mass_g_mean = mean(mass_g),
            mass_g_se = st.er(mass_g))
clm.sum.1 <- merge(clm.sum.1, site[, c(1, 5)], by = "site")

clm.sum.2 <- clm.site.quad.sp %>% 
  group_by(site, species_common) %>% 
  summarise(mass_g_mean = mean(mass_g),
            mass_g_se = st.er(mass_g))
clm.sum.2 <- merge(clm.sum.2, site[, c(1, 5)], by = "site")
```

Fish
```{r}
## Basic summary ##
fsh.sum.1 <- fsh %>%
  group_by(sea_otter_tr) %>% 
  summarise(mass_kg_mean = mean(total_fish_mass / 1000),
           mass_kg_se = st.er(total_fish_mass / 1000))

stg.sum.1 <- fsh %>%
  group_by(sea_otter_tr) %>% 
  summarise(mass_kg_mean = mean(SCULPSTG / 1000),
            mass_kg_se = st.er(SCULPSTG  / 1000))

shn.sum.1 <- fsh %>%
  group_by(sea_otter_tr) %>% 
  summarise(mass_kg_mean = mean(PERCHSH / 1000),
            mass_kg_se = st.er(PERCHSH / 1000))

snk.sum.1 <- fsh %>%
  group_by(sea_otter_tr) %>% 
  summarise(mass_kg_mean = mean(PRICKSN / 1000),
            mass_kg_se = st.er(PRICKSN / 1000))

## Proportion ##
fsh.prop <- fsh[, 2:30] / fsh$total_fish_mass
fsh.prop <- cbind(fsh[, c(1, 31, 32)], fsh.prop)

fsh.prop <- fsh.prop %>% 
  gather(key = "Species", value = "mass_prop", 4:32)

fsh.prop.sum <- fsh.prop %>% 
  group_by(sea_otter_tr, Species) %>% 
  summarise(prop_m = mean(mass_prop),
            prop_se = st.er(mass_prop))
```


##### Plots
```{r}
## Eelgrass ##
elg.m <- ggplot(eg.sum) +
  geom_bar(aes(x = site, y = shoot_mass_m_mean, fill = sea_otter_tr), position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(x = site, ymin = shoot_mass_m_mean - shoot_mass_m_se, ymax = shoot_mass_m_mean + shoot_mass_m_se), width = 0) +
  scale_fill_manual("Sea otter\ntreatment", labels = c("High", "Low"), values = so.pal) +
  scale_x_discrete(labels = c("H1", "H2", "H3", "L1", "L2", "L3")) +
  scale_y_continuous(limits = c(0, 300), breaks = seq(0, 300, by = 100)) +
  ylab(bquote("Eelgrass mass" ~(g/m^-2))) +
  xlab("Site") +
  theme(legend.position = "none", text = element_text(size = 8))

## Epiphyte Load ##
epi.m <- ggplot(eg.sum) +
  geom_bar(aes(x = site, y = epi_load_mean, fill = sea_otter_tr), position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(x = site, ymin = epi_load_mean - epi_load_se, ymax = epi_load_mean + epi_load_se), width = 0) +
  scale_fill_manual("Sea otter treatment", labels = c("High", "Low"), values = so.pal) +
  scale_x_discrete(labels = c("H1", "H2", "H3", "L1", "L2", "L3")) +
  scale_y_continuous(limits = c(0, 0.01), breaks = seq(0, 0.01, by = 0.0025)) +
  ylab("Epiphyte load (g/g)") +
  xlab("Site") +
  theme(legend.position = "none", text = element_text(size = 8))

## POM ##
pom.m <- ggplot(pom.sum) +
  geom_bar(aes(x = site, y = pc_om_m, fill = sea_otter_tr), position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(x = site, ymin = pc_om_m - pc_om_se, ymax = pc_om_m + pc_om_se), width = 0) +
  scale_fill_manual("Sea otter treatment", labels = c("High", "Low"), values = so.pal) +
  scale_x_discrete(labels = c("H1", "H2", "H3", "L1", "L2", "L3")) +
  scale_y_continuous(limits = c(0, 3.2), breaks = seq(0, 3, by = 1)) +
  ylab("Percent organic matter") +
  xlab("Site") +
  theme(legend.position = "none", text = element_text(size = 8))

## Grazer Load ##
grz.all <- ggplot(eg.sum) +
  geom_bar(aes(x = site, y = grz_load_mean, fill = sea_otter_tr), position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(x = site, ymin = grz_load_mean - grz_load_se, ymax = grz_load_mean + grz_load_se), width = 0) +
  scale_fill_manual("Sea otter treatment", labels = c("High", "Low"), values = so.pal) +
  scale_x_discrete(labels = c("H1", "H2", "H3", "L1", "L2", "L3")) +
  scale_y_continuous(limits = c(0, 0.25), breaks = seq(0, 0.25, by = 0.05)) +
  ylab("Epifauna load (g/g)") +
  xlab("Site") +
  theme(legend.position = "none", text = element_text(size = 8))

## Idotea Load ##
ido.m <- ggplot(eg.sum) +
  geom_bar(aes(x = site, y = ido_load_mean, fill = sea_otter_tr), position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(x = site, ymin = ido_load_mean - ido_load_se, ymax = ido_load_mean + ido_load_se), width = 0) +
  scale_fill_manual("Sea otter treatment", labels = c("High", "Low"), values = so.pal) +
  scale_x_discrete(labels = c("H1", "H2", "H3", "L1", "L2", "L3")) +
  scale_y_continuous(limits = c(0, 0.15), breaks = seq(0, 0.15, by = 0.03)) +
  ylab("Idotea load (g/g)") +
  xlab("Site") +
  theme(legend.position = "none", text = element_text(size = 8))

## Limpet Load ##
lmp.m <- ggplot(eg.sum) +
  geom_bar(aes(x = site, y = lmp_load_mean, fill = sea_otter_tr), position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(x = site, ymin = lmp_load_mean - lmp_load_se, ymax = lmp_load_mean + lmp_load_se), width = 0) +
  scale_fill_manual("Sea otter treatment", labels = c("High", "Low"), values = so.pal) +
  scale_x_discrete(labels = c("H1", "H2", "H3", "L1", "L2", "L3")) +
  scale_y_continuous(limits = c(0, 0.03), breaks = seq(0, 0.03, by = 0.01)) +
  ylab("Limpet load (g/g)") +
  xlab("Site") +
  theme(legend.position = "none", text = element_text(size = 8))

## Clams site ##
clm.all <- ggplot(clm.sum.1) +
  geom_bar(aes(x = site, y = mass_g_mean, fill = sea_otter_tr), position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(x = site, ymin = mass_g_mean - mass_g_se, ymax = mass_g_mean + mass_g_se), width = 0) +
  scale_fill_manual(values = so.pal) +
  scale_y_continuous(limits = c(0, 650), breaks = seq(0, 650, by = 200)) +
  scale_x_discrete(labels = c("H1", "H2", "H3", "L1", "L2", "L3")) +
  ylab(bquote("Clam mass" ~(g/m^-2))) +
  xlab("Site") +
  theme(legend.position = "none", text = element_text(size = 8))

## Butter clams ##
but.m <- ggplot(subset(clm.sum.2, species_common == "Butter clam")) +
  geom_bar(aes(x = site, y = mass_g_mean , fill = sea_otter_tr), position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(x = site, ymin = mass_g_mean  - mass_g_se , ymax = mass_g_mean  + mass_g_se ), width = 0) +
  scale_fill_manual("Sea otter treatment", labels = c("High", "Low"), values = so.pal) +
  scale_x_discrete(labels = c("H1", "H2", "H3", "L1", "L2", "L3")) +
  scale_y_continuous(limits = c(0, 500), breaks = seq(0, 500, by = 100)) +
  ylab(bquote("Butter clam" ~(g/m^-2))) +
  xlab("Site") +
  theme(legend.position = "none", text = element_text(size = 8))

## Macoma sp. clams ##
mac.m <- ggplot(subset(clm.sum.2, species_common == "Macoma sp.")) +
  geom_bar(aes(x = site, y = mass_g_mean , fill = sea_otter_tr), position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(x = site, ymin = mass_g_mean  - mass_g_se , ymax = mass_g_mean  + mass_g_se ), width = 0) +
  scale_fill_manual("Sea otter treatment", labels = c("High", "Low"), values = so.pal) +
  scale_x_discrete(labels = c("H1", "H2", "H3", "L1", "L2", "L3")) +
  scale_y_continuous(limits = c(0, 400), breaks = seq(0, 400, by = 100)) +
  ylab(bquote("Macoma sp. clams" ~(g/m^-2))) +
  xlab("Site") +
  theme(legend.position = "none", text = element_text(size = 8))

## Crabs site sp ##
crb.all <- ggplot(crb.sum) +
  geom_col(aes(x = site, y = mass_m , fill = sea_otter_tr)) +
  geom_errorbar(aes(x = site, ymin = mass_m  - mass_se , ymax = mass_m  + mass_se ), width = 0) +
  scale_fill_manual(name = "Sea otters", values = so.pal) +
  scale_y_continuous(limits = c(0, 600), breaks = seq(0, 600, by = 100)) +
  scale_x_discrete(labels = c("H1", "H2", "H3", "L1", "L2", "L3")) +
  ylab("Crab (g/string)") +
  xlab("Site") +
  theme(legend.position = "none", text = element_text(size = 8))

## Gracefuil crabs ##
grc.m <- ggplot(subset(crb.sum.2, species_common == "Graceful crab")) +
  geom_bar(aes(x = site, y = mass_m , fill = sea_otter_tr), position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(x = site, ymin = mass_m  - mass_se , ymax = mass_m  + mass_se ), width = 0) +
  scale_fill_manual("Sea otter treatment", labels = c("High", "Low"), values = so.pal) +
  scale_x_discrete(labels = c("H1", "H2", "H3", "L1", "L2", "L3")) +
  scale_y_continuous(limits = c(0, 500), breaks = seq(0, 500, by = 100)) +
  ylab("Graceful crab (g/string)") +
  xlab("Site") +
  theme(legend.position = "none", text = element_text(size = 8))

## Helmet crabs ##
hel.m <- ggplot(subset(crb.sum.2, species_common == "Helmet crab")) +
  geom_bar(aes(x = site, y = mass_m , fill = sea_otter_tr), position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(x = site, ymin = mass_m  - mass_se, ymax = mass_m  + mass_se ), width = 0) +
  scale_fill_manual("Sea otter\ntreatment", labels = c("High", "Low"), values = so.pal) +
  scale_x_discrete(labels = c("H1", "H2", "H3", "L1", "L2", "L3")) +
  scale_y_continuous(limits = c(0, 200), breaks = seq(0, 200, by = 50)) +
  ylab("Helmet crab (g/string)") +
  xlab("Site") +
  theme(legend.position = c(0.8, 0.5), text = element_text(size = 8))

## Red rock crabs ##
rrc.m <- ggplot(subset(crb.sum.2, species_common == "Red rock crab")) +
  geom_bar(aes(x = site, y = mass_m , fill = sea_otter_tr), position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(x = site, ymin = mass_m  - mass_se , ymax = mass_m  + mass_se ), width = 0) +
  scale_fill_manual("Sea otter treatment", labels = c("High", "Low"), values = so.pal) +
  scale_x_discrete(labels = c("H1", "H2", "H3", "L1", "L2", "L3")) +
  scale_y_continuous(limits = c(0, 2000), breaks = seq(0, 2000, by = 500)) +
  ylab("Red rock crab (g/string)") +
  xlab("Site") +
  theme(legend.position = "none", text = element_text(size = 8))

## Fish site ##
fsh.all <- ggplot(fsh.sum.1) +
  geom_bar(aes(x = sea_otter_tr, y = mass_kg_mean, fill = sea_otter_tr), position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(x = sea_otter_tr, ymin = mass_kg_mean - mass_kg_se, ymax = mass_kg_mean + mass_kg_se), width = 0) +
  scale_fill_manual("Sea otter treatment", labels = c("High", "Low"), values = so.pal) +
  scale_x_discrete(labels = c("High", "Low")) +
  scale_y_continuous(limits = c(0, 35), breaks = seq(0, 35, by = 10)) +
  ylab("Fish (kg/site)") +
  xlab("Site") +
  theme(legend.position = "none", text = element_text(size = 8))
  
## Staghorn ##
stg.m <- ggplot(stg.sum.1) +
  geom_bar(aes(x = sea_otter_tr, y = mass_kg_mean, fill = sea_otter_tr), position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(x = sea_otter_tr, ymin = mass_kg_mean - mass_kg_se, ymax = mass_kg_mean + mass_kg_se), width = 0) +
  scale_fill_manual(values = so.pal) +
  scale_x_discrete(labels = c("High", "Low")) +
  scale_y_continuous(limits = c(0, 2), breaks = seq(0, 2, by = 0.5)) +
  ylab("Staghorn sculpin (kg/set)") +
  xlab("Site") +
  theme(legend.position = "none", text = element_text(size = 8))

## Shiner ##
shn.m <- ggplot(shn.sum.1) +
  geom_bar(aes(x = sea_otter_tr, y = mass_kg_mean, fill = sea_otter_tr), position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(x = sea_otter_tr, ymin = mass_kg_mean - mass_kg_se, ymax = mass_kg_mean + mass_kg_se), width = 0) +
  scale_fill_manual(values = so.pal) +
  scale_x_discrete(labels = c("High", "Low")) +
  scale_y_continuous(limits = c(0, 16), breaks = seq(0, 16, by = 4)) +
  ylab("Shiner perch (kg/set)") +
  xlab("Site") +
  theme(legend.position = "none", text = element_text(size = 8))

## Snake prickleback ##
snk.m <- ggplot(snk.sum.1) +
  geom_bar(aes(x = sea_otter_tr, y = mass_kg_mean, fill = sea_otter_tr), position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(x = sea_otter_tr, ymin = mass_kg_mean - mass_kg_se, ymax = mass_kg_mean + mass_kg_se), width = 0) +
  scale_fill_manual(values = so.pal) +
  scale_x_discrete(labels = c("High", "Low")) +
  scale_y_continuous(limits = c(0, 12), breaks = seq(0, 12, by = 3)) +
  ylab("Snake prickleback (kg/set)") +
  xlab("Site") +
  theme(legend.position = "none", text = element_text(size = 8))

## Fish proportions ##
ggplot(subset(fsh.prop.sum, sea_otter_tr == "high")) +
  geom_bar(aes(x = reorder(Species, - prop_m), y = prop_m), stat = "identity") +
  geom_errorbar(aes(x = reorder(Species, - prop_m), ymin = prop_m - prop_se, ymax = prop_m + prop_se), width = 0) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

ggplot(subset(fsh.prop.sum, sea_otter_tr == "low")) +
  geom_bar(aes(x = reorder(Species, - prop_m), y = prop_m), stat = "identity") +
  geom_errorbar(aes(x = reorder(Species, - prop_m), ymin = prop_m - prop_se, ymax = prop_m + prop_se), width = 0) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

##### Panel - biomass
```{r}
cowplot::plot_grid(elg.m, epi.m, pom.m, grz.all, ido.m, lmp.m, clm.all, but.m, mac.m, crb.all, grc.m, hel.m, rrc.m, fsh.all, stg.m, shn.m, snk.m, labels = c("a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m", "n", "o", "p", "q"), nrow = 6, ncol = 3, label_size = 10, align = "v", label_x = 0.23)
```

### Stable Isotopes
There are two perspectives in analysis. 1) The whole community (all data) comparisons and 2) by species comparisons.

#### SI data prep
Filter out NA data duplicate QA/QC samples. 
```{r si data prep, echo = FALSE}
si <- si %>% 
  na.omit() %>% 
  filter(!str_detect(Biomarker_ID, "_B"))
```

Calculate C:N ratio
```{r c:n ratio, echo = FALSE}
si$C_N <- si$percent_C / si$percent_N
```

Append metadata etc. Convert all Macoma to Macoma sp. Then filter OUT limpets and B_226 the coccolithophore POM sample .... for now
```{r si metadata, echo = FALSE}
si <- merge(si, bimrk, by = "Biomarker_ID")
colnames(si)[11] <- "Sea_otter_tr"

si <- si %>% 
  filter(Species_common != "Limpet") %>% 
  filter(Biomarker_ID != "B_226")

si$Species_common <- ifelse(str_detect(si$Species_common, "Macoma"), "Macoma sp.", si$Species_common)

si.n <- si %>% 
  group_by(Sea_otter_region, Species_common) %>% 
  summarise(n = n())
```

#### Whole community
Convex hulls. First calcualte mean values by species by sea otter treatment
```{r c hulls all, echo = FALSE}
si.sum <- si %>% 
  group_by(Sea_otter_tr, Species_common) %>% 
  summarise(Species_scientific = first(Species_scientific),
            sp_code = first(sp_code),
            sp_group = first(sp_group),
            n = n(),
            del_N_mean = mean(del_N),
            del_N_sd = sd(del_N),
            del_C_mean = mean(del_C),
            del_C_sd = sd(del_C))

si.sum$sp_code <- ifelse(si.sum$Species_common == "Macoma sp.", "CLMMAC", si.sum$sp_code)

si.sum$del_N_ord_high <- sort(si.sum$del_N_mean)

## High sea otter ##
high.c.area <- convexhull(si.sum$del_C_mean[si.sum$Sea_otter_tr == "High"], si.sum$del_N_mean[si.sum$Sea_otter_tr == "High"])

## Low sea otter ##
low.c.area <- convexhull(si.sum$del_C_mean[si.sum$Sea_otter_tr == "Low"], si.sum$del_N_mean[si.sum$Sea_otter_tr == "Low"])

## Percent difference ##
(low.c.area$TA - high.c.area$TA) / low.c.area$TA
```

##### Plots
```{r plots si all, echo = FALSE}
## All data ##
si.raw <- ggplot(si) +
  geom_point(aes(x = del_C, y = del_N, shape = sp_group, color = Sea_otter_tr), size = 3) +
  scale_color_manual(values = so.pal, "Sea otter region") +
  scale_shape_manual(values = shape.pal, "Trophic role", labels = c("Primary consumer", "Primary producer", "Secondary consumer"))

## new names ##
si.names <- c("BUT", "DSH", "EG", "EP", "FU", "GRC", "HEL", "IDO", "MAC", "POM", "SHN", "SNK", "STG", "SK", "UL", "BUT", "DSH", "EG", "EP", "FU", "GRC", "HEL", "IDO", "MAC", "POM", "RRC", "SHN", "SNK", "STG", "SK", "UL")
si.sum$si.names <- si.names
si.sum$si.names <- factor(si.sum$si.names, levels = c("EG", "EP", "FU", "POM", "SK", "UL", "IDO", "BUT", "MAC", "DSH", "HEL", "GRC", "RRC", "SHN", "SNK", "STG"))

## Mean values and hulls ##
# High and Low #
si.all.h <- ggplot() +
  geom_point(aes(x = si.sum$del_C_mean, y = si.sum$del_N_mean, shape = si.sum$sp_group, color = si.sum$Sea_otter_tr), size = 2) +
  scale_color_manual(values = so.pal, "Sea otter region") +
  scale_shape_manual(values = shape.pal, "Trophic role", labels = c("Primary consumer", "Primary producer", "Secondary consumer")) +
  geom_polygon(aes(x = high.c.area$xcoords, y = high.c.area$ycoords), fill = so.pal[1], alpha = 0.4) +
  geom_polygon(aes(x = low.c.area$xcoords, y = low.c.area$ycoords), fill = so.pal[2], alpha = 0.4) +
  scale_x_continuous(limits = c(-20, -6), breaks = seq(-20, -6, by = 2)) +
  scale_y_continuous(limits = c(5, 15), breaks = seq(5, 15, by = 2)) +
  geom_text_repel(aes(x = si.sum$del_C_mean, y = si.sum$del_N_mean, label = si.sum$si.names), size = 2) +
  xlab(expression({delta}^13*C~'\u2030')) +
  ylab(expression({delta}^15*N~'\u2030')) +
  theme(legend.position = "none")

si.all.h.lgnd <- ggplot() +
  geom_point(aes(x = si.sum$del_C_mean, y = si.sum$del_N_mean, shape = si.sum$sp_group, color = si.sum$Sea_otter_tr), size = 2) +
  scale_color_manual(values = so.pal, "Sea otter region") +
  scale_shape_manual(values = shape.pal, "Trophic role", labels = c("Primary consumer", "Primary producer", "Secondary consumer")) +
  geom_polygon(aes(x = high.c.area$xcoords, y = high.c.area$ycoords), fill = so.pal[1], alpha = 0.4) +
  geom_polygon(aes(x = low.c.area$xcoords, y = low.c.area$ycoords), fill = so.pal[2], alpha = 0.4) +
  scale_x_continuous(limits = c(-20, -6), breaks = seq(-20, -6, by = 2)) +
  scale_y_continuous(limits = c(5, 15), breaks = seq(5, 15, by = 2)) +
  geom_text_repel(aes(x = si.sum$del_C_mean, y = si.sum$del_N_mean, label = si.sum$si.names), size = 2) +
  xlab(expression({delta}^13*C~'\u2030')) +
  ylab(expression({delta}^15*N~'\u2030'))

# High Only #
si.sum.h <- subset(si.sum, Sea_otter_tr == "High")

si.high.all <- ggplot() +
  geom_point(aes(x = si.sum.h$del_C_mean, y = si.sum.h$del_N_mean, shape = si.sum.h$sp_group, color = si.sum.h$Sea_otter_tr), size = 2) +
  scale_color_manual(values = so.pal, "Sea otter region") +
  scale_shape_manual(values = shape.pal, "Trophic role", labels = c("Primary consumer", "Primary producer", "Secondary consumer")) +
  geom_polygon(aes(x = high.c.area$xcoords, y = high.c.area$ycoords), fill = so.pal[1], alpha = 0.4) +
  scale_x_continuous(limits = c(-20, -6), breaks = seq(-20, -6, by = 2)) +
  scale_y_continuous(limits = c(5, 15), breaks = seq(5, 15, by = 2)) +
  geom_text_repel(aes(x = si.sum.h$del_C_mean, y = si.sum.h$del_N_mean, label = si.sum.h$si.names), size = 2) +
  xlab(expression({delta}^13*C~'\u2030')) +
  ylab(expression({delta}^15*N~'\u2030')) +
  theme(legend.position = "none")

# Low Only #
si.sum.l <- subset(si.sum, Sea_otter_tr == "Low")

si.low.all <- ggplot() +
  geom_point(aes(x = si.sum.l$del_C_mean, y = si.sum.l$del_N_mean, shape = si.sum.l$sp_group, color = si.sum.l$Sea_otter_tr), size = 2) +
  scale_color_manual(values = so.pal[2], "Sea otter region") +
  scale_shape_manual(values = shape.pal, "Trophic role", labels = c("Primary consumer", "Primary producer", "Secondary consumer")) +
  geom_polygon(aes(x = low.c.area$xcoords, y = low.c.area$ycoords), fill = so.pal[2], alpha = 0.4) +
  scale_x_continuous(limits = c(-20, -6), breaks = seq(-20, -6, by = 2)) +
  scale_y_continuous(limits = c(5, 15), breaks = seq(5, 15, by = 2)) +
  geom_text_repel(aes(x = si.sum.l$del_C_mean, y = si.sum.l$del_N_mean, label = si.sum.l$si.names), size = 2) +
  xlab(expression({delta}^13*C~'\u2030')) +
  ylab(expression({delta}^15*N~'\u2030')) +
  theme(legend.position = "none")

## C plots by treatment ##
si.c.all <- ggplot(si.sum) +
  geom_errorbar(aes(x = si.names, ymin = del_C_mean - del_C_sd, ymax = del_C_mean + del_C_sd, group = Sea_otter_tr), width = 0, position = position_dodge(0.7)) +
  geom_point(aes(x = si.names, y = del_C_mean, shape = sp_group, color = Sea_otter_tr), size = 2, position = position_dodge(0.7)) +
  scale_color_manual(values = so.pal, "Sea otter region") +
  scale_shape_manual(values = shape.pal, "Trophic role", labels = c("Primary consumer", "Primary producer", "Secondary consumer")) +
  scale_y_continuous(limits = c(-22, -6), breaks = seq(-22, -6, by = 2)) +
  ylab(expression({delta}^13*C~'\u2030')) +
  xlab("Species") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(legend.position = "none")

## N plots by treatment ##
si.n.all <- ggplot(si.sum) +
  geom_errorbar(aes(x = si.names, ymin = del_N_mean - del_N_sd, ymax = del_N_mean + del_N_sd, group = Sea_otter_tr), width = 0, position = position_dodge(0.7)) +
  geom_point(aes(x = si.names, y = del_N_mean, shape = sp_group, color = Sea_otter_tr), size = 2, position = position_dodge(0.7)) +
  scale_color_manual(values = so.pal, "Sea otter region") +
  scale_shape_manual(values = shape.pal, "Trophic role", labels = c("Primary consumer", "Primary producer", "Secondary consumer")) +
  scale_y_continuous(limits = c(5, 15), breaks = seq(5, 15, by = 2)) +
  ylab(expression({delta}^15*N~'\u2030')) +
  xlab("Species") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(legend.position = "none")


## N ranks ##
si.sum.h$N_rank <- NA
order.N.h <- order(si.sum.h$del_N_mean)
si.sum.h$N_rank[order.N.h] <- 1:nrow(si.sum.h)

si.sum.l$N_rank <- NA
order.N.l <- order(si.sum.l$del_N_mean)
si.sum.l$N_rank[order.N.l] <- 1:nrow(si.sum.l)

si.high.n <- ggplot(si.sum.h) +
  geom_errorbar(aes(x = N_rank, ymin = del_N_mean - del_N_sd, ymax = del_N_mean + del_N_sd), width = 0) +
  geom_point(aes(x = N_rank, y = del_N_mean, shape = sp_group, color = Sea_otter_tr), size = 2) +
  scale_color_manual(values = so.pal[1], "Sea otter region") +
  scale_shape_manual(values = shape.pal, "Trophic role", labels = c("Primary consumer", "Primary producer", "Secondary consumer")) +
  geom_text_repel(aes(x = N_rank, y = del_N_mean, label = si.names), size = 2) +
  scale_y_continuous(limits = c(5, 15), breaks = seq(5, 15, by = 2)) +
  scale_x_continuous(limits = c(1, 15), breaks = seq(1, 15, by = 1)) +
  xlab(expression(paste({delta}^15*N~'\u2030', " rank"))) +
  ylab(expression({delta}^15*N~'\u2030')) +
  theme(legend.position = "none")

si.low.n <- ggplot(si.sum.l) +
  geom_errorbar(aes(x = N_rank, ymin = del_N_mean - del_N_sd, ymax = del_N_mean + del_N_sd), width = 0) +
  geom_point(aes(x = N_rank, y = del_N_mean, shape = sp_group, color = Sea_otter_tr), size = 2) +
  scale_color_manual(values = so.pal[2], "Sea otter region") +
  scale_shape_manual(values = shape.pal, "Trophic role", labels = c("Primary consumer", "Primary producer", "Secondary consumer")) +
  geom_text_repel(aes(x = N_rank, y = del_N_mean, label = si.names), size = 2) +
  scale_y_continuous(limits = c(5, 15), breaks = seq(5, 15, by = 2)) +
   scale_x_continuous(limits = c(1, 16), breaks = seq(1, 16, by = 1)) +
  xlab(expression(paste({delta}^15*N~'\u2030', " rank"))) +
  ylab(expression({delta}^15*N~'\u2030')) +
  theme(legend.position = "none")
  
```

##### Panel - SI
```{r}
legend <- get_legend(si.all.h.lgnd)

si.pan1 <- cowplot::plot_grid(si.all.h, si.c.all, si.n.all, labels = c("a", "b", "c"), nrow = 3, ncol = 1, label_size = 10, label_x = 0.12)

cowplot::plot_grid(si.pan1, legend, rel_widths = c(2.5, 1))
```


#### Species specific
##### Subsets
```{r}
## Primary Producers ##
# Eelgrass #
si_eg <- si %>%
  filter(Species_common == "Eelgrass")

# Eelgrass diatoms / epiphytes #
si_ep <- si %>%
  filter(Species_common == "Eelgrass diatoms")

# Fucus #
si_fu <- si %>%
  filter(Species_common == "Fucus")

# POM #
si_pm <- si %>%
  filter(Species_common == "Particulate organic matter")

# Sugar Kelp #
si_sk <- si %>%
  filter(Species_common == "Sugar kelp")

# Ulva #
si_ul <- si %>%
  filter(Species_common == "Ulva")

## Primary Consumers ##
# Idotea #
si_ido <- si %>% 
  filter(Species_common == "Idotea")

# Butter Clams ##
si_but <- si %>% 
  filter(Species_common == "Butter clam")

# Macoma Clams #
si_mac <- si %>% 
  filter(Species_common == "Macoma sp.")

## Secondary Consumers ##
# Dock Shrimp #
si_dsh <- si %>% 
  filter(Species_common == "Dock shrimp")

# Helmet crabs #
si_hel <- si %>% 
  filter(Species_common == "Helmet crab")

# Graceful crabs #
si_grc <- si %>% 
  filter(Species_common == "Graceful crab")

# Shiner Perch #
si_shn <- si %>% 
  filter(Species_common == "Shiner perch")

# Snake prickleback #
si_snk <- si %>% 
  filter(Species_common == "Snake prickleback")

# Staghorn sculpin #
si_stg <- si %>% 
  filter(Species_common == "Staghorn sculpin")
```

##### T tests of treatment
```{r}
## Primary Producers ##
# Eelgrass #
t.test(del_C ~ Sea_otter_tr, data = si_eg)

t.test(del_N ~ Sea_otter_tr, data = si_eg)

# Epiphytes #
t.test(del_C ~ Sea_otter_tr, data = si_ep)

t.test(del_N ~ Sea_otter_tr, data = si_ep)

# Fucus #
t.test(del_C ~ Sea_otter_tr, data = si_fu)

t.test(del_N ~ Sea_otter_tr, data = si_fu)

# POM #
t.test(del_C ~ Sea_otter_tr, data = si_pm)

t.test(del_N ~ Sea_otter_tr, data = si_pm)

# Sugar kelp #
t.test(del_C ~ Sea_otter_tr, data = si_sk)

t.test(del_N ~ Sea_otter_tr, data = si_sk)

# Ulva #
t.test(del_C ~ Sea_otter_tr, data = si_ul)

t.test(del_N ~ Sea_otter_tr, data = si_ul)

## Primary consumers ##
# Idotea #
t.test(del_C ~ Sea_otter_tr, data = si_ido)

t.test(del_N ~ Sea_otter_tr, data = si_ido)

# Butter Clams #
t.test(del_C ~ Sea_otter_tr, data = si_but)

t.test(del_N ~ Sea_otter_tr, data = si_but)

# Macoma sp. clams #
t.test(del_C ~ Sea_otter_tr, data = si_mac)

t.test(del_N ~ Sea_otter_tr, data = si_mac)

## Seconday consumers ##
# Dock Shrimp #
t.test(del_C ~ Sea_otter_tr, data = si_dsh)

t.test(del_N ~ Sea_otter_tr, data = si_dsh)

# Helmet crabs #
t.test(del_C ~ Sea_otter_tr, data = si_hel)

t.test(del_N ~ Sea_otter_tr, data = si_hel)

# Graceful crabs #
t.test(del_C ~ Sea_otter_tr, data = si_grc)

t.test(del_N ~ Sea_otter_tr, data = si_grc)

# Shiner perch #
t.test(del_C ~ Sea_otter_tr, data = si_shn)

t.test(del_N ~ Sea_otter_tr, data = si_shn)

# Snake prickleback #
t.test(del_C ~ Sea_otter_tr, data = si_snk)

t.test(del_N ~ Sea_otter_tr, data = si_snk)

# Staghorn sculpin #
t.test(del_C ~ Sea_otter_tr, data = si_stg)

t.test(del_N ~ Sea_otter_tr, data = si_stg)
```


plots
```{r}
ggplot(si_eg) +
  geom_point(aes(x = del_C, y = del_N, color = si_eg$Sea_otter_tr), size = 3) +
  scale_color_manual(values = so.pal, "Sea otter region")
```

### Fatty Acids
Similar to SI data there are two perspectives to analysis. 1) The whole community and 2) by species comparisons. Along these lines I will run a nested PERMANOVA for the effects of species and sea otter treatment. Then species that appear to have a strong sea otter effect will be analyzed seperatly

#### FA data prep
Subsets
```{r}
fa.temp <- merge(fa, bimrk[, c(1, 2, 3, 4, 7)], by.x = "ID", by.y = "Biomarker_ID")

fa.n <- fa.temp %>% 
  group_by(Sea_otter_region, Species_common) %>% 
  summarise(n = n())
```



##### Primary Producers
```{r fa subsets, echo = FALSE}
## All Producers ##
fa_pro <- fa %>%
  filter(Species_common == "Eelgrass" | Species_common == "Eelgrass diatoms" | Species_common == "Fucus" | Species_common == "Particulate organic matter" | Species_common == "Sugar kelp" | Species_common == "Ulva")

# Eelgrass #
fa_eg <- fa %>%
  filter(Species_common == "Eelgrass")

# Eelgrass diatoms / epiphytes #
fa_ep <- fa %>%
  filter(Species_common == "Eelgrass diatoms")

# Fucus #
fa_fu <- fa %>%
  filter(Species_common == "Fucus")

# POM #
fa_pm <- fa %>%
  filter(Species_common == "Particulate organic matter")

# Sugar Kelp #
fa_sk <- fa %>%
  filter(Species_common == "Sugar kelp")

# Ulva #
fa_ul <- fa %>%
  filter(Species_common == "Ulva")
```

Append metadata
```{r}
# All Primary Producers #
fa_pro <- merge(fa_pro, bimrk[, c(1, 2, 3, 4, 7)], by.x = "ID", by.y = "Biomarker_ID")
fa_pro <- cbind(fa_pro[, c(1, 37:40, 2:36)])
colnames(fa_eg)[5] <- "Sea_otter_tr"

# Eelgrass #
fa_eg <- merge(fa_eg, bimrk[, c(1, 2, 3, 4, 7)], by.x = "ID", by.y = "Biomarker_ID")
fa_eg <- cbind(fa_eg[, c(1, 37:40, 2:36)])
colnames(fa_eg)[5] <- "Sea_otter_tr"

# Eelgrass diatoms / epiphytes #
fa_ep <- merge(fa_ep, bimrk[, c(1, 2, 3, 4, 7)], by.x = "ID", by.y = "Biomarker_ID")
fa_ep <- cbind(fa_ep[, c(1, 37:40, 2:36)])
colnames(fa_ep)[5] <- "Sea_otter_tr"

# Fucus #
fa_fu <- merge(fa_fu, bimrk[, c(1, 2, 3, 4, 7)], by.x = "ID", by.y = "Biomarker_ID")
fa_fu <- cbind(fa_fu[, c(1, 37:40, 2:36)])
colnames(fa_fu)[5] <- "Sea_otter_tr"

# POM #
fa_pm <- merge(fa_pm, bimrk[, c(1, 2, 3, 4, 7)], by.x = "ID", by.y = "Biomarker_ID")
fa_pm <- cbind(fa_pm[, c(1, 37:40, 2:36)])
colnames(fa_pm)[5] <- "Sea_otter_tr"

# Sugar Kelp #
fa_sk <- merge(fa_sk, bimrk[, c(1, 2, 3, 4, 7)], by.x = "ID", by.y = "Biomarker_ID")
fa_sk <- cbind(fa_sk[, c(1, 37:40, 2:36)])
colnames(fa_sk)[5] <- "Sea_otter_tr"

# Ulva #
fa_ul <- merge(fa_ul, bimrk[, c(1, 2, 3, 4, 7)], by.x = "ID", by.y = "Biomarker_ID")
fa_ul <- cbind(fa_ul[, c(1, 37:40, 2:36)])
colnames(fa_ul)[5] <- "Sea_otter_tr"
```

##### Primary Consumers
```{r}
## Primary consumers ##
fa_pcon <- fa %>% 
  filter(Species_common == "Butter clam" | Species_common == "Idotea" | Species_common == "Limpet" | Species_common == "Macoma sp." | Species_common == "Pointed Macoma" | Species_common == "Bentnose Macoma")

# Idotea #
fa_ido <- fa %>% 
  filter(Species_common == "Idotea")

# Limpet #
fa_lmp <- fa %>% 
  filter(Species_common == "Limpet")

# Butter Clams ##
fa_but <- fa %>% 
  filter(Species_common == "Butter clam")

# Macoma Clams #
fa_mac <- fa %>% 
  filter(Species_common == "Macoma sp." | Species_common == "Pointed Macoma" | Species_common == "Bentnose Macoma")
```

Append metadata
```{r}
# Primary consumers #
fa_pcon <- merge(fa_pcon, bimrk[, c(1, 2, 3, 4, 7)], by.x = "ID", by.y = "Biomarker_ID")
fa_pcon <- cbind(fa_pcon[, c(1, 37:40, 2:36)])
colnames(fa_pcon)[5] <- "Sea_otter_tr"

# Idotea #
fa_ido <- merge(fa_ido, bimrk[, c(1, 2, 3, 4, 7)], by.x = "ID", by.y = "Biomarker_ID")
fa_ido <- cbind(fa_ido[, c(1, 37:40, 2:36)])
colnames(fa_ido)[5] <- "Sea_otter_tr"

# Limpet #
fa_lmp <- merge(fa_lmp, bimrk[, c(1, 2, 3, 4, 7)], by.x = "ID", by.y = "Biomarker_ID")
fa_lmp <- cbind(fa_lmp[, c(1, 37:40, 2:36)])
colnames(fa_lmp)[5] <- "Sea_otter_tr"

# Butter Clams #
fa_but <- merge(fa_but, bimrk[, c(1, 2, 3, 4, 7)], by.x = "ID", by.y = "Biomarker_ID")
fa_but <- cbind(fa_but[, c(1, 37:40, 2:36)])
colnames(fa_but)[5] <- "Sea_otter_tr"

# Macoma clams #
fa_mac <- merge(fa_mac, bimrk[, c(1, 2, 3, 4, 7)], by.x = "ID", by.y = "Biomarker_ID")
fa_mac <- cbind(fa_mac[, c(1, 37:40, 2:36)])
colnames(fa_mac)[5] <- "Sea_otter_tr"
```

##### Secondary Consumers
Omitting B_271 - Shiner and B_277 Staghorn due to strange values.
```{r}
## All Secondary Consumers ##
fa_scon <- fa %>% 
  filter(Species_common == "Dock shrimp" | Species_common == "Helmet crab" | Species_common == "Graceful crab" | Species_common == "Shiner perch" | Species_common == "Snake prickleback" | Species_common == "Staghorn sculpin") %>% 
  filter(ID != "B_271") %>% 
  filter(ID != "B_277")

# Dock Shrimp #
fa_dsh <- fa %>% 
  filter(Species_common == "Dock shrimp")

# Helmet crabs #
fa_hel <- fa %>% 
  filter(Species_common == "Helmet crab")

# Graceful crabs #
fa_grc <- fa %>% 
  filter(Species_common == "Graceful crab")

# Shiner Perch #
fa_shn <- fa %>% 
  filter(Species_common == "Shiner perch" & ID != "B_271")

# Snake prickleback #
fa_snk <- fa %>% 
  filter(Species_common == "Snake prickleback")

# Staghorn sculpin #
fa_stg <- fa %>% 
  filter(Species_common == "Staghorn sculpin" & ID != "B_277")
```

```{r}
## All secondary consumers ##
fa_scon <- merge(fa_scon, bimrk[, c(1, 2, 3, 4, 7)], by.x = "ID", by.y = "Biomarker_ID")
fa_scon <- cbind(fa_scon[, c(1, 37:40, 2:36)])
colnames(fa_scon)[5] <- "Sea_otter_tr"

# Doch shrimp #
fa_dsh <- merge(fa_dsh, bimrk[, c(1, 2, 3, 4, 7)], by.x = "ID", by.y = "Biomarker_ID")
fa_dsh <- cbind(fa_dsh[, c(1, 37:40, 2:36)])
colnames(fa_dsh)[5] <- "Sea_otter_tr"

# Helmet crabs #
fa_hel <- merge(fa_hel, bimrk[, c(1, 2, 3, 4, 7)], by.x = "ID", by.y = "Biomarker_ID")
fa_hel <- cbind(fa_hel[, c(1, 37:40, 2:36)])
colnames(fa_hel)[5] <- "Sea_otter_tr"

# Graceful crabs #
fa_grc <- merge(fa_grc, bimrk[, c(1, 2, 3, 4, 7)], by.x = "ID", by.y = "Biomarker_ID")
fa_grc <- cbind(fa_grc[, c(1, 37:40, 2:36)])
colnames(fa_grc)[5] <- "Sea_otter_tr"

# Shiner Perch #
fa_shn <- merge(fa_shn, bimrk[, c(1, 2, 3, 4, 7)], by.x = "ID", by.y = "Biomarker_ID")
fa_shn <- cbind(fa_shn[, c(1, 37:40, 2:36)])
colnames(fa_shn)[5] <- "Sea_otter_tr"

# Snake pricklback #
fa_snk <- merge(fa_snk, bimrk[, c(1, 2, 3, 4, 7)], by.x = "ID", by.y = "Biomarker_ID")
fa_snk <- cbind(fa_snk[, c(1, 37:40, 2:36)])
colnames(fa_snk)[5] <- "Sea_otter_tr"

# Staghorn sculpin #
fa_stg <- merge(fa_stg, bimrk[, c(1, 2, 3, 4, 7)], by.x = "ID", by.y = "Biomarker_ID")
fa_stg <- cbind(fa_stg[, c(1, 37:40, 2:36)])
colnames(fa_stg)[5] <- "Sea_otter_tr"
```

##### Marker FA
Filter data for FA which have known sources.
```{r}
## Specific Markers ##
fa_mrk <- merge(bimrk[, c(1, 2, 3, 4, 7)], fa, by.x = "Biomarker_ID", by.y = "ID")

# clean up species #
fa_mrk$Species_common <- ifelse(fa_mrk$Species_common == "Pointed Macoma", "Macoma sp.", fa_mrk$Species_common)
fa_mrk$Species_common <- ifelse(fa_mrk$Species_common == "Bentnose Macoma", "Macoma sp.", fa_mrk$Species_common)

fa_mrk <- fa_mrk  %>% 
  gather(key = "FA", value = "prop", 11:40) %>% 
  filter(FA %in% famrk$FA) %>%
  filter(Species_common != "Red rock crab") %>% 
  group_by(FA, Sea_otter_region, Species_common) %>% 
  summarize(prop_m = mean(prop),
            prop_sd = sd(prop))

fa_mrk$Species_common <- factor(fa_mrk$Species_common, levels = c("Eelgrass", "Eelgrass diatoms", "Fucus", "Particulate organic matter", "Sugar kelp", "Ulva", "Idotea", "Limpet", "Butter clam", "Macoma sp.", "Dock shrimp", "Helmet crab", "Graceful crab", "Shiner perch", "Snake prickleback", "Staghorn sculpin"))
```

###### FA groups
LC-PUFAs, 18C EFA, omega-3 and omega-6, PUFA, Bacterial

Make groups
```{r}
## Make groups ##
LCPUFA <- c("C20.5w3", "C22.6w3", "C20.4w6")
ALA.LIN <- c("C18.2w6", "C18.3w3")
C18PUFA <- c("C18.3w6", "C18.4w3")
OM3 <- names(fa[str_detect(names(fa), "w3")])
OM6 <- names(fa[str_detect(names(fa), "w6")])
OM3.6 <- names(fa[str_detect(names(fa), paste(c("w3", "w6"), collapse = "|"))])
PUFA <- names(fa[str_detect(names(fa), paste(c(".2w", ".3w", ".4w", ".5w", ".6w"), collapse = "|"))])
BAC <- c("C16.1w7", "C18.1w7", "a.C17.0", "i.C17.0")
```

Make comparisons
```{r}
fa_mrk <- merge(bimrk[, c(1, 2, 3, 4, 7)], fa, by.x = "Biomarker_ID", by.y = "ID")
fa_mrk$EPA.DHA <- fa_mrk$C20.5w3 / fa_mrk$C22.6w3

# clean up species #
fa_mrk$Species_common <- ifelse(fa_mrk$Species_common == "Pointed Macoma", "Macoma sp.", fa_mrk$Species_common)
fa_mrk$Species_common <- ifelse(fa_mrk$Species_common == "Bentnose Macoma", "Macoma sp.", fa_mrk$Species_common)

fa_tll <- fa_mrk  %>% 
  gather(key = "FA", value = "prop", 11:41) %>% 
  filter(Species_common != "Red rock crab")

## ALA.LIN ##
fa_ALA.LIN_all <- fa_tll %>% 
  filter(FA %in% ALA.LIN) %>% 
  group_by(Biomarker_ID) %>% 
  summarize(prop_sum = sum(prop))

fa_ALA.LIN_all <- merge(unique(fa_tll[, 1:10]), fa_ALA.LIN_all, by = "Biomarker_ID")
fa_ALA.LIN_all$FA_grp  <- "ALA.LIN" 

fa_ALA.LIN <- fa_ALA.LIN_all %>% 
  group_by(Sea_otter_region, Species_common) %>% 
  summarize(prop_sum_m = mean(prop_sum),
            prop_sum_sd = sd(prop_sum))
fa_ALA.LIN$FA_grp <- "ALA.LIN"

## C18PUFA ##
fa_C18PUFA_all <- fa_tll %>% 
  filter(FA %in% C18PUFA) %>% 
  group_by(Biomarker_ID) %>% 
  summarize(prop_sum = sum(prop))

fa_C18PUFA_all <- merge(unique(fa_tll[, 1:10]), fa_C18PUFA_all, by = "Biomarker_ID")
fa_C18PUFA_all$FA_grp  <- "C18PUFA" 

fa_C18PUFA <- fa_C18PUFA_all %>% 
  group_by(Sea_otter_region, Species_common) %>% 
  summarize(prop_sum_m = mean(prop_sum),
            prop_sum_sd = sd(prop_sum))
fa_C18PUFA$FA_grp <- "C18PUFA"

## PUFA ##
fa_PUFA_all <- fa_tll %>% 
  filter(FA %in% PUFA) %>% 
  group_by(Biomarker_ID) %>% 
  summarize(prop_sum = sum(prop))

fa_PUFA_all <- merge(unique(fa_tll[, 1:10]), fa_PUFA_all, by = "Biomarker_ID")
fa_PUFA_all$FA_grp  <- "PUFA"

fa_PUFA <- fa_PUFA_all %>% 
  group_by(Sea_otter_region, Species_common) %>% 
  summarize(prop_sum_m = mean(prop_sum),
            prop_sum_sd = sd(prop_sum))
fa_PUFA$FA_grp <- "PUFA"

## BAC ##
fa_BAC_all <- fa_tll %>% 
  filter(FA %in% BAC) %>% 
  group_by(Biomarker_ID) %>% 
  summarize(prop_sum = sum(prop))

fa_BAC_all <- merge(unique(fa_tll[, 1:10]), fa_BAC_all, by = "Biomarker_ID")
fa_BAC_all$FA_grp  <- "BAC"

fa_BAC <- fa_BAC_all %>% 
  group_by(Sea_otter_region, Species_common) %>% 
  summarize(prop_sum_m = mean(prop_sum),
            prop_sum_sd = sd(prop_sum))
fa_BAC$FA_grp <- "BAC"

## PAL ##
fa_PAL_all <- fa_tll %>% 
  filter(FA == "C16.1w7")
colnames(fa_PAL_all)[11] <- "FA_grp"
colnames(fa_PAL_all)[12] <- "prop_sum"

fa_PAL_all <- cbind(fa_PAL_all[, c(1:10, 12, 11)])

fa_PAL <- fa_tll %>% 
  filter(FA == "C16.1w7") %>% 
  group_by(Sea_otter_region, Species_common) %>% 
  summarize(prop_sum_m = mean(prop),
            prop_sum_sd = sd(prop))
fa_PAL$FA_grp <- "PAL"

## ARA ##
fa_ARA_all <- fa_tll %>% 
  filter(FA == "C20.4w6")
colnames(fa_ARA_all)[11] <- "FA_grp"
colnames(fa_ARA_all)[12] <- "prop_sum"

fa_ARA_all <- cbind(fa_ARA_all[, c(1:10, 12, 11)])

fa_ARA <- fa_tll %>% 
  filter(FA == "C20.4w6") %>% 
  group_by(Sea_otter_region, Species_common) %>% 
  summarize(prop_sum_m = mean(prop),
            prop_sum_sd = sd(prop))
fa_ARA$FA_grp <- "ARA"

## EPA ##
fa_EPA_all <- fa_tll %>% 
  filter(FA == "C20.5w3")
colnames(fa_EPA_all)[11] <- "FA_grp"
colnames(fa_EPA_all)[12] <- "prop_sum"

fa_EPA_all <- cbind(fa_EPA_all[, c(1:10, 12, 11)])

fa_EPA <- fa_tll %>% 
  filter(FA == "C20.5w3") %>% 
  group_by(Sea_otter_region, Species_common) %>% 
  summarize(prop_sum_m = mean(prop),
            prop_sum_sd = sd(prop))
fa_EPA$FA_grp <- "EPA"

## DHA ##
fa_DHA_all <- fa_tll %>% 
  filter(FA == "C22.6w3")
colnames(fa_DHA_all)[11] <- "FA_grp"
colnames(fa_DHA_all)[12] <- "prop_sum"

fa_DHA_all <- cbind(fa_DHA_all[, c(1:10, 12, 11)])

fa_DHA <- fa_tll %>% 
  filter(FA == "C22.6w3") %>% 
  group_by(Sea_otter_region, Species_common) %>% 
  summarize(prop_sum_m = mean(prop),
            prop_sum_sd = sd(prop))
fa_DHA$FA_grp <- "DHA"

## All together now - for t.test ##
fa_grp_all <- rbind(fa_BAC_all, fa_ALA.LIN_all, fa_C18PUFA_all, fa_PUFA_all, fa_PAL_all, fa_ARA_all, fa_EPA_all, fa_DHA_all)

## All together now - for plots ##
fa_grp <- rbind(fa_BAC, fa_ALA.LIN, fa_C18PUFA, fa_PUFA, fa_PAL, fa_ARA, fa_EPA, fa_DHA)
fa_grp$FA_grp <- factor(fa_grp$FA_grp, levels = c("BAC", "ALA.LIN", "C18PUFA", "PUFA", "PAL", "ARA", "EPA", "DHA"))
fa_grp$Species_common <- factor(fa_grp$Species_common, levels = c("Eelgrass", "Eelgrass diatoms", "Fucus", "Particulate organic matter", "Sugar kelp", "Ulva", "Idotea", "Limpet", "Butter clam", "Macoma sp.", "Dock shrimp", "Helmet crab", "Graceful crab", "Shiner perch", "Snake prickleback", "Staghorn sculpin"))

fa_grp_high_wide <- fa_grp %>% 
  dplyr::select(-prop_sum_sd) %>% 
  filter(Sea_otter_region == "High") %>% 
  spread(key = FA_grp, value = prop_sum_m)
fa_grp_high_wide[, 3:10] <- round(fa_grp_high_wide[, 3:10], 3)

fa_grp_low_wide <- fa_grp %>% 
  dplyr::select(-prop_sum_sd) %>% 
  filter(Sea_otter_region == "Low") %>% 
  spread(key = FA_grp, value = prop_sum_m, 3)
fa_grp_low_wide[, 3:10] <- round(fa_grp_low_wide[, 3:10], 3)
  
fa_grp_high_sd_wide <- fa_grp %>% 
  dplyr::select(-prop_sum_m) %>% 
  filter(Sea_otter_region == "High") %>% 
  spread(key = FA_grp, value = prop_sum_sd)
fa_grp_high_sd_wide[, 3:10] <- round(fa_grp_high_sd_wide[, 3:10], 3)

fa_grp_low_sd_wide <- fa_grp %>% 
  dplyr::select(-prop_sum_m) %>% 
  filter(Sea_otter_region == "Low") %>% 
  spread(key = FA_grp, value = prop_sum_sd)
fa_grp_low_sd_wide[, 3:10] <- round(fa_grp_low_sd_wide[, 3:10], 3)
```

T.tests
```{r}
## ALA.LIN ##
ALA.LIN.ttest <- fa_ALA.LIN_all %>% 
  group_by(Species_common) %>% 
  do(broom::tidy(t.test(prop_sum ~ Sea_otter_region, data = .)))
ALA.LIN.ttest$FA_grp <- "ALA.LIN"

## C18PUFA ##
C18PUFA.ttest <- fa_C18PUFA_all %>% 
  group_by(Species_common) %>% 
  do(broom::tidy(t.test(prop_sum ~ Sea_otter_region, data = .)))
C18PUFA.ttest$FA_grp <- "C18PUFA"

## PUFA ##
PUFA.ttest <- fa_PUFA_all %>% 
  group_by(Species_common) %>% 
  do(broom::tidy(t.test(prop_sum ~ Sea_otter_region, data = .)))
PUFA.ttest$FA_grp <- "PUFA"

## BAC ##
BAC.ttest <- fa_BAC_all %>% 
  group_by(Species_common) %>% 
  do(broom::tidy(t.test(prop_sum ~ Sea_otter_region, data = .)))
BAC.ttest$FA_grp <- "BAC"

## PAL ##
PAL.ttest <- fa_PAL_all %>% 
  group_by(Species_common) %>% 
  do(broom::tidy(t.test(prop_sum ~ Sea_otter_region, data = .)))
PAL.ttest$FA_grp <- "PAL"

## ARA ##
ARA.ttest <- fa_ARA_all %>% 
  group_by(Species_common) %>% 
  do(broom::tidy(t.test(prop_sum ~ Sea_otter_region, data = .)))
ARA.ttest$FA_grp <- "ARA"

## EPA ##
EPA.ttest <- fa_EPA_all %>% 
  group_by(Species_common) %>% 
  do(broom::tidy(t.test(prop_sum ~ Sea_otter_region, data = .)))
EPA.ttest$FA_grp <- "EPA"

## DHA ##
DHA.ttest <- fa_DHA_all %>% 
  group_by(Species_common) %>% 
  do(broom::tidy(t.test(prop_sum ~ Sea_otter_region, data = .)))
DHA.ttest$FA_grp <- "DHA"

## Clean up ##
fa_grp_ttest <- rbind(ALA.LIN.ttest, C18PUFA.ttest, PUFA.ttest, BAC.ttest, PAL.ttest, ARA.ttest, EPA.ttest, DHA.ttest)

fa_grp_ttest_p <- fa_grp_ttest[, c(1, 6, 12)]
fa_grp_ttest_p$p.value <- round(fa_grp_ttest_p$p.value, 3)
fa_grp_ttest_p$FA_grp <- factor(fa_grp_ttest_p$FA_grp, levels = c("BAC", "ALA.LIN", "C18PUFA", "PUFA", "PAL", "ARA", "EPA", "DHA"))
fa_grp_ttest_p$Species_common <- factor(fa_grp_ttest_p$Species_common, levels = c("Eelgrass", "Eelgrass diatoms", "Fucus", "Particulate organic matter", "Sugar kelp", "Ulva", "Idotea", "Limpet", "Butter clam", "Macoma sp.", "Dock shrimp", "Helmet crab", "Graceful crab", "Shiner perch", "Snake prickleback", "Staghorn sculpin"))
fa_grp_ttest_p <- tidyr::spread(fa_grp_ttest_p, key = FA_grp, value = p.value)

fa_grp_ttest_t <- fa_grp_ttest[, c(1, 5, 12)]
fa_grp_ttest_t$statistic <- round(fa_grp_ttest_t$statistic, 3)
fa_grp_ttest_t$FA_grp <- factor(fa_grp_ttest_t$FA_grp, levels = c("BAC", "ALA.LIN", "C18PUFA", "PUFA", "PAL", "ARA", "EPA", "DHA"))
fa_grp_ttest_t$Species_common <- factor(fa_grp_ttest_t$Species_common, levels = c("Eelgrass", "Eelgrass diatoms", "Fucus", "Particulate organic matter", "Sugar kelp", "Ulva", "Idotea", "Limpet", "Butter clam", "Macoma sp.", "Dock shrimp", "Helmet crab", "Graceful crab", "Shiner perch", "Snake prickleback", "Staghorn sculpin"))
fa_grp_ttest_t <- tidyr::spread(fa_grp_ttest_t, key = FA_grp, value = statistic)
```

Plots
```{r}
ggplot(fa_grp, aes(x = FA_grp, y = prop_sum_m, fill = Sea_otter_region)) +
  geom_bar(position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(ymin = prop_sum_m - prop_sum_sd, ymax = prop_sum_m + prop_sum_sd), width = 0, position = position_dodge(.9)) +
  scale_fill_manual("Sea otter \n region", c("High", "Low"), values = so.pal) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_y_continuous(limits = c(-0.1, 0.6), breaks = seq(0, 0.6, by = 0.2)) +
  xlab("Fatty acid") +
  ylab("Mean Proportion") +
  facet_wrap(~Species_common, scales = "free_x")
```

##### Transformations
I will use and arcsine sqrt transformation.
```{r fa trans std, echo = FALSE}
## Primary Producers ##
fa_pro_trs <- asin(sqrt(fa_pro[, 11:40]))
fa_eg_trs <- asin(sqrt(fa_eg[, 11:40]))
fa_ep_trs <- asin(sqrt(fa_ep[, 11:40]))
fa_fu_trs <- asin(sqrt(fa_fu[, 11:40]))
fa_pm_trs <- asin(sqrt(fa_pm[, 11:40]))
fa_sk_trs <- asin(sqrt(fa_sk[, 11:40]))
fa_ul_trs <- asin(sqrt(fa_ul[, 11:40]))

## Primary Consumers ##
fa_pcon_trs <- asin(sqrt(fa_pcon[, 11:40]))
fa_ido_trs <- asin(sqrt(fa_ido[, 11:40]))
fa_lmp_trs <- asin(sqrt(fa_lmp[, 11:40]))
fa_but_trs <- asin(sqrt(fa_but[, 11:40]))
fa_mac_trs <- asin(sqrt(fa_mac[, 11:40]))

## Secondary consumers ##
fa_scon_trs <- asin(sqrt(fa_scon[, 11:40]))
fa_dsh_trs <- asin(sqrt(fa_dsh[, 11:40]))
fa_hel_trs <- asin(sqrt(fa_hel[, 11:40]))
fa_grc_trs <- asin(sqrt(fa_grc[, 11:40]))
fa_shn_trs <- asin(sqrt(fa_shn[, 11:40]))
fa_snk_trs <- asin(sqrt(fa_snk[, 11:40]))
fa_stg_trs <- asin(sqrt(fa_stg[, 11:40]))
```

#### Ordination
Calculate distances
```{r dist, echo = FALSE}
## Primary Producers ##
fa_pro_dist <- vegdist(fa_pro_trs, method = "euclidean")
fa_eg_dist <- vegdist(fa_eg_trs, method = "euclidean")
fa_ep_dist <- vegdist(fa_ep_trs, method = "euclidean")
fa_fu_dist <- vegdist(fa_fu_trs, method = "euclidean")
fa_pm_dist <- vegdist(fa_pm_trs, method = "euclidean")
fa_sk_dist <- vegdist(fa_sk_trs, method = "euclidean")
fa_ul_dist <- vegdist(fa_ul_trs, method = "euclidean")

## Primary Consumers ##
fa_pcon_dist <- vegdist(fa_pcon_trs, method = "euclidean")
fa_ido_dist <- vegdist(fa_ido_trs, method = "euclidean")
fa_lmp_dist <- vegdist(fa_lmp_trs, method = "euclidean")
fa_but_dist <- vegdist(fa_but_trs, method = "euclidean")
fa_mac_dist <- vegdist(fa_mac_trs, method = "euclidean")

## Secondary Consumers ##
fa_scon_dist <- vegdist(fa_scon_trs, method = "euclidean")
fa_dsh_dist <- vegdist(fa_dsh_trs, method = "euclidean")
fa_hel_dist <- vegdist(fa_hel_trs, method = "euclidean")
fa_grc_dist <- vegdist(fa_grc_trs, method = "euclidean")
fa_shn_dist <- vegdist(fa_shn_trs, method = "euclidean")
fa_snk_dist <- vegdist(fa_snk_trs, method = "euclidean")
fa_stg_dist <- vegdist(fa_stg_trs, method = "euclidean")
```

#### PERMANOVA
Test for the effect of sea otter nested by species. Then within species sea otter tests.

##### Primary Producers
```{r permanova, echo = FLASE}
## Producers ##
# Eelgrass #
perm.eg <- adonis2(fa_eg_dist ~ Sea_otter_tr, data = fa_eg, perm = 9999) 
perm.eg

# Epiphytes #
perm.ep <- adonis2(fa_ep_dist ~ Sea_otter_tr, data = fa_ep, perm = 9999) 
perm.ep

# Fucus #
perm.fu <- adonis2(fa_fu_dist ~ Sea_otter_tr, data = fa_fu, perm = 9999)
perm.fu

# POM #
perm.pm <- adonis2(fa_pm_dist ~ Sea_otter_tr, data = fa_pm, perm = 9999)
perm.pm

# Sugar kelp #
perm.sk <- adonis2(fa_sk_dist ~ Sea_otter_tr, data = fa_sk, perm = 9999)
perm.sk

# Ulva #
perm.ul <- adonis2(fa_ul_dist ~ Sea_otter_tr, data = fa_ul, perm = 9999)
perm.ul
```

##### Primary Consumers
```{r}
## All primary consumers ##
# Idotea #
perm.ido <- adonis2(fa_ido_dist ~ Sea_otter_tr, data = fa_ido, perm = 9999)
perm.ido

# Limpet #
perm.lmp <- adonis2(fa_lmp_dist ~ Sea_otter_tr, data = fa_lmp, perm = 9999)
perm.lmp

# Butter clam #
perm.but <- adonis2(fa_but_dist ~ Sea_otter_tr, data = fa_but, perm = 9999)
perm.but

# Macoma clam #
perm.mac <- adonis2(fa_mac_dist ~ Sea_otter_tr, data = fa_mac, perm = 9999)
perm.mac
```

##### Secondary Consumers
```{r}
## All secondary consumers ##
# Dock shrimp #
perm.dsh <- adonis2(fa_dsh_dist ~ Sea_otter_tr, data = fa_dsh, perm = 9999)
perm.dsh

# Helmet crabs #
perm.hel <- adonis2(fa_hel_dist ~ Sea_otter_tr, data = fa_hel, perm = 9999)
perm.hel

# Graceful crabs #
perm.grc <- adonis2(fa_grc_dist ~ Sea_otter_tr, data = fa_grc, perm = 9999)
perm.grc

# Shiner perch #
perm.shn <- adonis2(fa_shn_dist ~ Sea_otter_tr, data = fa_shn, perm = 9999)
perm.shn

# Snake prickleback
perm.snk <- adonis2(fa_snk_dist ~ Sea_otter_tr, data = fa_snk, perm = 9999)
perm.snk

# Staghorn sculpin #
perm.stg <- adonis2(fa_stg_dist ~ Sea_otter_tr, data = fa_stg, perm = 9999)
perm.stg
```

#### SIMPER
Calcualte on untransformed data. Also remove the undetermined FAs because the are sums of multiple FAs.

Identify any undetermined FAs. 17:3w is the only undetermined FA. Turns our it only occurs in POM. 
```{r}
colnames(fa[, 7:37])
```

##### Data prep
Remove undetermined FA from *untranformed* FA data. * NOTE * Run initial FA data preperation lines BEFORE these so that the correct subset is used.
```{r}
## Primary Producers ##
# Eelgrass #
fa_eg_simp <- fa_eg 

# Eelgrass diatoms / epiphytes #
fa_ep_simp <- fa_ep %>%
  dplyr::select(- C17.3w)

# Fucus #
fa_fu_simp <- fa_fu %>%
  dplyr::select(- C17.3w)

# POM #
fa_pm_simp <- fa_pm %>%
  dplyr::select(- C17.3w)

# Sugar Kelp #
fa_sk_simp <- fa_sk %>%
  dplyr::select(- C17.3w)

# Ulva #
fa_ul_simp <- fa_ul %>%
  dplyr::select(- C17.3w)

## Primary Consumers ##
# Idotea #
fa_ido_simp <- fa_ido %>%
  dplyr::select(- C17.3w)

# Limpet #
fa_lmp_simp <- fa_lmp %>%
  dplyr::select(- C17.3w)

# Butter Clams ##
fa_but_simp <- fa_but %>%
  dplyr::select(- C17.3w)

# Macoma Clams #
fa_mac_simp <- fa_mac %>%
  dplyr::select(- C17.3w)

## Secondary Consumers ##
# Dock Shrimp #
fa_dsh_simp <- fa_dsh %>%
  dplyr::select(- C17.3w)

# Helmet crabs #
fa_hel_simp <- fa_hel %>%
  dplyr::select(- C17.3w)

# Graceful crabs #
fa_grc_simp <- fa_grc %>%
  dplyr::select(- C17.3w)

# Shiner Perch #
fa_shn_simp <- fa_shn %>%
  dplyr::select(- C17.3w)

# Snake prickleback #
fa_snk_simp <- fa_snk %>%
  dplyr::select(- C17.3w)

# Staghorn sculpin #
fa_stg_simp <- fa_stg %>%
  dplyr::select(- C17.3w)
```

###### Primary Producers
```{r}
## Eelgrass ##
simp.eg <- simper(fa_eg_simp[, 11:40], fa_eg_simp$Sea_otter_tr, permutations = 9999)
simp.eg.dat <- summary(simp.eg, ordered = TRUE, digits = 4)
simp.eg.dat <- data.frame(simp.eg.dat$Low_High)
simp.eg.dat$FA <- row.names(simp.eg.dat)
simp.eg.dat$average_scaled <- simp.eg.dat$average / sum(simp.eg.dat$average)
simp.eg.dat$taxa <- "Eelgrass"

simp.eg.redu <- simp.eg.dat %>% 
  filter(cumsum <= 0.9) %>% 
  dplyr::select(FA, ava, avb, average, sd, cumsum, p) %>% 
  mutate_if(is.numeric, round, 4) %>% 
  mutate(ava = ava * 100) %>% 
  mutate(avb = avb * 100) %>% 
  mutate(average = average * 100) %>% 
  mutate(sd = sd * 100) %>% 
  mutate(cumsum = cumsum * 100) %>% 
  rename("Low" = ava) %>% 
  rename("High" = avb)

## Epiphytes ##
simp.ep <- simper(fa_ep_simp[, 11:40], fa_ep_simp$Sea_otter_tr, permutations = 9999)
simp.ep.dat <- summary(simp.ep, ordered = TRUE, digits = 4)
simp.ep.dat <- data.frame(simp.ep.dat$High_Low)
simp.ep.dat$FA <- row.names(simp.ep.dat)
simp.ep.dat$average_scaled <- simp.ep.dat$average / sum(simp.ep.dat$average)
simp.ep$High_Low$overall
simp.ep.dat$taxa <- "Epiphytes"

simp.ep.redu <- simp.ep.dat %>% 
  filter(cumsum <= 0.9) %>% 
  dplyr::select(FA, ava, avb, average, sd, cumsum, p) %>% 
  mutate_if(is.numeric, round, 4) %>% 
  mutate(ava = ava * 100) %>% 
  mutate(avb = avb * 100) %>% 
  mutate(average = average * 100) %>% 
  mutate(sd = sd * 100) %>% 
  mutate(cumsum = cumsum * 100) %>% 
  rename("High" = ava) %>% 
  rename("Low" = avb)

## Fucus ##
simp.fu <- simper(fa_fu_simp[, 11:40], fa_fu_simp$Sea_otter_tr, permutations = 9999)
simp.fu.dat <- summary(simp.fu, ordered = TRUE, digits = 4)
simp.fu.dat <- data.frame(simp.fu.dat$Low_High)
simp.fu.dat$FA <- row.names(simp.fu.dat)
simp.fu.dat$average_scaled <- simp.fu.dat$average / sum(simp.fu.dat$average)
simp.fu$Low_High$overall
simp.fu.dat$taxa <- "Fucus"

simp.fu.redu <- simp.fu.dat %>% 
  filter(cumsum <= 0.9) %>% 
  dplyr::select(FA, ava, avb, average, sd, cumsum, p) %>% 
  mutate_if(is.numeric, round, 4) %>% 
  mutate(ava = ava * 100) %>% 
  mutate(avb = avb * 100) %>% 
  mutate(average = average * 100) %>% 
  mutate(sd = sd * 100) %>% 
  mutate(cumsum = cumsum * 100) %>% 
  rename("Low" = ava) %>% 
  rename("High" = avb)

## POM ##
simp.pm <- simper(fa_pm_simp[, 11:40], fa_pm_simp$Sea_otter_tr, permutations = 9999)
simp.pm.dat <- summary(simp.pm, ordered = TRUE, digits = 4)
simp.pm.dat <- data.frame(simp.pm.dat$Low_High)
simp.pm.dat$FA <- row.names(simp.pm.dat)
simp.pm.dat$average_scaled <- simp.pm.dat$average / sum(simp.pm.dat$average)
simp.pm$Low_High$overall
simp.pm.dat$taxa <- "POM"

simp.pm.redu <- simp.pm.dat %>% 
  filter(cumsum <= 0.9) %>% 
  dplyr::select(FA, ava, avb, average, sd, cumsum, p) %>% 
  mutate_if(is.numeric, round, 4) %>% 
  mutate(ava = ava * 100) %>% 
  mutate(avb = avb * 100) %>% 
  mutate(average = average * 100) %>% 
  mutate(sd = sd * 100) %>% 
  mutate(cumsum = cumsum * 100) %>% 
  rename("Low" = ava) %>% 
  rename("High" = avb)

## Sugar kelp ##
simp.sk <- simper(fa_sk_simp[, 11:40], fa_sk_simp$Sea_otter_tr, permutations = 9999)
simp.sk.dat <- summary(simp.sk, ordered = TRUE, digits = 4)
simp.sk.dat <- data.frame(simp.sk.dat$Low_High)
simp.sk.dat$FA <- row.names(simp.sk.dat)
simp.sk.dat$average_scaled <- simp.sk.dat$average / sum(simp.sk.dat$average)
simp.sk$Low_High$overall
simp.sk.dat$taxa <- "Sugar kelp"

simp.sk.redu <- simp.sk.dat %>% 
  filter(cumsum <= 0.9) %>% 
  dplyr::select(FA, ava, avb, average, sd, cumsum, p) %>% 
  mutate_if(is.numeric, round, 4) %>% 
  mutate(ava = ava * 100) %>% 
  mutate(avb = avb * 100) %>% 
  mutate(average = average * 100) %>% 
  mutate(sd = sd * 100) %>% 
  mutate(cumsum = cumsum * 100) %>% 
  rename("Low" = ava) %>% 
  rename("High" = avb)

## Ulva ##
simp.ul <- simper(fa_ul_simp[, 11:40], fa_ul_simp$Sea_otter_tr, permutations = 9999)
simp.ul.dat <- summary(simp.ul, ordered = TRUE, digits = 4)
simp.ul.dat <- data.frame(simp.ul.dat$Low_High)
simp.ul.dat$FA <- row.names(simp.ul.dat)
simp.ul.dat$average_scaled <- simp.ul.dat$average / sum(simp.ul.dat$average)
simp.ul$Low_High$overall
simp.ul.dat$taxa <- "Ulva"

simp.ul.redu <- simp.ul.dat %>% 
  filter(cumsum <= 0.9) %>% 
  dplyr::select(FA, ava, avb, average, sd, cumsum, p) %>% 
  mutate_if(is.numeric, round, 4) %>% 
  mutate(ava = ava * 100) %>% 
  mutate(avb = avb * 100) %>% 
  mutate(average = average * 100) %>% 
  mutate(sd = sd * 100) %>% 
  mutate(cumsum = cumsum * 100) %>% 
  rename("Low" = ava) %>% 
  rename("High" = avb)
```

###### Primary Consumers
```{r}
## Idotea ##
simp.ido <- simper(fa_ido_simp[, 11:40], fa_ido_simp$Sea_otter_tr, permutations = 9999)
simp.ido.dat <- summary(simp.ido, ordered = TRUE, digits = 4)
simp.ido.dat <- data.frame(simp.ido.dat$Low_High)
simp.ido.dat$FA <- row.names(simp.ido.dat)
simp.ido.dat$average_scaled <- simp.ido.dat$average / sum(simp.ido.dat$average)
simp.ido$Low_High$overall
simp.ido.dat$taxa <- "Idotea"

simp.ido.redu <- simp.ido.dat %>% 
  filter(cumsum <= 0.9) %>% 
  dplyr::select(FA, ava, avb, average, sd, cumsum, p) %>% 
  mutate_if(is.numeric, round, 4) %>% 
  mutate(ava = ava * 100) %>% 
  mutate(avb = avb * 100) %>% 
  mutate(average = average * 100) %>% 
  mutate(sd = sd * 100) %>% 
  mutate(cumsum = cumsum * 100) %>% 
  rename("Low" = ava) %>% 
  rename("High" = avb)

## Limpets ##
simp.lmp <- simper(fa_lmp_simp[, 11:40], fa_lmp_simp$Sea_otter_tr, permutations = 9999)
simp.lmp.dat <- summary(simp.lmp, ordered = TRUE, digits = 4)
simp.lmp.dat <- data.frame(simp.lmp.dat$Low_High)
simp.lmp.dat$FA <- row.names(simp.lmp.dat)
simp.lmp.dat$average_scaled <- simp.lmp.dat$average / sum(simp.lmp.dat$average)
simp.lmp$Low_High$overall
simp.lmp.dat$taxa <- "Limpet"

simp.lmp.redu <- simp.lmp.dat %>% 
  filter(cumsum <= 0.9) %>% 
  dplyr::select(FA, ava, avb, average, sd, cumsum, p) %>% 
  mutate_if(is.numeric, round, 4) %>% 
  mutate(ava = ava * 100) %>% 
  mutate(avb = avb * 100) %>% 
  mutate(average = average * 100) %>% 
  mutate(sd = sd * 100) %>% 
  mutate(cumsum = cumsum * 100) %>% 
  rename("Low" = ava) %>% 
  rename("High" = avb)

# Butter clams #
simp.but <- simper(fa_but_simp[, 11:40], fa_but_simp$Sea_otter_tr, permutations = 9999)
simp.but.dat <- summary(simp.but, ordered = TRUE, digits = 4)
simp.but.dat <- data.frame(simp.but.dat$Low_High)
simp.but.dat$FA <- row.names(simp.but.dat)
simp.but.dat$average_scaled <- simp.but.dat$average / sum(simp.but.dat$average)
simp.but$Low_High$overall
simp.but.dat$taxa <- "Butter clam"

simp.but.redu <- simp.but.dat %>% 
  filter(cumsum <= 0.9) %>% 
  dplyr::select(FA, ava, avb, average, sd, cumsum, p) %>% 
  mutate_if(is.numeric, round, 4) %>% 
  mutate(ava = ava * 100) %>% 
  mutate(avb = avb * 100) %>% 
  mutate(average = average * 100) %>% 
  mutate(sd = sd * 100) %>% 
  mutate(cumsum = cumsum * 100) %>% 
  rename("Low" = ava) %>% 
  rename("High" = avb)

# Macoma sp #
simp.mac <- simper(fa_mac_simp[, 11:40], fa_mac_simp$Sea_otter_tr, permutations = 9999)
simp.mac.dat <- summary(simp.mac, ordered = TRUE, digits = 4)
simp.mac.dat <- data.frame(simp.mac.dat$Low_High)
simp.mac.dat$FA <- row.names(simp.mac.dat)
simp.mac.dat$average_scaled <- simp.mac.dat$average / sum(simp.mac.dat$average)
simp.mac$Low_High$overall
simp.mac.dat$taxa <- "Macoma sp."

simp.mac.redu <- simp.mac.dat %>% 
  filter(cumsum <= 0.9) %>% 
  dplyr::select(FA, ava, avb, average, sd, cumsum, p) %>% 
  mutate_if(is.numeric, round, 4) %>% 
  mutate(ava = ava * 100) %>% 
  mutate(avb = avb * 100) %>% 
  mutate(average = average * 100) %>% 
  mutate(sd = sd * 100) %>% 
  mutate(cumsum = cumsum * 100) %>% 
  rename("Low" = ava) %>% 
  rename("High" = avb)
```

###### Secondary consumers
```{r}
## Dock shrimp ##
simp.dsh <- simper(fa_dsh_simp[, 11:40], fa_dsh_simp$Sea_otter_tr, permutations = 9999)
simp.dsh.dat <- summary(simp.dsh, ordered = TRUE, digits = 4)
simp.dsh.dat <- data.frame(simp.dsh.dat$Low_High)
simp.dsh.dat$FA <- row.names(simp.dsh.dat)
simp.dsh.dat$average_scaled <- simp.dsh.dat$average / sum(simp.dsh.dat$average)
simp.dsh$Low_High$overall
simp.dsh.dat$taxa <- "Dock shrimp"

simp.dsh.redu <- simp.dsh.dat %>% 
  filter(cumsum <= 0.9) %>% 
  dplyr::select(FA, ava, avb, average, sd, cumsum, p) %>% 
  mutate_if(is.numeric, round, 4) %>% 
  mutate(ava = ava * 100) %>% 
  mutate(avb = avb * 100) %>% 
  mutate(average = average * 100) %>% 
  mutate(sd = sd * 100) %>% 
  mutate(cumsum = cumsum * 100) %>% 
  rename("Low" = ava) %>% 
  rename("High" = avb)

## Helmet crabs ##
simp.hel <- simper(fa_hel_simp[, 11:40], fa_hel_simp$Sea_otter_tr, permutations = 9999)
simp.hel.dat <- summary(simp.hel, ordered = TRUE, digits = 4)
simp.hel.dat <- data.frame(simp.hel.dat$Low_High)
simp.hel.dat$FA <- row.names(simp.hel.dat)
simp.hel.dat$average_scaled <- simp.hel.dat$average / sum(simp.hel.dat$average)
simp.hel$Low_High$overall
simp.hel.dat$taxa <- "Helmet crab"

simp.hel.redu <- simp.hel.dat %>% 
  filter(cumsum <= 0.9) %>% 
  dplyr::select(FA, ava, avb, average, sd, cumsum, p) %>% 
  mutate_if(is.numeric, round, 4) %>% 
  mutate(ava = ava * 100) %>% 
  mutate(avb = avb * 100) %>% 
  mutate(average = average * 100) %>% 
  mutate(sd = sd * 100) %>% 
  mutate(cumsum = cumsum * 100) %>% 
  rename("Low" = ava) %>% 
  rename("High" = avb)

## Graceful crabs ##
simp.grc <- simper(fa_grc_simp[, 11:40], fa_grc_simp$Sea_otter_tr, permutations = 9999)
simp.grc.dat <- summary(simp.grc, ordered = TRUE, digits = 4)
simp.grc.dat <- data.frame(simp.grc.dat$Low_High)
simp.grc.dat$FA <- row.names(simp.grc.dat)
simp.grc.dat$average_scaled <- simp.grc.dat$average / sum(simp.grc.dat$average)
simp.grc$Low_High$overall
simp.grc.dat$taxa <- "Graceful crab"

simp.grc.redu <- simp.grc.dat %>% 
  filter(cumsum <= 0.9) %>% 
  dplyr::select(FA, ava, avb, average, sd, cumsum, p) %>% 
  mutate_if(is.numeric, round, 4) %>% 
  mutate(ava = ava * 100) %>% 
  mutate(avb = avb * 100) %>% 
  mutate(average = average * 100) %>% 
  mutate(sd = sd * 100) %>% 
  mutate(cumsum = cumsum * 100) %>% 
  rename("Low" = ava) %>% 
  rename("High" = avb)

## Shiner perch ##
simp.shn <- simper(fa_shn_simp[, 11:40], fa_shn_simp$Sea_otter_tr, permutations = 9999)
simp.shn.dat <- summary(simp.shn, ordered = TRUE, digits = 4)
simp.shn.dat <- data.frame(simp.shn.dat$Low_High)
simp.shn.dat$FA <- row.names(simp.shn.dat)
simp.shn.dat$average_scaled <- simp.shn.dat$average / sum(simp.shn.dat$average)
simp.shn$Low_High$overall
simp.shn.dat$taxa <- "Shiner perch"

simp.shn.redu <- simp.shn.dat %>% 
  filter(cumsum <= 0.9) %>% 
  dplyr::select(FA, ava, avb, average, sd, cumsum, p) %>% 
  mutate_if(is.numeric, round, 4) %>% 
  mutate(ava = ava * 100) %>% 
  mutate(avb = avb * 100) %>% 
  mutate(average = average * 100) %>% 
  mutate(sd = sd * 100) %>% 
  mutate(cumsum = cumsum * 100) %>% 
  rename("Low" = ava) %>% 
  rename("High" = avb)

## Snake prickleback ##
simp.snk <- simper(fa_snk_simp[, 11:40], fa_snk_simp$Sea_otter_tr, permutations = 9999)
simp.snk.dat <- summary(simp.snk, ordered = TRUE, digits = 4)
simp.snk.dat <- data.frame(simp.snk.dat$Low_High)
simp.snk.dat$FA <- row.names(simp.snk.dat)
simp.snk.dat$average_scaled <- simp.snk.dat$average / sum(simp.snk.dat$average)
simp.snk$Low_High$overall
simp.snk.dat$taxa <- "Snake prickleback"

simp.snk.redu <- simp.snk.dat %>% 
  filter(cumsum <= 0.9) %>% 
  dplyr::select(FA, ava, avb, average, sd, cumsum, p) %>% 
  mutate_if(is.numeric, round, 4) %>% 
  mutate(ava = ava * 100) %>% 
  mutate(avb = avb * 100) %>% 
  mutate(average = average * 100) %>% 
  mutate(sd = sd * 100) %>% 
  mutate(cumsum = cumsum * 100) %>% 
  rename("Low" = ava) %>% 
  rename("High" = avb)

## Staghorn sculpin ##
simp.stg <- simper(fa_stg_simp[, 11:40], fa_stg_simp$Sea_otter_tr, permutations = 9999)
simp.stg.dat <- summary(simp.stg, ordered = TRUE, digits = 4)
simp.stg.dat <- data.frame(simp.stg.dat$High_Low)
simp.stg.dat$FA <- row.names(simp.stg.dat)
simp.stg.dat$average_scaled <- simp.stg.dat$average / sum(simp.stg.dat$average)
simp.stg$High_Low$overall
simp.stg.dat$taxa <- "Staghorn sculpin"

simp.stg.redu <- simp.stg.dat %>% 
  filter(cumsum <= 0.9) %>% 
  dplyr::select(FA, ava, avb, average, sd, cumsum, p) %>% 
  mutate_if(is.numeric, round, 4) %>% 
  mutate(ava = ava * 100) %>% 
  mutate(avb = avb * 100) %>% 
  mutate(average = average * 100) %>% 
  mutate(sd = sd * 100) %>% 
  mutate(cumsum = cumsum * 100) %>% 
  rename("High" = ava) %>% 
  rename("Low" = avb)
```

##### SIMPER summaries
```{r}
## Combine ##
simp.sum <- rbind(simp.eg.dat,
                  simp.ep.dat,
                  simp.fu.dat,
                  simp.pm.dat,
                  simp.sk.dat,
                  simp.ul.dat,
                  simp.ido.dat,
                  simp.lmp.dat,
                  simp.but.dat,
                  simp.mac.dat,
                  simp.dsh.dat,
                  simp.grc.dat,
                  simp.hel.dat,
                  simp.shn.dat,
                  simp.snk.dat,
                  simp.stg.dat)

## Export ##
write.csv(simp.sum, "../ALL_DATA/FA_SIMPER_output.csv", row.names = FALSE)

## Read in ##
simp.sum <- read.csv("../ALL_DATA/FA_SIMPER_output.csv", header = TRUE, stringsAsFactors = FALSE)
```

Looking for SIMPER patterns
```{r simp pat}
## Filter top FAs ##
simp.top <- simp.sum %>% 
  filter(cumsum < 0.9) %>% 
  group_by(taxa) %>% 
  top_n(-5, cumsum) %>% 
  mutate(FA = FA) %>% 
  mutate(cumsum = cumsum) 


## Top summaries ##
simp.top.sum <- simp.top %>% 
  filter(taxa == "Eelgrass" | taxa == "Fucus" | taxa == "POM" | taxa == "Sugar kelp" | taxa == "Ulva" | taxa == "Idotea" | taxa == "Limpet" | taxa == "Butter clam" | taxa == "Dock shrimp" | taxa == "Graceful crab" | taxa == "Staghorn sculpin") %>% 
  group_by(FA) %>% 
  summarize(n = n())

simp.top$taxa[simp.top$FA == "C20.5w3"]

## 
```



Helmet crabs
-- remove undetermined FA
```{r}
hel_simp <- fa_hel_1.0[, c(10:15, 17:19, 21:23, 25:26, 28:29, 31:32, 34:35, 37:38, 40:41, 43, 45:46, 51, 53:57, 59, 61:63, 65:74)]
```
```{r}
simp.hel <- simper(hel_simp, fa_hel_1.0$Sea_otter_tr, permutations = 9999)
simp.hel.dat <- summary(simp.hel, ordered = TRUE, digits = 4)
simp.hel.dat <- data.frame(simp.hel.dat$Low_High)
simp.hel.dat$FA <- row.names(simp.hel.dat)
simp.hel.dat$average_scaled <- simp.hel.dat$average / sum(simp.hel.dat$average)

datatable(filter(simp.hel.dat, p < 0.05))
```

#### NMDS Plots
With Vectors of significant <0.05 PERMANOVAs
##### Ordination
Calculate NMDS 
```{r MDS, echo = FALSE}
## Primary Producers ##
fa_fu_mds <- metaMDS(fa_fu_dist, k = 2, distance = "euclidean", autotransform = FALSE)
fa_pm_mds <- metaMDS(fa_pm_dist, k = 2, distance = "euclidean", autotransform = FALSE)
fa_eg_mds <- metaMDS(fa_eg_dist, k = 2, distance = "euclidean", autotransform = FALSE)
fa_ul_mds <- metaMDS(fa_ul_dist, k = 2, distance = "euclidean", autotransform = FALSE)

## Primary Consumers
fa_ido_mds <- metaMDS(fa_ido_dist, k = 2, distance = "euclidean", autotransform = FALSE)
fa_lmp_mds <- metaMDS(fa_lmp_dist, k = 2, distance = "euclidean", autotransform = FALSE)
fa_but_mds <- metaMDS(fa_but_dist, k = 2, distance = "euclidean", autotransform = FALSE)

## Secondary consumers ##
fa_dsh_mds <- metaMDS(fa_dsh_dist, k = 2, distance = "euclidean", autotransform = FALSE)
fa_grc_mds <- metaMDS(fa_grc_dist, k = 2, distance = "euclidean", autotransform = FALSE)
fa_stg_mds <- metaMDS(fa_stg_dist, k = 2, distance = "euclidean", autotransform = FALSE)
```

Stress. so stressful
```{r}
## Primary Producers ##
fa_fu_mds$stress
fa_pm_mds$stress
fa_eg_mds$stress
fa_ul_mds$stress

## Primary Consumers
fa_ido_mds$stress
fa_lmp_mds$stress
fa_but_mds$stress

## Secondary consumers ##
fa_dsh_mds$stress
fa_grc_mds$stress
fa_stg_mds$stress
```

##### Data Prep
```{r}
## Producers ##
# Fucus #
fa_fu_mds_dat <- as.data.frame(scores(fa_fu_mds))
fa_fu_mds_dat$ID <- fa_fu$ID 
fa_fu_mds_dat <- merge(fa_fu_mds_dat, bimrk[, c(1:4, 7:10)], by.x = "ID", by.y = "Biomarker_ID")

# POM #
fa_pm_mds_dat <- as.data.frame(scores(fa_pm_mds))
fa_pm_mds_dat$ID <- fa_pm$ID 
fa_pm_mds_dat <- merge(fa_pm_mds_dat, bimrk[, c(1:4, 7:10)], by.x = "ID", by.y = "Biomarker_ID")

# Ulva #
fa_ul_mds_dat <- as.data.frame(scores(fa_ul_mds))
fa_ul_mds_dat$ID <- fa_ul$ID 
fa_ul_mds_dat <- merge(fa_ul_mds_dat, bimrk[, c(1:4, 7:10)], by.x = "ID", by.y = "Biomarker_ID")

# Eelgrass #
fa_eg_mds_dat <- as.data.frame(scores(fa_eg_mds))
fa_eg_mds_dat$ID <- fa_eg$ID 
fa_eg_mds_dat <- merge(fa_eg_mds_dat, bimrk[, c(1:4, 7:10)], by.x = "ID", by.y = "Biomarker_ID")

## Primary consumers ##
# Limpet #
fa_lmp_mds_dat <- as.data.frame(scores(fa_lmp_mds))
fa_lmp_mds_dat$ID <- fa_lmp$ID 
fa_lmp_mds_dat <- merge(fa_lmp_mds_dat, bimrk[, c(1:4, 7:10)], by.x = "ID", by.y = "Biomarker_ID")

# Idotea #
fa_ido_mds_dat <- as.data.frame(scores(fa_ido_mds))
fa_ido_mds_dat$ID <- fa_ido$ID 
fa_ido_mds_dat <- merge(fa_ido_mds_dat, bimrk[, c(1:4, 7:10)], by.x = "ID", by.y = "Biomarker_ID")

# Butter clam #
fa_but_mds_dat <- as.data.frame(scores(fa_but_mds))
fa_but_mds_dat$ID <- fa_but$ID 
fa_but_mds_dat <- merge(fa_but_mds_dat, bimrk[, c(1:4, 7:10)], by.x = "ID", by.y = "Biomarker_ID")

## Secondary Consumers ##
# Dock Shrimp #
fa_dsh_mds_dat <- as.data.frame(scores(fa_dsh_mds))
fa_dsh_mds_dat$ID <- fa_dsh$ID 
fa_dsh_mds_dat <- merge(fa_dsh_mds_dat, bimrk[, c(1:4, 7, 9, 10)], by.x = "ID", by.y = "Biomarker_ID")

# Graceful crabs #
fa_grc_mds_dat <- as.data.frame(scores(fa_grc_mds))
fa_grc_mds_dat$ID <- fa_grc$ID 
fa_grc_mds_dat <- merge(fa_grc_mds_dat, bimrk[, c(1:4, 7, 9, 10)], by.x = "ID", by.y = "Biomarker_ID")

# Staghorn #
fa_stg_mds_dat <- as.data.frame(scores(fa_stg_mds))
fa_stg_mds_dat$ID <- fa_stg$ID 
fa_stg_mds_dat <- merge(fa_stg_mds_dat, bimrk[, c(1:4, 7:10)], by.x = "ID", by.y = "Biomarker_ID")
```

##### FA Vectors
```{r fa vector, echo = FALSE, eval = FALSE}
## Primary producer Vectors ##
# Fucus #
vec.fu <- envfit(fa_fu_mds$points, fa_fu[, 11:40], perm = 9999)
vec.fu.arrows <- scores(vec.fu, display = "vectors")
vec.fu.dat <- data.frame(vec.fu.arrows)
vec.fu.dat$pvals <- vec.fu$vectors$pvals
vec.fu.dat$FA <- row.names(vec.fu.dat)
vec.fu.dat$r2 <- vec.fu$vectors$r

scalefactor <- min(max(fa_fu_mds_dat$NMDS1) - min(fa_fu_mds_dat$NMDS1), max(fa_fu_mds_dat$NMDS2) - min(fa_fu_mds_dat$NMDS2))
vec.fu.dat$MDS1_sc <- vec.fu.dat$MDS1 * (scalefactor * vec.fu.dat$r2)
vec.fu.dat$MDS2_sc <- vec.fu.dat$MDS2 * (scalefactor * vec.fu.dat$r2)

vec.fu.dat.sig <- vec.fu.dat %>% 
  filter(r2 >= 0.75)

fu_arrow_angle <- 90 - ((atan2(vec.fu.dat.sig$MDS1_sc, vec.fu.dat.sig$MDS2_sc)* 180)/pi)
fu_arrow_angle <- ifelse(fu_arrow_angle > 90 & fu_arrow_angle < 270, fu_arrow_angle + 180, fu_arrow_angle)
fu_arrow_hjust <- ifelse(fu_arrow_angle > 90, 1, 0)
vec.fu.dat.sig$FA = gsub("C", "", vec.fu.dat.sig$FA)
vec.fu.dat.sig$FA = sub("w", "*omega*-", vec.fu.dat.sig$FA)
vec.fu.dat.sig$FA = sub("\\.", ":", vec.fu.dat.sig$FA)

# POM #
vec.pm <- envfit(fa_pm_mds$points, fa_pm[, 11:40], perm = 9999)
vec.pm.arrows <- scores(vec.pm, display = "vectors")
vec.pm.dat <- data.frame(vec.pm.arrows)
vec.pm.dat$pvals <- vec.pm$vectors$pvals
vec.pm.dat$FA <- row.names(vec.pm.dat)
vec.pm.dat$r2 <- vec.pm$vectors$r

scalefactor <- min(max(fa_pm_mds_dat$NMDS1) - min(fa_pm_mds_dat$NMDS1), max(fa_pm_mds_dat$NMDS2) - min(fa_pm_mds_dat$NMDS2))
vec.pm.dat$MDS1_sc <- vec.pm.dat$MDS1 * (scalefactor * vec.pm.dat$r2)
vec.pm.dat$MDS2_sc <- vec.pm.dat$MDS2 * (scalefactor * vec.pm.dat$r2)

vec.pm.dat.sig <- vec.pm.dat %>% 
  filter(r2 >= 0.9)

pm_arrow_angle <- 90 - ((atan2(vec.pm.dat.sig$MDS1_sc, vec.pm.dat.sig$MDS2_sc)* 180)/pi)
pm_arrow_angle <- ifelse(pm_arrow_angle > 90 & pm_arrow_angle < 270, pm_arrow_angle + 180, pm_arrow_angle)
pm_arrow_hjust <- ifelse(pm_arrow_angle > 90, 1, 0)
vec.pm.dat.sig$FA = gsub("C", "", vec.pm.dat.sig$FA)
vec.pm.dat.sig$FA = sub("w", "*omega*-", vec.pm.dat.sig$FA)
vec.pm.dat.sig$FA = sub("\\.", ":", vec.pm.dat.sig$FA)

# Eelgrass #
vec.eg <- envfit(fa_eg_mds$points, fa_eg[, 11:40], perm = 9999)
vec.eg.arrows <- scores(vec.eg, display = "vectors")
vec.eg.dat <- data.frame(vec.eg.arrows)
vec.eg.dat$pvals <- vec.eg$vectors$pvals
vec.eg.dat$FA <- row.names(vec.eg.dat)
vec.eg.dat$r2 <- vec.eg$vectors$r

scalefactor <- min(max(fa_eg_mds_dat$NMDS1) - min(fa_eg_mds_dat$NMDS1), max(fa_eg_mds_dat$NMDS2) - min(fa_eg_mds_dat$NMDS2))
vec.eg.dat$MDS1_sc <- vec.eg.dat$MDS1 * (scalefactor * vec.eg.dat$r2)
vec.eg.dat$MDS2_sc <- vec.eg.dat$MDS2 * (scalefactor * vec.eg.dat$r2)

vec.eg.dat.sig <- vec.eg.dat %>% 
  filter(r2 >= 0.75)

eg_arrow_angle <- 90 - ((atan2(vec.eg.dat.sig$MDS1_sc, vec.eg.dat.sig$MDS2_sc)* 180)/pi)
eg_arrow_angle <- ifelse(eg_arrow_angle > 90 & eg_arrow_angle < 270, eg_arrow_angle + 180, eg_arrow_angle)
eg_arrow_hjust <- ifelse(eg_arrow_angle > 90, 1, 0)
vec.eg.dat.sig$FA = gsub("C", "", vec.eg.dat.sig$FA)
vec.eg.dat.sig$FA = sub("w", "*omega*-", vec.eg.dat.sig$FA)
vec.eg.dat.sig$FA = sub("\\.", ":", vec.eg.dat.sig$FA)

# Ulva #
vec.ul <- envfit(fa_ul_mds$points, fa_ul[, 11:40], perm = 9999)
vec.ul.arrows <- scores(vec.ul, display = "vectors")
vec.ul.dat <- data.frame(vec.ul.arrows)
vec.ul.dat$pvals <- vec.ul$vectors$pvals
vec.ul.dat$FA <- row.names(vec.ul.dat)
vec.ul.dat$r2 <- vec.ul$vectors$r

scalefactor <- min(max(fa_ul_mds_dat$NMDS1) - min(fa_ul_mds_dat$NMDS1), max(fa_ul_mds_dat$NMDS2) - min(fa_ul_mds_dat$NMDS2))
vec.ul.dat$MDS1_sc <- vec.ul.dat$MDS1 * (scalefactor * vec.ul.dat$r2)
vec.ul.dat$MDS2_sc <- vec.ul.dat$MDS2 * (scalefactor * vec.ul.dat$r2)

vec.ul.dat.sig <- vec.ul.dat %>% 
  filter(r2 >= 0.75)

ul_arrow_angle <- 90 - ((atan2(vec.ul.dat.sig$MDS1_sc, vec.ul.dat.sig$MDS2_sc)* 180)/pi)
ul_arrow_angle <- ifelse(ul_arrow_angle > 90 & ul_arrow_angle < 270, ul_arrow_angle + 180, ul_arrow_angle)
ul_arrow_hjust <- ifelse(ul_arrow_angle > 90, 1, 0)
vec.ul.dat.sig$FA = gsub("C", "", vec.ul.dat.sig$FA)
vec.ul.dat.sig$FA = sub("w", "*omega*-", vec.ul.dat.sig$FA)
vec.ul.dat.sig$FA = sub("\\.", ":", vec.ul.dat.sig$FA)

## Primary Consumers ##
# Idotea #
vec.ido <- envfit(fa_ido_mds$points, fa_ido[, 11:40], perm = 9999)
vec.ido.arrows <- scores(vec.ido, display = "vectors")
vec.ido.dat <- data.frame(vec.ido.arrows)
vec.ido.dat$pvals <- vec.ido$vectors$pvals
vec.ido.dat$FA <- row.names(vec.ido.dat)
vec.ido.dat$r2 <- vec.ido$vectors$r

scalefactor <- min(max(fa_ido_mds_dat$NMDS1) - min(fa_ido_mds_dat$NMDS1), max(fa_ido_mds_dat$NMDS2) - min(fa_ido_mds_dat$NMDS2))
vec.ido.dat$MDS1_sc <- vec.ido.dat$MDS1 * (scalefactor * vec.ido.dat$r2)
vec.ido.dat$MDS2_sc <- vec.ido.dat$MDS2 * (scalefactor * vec.ido.dat$r2)

vec.ido.dat.sig <- vec.ido.dat %>% 
  filter(r2 >= 0.75)

ido_arrow_angle <- 90 - ((atan2(vec.ido.dat.sig$MDS1_sc, vec.ido.dat.sig$MDS2_sc)* 180)/pi)
ido_arrow_angle <- ifelse(ido_arrow_angle > 90 & ido_arrow_angle < 270, ido_arrow_angle + 180, ido_arrow_angle)
ido_arrow_hjust <- ifelse(ido_arrow_angle > 90, 1, 0)
vec.ido.dat.sig$FA = gsub("C", "", vec.ido.dat.sig$FA)
vec.ido.dat.sig$FA = sub("w", "*omega*-", vec.ido.dat.sig$FA)
vec.ido.dat.sig$FA = sub("\\.", ":", vec.ido.dat.sig$FA)

# Limpet #
vec.lmp <- envfit(fa_lmp_mds$points, fa_lmp[, 11:40], perm = 9999)
vec.lmp.arrows <- scores(vec.lmp, display = "vectors")
vec.lmp.dat <- data.frame(vec.lmp.arrows)
vec.lmp.dat$pvals <- vec.lmp$vectors$pvals
vec.lmp.dat$FA <- row.names(vec.lmp.dat)
vec.lmp.dat$r2 <- vec.lmp$vectors$r

scalefactor <- min(max(fa_lmp_mds_dat$NMDS1) - min(fa_lmp_mds_dat$NMDS1), max(fa_lmp_mds_dat$NMDS2) - min(fa_lmp_mds_dat$NMDS2))
vec.lmp.dat$MDS1_sc <- vec.lmp.dat$MDS1 * (scalefactor * vec.lmp.dat$r2)
vec.lmp.dat$MDS2_sc <- vec.lmp.dat$MDS2 * (scalefactor * vec.lmp.dat$r2)

vec.lmp.dat.sig <- vec.lmp.dat %>% 
  filter(r2 >= 0.75)

lmp_arrow_angle <- 90 - ((atan2(vec.lmp.dat.sig$MDS1_sc, vec.lmp.dat.sig$MDS2_sc)* 180)/pi)
lmp_arrow_angle <- ifelse(lmp_arrow_angle > 90 & lmp_arrow_angle < 270, lmp_arrow_angle + 180, lmp_arrow_angle)
lmp_arrow_hjust <- ifelse(lmp_arrow_angle > 90, 1, 0)
vec.lmp.dat.sig$FA = gsub("C", "", vec.lmp.dat.sig$FA)
vec.lmp.dat.sig$FA = sub("w", "*omega*-", vec.lmp.dat.sig$FA)
vec.lmp.dat.sig$FA = sub("\\.", ":", vec.lmp.dat.sig$FA)

# Butter clam #
vec.but <- envfit(fa_but_mds$points, fa_but[, 11:40], perm = 9999)
vec.but.arrows <- scores(vec.but, display = "vectors")
vec.but.dat <- data.frame(vec.but.arrows)
vec.but.dat$pvals <- vec.but$vectors$pvals
vec.but.dat$FA <- row.names(vec.but.dat)
vec.but.dat$r2 <- vec.but$vectors$r

scalefactor <- min(max(fa_but_mds_dat$NMDS1) - min(fa_but_mds_dat$NMDS1), max(fa_but_mds_dat$NMDS2) - min(fa_but_mds_dat$NMDS2))
vec.but.dat$MDS1_sc <- vec.but.dat$MDS1 * (scalefactor * vec.but.dat$r2)
vec.but.dat$MDS2_sc <- vec.but.dat$MDS2 * (scalefactor * vec.but.dat$r2)

vec.but.dat.sig <- vec.but.dat %>% 
  filter(r2 >= 0.75)

but_arrow_angle <- 90 - ((atan2(vec.but.dat.sig$MDS1_sc, vec.but.dat.sig$MDS2_sc)* 180)/pi)
but_arrow_angle <- ifelse(but_arrow_angle > 90 & but_arrow_angle < 270, but_arrow_angle + 180, but_arrow_angle)
but_arrow_hjust <- ifelse(but_arrow_angle > 90, 1, 0)
vec.but.dat.sig$FA = gsub("C", "", vec.but.dat.sig$FA)
vec.but.dat.sig$FA = sub("w", "*omega*-", vec.but.dat.sig$FA)
vec.but.dat.sig$FA = sub("\\.", ":", vec.but.dat.sig$FA)

## Secondary Consumers ##
# Dock Shrimp #
vec.dsh <- envfit(fa_dsh_mds$points, fa_dsh[, 11:40], perm = 9999)
vec.dsh.arrows <- scores(vec.dsh, display = "vectors")
vec.dsh.dat <- data.frame(vec.dsh.arrows)
vec.dsh.dat$pvals <- vec.dsh$vectors$pvals
vec.dsh.dat$FA <- row.names(vec.dsh.dat)
vec.dsh.dat$r2 <- vec.dsh$vectors$r

scalefactor <- min(max(fa_dsh_mds_dat$NMDS1) - min(fa_dsh_mds_dat$NMDS1), max(fa_dsh_mds_dat$NMDS2) - min(fa_dsh_mds_dat$NMDS2))
vec.dsh.dat$MDS1_sc <- vec.dsh.dat$MDS1 * (scalefactor * vec.dsh.dat$r2)
vec.dsh.dat$MDS2_sc <- vec.dsh.dat$MDS2 * (scalefactor * vec.dsh.dat$r2)

vec.dsh.dat.sig <- vec.dsh.dat %>% 
  filter(r2 >= 0.75)

dsh_arrow_angle <- 90 - ((atan2(vec.dsh.dat.sig$MDS1_sc, vec.dsh.dat.sig$MDS2_sc)* 180)/pi)
dsh_arrow_angle <- ifelse(dsh_arrow_angle > 90 & dsh_arrow_angle < 270, dsh_arrow_angle + 180, dsh_arrow_angle)
dsh_arrow_hjust <- ifelse(dsh_arrow_angle > 90, 1, 0)
vec.dsh.dat.sig$FA = gsub("C", "", vec.dsh.dat.sig$FA)
vec.dsh.dat.sig$FA = sub("w", "*omega*-", vec.dsh.dat.sig$FA)
vec.dsh.dat.sig$FA = sub("\\.", ":", vec.dsh.dat.sig$FA)

# Graceful crabs #
vec.grc <- envfit(fa_grc_mds$points, fa_grc[, 11:40], perm = 9999)
vec.grc.arrows <- scores(vec.grc, display = "vectors")
vec.grc.dat <- data.frame(vec.grc.arrows)
vec.grc.dat$pvals <- vec.grc$vectors$pvals
vec.grc.dat$FA <- row.names(vec.grc.dat)
vec.grc.dat$r2 <- vec.grc$vectors$r

scalefactor <- min(max(fa_grc_mds_dat$NMDS1) - min(fa_grc_mds_dat$NMDS1), max(fa_grc_mds_dat$NMDS2) - min(fa_grc_mds_dat$NMDS2))
vec.grc.dat$MDS1_sc <- vec.grc.dat$MDS1 * (scalefactor * vec.grc.dat$r2)
vec.grc.dat$MDS2_sc <- vec.grc.dat$MDS2 * (scalefactor * vec.grc.dat$r2)

vec.grc.dat.sig <- vec.grc.dat %>% 
  filter(r2 >= 0.75)

grc_arrow_angle <- 90 - ((atan2(vec.grc.dat.sig$MDS1_sc, vec.grc.dat.sig$MDS2_sc)* 180)/pi)
grc_arrow_angle <- ifelse(grc_arrow_angle > 90 & grc_arrow_angle < 270, grc_arrow_angle + 180, grc_arrow_angle)
grc_arrow_hjust <- ifelse(grc_arrow_angle > 90, 1, 0)
vec.grc.dat.sig$FA = gsub("C", "", vec.grc.dat.sig$FA)
vec.grc.dat.sig$FA = sub("w", "*omega*-", vec.grc.dat.sig$FA)
vec.grc.dat.sig$FA = sub("\\.", ":", vec.grc.dat.sig$FA)

# Staghorn sculpin #
vec.stg <- envfit(fa_stg_mds$points, fa_stg[, 11:40], perm = 9999)
vec.stg.arrows <- scores(vec.stg, display = "vectors")
vec.stg.dat <- data.frame(vec.stg.arrows)
vec.stg.dat$pvals <- vec.stg$vectors$pvals
vec.stg.dat$FA <- row.names(vec.stg.dat)
vec.stg.dat$r2 <- vec.stg$vectors$r

scalefactor <- min(max(fa_stg_mds_dat$NMDS1) - min(fa_stg_mds_dat$NMDS1), max(fa_stg_mds_dat$NMDS2) - min(fa_stg_mds_dat$NMDS2))
vec.stg.dat$MDS1_sc <- vec.stg.dat$MDS1 * (scalefactor * vec.stg.dat$r2)
vec.stg.dat$MDS2_sc <- vec.stg.dat$MDS2 * (scalefactor * vec.stg.dat$r2)

vec.stg.dat.sig <- vec.stg.dat %>% 
  filter(r2 >= 0.75)

stg_arrow_angle <- 90 - ((atan2(vec.stg.dat.sig$MDS1_sc, vec.stg.dat.sig$MDS2_sc)* 180)/pi)
stg_arrow_angle <- ifelse(stg_arrow_angle > 90 & stg_arrow_angle < 270, stg_arrow_angle + 180, stg_arrow_angle)
stg_arrow_hjust <- ifelse(stg_arrow_angle > 90, 1, 0)
vec.stg.dat.sig$FA = gsub("C", "", vec.stg.dat.sig$FA)
vec.stg.dat.sig$FA = sub("w", "*omega*-", vec.stg.dat.sig$FA)
vec.stg.dat.sig$FA = sub("\\.", ":", vec.stg.dat.sig$FA)
```

##### Plots
NOTE that axes limits are very specific to allow for plotting a 4.5 X 10 in pdf panel plot
```{r}
## Primary Producers ##
# Fucus #
fu.nmds <- ggplot(fa_fu_mds_dat) +
  geom_point(aes(x = NMDS1, y = NMDS2, color = Sea_otter_region), size = 2) +
  scale_color_manual(values = so.pal, "Sea otter treatment") +
  geom_segment(data = vec.fu.dat.sig, aes(x = 0, y = 0, xend = MDS1_sc, yend = MDS2_sc), arrow = arrow(length = unit(0.07, "inches")), colour = "gray50", alpha = 1) +
  geom_text(data = vec.fu.dat.sig, aes(MDS1_sc * 1.02, MDS2_sc * 1.02, label = FA), alpha=0.5, size = 2, parse = T, angle = fu_arrow_angle, hjust = fu_arrow_hjust) +
  scale_x_continuous(limits = c(-0.05, 0.1)) +
  scale_y_continuous(limits = c(-0.1, 0.07)) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_blank(), axis.ticks.y = element_blank()) +
  theme(legend.position = "none")
  
# POM #   
pm.nmds <- ggplot(fa_pm_mds_dat) +
  geom_point(aes(x = NMDS1, y = NMDS2, color = Sea_otter_region), size = 2) +
  scale_color_manual(values = so.pal, "Sea otter treatment") +
  geom_segment(data = vec.pm.dat.sig, aes(x = 0, y = 0, xend = MDS1_sc, yend = MDS2_sc), arrow = arrow(length = unit(0.07, "inches")), colour = "gray50", alpha = 1) +
  geom_text(data = vec.pm.dat.sig, aes(MDS1_sc * 1.02, MDS2_sc * 1.02, label = FA), alpha = 0.5, size = 2, parse = T, angle = pm_arrow_angle, hjust = pm_arrow_hjust) +
  scale_x_continuous(limits = c(-0.14, 0.14)) +
  scale_y_continuous(limits = c(-0.1, 0.13)) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_blank(), axis.ticks.y = element_blank()) +
  theme(legend.position = "none")Eelgrass

# Eelgrass #
eg.nmds <- ggplot(fa_eg_mds_dat) +
  geom_point(aes(x = NMDS1, y = NMDS2, color = Sea_otter_region), size = 2) +
  scale_color_manual(values = so.pal, "Sea otter treatment") +
  geom_segment(data = vec.eg.dat.sig, aes(x = 0, y = 0, xend = MDS1_sc, yend = MDS2_sc), arrow = arrow(length = unit(0.07, "inches")), colour = "gray50", alpha = 1) +
  geom_text(data = vec.eg.dat.sig, aes(MDS1_sc * 1.02, MDS2_sc * 1.02, label = FA), alpha=0.5, size = 2, parse = T, angle = eg_arrow_angle, hjust = eg_arrow_hjust) +
  scale_x_continuous(limits = c(-0.1, 0.2)) +
  scale_y_continuous(limits = c(-0.055, 0.12)) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_blank(), axis.ticks.y = element_blank()) +
  theme(legend.position = "none")

# Ulva #
ul.nmds <- ggplot(fa_ul_mds_dat) +
  geom_point(aes(x = NMDS1, y = NMDS2, color = Sea_otter_region), size = 2) +
  scale_color_manual(values = so.pal, "Sea otter treatment") +
  geom_segment(data = vec.ul.dat.sig, aes(x = 0, y = 0, xend = MDS1_sc, yend = MDS2_sc), arrow = arrow(length = unit(0.07, "inches")), colour = "gray50", alpha = 1) +
  geom_text(data = vec.ul.dat.sig, aes(MDS1_sc * 1.02, MDS2_sc * 1.02, label = FA), alpha=0.5, size = 2, parse = T, angle = ul_arrow_angle, hjust = ul_arrow_hjust) +
  scale_x_continuous(limits = c(-0.265, 0.3)) +
  scale_y_continuous(limits = c(-0.17, 0.25)) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_blank(), axis.ticks.y = element_blank()) +
  theme(legend.position = "none")

## Primary Consumers ##
# Idotea #
ido.nmsd <- ggplot(fa_ido_mds_dat) +
  geom_point(aes(x = NMDS1, y = NMDS2, color = Sea_otter_region), size = 2) +
  scale_color_manual(values = so.pal, "Sea otter treatment") +
  geom_segment(data = vec.ido.dat.sig, aes(x = 0, y = 0, xend = MDS1_sc, yend = MDS2_sc), arrow = arrow(length = unit(0.07, "inches")), colour = "gray50", alpha = 1) +
  geom_text(data = vec.ido.dat.sig, aes(MDS1_sc * 1.02, MDS2_sc * 1.02, label = FA), alpha=0.5, size = 2, parse = T, angle = ido_arrow_angle, hjust = ido_arrow_hjust) +
  scale_x_continuous(limits = c(-0.22, 0.25)) +
  scale_y_continuous(limits = c(-0.18, 0.12)) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_blank(), axis.ticks.y = element_blank()) +
  theme(legend.position = "none")

# Limpet #
lmp.nmds <- ggplot(fa_lmp_mds_dat) +
  geom_point(aes(x = NMDS1, y = NMDS2, color = Sea_otter_region), size = 2) +
  scale_color_manual(values = so.pal, "Sea otter treatment") +
  geom_segment(data = vec.lmp.dat.sig, aes(x = 0, y = 0, xend = MDS1_sc, yend = MDS2_sc), arrow = arrow(length = unit(0.07, "inches")), colour = "gray50", alpha = 1) +
  geom_text(data = vec.lmp.dat.sig, aes(MDS1_sc * 1.02, MDS2_sc * 1.02, label = FA), alpha=0.5, size = 2, parse = T, angle = lmp_arrow_angle, hjust = lmp_arrow_hjust) +
  scale_x_continuous(limits = c(-0.15, 0.17)) +
  scale_y_continuous(limits = c(-0.16, 0.12)) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_blank(), axis.ticks.y = element_blank()) +
  theme(legend.position = "none")

# Butter Clam #
but.nmds <- ggplot(fa_but_mds_dat) +
  geom_point(aes(x = NMDS1, y = NMDS2, color = Sea_otter_region), size = 2) +
  scale_color_manual(values = so.pal, "Sea otter treatment") +
  geom_segment(data = vec.but.dat.sig, aes(x = 0, y = 0, xend = MDS1_sc, yend = MDS2_sc), arrow = arrow(length = unit(0.07, "inches")), colour = "gray50", alpha = 1) +
  geom_text(data = vec.but.dat.sig, aes(MDS1_sc * 1.02, MDS2_sc * 1.02, label = FA), alpha=0.5, size = 2, parse = T, angle = but_arrow_angle, hjust = but_arrow_hjust) +
  scale_x_continuous(limits = c(-0.22, 0.15)) +
  scale_y_continuous(limits = c(-0.21, 0.25)) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_blank(), axis.ticks.y = element_blank()) +
  theme(legend.position = "none")

## Secondary Consumers ##
# Dock Shrimp #
dsh.nmds <- ggplot(fa_dsh_mds_dat) +
  geom_point(aes(x = NMDS1, y = NMDS2, color = Sea_otter_region), size = 2) +
  scale_color_manual(values = so.pal, "Sea otter treatment") +
  geom_segment(data = vec.dsh.dat.sig, aes(x = 0, y = 0, xend = MDS1_sc, yend = MDS2_sc), arrow = arrow(length = unit(0.07, "inches")), colour = "gray50", alpha = 1) +
  geom_text(data = vec.dsh.dat.sig, aes(MDS1_sc * 1.02, MDS2_sc * 1.02, label = FA), alpha = 0.5, size = 2, parse = T, angle = dsh_arrow_angle, hjust = dsh_arrow_hjust) +
  scale_x_continuous(limits = c(-0.10, 0.075)) +
  scale_y_continuous(limits = c(-0.07, 0.085)) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_blank(), axis.ticks.y = element_blank()) +
  theme(legend.position = "none")

# Graceful crabs #
grc.nmds <- ggplot(fa_grc_mds_dat) +
  geom_point(aes(x = NMDS1, y = NMDS2, color = Sea_otter_region), size = 2) +
  scale_color_manual(values = so.pal, "Sea otter treatment") +
  geom_segment(data = vec.grc.dat.sig, aes(x = 0, y = 0, xend = MDS1_sc, yend = MDS2_sc), arrow = arrow(length = unit(0.07, "inches")), colour = "gray50", alpha = 1) +
  geom_text(data = vec.grc.dat.sig, aes(MDS1_sc * 1.02, MDS2_sc * 1.02, label = FA), alpha = 0.5, size = 2, parse = T, angle = grc_arrow_angle, hjust = grc_arrow_hjust) +
  scale_x_continuous(limits = c(-0.13, 0.17)) +
  scale_y_continuous(limits = c(-0.12, 0.13)) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_blank(), axis.ticks.y = element_blank()) +
  theme(legend.position = "none")

# Staghorn sculpin #
stg.nmds <- ggplot(fa_stg_mds_dat) +
  geom_point(aes(x = NMDS1, y = NMDS2, color = Sea_otter_region), size = 2) +
  scale_color_manual(values = so.pal, "Sea otter treatment") +
  geom_segment(data = vec.stg.dat.sig, aes(x = 0, y = 0, xend = MDS1_sc, yend = MDS2_sc), arrow = arrow(length = unit(0.07, "inches")), colour = "gray50", alpha = 1) +
  geom_text(data = vec.stg.dat.sig, aes(MDS1_sc * 1.02, MDS2_sc * 1.02, label = FA), alpha = 0.5, size = 2, parse = T, angle = stg_arrow_angle, hjust = stg_arrow_hjust) +
  scale_x_continuous(limits = c(-0.13, 0.16)) +
  scale_y_continuous(limits = c(-0.19, 0.18)) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_blank(), axis.ticks.y = element_blank()) +
  theme(legend.position = "none")
```

##### Panel - FA
```{r}
cowplot::plot_grid(eg.nmds, fu.nmds, pm.nmds, ul.nmds, ido.nmsd, lmp.nmds, but.nmds, dsh.nmds, grc.nmds, stg.nmds, nrow = 5, ncol = 2, labels = c("a", "b", "c", "d", "e", "f", "g", "h", "i", "j"), label_size = 10)
```

