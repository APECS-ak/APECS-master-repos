---
title: "Eelgrass_community_structure_analyses_full"
author: "Wendel Raymond"
date: "November 1, 2018"
output: html_document
editor_options: 
  chunk_output_type: console
---
```{r libraries, echo=FALSE, warning=FALSE, message=FALSE}
library(dplyr)
library(tidyr)
library(ggplot2)
library(vegan)
library(nlme)
library(lme4)
library(MASS)
library(lmerTest)
library(DT)
library(ggplot2)
library(sjPlot)
library(cowplot)
library(MuMIn)
library(AICcmodavg)
library(LaCroixColoR)
options(na.action = "na.fail") # needed for MuMIn
theme_set(theme_classic())

st.er <- function(x, na.rm = TRUE) {
  stopifnot(is.numeric(x))
  return(sd(x, na.rm = na.rm)/sqrt(length(x)))
}
```

## Data
All data are summarized at the site level. That is the level at which we can apply treatments. Replicaiton listed below is how may sampler *per site* were collected. i.e. the number of quadrats per site.
**Response metrics**
1. eelgrass aboveground biomass density (g / m^2^). n = 8
2. epiphyte load (g epiphyte / g eelgrass). n = 8
3. total grazer load (g grazers/ g eelgrass). n = 8
4. crab biomass (g) - can also be counts. n = 3
5. fish biomass (g) - can also be counts. n = 1

**Explanatory factors**
1. Sea otter index. n = 1
2. Time (julian day). n = 1
3. Sediment type (primary sediment type from the "inside" eelgrass transect). n = 10
4. Light attenuation. n = 1
5. crab biomass (g). n = 3
6. fish biomass (g). n = 1
7. grazer load (g/g). n = 8
8. epiphyte load (g/g). n = 8
9. macrophyte cover (percent). n = 8
10. diatom cover (percent). n = 8
11. Total nitrogen. n = 1, but there is the 'day of' sampling, 1m on nutrient day, and 4m on nutrient day.

```{r import data, echo = FALSE, message = FALSE, warning = FALSE}
## Transect ##
tran.dat <- read.csv("../ALL_DATA/eelgrass_and_grazer_2017_derived.csv", header = TRUE, stringsAsFactors = FALSE)

## Sea Otter Impact Index ##
so.index <- read.csv("../ALL_DATA/sea_otter_impact_index_new.csv", stringsAsFactors = FALSE, header = TRUE)

## Sediment ##
sed.site <- read.csv("../ALL_DATA/TIFF_seagrass_carbon_disturbance/2017_data_efforts/seagrass_seaotter_pit_sediment_2017_RAW.csv", stringsAsFactors = FALSE, header = TRUE)

## Crab ##
crab.dat <- read.csv("../All_DATA/eelgrass_crab_pot_derived.csv", header = TRUE, stringsAsFactors = FALSE)
crab.dat$string <- as.character(crab.dat$string)

## Fish ##
fish.dat <- read.csv("../ALL_DATA/eelgrass_beach_seine_derived.csv", header = TRUE, stringsAsFactors = FALSE)

## Fish Taxonomy ##
fish.tax <- read.csv("../ALL_DATA/fish_taxonomy_RAW.csv", header = TRUE, stringsAsFactors = FALSE)

## RAW Nutrient Data ##
nut.dat <- read.csv("../ALL_DATA/seagrass_nutrients_2017_RAW.csv", header = TRUE, stringsAsFactors = FALSE)
nut.temp <- read.csv("../ALL_DATA/site_abiotic_template_2017_RAW.csv", header = TRUE, stringsAsFactors = FALSE)
```

### Data Prep
Sediment data preparation. We will assign the average sediment score from the inside eelgrass bed transect to each site.
```{r seds by site, echo=FALSE}
seds <- sed.site %>% 
  filter(trans_type == "Inside") %>% 
  group_by(site) %>% 
  summarise(sed_inside_prim = mean(sed1_no, na.rm = TRUE),
            sed_inside_prim_se = st.er(sed1_no))

dat <- merge(tran.dat, seds, by = "site")
```

Light availability calculation. Taken as the ratio of light intensity at the eelgrass canopy to the light intensity at the surface.
```{r light avail, echo=FALSE}
dat$light_avail <- (dat$light_intensity_umol.m2.sec_transect / dat$light_intensity_umol.m2.sec_surface)
```

Crab data preparation. This needs to be done to summarise by site and string (i.e. loose species information). Average by site.
```{r crab sites string, echo=FALSE}
crab.site <- crab.dat %>% 
  group_by(site) %>% 
  summarise(crab_count = mean(count, na.rm = TRUE),
            crab_mass = mean(mass_g, na.rm = TRUE))

dat <- merge(dat, crab.site, by = "site")
```

Crab data preparation. Summarize counts and mass of cancer/rock crabs. Average by site.
```{r rock crabs string, echo=FALSE}
crab.rock <- crab.dat %>% 
  filter(sp_code == "CRABDUN" | sp_code == "CRABRR" | sp_code == "CRAGRA"| sp_code == "UNRKCB") %>% 
  group_by(site) %>% 
    summarise(rock_count = mean(count, na.rm = TRUE),
            rock_mass = mean(mass_g, na.rm = TRUE))

dat <- merge(dat, crab.rock, by = "site")
```

Fish data preparation. 
Append taxonomy
```{r fish tax, echo=FALSE}
fish.dat <- merge(fish.dat, fish.tax, by.x = "species_scientific", by.y = "scientific_name", all = TRUE)
```

This needs to be done to summarise count as mass by site across all species. Further the sum of fish predator mass will be caluclated.
```{r fish site, echo = FALSE}
## Full species List ##
# prep #
fish.site <- fish.dat %>% 
  group_by(site) %>% 
  summarise(fish_count = n(),
            fish_mass = sum(mass_g))

fish.site.sp <- fish.dat %>% 
  group_by(site, sp_code) %>% 
  summarise(count = n()) %>% 
  spread(key = sp_code, value = count)

fish.site.sp[is.na(fish.site.sp)] <- 0

fish.site.sp$fish_SW_diverse <- diversity(fish.site.sp[,2:56], index = "shannon")
fish.site.sp$fish_rich <- rowSums(fish.site.sp[, 2:56] != 0)

# Sum predators #
fish.site.sp$fish_preds <- rowSums(fish.site.sp[, c(2, 7:9, 13, 20, 31:40, 51, 53:55)])

fish.site <- merge(fish.site, fish.site.sp[, c(1, 57:59)], by = "site")

dat <- merge(dat, fish.site, by = "site")

# biomass community matirx #
fishmass.site.sp <- fish.dat %>% 
  group_by(site, sp_code) %>% 
  summarise(mass = sum(mass_g)) %>% 
  spread(key = sp_code, value = mass)

fishmass.site.sp[is.na(fishmass.site.sp)] <- 0

## Group by family counts ##
fish.site.fam <- fish.dat %>% 
  group_by(site, family) %>% 
  summarise(count = n()) %>% 
  spread(key = family, value = count)

fish.site.fam[is.na(fish.site.fam)] <- 0

## Group by family Mass ##
fishmass.site.fam <- fish.dat %>% 
  group_by(site, family) %>% 
  summarise(mass = sum(mass_g)) %>% 
  spread(key = family, value = mass)

fishmass.site.fam[is.na(fishmass.site.fam)] <- 0

dat <- merge(dat, fishmass.site.fam, by = "site")
```

Look at nutrient data
```{r}
## Summarize good data by site and sampling type ##
nut.sum <- nut.dat %>% 
  filter(site_full != "2017_M_01") %>% 
  filter(quality == "G") %>% 
  group_by(site_full, sampling_type, depth_m) %>% 
  summarise(NOx_umol = mean(nox_umol),
            NH4_umol = mean(nh4_umol),
            PO4_umol = mean(po4_umol),
            NTotal_umol = mean(tot_N),
            N_P = mean(N.P))

## Merge with template ##
abiot.final <- nut.temp[, 1:7]

abiot.final$NOx_umol <- c(nut.sum$NOx_umol[nut.sum$sampling_type == "eelgrass"], nut.sum$NOx_umol[nut.sum$sampling_type == "nutday"])

abiot.final$NH4_umol <- c(nut.sum$NH4_umol[nut.sum$sampling_type == "eelgrass"], nut.sum$NH4_umol[nut.sum$sampling_type == "nutday"])

abiot.final$PO4_umol <- c(nut.sum$PO4_umol[nut.sum$sampling_type == "eelgrass"], nut.sum$PO4_umol[nut.sum$sampling_type == "nutday"])

abiot.final$NTotal_umol <- c(nut.sum$NTotal_umol[nut.sum$sampling_type == "eelgrass"], nut.sum$NTotal_umol[nut.sum$sampling_type == "nutday"])

abiot.final$N_P <- c(nut.sum$N_P[nut.sum$sampling_type == "eelgrass"], nut.sum$N_P[nut.sum$sampling_type == "nutday"])
```

Append total N to dat
```{r}
dat$Ntotal_site <- abiot.final$NTotal_umol[abiot.final$sample_type == "site"]
dat$NOx_site <- abiot.final$NOx_umol[abiot.final$sample_type == "site"]
```


## Tests for normality
Responses should be tested for normality. If a responce is also a predictor it should not be tranformed unless the resulting model indicates a strange residual structure.

Aboveground biomass is fairly normal and does not need a transformaiton.
```{r abvgrnd biomass, echo=FALSE}
hist(dat$abvgnd_mass)
shapiro.test(dat$abvgnd_mass)
```

Epiphyte load is not normal but log transformation fixes it
```{r epi load , echo=FALSE}
hist(dat$epiphmass_shootmass)
range(dat$epiphmass_shootmass)
shapiro.test(dat$epiphmass_shootmass)

hist(log(dat$epiphmass_shootmass))
shapiro.test(log(dat$epiphmass_shootmass))
```

Grazer Load is not normal but log transformation fixes it.
```{r grz load, echo=FALSE}
hist(dat$grazermass_shootmass)
range(dat$grazermass_shootmass)

hist(log(dat$grazermass_shootmass))
shapiro.test(log(dat$grazermass_shootmass))
```

Crab biomass is not normal but is corrected with sqrt tranformation
```{r crb biomass, echo=FALSE}
hist(dat$crab_mass)
shapiro.test(dat$crab_mass)

hist(sqrt(dat$crab_mass))
shapiro.test(sqrt(dat$crab_mass))
```

Fish  mass is not normal but log transforamtion fixes it. 
```{r fish pred biomass, echo=FALSE}
hist(dat$fish_mass)
shapiro.test(dat$fish_mass)

range(dat$fish_mass)
hist(log(dat$fish_mass))
shapiro.test(log(dat$fish_mass))
```

Sediment is not normal and there is not a good transformation becasue there are so many low values. I will proceed without a tranformation. We purposly selected eelgrass beds and therefore we are going to get a certian sediment type. We see here that we see two types (generally) of sediment types. Places with small, muddy sediemnts and places with sandier more consolidated sediments.
```{r sed norm, echo=FALSE}
hist(dat$sed_inside_prim)
shapiro.test(dat$sed_inside_prim)

hist(sqrt(dat$sed_inside_prim))
shapiro.test(sqrt(dat$sed_inside_prim))
```

Total Nitrogen is not normal and there is not a good transformation. I will proceed with no transformation. This is just what the system looks like. Especially this is essentially a point estimate at each site I am not conviced that we can make trustworthy transformations.
```{r tot n norm, echo=FALSE}
hist(dat$Ntotal_site)
shapiro.test(dat$Ntotal_site)

hist(sqrt(dat$Ntotal_site))
shapiro.test(sqrt(dat$Ntotal_site))
```

Light availability is normal. I may not use this variable at all though. See below.
```{r li avil norm, echo=FALSE}
hist(dat$light_avail)
shapiro.test(dat$light_avail)
```

Macrophyte cover. So this is tricky. Its percent coer data so one would think that a asin(sqrt()) transformation would be good, but its not. Also log gets really strange because there are so many zeros. Given this I think that we should proceed without transformation. 
```{r macro norm, echo=FALSE}
hist(dat$macro_dens)
range(dat$macro_dens)
shapiro.test(dat$macro_dens)

hist(asin(sqrt(dat$macro_dens / 100)))
hist(log(dat$macro_dens + 1), breaks = 7)
```

Diatom cover is not normal but a asin(sqrt()) tranformation does the trick.
```{r dia norm, echo = FALSE}
hist(dat$diatom_dens)
shapiro.test(dat$diatom_dens)

hist(asin(sqrt(dat$diatom_dens / 100)))
shapiro.test(asin(sqrt(dat$diatom_dens / 100)))
```

### Summary of appropriate transformations to meet normality
Factor  | Transformation
------  | --------------
Aboveground | none
epi load  | log
grz load  | log
crab  | sqrt
fish | log
sediment | none
Total N | none
Light avil | none
Macroalgae | none
Diatoms | asing-sqrt

## Checking for multicolinearity among common predictors
Checking for multicolinearity among predictors. There is little evidence for multicolinearity among predictors. This suggests that I can use a standard deviation predictor standardization in models later. Note that diatoms and grazers appear to have a relationships, but both will also need to be assessed for temporal effects. So we may still need to consider a partial standard deviation predictor standardization.

```{r muticol, echo=FALSE}
pairs(dat[, c( 21, 49, 65, 67, 93, 99, 101, 109, 116, 120)])
```

## Variation of predictor variables acorss sites
In an effort to avoid spurious models, we can look at some of the environmental co-variates across sites to see if there are  patterns. If there seems to be no site effect it may be reasonable to exclude that variable from analysis.

Sediment grain size varries strongly across sites. It should definitely be included.
```{r site covar sed, echo=FALSE}
ggplot(dat) +
  geom_col(aes(x = site, y = sed_inside_prim)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Total Nitorgen has a fair amount of variation across sites both on the day of eelgrass sampling and coordinated sampling. However, the magnitude is low, especailly on the day-of sampling.
```{r site covar tn, echo=FALSE}
ggplot(dat) +
  geom_col(aes(x = site, y = Ntotal_site)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(dat) +
  geom_col(aes(x = site, y = Ntotal_1m_ND)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(dat) +
  geom_col(aes(x = site, y = Ntotal_4m_ND)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Light availability varries slightly acorss sites. This is a challanging variable because its just a point estimate and presumably the long term average light availability could impact primary production, and we don't know that. I think a reasonable argument can be made to not include this in alaysis because while it was actually measured, that measurment is hard to justify as being relateable/meaningful to other variables.
```{r site covar light, echo=FALSE}
ggplot(dat) +
  geom_col(aes(x = site, y = light_avail)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Removing temporal signal
Things change through time. Especially things that grow.
Eelgrass aboveground biomass has a strong temporal signal. *Eelgrass aboveground biomass will be de-trended*.
```{r abv mass time, echo = FALSE}
## Assess temporal trend ##
plot(dat$date_julian, dat$abvgnd_mass)
tmod1 <- lm(dat$abvgnd_mass ~ dat$date_julian)
summary(tmod1)

## De-trend ##
resid.abv <- residuals(tmod1)
dat$abvgnd_mass_dt <- resid.abv
plot(dat$date_julian, dat$abvgnd_mass_dt)
```

Epiphyte load has a significant negative relationships with epiphyte load. I will not transform these data for the temporal testing. But the check the de-trended data *epiphyte load will be de-trended*.
```{r epi time, echo = FALSE}
## Assess temporal trend ##
plot(dat$date_julian, dat$epiphmass_shootmass)
tmod2 <- lm(dat$epiphmass_shootmass ~ dat$date_julian)
summary(tmod2)

## De-trend ##
resid.epi <- residuals(tmod2)
dat$epiphmass_shootmass_dt <- resid.epi
plot(dat$date_julian, dat$epiphmass_shootmass_dt)
```

Grazer load looks like it may have a temporal signal but its turns out that its not significant and has a low R-sq value.
```{r grz time, echo = FALSE}
## Assess temporal trend ##
plot(dat$date_julian, dat$grazermass_shootmass)
tmod3 <- lm(dat$grazermass_shootmass ~ dat$date_julian)
summary(tmod3)
```

Crabmass
```{r crb time, echo = FALSE}
## Assess temporal trend ##
plot(dat$date_julian, sqrt(dat$crab_mass))
```

Macroalgae cover does not have a temporal signal.
```{r macro time, echo = FLASE}
plot(dat$date_julian, asin(sqrt(dat$macro_dens / 100)))
tmod4 <- lm(asin(sqrt(dat$macro_dens / 100)) ~ dat$date_julian)
summary(tmod4)
```

Diatom cover shows some positive signal with time but turns out that its fairly weak. A bigger issue is how to deal with the missing data from one site. Se below
```{r dia time, echo = FALSE}
plot(dat$date_julian, asin(sqrt(dat$diatom_dens / 100)))
tmod5 <- lm(asin(sqrt(dat$diatom_dens[2:21] / 100)) ~ dat$date_julian[2:21])
summary(tmod5)

mean(asin(sqrt(dat$diatom_dens[2:21] / 100)))
```

### Missing data
The diatom cover data does not have a value for one site. There are a few ways to deal with this. One is to omit the data entirely which means omitting the site. I don't really want to do that. The overall mean of the observed could also work. Seeing that the transformation does reasonable well to normalize the data and there is reasonable spread across sites I think we can proceed with this approach. Note that later interpretation will need to address this. Another approach is to take the mean value from sites sampled close in time to site with missing data. This makes logical sense, but then again we did not find a significant time effect. We could also use multiple imputation, but thats hold off.. for now. 

So lets add the mean value. And check normality again. Looks good.
```{r dia missing, echo = FALSE}
ggplot(dat[2:21,]) +
  geom_col(aes(x = site, y = asin(sqrt(diatom_dens/ 100)))) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

## add mean value ##
dat[1, 37] <- mean(dat$diatom_dens, na.rm = TRUE)

## assess normality again ##
hist(dat$diatom_dens)
hist(asin(sqrt(dat$diatom_dens / 100)))
shapiro.test(asin(sqrt(dat$diatom_dens / 100)))
```

## Polynomial relationships
Early exploratory analysis suggested that there may be some quadratic / exponetial relationships among data. This is especially true for eelgrass biomass vs. sea otter index. *Note* these relationships will be assessed with temporally detrended data if applicable.

Aboveground biomass shows some slight signs of a quadratic relationship with eelgrass above ground biomass. Plotting and modeling do not suggest that such a relationship is more explanatory than a linear relationship though.
```{r abv quad, echo=FALSE}
plot(dat$sea_otter_index_tr, dat$abvgnd_mass_dt)


ggplot(dat) +
  geom_point(aes(x = sea_otter_index_tr, y = abvgnd_mass_dt)) +
  geom_smooth(aes(x = sea_otter_index_tr, y = abvgnd_mass_dt), method = "loess")

ggplot(dat) +
  geom_point(aes(x = sea_otter_index_tr, y = abvgnd_mass_dt)) +
  geom_smooth(aes(x = sea_otter_index_tr, y = abvgnd_mass_dt), method = "loess", n = 4)

summary(gam(dat$abvgnd_mass_dt ~ s(dat$sea_otter_index_tr)))
```

## Multicolinearity
Another check after doing transfomarions etc.

The suspect grazer v diatom relationships does not look that good at all. 
```{r multi check, echo = FALSE}
plot(log(dat$grazermass_shootmass), asin(sqrt(dat$diatom_dens / 100)))
```

## Environmental data
Plots and analyses of environmental data across sites. I will focus on primary sediment, and coordinated nutirents, temp, salinity.

```{r envi dat, echo = FALSE}
pal <- lacroix_palette("PeachPear")

## Sediment ##
ggplot(dat) +
  geom_col(aes(x = site_num, y = sed_inside_prim)) +
  geom_errorbar(aes(x = site_no, ymin = sed_inside_prim - sed_inside_prim_se, ymax = sed_inside_prim + sed_inside_prim_se), width = 0) +
  scale_y_continuous(limits = c(0, 6), breaks = seq(0, 6, by = 1)) +
  labs(x = "Site", y = "Primary sediment score +/- SE") +
  theme(text = element_text(size = 10))

## Temperature ##
ggplot(subset(abiot.final, sample_type != "site")) +
  geom_bar(aes(x = as.factor(site_number), y = temperature_c, fill = sample_type), position = "dodge", stat = "identity") +
  scale_y_continuous(limits = c(0, 16), breaks = seq(0, 16, by = 2)) +
  scale_fill_manual(values = c("blue3", "deepskyblue"), name = "Sampling\nperiod", labels = c("1m", "4m")) +
  labs(x = "Site", y = expression('Temperature ('*~degree*C*')'))

## Nitrate ##
ggplot(abiot.final) +
  geom_bar(aes(x = as.factor(site_number), y = NOx_umol, fill = sample_type), position = "dodge", stat = "identity") +
  scale_y_continuous(limits = c(0, 3), breaks = seq(0, 3, by = 0.5)) +
  scale_fill_manual(values = c("blue3", "deepskyblue", "grey"), name = "Sampling\nperiod", labels = c("1m", "4m", "eelgrass")) +
  labs(x = "Site", y = "Nitrate (umol)")

## Salinity ##
ggplot(abiot.final) +
  geom_bar(aes(x = as.factor(site_number), y = salinity_ppt, fill = sample_type), position = "dodge", stat = "identity") +
  scale_y_continuous(limits = c(0, 33), breaks = seq(0, 33, by = 2)) +
  scale_fill_manual(values = c("blue3", "deepskyblue", "grey"), name = "Sampling\nperiod", labels = c("1m", "4m", "eelgrass")) +
  labs(x = "Site", y = "Salinity (ppt)")
```

## Models
General approach
1. Pass a global model to the `dredge()` funciton. This global model will include all predictors that make biological sense given the current understanding of trophic relationships and cascades in eelgrass ecosystems. Models will be ranked using AICc, as is recommended with small sample sizes. In general interactions will not be evaluated unless there is a seriously good biological reason.

2. Models within a delta AICc of <= 2 will be evaluated and interpreted on their effects on the response. 

3. Models within 2 AICc will be averages and evaluate on the 'full' average as that is recommened when there is high model selection uncertainty (Symonds and Moussalli 2011)

### Model 1 - Aboveground eelgrass biomass

Global model will include, sea otter index, epiphyte load, grazer load, crab biomass, fish biomass, sediment score, total nitrogen, macroalgae, and diatom percent cover. Note transformations of variables where appropraite.
```{r mod1 global, echo=FALSE}
mod1 <- lm(abvgnd_mass_dt ~ sea_otter_index_tr + epiphmass_shootmass_dt + grazermass_shootmass + crab_mass + fish_mass + asin(sqrt(macro_dens / 100)) + asin(sqrt(diatom_dens / 100)) + sed_inside_prim + NOx_site, data = dat)
```

Dredge and filter models
```{r mod1 dr, echo=FALSE}
## Dredge ##
mod1.dr <- dredge(mod1, rank = "AICc", evaluate = TRUE, extra = c("BIC", "R^2","adjR^2"), beta = "sd")

## Filter top models ##
mod1.dr.top <- mod1.dr %>% 
  filter(delta <= 2)

mod1.dr.top <- mod1.dr.top[,colSums(is.na(mod1.dr.top)) < nrow(mod1.dr.top)] # remove columns with 0s
datatable(round(mod1.dr.top, 4))

## Model average ##
mod1.avg <- model.avg(mod1.dr, subset = delta < 2, fit = TRUE, beta = "sd")
```

Model Diagnostics
```{r mod1 diag, echo = FALSE}
summary(mod1.avg)
mod1.avg$coefArray

beta_hat <- coef(mod1.avg)
obs_values_hat <- beta_hat["(Intercept)"] + beta_hat["sea_otter_index_tr"] * dat$sea_otter_index_tr
u_hat <- dat$abvgnd_mass_dt - obs_values_hat # residuals

plot(obs_values_hat, u_hat)
```

Extract coefficents 
```{r coefs top mod1, echo=FALSE}
## Summary ##
summary(mod1.avg)

## Extract coefficients ##
coef.mod1 <- data.frame(confint(mod1.avg, full = FALSE))
t <- data.frame(mod1.avg$coefficients[2,])
coef.mod1$est <- t$mod1.avg.coefficients.2...
coef.mod1$term <- rownames(coef.mod1)
names(coef.mod1) <- c("low", "high", "est", "term")

## Exclude intercept - for simplicity ##
coef.mod1 <- filter(coef.mod1, term != "(Intercept)")
```

Plotting coefficients by model
```{r mod1 plots coefs, echo=FALSE}
p.abv <- ggplot(coef.mod1) +
  geom_hline(yintercept = 0, lty = 2) +
  geom_point(aes(x = term, y = est), size = 2) +
  geom_errorbar(aes(x = term, ymin = low, ymax = high), width = 0) +
  scale_y_continuous(limits = c(-1.1, 1.1), breaks = seq(-1, 1, by = 0.50)) +
  labs(x = "Factor", y = "Estimate +/- 95% CI") +
  scale_x_discrete(labels = c("Diatoms", "Epiphytes", "Fish", "Nitrate","Sea otter\nindex", "Sediment")) +
  theme(text = element_text(size = 10))

ggplot(dat) +
  geom_point(aes(x = sea_otter_index_tr, y = abvgnd_mass_dt), size = 2) +
  labs(x = "Sea otter index", y = expression(paste("Aboveground eelgrass biomass (g/m"^"2"*")")))
```

### Model 2 - epiphyte load

Global model will include sea otter index, grazer load, crab biomass, fish biomass, sediment score, total nitrogen and macroalgae and diatom percent cover. Note transformations of variables where appropraite.
```{r mod2 global, echo=FALSE}
mod2 <- lm(epiphmass_shootmass_dt ~ sea_otter_index_tr + grazermass_shootmass + crab_mass + fish_mass + sed_inside_prim + NOx_site + asin(sqrt(macro_dens / 100)) + asin(sqrt(diatom_dens / 100)), data = dat)
```

Dredge and filter models
```{r mod2 dr, echo=FALSE}
## Dredge ##
mod2.dr <- dredge(mod2, rank = "AICc", evaluate = TRUE, extra = c("BIC", "R^2","adjR^2"), beta = "sd")

## Filter top models ##
mod2.dr.top <- mod2.dr %>% 
  filter(delta <= 2)

mod2.dr.top <- mod2.dr.top[,colSums(is.na(mod2.dr.top)) < nrow(mod2.dr.top)] # remove columns with 0s
datatable(round(mod2.dr.top, 4))

## Model average ##
mod2.avg <- model.avg(mod2.dr, subset = delta < 2, fit = TRUE, beta = "sd")
```

Extract coefficents 
```{r coefs top mod2, echo=FALSE}
## Summary ##
summary(mod2.avg)

## Extract coefficients ##
coef.mod2 <- data.frame(confint(mod2.avg, full = FALSE))
t <- data.frame(mod2.avg$coefficients[2,])
coef.mod2$est <- t$mod2.avg.coefficients.2...
coef.mod2$term <- rownames(coef.mod2)
names(coef.mod2) <- c("low", "high", "est", "term")

## Exclude intercept - for simplicity ##
coef.mod2 <- filter(coef.mod2, term != "(Intercept)")
```

Plotting coefficients by model
```{r mod2 plots coefs, echo=FALSE}
p.epi <- ggplot(coef.mod2) +
  geom_hline(yintercept = 0, lty = 2) +
  geom_point(aes(x = term, y = est), size = 2) +
  geom_errorbar(aes(x = term, ymin = low, ymax = high), width = 0) +
  scale_y_continuous(limits = c(-1.1, 1.1), breaks = seq(-1, 1, by = 0.50)) +
  labs(x = "Factor", y = "Estimate +/- 95% CI") +
  scale_x_discrete(labels = c("Benthic\ndiatoms", "Macroalgae", "Crabs", "Fish", "Grazers", "Nitrate", "Sediment")) +
  theme(text = element_text(size = 10))
```

### Model 3 - grazer load

Global model will include, sea otter index, epiphyte load, crab biomass, fish predator biomass, sediment score, and total nitrogen. Note transformations of variables where appropraite.

```{r mod3 global, echo=FALSE}
mod3 <- lm(log(grazermass_shootmass) ~ sea_otter_index_tr + epiphmass_shootmass_dt + crab_mass + fish_mass + sed_inside_prim + NOx_site + asin(sqrt(macro_dens / 100)) + asin(sqrt(diatom_dens / 100)), data = dat)
```

Dredge and filter models
```{r mod3 dr, echo=FALSE}
## Dredge ##
mod3.dr <- dredge(mod3, rank = "AICc", evaluate = TRUE, extra = c("BIC", "R^2","adjR^2"), beta = "sd")

## Filter top models ##
mod3.dr.top <- mod3.dr %>% 
  filter(delta <= 2)

mod3.dr.top <- mod3.dr.top[,colSums(is.na(mod3.dr.top)) < nrow(mod3.dr.top)] # remove columns with 0s
datatable(round(mod3.dr.top, 4))

## Model average ##
mod3.avg <- model.avg(mod3.dr, subset = delta < 2, fit = TRUE, beta = "sd")
```

Extract coefficents 
```{r coefs top mod3, echo=FALSE}
## Summary ##
summary(mod3.avg)

## Extract coefficients ##
coef.mod3 <- data.frame(confint(mod3.avg, full = FALSE))
t <- data.frame(mod3.avg$coefficients[2, ])
coef.mod3$est <- t$mod3.avg.coefficients.2...
coef.mod3$term <- rownames(coef.mod3)
names(coef.mod3) <- c("low", "high", "est", "term")

## Exclude intercept - for simplicity ##
coef.mod3 <- filter(coef.mod3, term != "(Intercept)")
```

Plotting coefficients by model
```{r mod3 plots coefs, echo=FALSE}
p.grz <- ggplot(coef.mod3) +
  geom_hline(yintercept = 0, lty = 2) +
  geom_point(aes(x = term, y = est), size = 2) +
  geom_errorbar(aes(x = term, ymin = low, ymax = high), width = 0) +
  scale_y_continuous(limits = c(-1.1, 1.1), breaks = seq(-1, 1, by = 0.50)) +
  labs(x = "Factor", y = "Estimate +/- 95% CI") +
  scale_x_discrete(labels = c("Benthic\ndiatoms", "Crabs", "Epiphytes")) +
  theme(text = element_text(size = 10))

ggplot(dat) +
  geom_point(aes(x = epiphmass_shootmass_dt, y = grazermass_shootmass), size = 2) +
  labs(x = "Epiphyte load (g /g eelgrass)", y = "Grazer load (g / g eelgrass)")

predict(mod3.avg)
```

### Model 4 - Crab biomass

Global model will include julian day, sea otter index, grazer load, epiphyte load, aboveground eelgrass biomass, fish predator biomass, sediment score. Note transformations of variables where appropraite.

```{r mod4 global, echo=FALSE}
mod4 <- lm(sqrt(crab_mass) ~ abvgnd_mass_dt + sea_otter_index_tr + grazermass_shootmass + fish_mass + sed_inside_prim, data = dat)
```

Dredge and filter models
```{r mod4 dr, echo=FALSE}
## Dredge ##
mod4.dr <- dredge(mod4, rank = "AICc", evaluate = TRUE, extra = c("BIC", "R^2","adjR^2"), beta = "sd")

## Filter top models ##
mod4.dr.top <- mod4.dr %>% 
  filter(delta <= 2)

mod4.dr.top <- mod4.dr.top[,colSums(is.na(mod4.dr.top)) < nrow(mod4.dr.top)] # remove columns with 0s
datatable(round(mod4.dr.top, 4))

## Model average - except not because it does not need one ##
mod4.avg <- lm(sqrt(crab_mass) ~ sea_otter_index_tr, data = dat)
std.coef(mod4.avg, partial.sd = FALSE)
```

Extract coefficents 
```{r coefs top mod4, echo=FALSE}
## Summary ##
summary(mod4.avg)

## Extract coefficients ##
coef.mod4 <- data.frame(std.coef(mod4.avg, partial.sd = FALSE))
coef.mod4$low <- coef.mod4$Estimate. - (coef.mod4$Std..Error. * 1.96)
coef.mod4$high <- coef.mod4$Estimate. + (coef.mod4$Std..Error. * 1.96)
coef.mod4$term <- rownames(coef.mod4)

## Exclude intercept - for simplicity ##
coef.mod4 <- filter(coef.mod4, term != "(Intercept)")
```

Plotting coefficients by model
```{r mod4 plots coefs, echo=FALSE}
p.crb <- ggplot(coef.mod4) +
  geom_hline(yintercept = 0, lty = 2) +
  geom_point(aes(x = term, y = Estimate.), size = 2) +
  geom_errorbar(aes(x = term, ymin = round(low, 2), ymax = high), width = 0) +
  scale_y_continuous(limits = c(-1.1, 1.1), breaks = seq(-1, 1, by = 0.50)) +
  labs(x = "Factor", y = "Estimate +/- 95% CI") +
  scale_x_discrete(labels = c("Sea otter\nindex")) +
  theme(text = element_text(size = 10))

ggplot(dat) +
  geom_point(aes(x = sea_otter_index_tr, y = crab_mass), size = 2)
  
```

### Model 5 - Fish

Global model will include sea otter index, grazer load, epiphyte load, total eelgrass biomass, crab biomass, sediment score, total nitrogen. Note transformations of variables where appropraite.

```{r mod5 global, echo=FALSE}
mod5 <- lm(log(fish_mass) ~  sea_otter_index_tr + abvgnd_mass_dt + grazermass_shootmass + crab_mass + sed_inside_prim, data = dat)
```

Dredge and filter models
```{r mod5 dr, echo=FALSE}
## Dredge ##
mod5.dr <- dredge(mod5, rank = "AICc", evaluate = TRUE, extra = c("BIC", "R^2","adjR^2"), beta = "sd")

## Filter top models ##
mod5.dr.top <- mod5.dr %>% 
  filter(delta <= 2)

mod5.dr.top <- mod5.dr.top[,colSums(is.na(mod5.dr.top)) < nrow(mod5.dr.top)] # remove columns with 0s
datatable(round(mod5.dr.top, 4))

## Model average ##
mod5.avg <- model.avg(mod5.dr, subset = delta < 2, fit = TRUE, beta = "sd")
```

Extract coefficents 
```{r coefs top mod5}
## Summary ##
summary(mod5.avg)

## Extract coefficients ##
coef.mod5 <- data.frame(confint(mod5.avg, full = FALSE))
t <- data.frame(mod5.avg$coefficients[2,])
coef.mod5$est <- t$mod5.avg.coefficients.2...
coef.mod5$term <- rownames(coef.mod5)
names(coef.mod5) <- c("low", "high", "est", "term")

## Exclude intercept - for simplicity ##
coef.mod5 <- filter(coef.mod5, term != "(Intercept)")
```

Plotting coefficients by model
```{r mod5 plots coefs, echo=FALSE}
p.fsh <- ggplot(coef.mod5) +
  geom_hline(yintercept = 0, lty = 2) +
  geom_point(aes(x = term, y = est), size = 2) +
  geom_errorbar(aes(x = term, ymin = round(low, 2), ymax = high), width = 0) +
  scale_y_continuous(limits = c(-1.1, 1.1), breaks = seq(-1, 1, by = 0.50)) +
  labs(x = "Factor", y = "Estimate +/- 95% CI") +
  scale_x_discrete(labels = c("Eelgrass", "Crabs", "Sea otter\nindex", "Sediment")) +
  theme(text = element_text(size = 10))
```

## Results summary
All together now.
```{r summary plot}
plot_grid(p.crb, p.fsh, p.grz, p.epi, p.abv, ncol = 1, labels = "auto", align = "v", label_x = 0.17)
```

## Export dredge objects
For manuscripts and the like
```{r export dredge}
write.csv(mod1.dr.top, "abv_raw_dredge.csv", row.names = FALSE)
write.csv(mod2.dr.top, "epi_raw_dredge.csv", row.names = FALSE)
write.csv(mod3.dr.top, "grz_raw_dredge.csv", row.names = FALSE)
write.csv(mod4.dr.top, "crb_raw_dredge.csv", row.names = FALSE)
write.csv(mod5.dr.top, "fsh_raw_dredge.csv", row.names = FALSE)
```

## Useful Plots
Plots of other data that are helpful to look at/show people so they calm down.
```{r ex plots}
## Total nitrogen ##
ggplot(dat) +
  geom_col(aes(x = site, y = Ntotal_site)) +
  geom_errorbar(aes(x = site, ymin = Ntotal_site - Ntotal_site_se, ymax = Ntotal_site + Ntotal_site_se), width = 0) +
  theme(text = element_text(size = 18), axis.ticks = element_line(size = 2)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

## time and eelgrass ##
ggplot(dat) +
  geom_point(aes(x = date_julian, y = abvgnd_mass), size = 5) +
  labs(x = "date", y = "aboveground biomass") +
  theme(text = element_text(size = 18), axis.ticks = element_line(size = 2)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

## Grazer load and epiphyte load ##
ggplot(dat) +
  geom_point(aes(x = grazermass_shootmass, y = epiphmass_shootmass)) +
  labs(x = "Grazer load (g/g eelgrass)", y = "Epiphyte load (g/g eelgrass)") +
  theme(text = element_text(size = 10))

## Crab Mass by site ##
ggplot(dat) +
  geom_col(aes(x = place_name, y = crab_mass)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

## Crabs and Fish ##
ggplot(dat) +
  geom_point(aes(x = crab_mass, y = log(fish_mass)))

## Epiphytes and site ##
ggplot(dat) +
  geom_point(aes(x = order(site_num), y = epiphmass_shootmass)) +
  geom_errorbar(aes(x = order(site_num), ymin = epiphmass_shootmass - epiphmass_shootmass_se, ymax = epiphmass_shootmass + epiphmass_shootmass_se), width = 0) +
  scale_x_continuous(breaks = c(1:21)) +
  labs(x = "Site", y = "Epiphyte load +/- SE (g/g eelgrass)") +
  theme(text = element_text(size = 10))

## Eelgrass and fish ##
ggplot(dat) +
  geom_point(aes(x = fish_mass / 1000, y = abvgnd_mass)) +
  labs(x = "Fish mass (kg)", y = bquote('Eelgrass mass' ~(g/m^2))) +
  scale_x_continuous(breaks = c(0, 25, 50, 75, 100, 125, 150)) +
  scale_y_continuous(breaks = c(0, 40, 80, 120, 160)) +
  theme(text = element_text(size = 10))
```

