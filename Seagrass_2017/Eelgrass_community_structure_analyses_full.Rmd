---
title: "Eelgrass_community_structure_analyses_full"
author: "Wendel Raymond"
date: "November 1, 2018"
output: html_document
editor_options: 
  chunk_output_type: console
---
```{r}
library(dplyr)
library(tidyr)
library(ggplot2)
library(vegan)
library(nlme)
library(lme4)
library(MASS)
library(lmerTest)
library(DT)
library(ggplot2)
library(sjPlot)
library(cowplot)
library(MuMIn)
library(AICcmodavg)
options(na.action = "na.fail") # needed for MuMIn
theme_set(theme_classic())

st.er <- function(x, na.rm = TRUE) {
  stopifnot(is.numeric(x))
  return(sd(x, na.rm = na.rm)/sqrt(length(x)))
}
```

## Data
**Response metrics**
1. eelgrass aboveground biomass density (g / m^2^)
2. eelgrass belowground biomass density (g / m^2^)
3. ratio of aboveground to belowground biomass density (g / m^2^)
4. epiphyte load (g epiphyte / g eelgrass)
5. total grazer load (g grazers/ g eelgrass)
6. crab biomass (g) - can also be counts
7. fish biomass (g) - can also be counts

**Explanatory factors**
1. Sea otter index
2. Time
3. Sediment type (primary sediment type from the "inside" eelgrass transect)
4. Light attenuation
5. crab biomass (g)
6. fish biomass (g)
7. grazer load (g/g)
8. epiphyte load (g/g)
9. Total nitirgen

```{r import data, echo = FALSE, message = FALSE, warning = FALSE}
## Transect ##
tran.dat <- read.csv("../ALL_DATA/eelgrass_and_grazer_2017_derived.csv", header = TRUE, stringsAsFactors = FALSE)

## Sea Otter Impact Index ##
so.index <- read.csv("../ALL_DATA/sea_otter_impact_index_new.csv", stringsAsFactors = FALSE, header = TRUE)

## Sediment ##
sed.site <- read.csv("../ALL_DATA/TIFF_seagrass_carbon_disturbance/2017_data_efforts/seagrass_seaotter_pit_sediment_2017_RAW.csv", stringsAsFactors = FALSE, header = TRUE)

## Crab ##
crab.dat <- read.csv("../All_DATA/eelgrass_crab_pot_derived.csv", header = TRUE, stringsAsFactors = FALSE)
crab.dat$string <- as.character(crab.dat$string)

## Fish ##
fish.dat <- read.csv("../ALL_DATA/eelgrass_beach_seine_derived.csv", header = TRUE, stringsAsFactors = FALSE)

## Fish Taxonomy ##
fish.tax <- read.csv("../ALL_DATA/fish_taxonomy_RAW.csv", header = TRUE, stringsAsFactors = FALSE)

## RAW Nutrient Data ##
nut.dat <- read.csv("../ALL_DATA/seagrass_nutrients_2017_RAW.csv", header = TRUE, stringsAsFactors = FALSE)
```

### Data Prep
Sediment data preparation. We will assign the average sediment score from the inside eelgrass bed transect to each site.
```{r seds by site, echo=FALSE}
seds <- sed.site %>% 
  filter(trans_type == "Inside") %>% 
  group_by(site) %>% 
  summarise(sed_inside_prim = mean(sed1_no, na.rm = TRUE))

dat <- merge(tran.dat, seds, by = "site")
```

Light availability calculation. Taken as the ratio of light intensity at the eelgrass canopy to the light intensity at the surface.
```{r light avail, echo=FALSE}
dat$light_avail <- (dat$light_intensity_umol.m2.sec_transect / dat$light_intensity_umol.m2.sec_surface)
```

Crab data preparation. This needs to be done to summarise by site and string (i.e. loose species information). Average by site.
```{r crab sites string, echo=FALSE}
crab.site <- crab.dat %>% 
  group_by(site) %>% 
  summarise(crab_count = mean(count, na.rm = TRUE),
            crab_mass = mean(mass_g, na.rm = TRUE))

dat <- merge(dat, crab.site, by = "site")
```

Crab data preparation. Summarize counts and mass of cancer/rock crabs. Average by site.
```{r rock crabs string, echo=FALSE}
crab.rock <- crab.dat %>% 
  filter(sp_code == "CRABDUN" | sp_code == "CRABRR" | sp_code == "CRAGRA"| sp_code == "UNRKCB") %>% 
  group_by(site) %>% 
    summarise(rock_count = mean(count, na.rm = TRUE),
            rock_mass = mean(mass_g, na.rm = TRUE))

dat <- merge(dat, crab.rock, by = "site")
```

Fish data preparation. 
Append taxonomy
```{r}
fish.dat <- merge(fish.dat, fish.tax, by.x = "species_scientific", by.y = "scientific_name", all = TRUE)
```

This needs to be done to summarise count as mass by site across all species. Further the sum of fish predator mass will be caluclated.
```{r fish site, echo = FALSE}
## Full species List ##
# prep #
fish.site <- fish.dat %>% 
  group_by(site) %>% 
  summarise(fish_count = n(),
            fish_mass = sum(mass_g))

fish.site.sp <- fish.dat %>% 
  group_by(site, sp_code) %>% 
  summarise(count = n()) %>% 
  spread(key = sp_code, value = count)

fish.site.sp[is.na(fish.site.sp)] <- 0

fish.site.sp$fish_SW_diverse <- diversity(fish.site.sp[,2:56], index = "shannon")
fish.site.sp$fish_rich <- rowSums(fish.site.sp[, 2:56] != 0)

# Sum predators #
fish.site.sp$fish_preds <- rowSums(fish.site.sp[, c(2, 7:9, 13, 20, 31:40, 51, 53:55)])

fish.site <- merge(fish.site, fish.site.sp[, c(1, 57:59)], by = "site")

dat <- merge(dat, fish.site, by = "site")

# biomass community matirx #
fishmass.site.sp <- fish.dat %>% 
  group_by(site, sp_code) %>% 
  summarise(mass = sum(mass_g)) %>% 
  spread(key = sp_code, value = mass)

fishmass.site.sp[is.na(fishmass.site.sp)] <- 0

## Group by family counts ##
fish.site.fam <- fish.dat %>% 
  group_by(site, family) %>% 
  summarise(count = n()) %>% 
  spread(key = family, value = count)

fish.site.fam[is.na(fish.site.fam)] <- 0

## Group by family Mass ##
fishmass.site.fam <- fish.dat %>% 
  group_by(site, family) %>% 
  summarise(mass = sum(mass_g)) %>% 
  spread(key = family, value = mass)

fishmass.site.fam[is.na(fishmass.site.fam)] <- 0

dat <- merge(dat, fishmass.site.fam, by = "site")
```

## Tests for normality
Responses and predictors should be tested to see if they meet normality assumptions.

### Response data
Aboveground biomass
```{r abvgrnd biomass}
hist(dat$abvgnd_mass)
shapiro.test(dat$abvgnd_mass)
```

Belowground biomass is not normal. Log transformation fixes it.
```{r blwgrnd biomass}
hist(dat$blwgnd_mass)
shapiro.test(dat$blwgnd_mass)

hist(log(dat$blwgnd_mass))
shapiro.test(log(dat$blwgnd_mass))
```

Total eelgrass biomass is non-normal. Square root fixes it. Log it too intense.
```{r}
hist(dat$abvgnd_mass + dat$blwgnd_mass)
shapiro.test(dat$abvgnd_mass + dat$blwgnd_mass)

hist(sqrt(dat$abvgnd_mass + dat$blwgnd_mass))
shapiro.test(sqrt(dat$abvgnd_mass + dat$blwgnd_mass))
```

Aboveground:belowground biomass is normal
```{r avb:blw grnd biomass}
hist(dat$abvgnd_mass/dat$blwgnd_mass)
shapiro.test(dat$abvgnd_mass/dat$blwgnd_mass)
```

Epiphyte load is not normal but log transformation fixes it
```{r epi load }
hist(dat$epiphmass_shootmass)
range(dat$epiphmass_shootmass)
shapiro.test(dat$epiphmass_shootmass)

hist(log(dat$epiphmass_shootmass))
shapiro.test(log(dat$epiphmass_shootmass))
```

Grazer Load is not normal but log transformation fixes it.
```{r grz load}
hist(dat$grazermass_shootmass)
range(dat$grazermass_shootmass)

hist(log(dat$grazermass_shootmass))
shapiro.test(log(dat$grazermass_shootmass))
```

Crab biomass is not normal but is corrected with sqrt tranformation
```{r crb biomass}
hist(dat$crab_mass)
shapiro.test(dat$crab_mass)

hist(sqrt(dat$crab_mass))
shapiro.test(sqrt(dat$crab_mass))
```

Fish pred mass is not normal but log transforamtion fixes it. 
```{r fish pred biomass}
hist(dat$fish_preds)
shapiro.test(dat$fish_preds)

range(dat$fish_preds)
hist(log(dat$fish_preds))
shapiro.test(log(dat$fish_preds))
```

Sediment is not normal and there is not a good transformation becasue there are so many low values. I will proceed with a sqrt transformation because it appears the most normal.
```{r}
hist(dat$sed_inside_prim)
shapiro.test(dat$sed_inside_prim)

hist(sqrt(dat$sed_inside_prim))
shapiro.test(sqrt(dat$sed_inside_prim))
```

Total Nitrogen is not normal and there is not a good transformation. I will proceed with no transformation
```{r}
hist(dat$Ntotal_site)
shapiro.test(dat$Ntotal_site)

hist(log(dat$Ntotal_site))
shapiro.test(log(dat$Ntotal_site))
```

Light availability
```{r}
hist(dat$light_avail)
shapiro.test(dat$light_avail)
```

### Summary of appropriate transformations to meet normality
Factor  | Transformation
------  | --------------
Aboveground | none
Belowground | log
Total eelgrass mass | sqrt
Abv:Blw | none
epi load  | log
grz load  | log
crab  | sqrt
fish predators | log
sediment | sqrt
Total N | none
Light avil | none

## Checking for multicolinearity among common predictors
Checking for multicolinearity among predictors. 

```{r muticol}
pairs(dat[, c(4, 21, 51, 101, 109, 118, 115, 116, 125)])
```

## Models
General approach
1. Pass a global model to the `dredge()` funciton. This global model will include all predictors that make biological sense given the current understanding of trophic relationships and cascades in eelgrass ecosystems. Models will be ranked using AICc, as is recommended with small sample sizes. In general interactions will not be evaluated unless there is a seriously good biological reason.

2. Models within a delta AICc of <= 2 will be evaluated and interpreted on their effects on the response. 

3. Interpretation will focus primarily on the presnese of a factor in a model and their consistance of inclusion and sign in top models. P-values will serve a secondary role in evaluating factors, as the goal is to enucidate the ecological relationships amoung eelgrass community constiuents.

### Model 1 - Total eelgrass biomass

Global model will include julian day, sea otter index, epiphyte load, grazer load, crab biomass, fish predator biomass, sediment score, total nitrogen and light availability. Note transformations of variables where appropraite.
```{r mod1 global}
mod1 <- lm(sqrt(abvgnd_mass + blwgnd_mass) ~ date_julian + sea_otter_index_tr + log(epiphmass_shootmass) + log(grazermass_shootmass) + sqrt(crab_mass) + log(fish_preds) + sqrt(sed_inside_prim) + Ntotal_site + light_avail, data = dat)
```

Dredge and filter models
```{r mod1 dr}
## Dredge ##
mod1.dr <- dredge(mod1, rank = "AICc", evaluate = TRUE)
mod1.dr

## Filter top models ##
mod1.dr.top <- mod1.dr %>% 
  filter(delta <= 2)

mod1.dr.top <- mod1.dr.top[,colSums(is.na(mod1.dr.top)) < nrow(mod1.dr.top)] # remove columns with 0s
datatable(round(mod1.dr.top, 4))
```

Fit top models and view summary.
```{r fit top mod1}
## Model fits ##
mod1a <- lm(sqrt(abvgnd_mass + blwgnd_mass) ~ date_julian + sea_otter_index_tr + log(epiphmass_shootmass), data = dat)
mod1b <- lm(sqrt(abvgnd_mass + blwgnd_mass) ~ date_julian , data = dat)
mod1c <- lm(sqrt(abvgnd_mass + blwgnd_mass) ~ date_julian + sea_otter_index_tr, data = dat)
mod1d <- lm(sqrt(abvgnd_mass + blwgnd_mass) ~ date_julian + log(epiphmass_shootmass), data = dat)

## Model summary ##
summary(mod1a)
summary(mod1b)
summary(mod1c)
summary(mod1d)
```

Predicted values. Note that values will need to be squared becasue the model was fitted with the sqrt of total eelgrass mass.
```{r mod1 pred values}
## New data with median values ##
# Epiphyte load #
newdat.mod1.epi <- data.frame(date_julian = rep(median(dat$date_julian), 100), 
                              sea_otter_index_tr = rep(median(dat$sea_otter_index_tr), 100),
                              epiphmass_shootmass = seq(min(dat$epiphmass_shootmass), max(dat$epiphmass_shootmass), length.out = 100))

# Sea otter index #
newdat.mod1.soi <- data.frame(date_julian = rep(median(dat$date_julian), 100), 
                              sea_otter_index_tr = seq(min(dat$sea_otter_index_tr), max(dat$sea_otter_index_tr), length.out = 100),
                              epiphmass_shootmass = rep(median(dat$epiphmass_shootmass), 100))

# Julian day #
newdat.mod1.jday <- data.frame(date_julian = seq(min(dat$date_julian ), max(dat$date_julian ), length.out = 100), 
                              sea_otter_index_tr = rep(median(dat$sea_otter_index_tr), 100),
                              epiphmass_shootmass = rep(median(dat$epiphmass_shootmass), 100))

## Prediciton ##
# Epiphyte Load #
pred.mod1.epi <- predict(mod1a, type = "response", se.fit = TRUE, newdata = newdat.mod1.epi)
newdat.mod1.epi$pred <- (pred.mod1.epi$fit)^2
newdat.mod1.epi$lwr <- (pred.mod1.epi$fit - pred.mod1.epi$se.fit)^2
newdat.mod1.epi$upr <- (pred.mod1.epi$fit + pred.mod1.epi$se.fit)^2

# Sea otter index #
pred.mod1.soi <- predict(mod1a, type = "response", se.fit = TRUE, newdata = newdat.mod1.soi)
newdat.mod1.soi$pred <- (pred.mod1.soi$fit)^2
newdat.mod1.soi$lwr <- (pred.mod1.soi$fit - pred.mod1.soi$se.fit)^2
newdat.mod1.soi$upr <- (pred.mod1.soi$fit + pred.mod1.soi$se.fit)^2

# Julian day #
pred.mod1.jday <- predict(mod1a, type = "response", se.fit = TRUE, newdata = newdat.mod1.jday)
newdat.mod1.jday$pred <- (pred.mod1.jday$fit)^2
newdat.mod1.jday$lwr <- (pred.mod1.jday$fit - pred.mod1.jday$se.fit)^2
newdat.mod1.jday$upr <- (pred.mod1.jday$fit + pred.mod1.jday$se.fit)^2
```

Predicted values plots.
```{r mod1 pred plots}
## Epiphyte load ##
ggplot(newdat.mod1.epi) +
  geom_line(aes(x = epiphmass_shootmass, y = pred), lwd = 1) +
  geom_ribbon(aes(x = epiphmass_shootmass, ymin = lwr, ymax = upr), alpha = 0.2) +
  labs(x = "Epiphyte load", y = bquote(atop("Eelgrass biomass","+/- se" ~(g/m^2)))) +
  scale_y_continuous(limits = c(0, 120), breaks = seq(0, 120, by = 20)) +
  theme(text = element_text(size = 25), legend.position = "none")

## Sea otter index ##
ggplot(newdat.mod1.soi) +
  geom_line(aes(x = sea_otter_index_tr, y = pred), lwd = 1) +
  geom_ribbon(aes(x = sea_otter_index_tr, ymin = lwr, ymax = upr), alpha = 0.2) +
  labs(x = "Sea otter index", y = bquote(atop("Eelgrass biomass","+/- se" ~(g/m^2)))) +
  scale_y_continuous(limits = c(0, 130), breaks = seq(0, 130, by = 20)) +
  theme(text = element_text(size = 25), legend.position = "none")

## Julian Day ##
ggplot(newdat.mod1.jday) +
  geom_line(aes(x = date_julian, y = pred), lwd = 1) +
  geom_ribbon(aes(x = date_julian, ymin = lwr, ymax = upr), alpha = 0.2) +
  labs(x = "Julian Day", y = bquote(atop("Eelgrass biomass","+/- se" ~(g/m^2)))) +
  scale_y_continuous(limits = c(0, 160), breaks = seq(0, 160, by = 20)) +
  scale_x_continuous(limits = c(119, 240), breaks = seq(120, 240, by = 20)) +
  theme(text = element_text(size = 25), legend.position = "none")

ggplot(dat) +
  geom_point(aes(x = grazermass_shootmass, y = (abvgnd_mass + blwgnd_mass)), size = 4) +
  geom_errorbar(aes(x = grazermass_shootmass, ymin = (abvgnd_mass + blwgnd_mass) - (abvgnd_mass_se + blwgnd_mass_se), ymax = (abvgnd_mass + blwgnd_mass) + (abvgnd_mass_se + blwgnd_mass_se), width = 0)) +
  labs(x = "Grazer load", y = bquote(atop("Eelgrass biomass","+/- se" ~(g/m^2)))) +
  scale_y_continuous(limits = c(0, 250), breaks = seq(0, 250, by = 50)) +
  theme(text = element_text(size = 25), legend.position = "none")
```

### Model 2 - epiphyte load

Global model will include julian day, sea otter index, grazer load, crab biomass, fish predator biomass, sediment score, total nitrogen and light availability. Note transformations of variables where appropraite.
```{r mod2 global}
mod2 <- lm(log(epiphmass_shootmass) ~ date_julian + sea_otter_index_tr + log(grazermass_shootmass) + sqrt(crab_mass) + log(fish_preds) + sqrt(sed_inside_prim) + Ntotal_site + light_avail, data = dat)
```

Dredge and filter models
```{r mod2 dr}
## Dredge ##
mod2.dr <- dredge(mod2, rank = "AICc", evaluate = TRUE)
mod2.dr

## Filter top models ##
mod2.dr.top <- mod2.dr %>% 
  filter(delta <= 2)

mod2.dr.top <- mod2.dr.top[,colSums(is.na(mod2.dr.top)) < nrow(mod2.dr.top)] # remove columns with 0s
datatable(round(mod2.dr.top, 4))
```

Fit top models and view summary.
```{r fit top mod2}
## Model fits ##
mod2a <- lm(log(epiphmass_shootmass) ~ log(grazermass_shootmass) + sqrt(sed_inside_prim), data = dat)

## Model summary ##
summary(mod2a)
```

Predicted values. Note that values will need to be exp becasue the model was fitted with the log of grazerload.
```{r mod2 pred values}
## New data with median values ##
newdat.mod2.grz <- data.frame(grazermass_shootmass = seq(min(dat$grazermass_shootmass), max(dat$grazermass_shootmass), length.out = 100), sed_inside_prim = rep(median(dat$sed_inside_prim), 100))

newdat.mod2.sed <- data.frame(grazermass_shootmass = rep(median(dat$grazermass_shootmass, 100)), 
                              sed_inside_prim = seq(min(dat$sed_inside_prim), max(dat$sed_inside_prim), length.out = 100))

## Prediciton ##
pred.mod2.grz <- predict(mod2a, type = "response", se.fit = TRUE, newdata = newdat.mod2.grz)
newdat.mod2.grz$pred <- exp(pred.mod2.grz$fit)
newdat.mod2.grz$lwr <- exp(pred.mod2.grz$fit - pred.mod2.grz$se.fit)
newdat.mod2.grz$upr <- exp(pred.mod2.grz$fit + pred.mod2.grz$se.fit)

pred.mod2.sed <- predict(mod2a, type = "response", se.fit = TRUE, newdata = newdat.mod2.sed)
newdat.mod2.sed$pred <- exp(pred.mod2.sed$fit)
newdat.mod2.sed$lwr <- exp(pred.mod2.sed$fit - pred.mod2.sed$se.fit)
newdat.mod2.sed$upr <- exp(pred.mod2.sed$fit + pred.mod2.sed$se.fit)
```

Predicted values plots.
```{r mod2 pred plots}
## Grazer load ##
ggplot(newdat.mod2.grz) +
  geom_line(aes(x = grazermass_shootmass, y = pred), lwd = 1) +
  geom_ribbon(aes(x = grazermass_shootmass, ymin = lwr, ymax = upr), alpha = 0.2) +
  labs(x = "Grazer load (g/g)", y = bquote(atop("Epiphyte load", " +/- se (g/g)"))) +
  scale_y_continuous(limits = c(0, 0.15), breaks = seq(0, 0.15, by = 0.025)) +
  theme(text = element_text(size = 25), legend.position = "none")

## Sediment ##
ggplot(newdat.mod2.sed) +
  geom_line(aes(x = sed_inside_prim, y = pred), lwd = 1) +
  geom_ribbon(aes(x = sed_inside_prim, ymin = lwr, ymax = upr), alpha = 0.2) +
  labs(x = "Mean sediment grain size score", y = "Epiphyte load +/- se (g/g)") +
  scale_y_continuous(limits = c(0, 0.075), breaks = seq(0, 0.1, by = 0.025)) +
  theme(text = element_text(size = 25), legend.position = "none")
```

### Model 3 - grazer load

Global model will include julian day, sea otter index, epiphyte load, crab biomass, fish predator biomass, sediment score, total nitrogen and light availability. Note transformations of variables where appropraite.

```{r mod3 global}
mod3 <- lm(log(grazermass_shootmass) ~ date_julian + sea_otter_index_tr + log(epiphmass_shootmass) + sqrt(crab_mass) + log(fish_preds) + sqrt(sed_inside_prim) + Ntotal_site + light_avail, data = dat)
```

Dredge and filter models
```{r mod3 dr}
## Dredge ##
mod3.dr <- dredge(mod3, rank = "AICc", evaluate = TRUE)
mod3.dr

## Filter top models ##
mod3.dr.top <- mod3.dr %>% 
  filter(delta <= 2)

mod3.dr.top <- mod3.dr.top[,colSums(is.na(mod3.dr.top)) < nrow(mod3.dr.top)] # remove columns with 0s
datatable(round(mod3.dr.top, 4))
```

Fit top models and review summary
```{r fit top mod3}
## Fit ##
mod3a <- lm(log(grazermass_shootmass) ~ log(epiphmass_shootmass), data = dat)

mod3d <- lm(log(grazermass_shootmass) ~ log(epiphmass_shootmass) + log(fish_preds) + sqrt(crab_mass), data = dat)

## Summary ##
summary(mod3d)
```

Predicted values. Note that values will need to be exp becasue the model was fitted with the log of grazerload.
```{r mod3 pred values}
## New data with median values ##
newdat.mod3.epi <- data.frame(epiphmass_shootmass = seq(min(dat$epiphmass_shootmass), max(dat$epiphmass_shootmass), length.out = 100))

newdat.mod3.crb <- data.frame(epiphmass_shootmass  = rep(median(dat$epiphmass_shootmass), 100),
                              fish_preds = rep(median(dat$fish_preds), 100),
                              crab_mass = seq(min(dat$crab_mass), max(dat$crab_mass), length.out = 100))

## Prediciton ##
pred.mod3.epi <- predict(mod3a, type = "response", se.fit = TRUE, newdata = newdat.mod3.epi)
newdat.mod3.epi$pred <- exp(pred.mod3.epi$fit)
newdat.mod3.epi$lwr <- exp(pred.mod3.epi$fit - pred.mod3.epi$se.fit)
newdat.mod3.epi$upr <- exp(pred.mod3.epi$fit + pred.mod3.epi$se.fit)

pred.mod3.crb <- predict(mod3d, type = "response", se.fit = TRUE, newdata = newdat.mod3.crb)
newdat.mod3.crb$pred <- exp(pred.mod3.crb$fit)
newdat.mod3.crb$lwr <- exp(pred.mod3.crb$fit - pred.mod3.crb$se.fit)
newdat.mod3.crb$upr <- exp(pred.mod3.crb$fit + pred.mod3.crb$se.fit)
```

Predicted values plots.
```{r mod3 pred plots}
ggplot(newdat.mod3.epi) +
  geom_line(aes(x = epiphmass_shootmass, y = pred), lwd = 1) +
  geom_ribbon(aes(x = epiphmass_shootmass, ymin = lwr, ymax = upr), alpha = 0.2) +
  labs(x = "Epiphyte load (g/g)", y = "Grazer load +/- se (g/g)") +
  scale_y_continuous(limits = c(0, 0.1), breaks = seq(0, 0.1, by = 0.025)) +
  theme(text = element_text(size = 25), legend.position = "none")

ggplot(newdat.mod3.crb) +
  geom_line(aes(x = crab_mass, y = pred), lwd = 1) +
  geom_ribbon(aes(x = crab_mass, ymin = lwr, ymax = upr), alpha = 0.2) +
  labs(x = "Crab mass", y = "Grazer load +/- se (g/g)") +
  scale_y_continuous(limits = c(0, 0.1), breaks = seq(0, 0.1, by = 0.025)) +
  theme(text = element_text(size = 25), legend.position = "none")

ggplot(dat) +
  geom_point(aes(x = crab_mass, y = grazermass_shootmass), size = 4) +
  geom_errorbar(aes(x = crab_mass, ymin = grazermass_shootmass - grazermass_shootmass_se, ymax = grazermass_shootmass + grazermass_shootmass_se), width = 1) +
  labs(x = "Crab mass", y = "Grazer load +/- se (g/g)") +
  scale_y_continuous(limits = c(0, 0.25), breaks = seq(0, 0.25, by = 0.125)) +
  theme(text = element_text(size = 25), legend.position = "none")

ggplot(dat) +
  geom_point(aes(x = fish_preds, y = grazermass_shootmass), size = 4) +
  geom_errorbar(aes(x = fish_preds, ymin = grazermass_shootmass - grazermass_shootmass_se, ymax = grazermass_shootmass + grazermass_shootmass_se), width = 1) +
  labs(x = "Benthic fish predators", y = "Grazer load +/- se (g/g)") +
  scale_y_continuous(limits = c(0, 0.25), breaks = seq(0, 0.25, by = 0.125)) +
  theme(text = element_text(size = 25), legend.position = "none")

ggplot(dat) +
  geom_point(aes(x = sea_otter_index, y = grazermass_shootmass), size = 4) +
  geom_errorbar(aes(x = sea_otter_index, ymin = grazermass_shootmass - grazermass_shootmass_se, ymax = grazermass_shootmass + grazermass_shootmass_se), width = 0) +
  labs(x = "Sea otter index", y = "Grazer load +/- se (g/g)") +
  scale_y_continuous(limits = c(0, 0.25), breaks = seq(0, 0.25, by = 0.125)) +
  scale_x_continuous(limits = c(-0.6, 1.5), breaks = seq(-0.5, 1.5, by = 0.5)) +
  theme(text = element_text(size = 25), legend.position = "none")
```

### Model 4 - Crab biomass

Global model will include julian day, sea otter index, grazer load, epiphyte load, total eelgrass biomass, fish predator biomass, sediment score, total nitrogen and light availability. Note transformations of variables where appropraite.

```{r mod4 global}
mod4 <- lm(sqrt(crab_mass) ~ date_julian + sea_otter_index_tr + +log(grazermass_shootmass) + log(epiphmass_shootmass) + log(fish_preds) + sqrt(sed_inside_prim) + Ntotal_site + light_avail, data = dat)
```

Dredge and filter models
```{r mod4 dr}
## Dredge ##
mod4.dr <- dredge(mod4, rank = "AICc", evaluate = TRUE)
mod4.dr

## Filter top models ##
mod4.dr.top <- mod4.dr %>% 
  filter(delta <= 2)

mod4.dr.top <- mod4.dr.top[,colSums(is.na(mod4.dr.top)) < nrow(mod4.dr.top)] # remove columns with 0s
datatable(round(mod4.dr.top, 4))
```

Fit top models and review summary
```{r fit top mod4}
## Fit ##
mod4a <- lm(sqrt(crab_mass) ~ sea_otter_index_tr, data = dat)

## Summary ##
summary(mod4a)
```

Predicted values. Note that values will need to be squared becasue the model was fitted with the sqrt of crab biomass.
```{r mod4 pred values}
## New data with median values ##
newdat.mod4.soi <- data.frame(sea_otter_index_tr = seq(min(dat$sea_otter_index_tr), max(dat$sea_otter_index_tr), length.out = 100))

## Prediciton ##
pred.mod4.soi <- predict(mod4a, type = "response", se.fit = TRUE, newdata = newdat.mod4.soi)
newdat.mod4.soi$pred <- (pred.mod4.soi$fit)^2
newdat.mod4.soi$lwr <- (pred.mod4.soi$fit - pred.mod4.soi$se.fit)^2
newdat.mod4.soi$upr <- (pred.mod4.soi$fit + pred.mod4.soi$se.fit)^2
```

Predicted values plots.
```{r mod4 pred plots}
ggplot(newdat.mod4.soi) +
  geom_line(aes(x = sea_otter_index_tr, y = pred), lwd = 1) +
  geom_ribbon(aes(x = sea_otter_index_tr, ymin = lwr, ymax = upr), alpha = 0.2) +
  labs(x = "Sea otter index", y = "Crab biomass +/- se (g)") +
  scale_y_continuous(limits = c(0, 150), breaks = seq(0, 150, by = 25)) +
  theme(text = element_text(size = 20), legend.position = "none")
```

### Model 5 - Fish predators

Global model will include julian day, sea otter index, grazer load, epiphyte load, total eelgrass biomass, crab biomass, sediment score, total nitrogen and light availability. Note transformations of variables where appropraite.

```{r mod5 global}
mod5 <- lm(log(fish_preds) ~ date_julian + sea_otter_index_tr + +log(grazermass_shootmass) + log(epiphmass_shootmass) + sqrt(crab_mass)  + sqrt(sed_inside_prim) + Ntotal_site + light_avail, data = dat)
```

Dredge and filter models
```{r mod5 dr}
## Dredge ##
mod5.dr <- dredge(mod5, rank = "AICc", evaluate = TRUE)
mod5.dr

## Filter top models ##
mod5.dr.top <- mod5.dr %>% 
  filter(delta <= 2)

mod5.dr.top <- mod4.dr.top[,colSums(is.na(mod5.dr.top)) < nrow(mod5.dr.top)] # remove columns with 0s
datatable(round(mod5.dr.top, 4))
```

Fit top models and review summary
```{r fit top mod5}
## Fit ##
mod5a <- lm(log(fish_preds) ~ sqrt(sed_inside_prim), data = dat)

## Summary ##
summary(mod5a)
```

Predict values. Note that values will have to be exp to account for log transformation.
```{r mod5 pred values}
## New data with median values ##
newdat.mod5.sed <- data.frame(sed_inside_prim = seq(min(dat$sed_inside_prim), max(dat$sed_inside_prim), length.out = 100))

## Prediction ##
pred.mod5.sed <- predict(mod5a, type = "response", se.fit = TRUE, newdata = newdat.mod5.sed)
newdat.mod5.sed$pred <- exp(pred.mod5.sed$fit)
newdat.mod5.sed$lwr <- exp(pred.mod5.sed$fit - pred.mod5.sed$se.fit)
newdat.mod5.sed$upr <- exp(pred.mod5.sed$fit + pred.mod5.sed$se.fit)
```

Predicted values plot
```{r mod5 pred plot}
ggplot(newdat.mod5.sed) +
  geom_line(aes(x = sed_inside_prim, y = pred), lwd = 1) +
  geom_ribbon(aes(x = sed_inside_prim, ymin = lwr, ymax = upr), alpha = 0.2) +
  labs(x = "Mean sediment grain size score", y = bquote(atop("Benthic fish predator biomass", " +/- se (g)"))) +
  scale_y_continuous(limits = c(0, 230), breaks = seq(0, 230, by = 50)) +
  theme(text = element_text(size = 25), legend.position = "none")
```

## Useful Plots
Plots of other data that are helpful to look at/show people so they calm down.
```{r ex plots}
## Total nitrogen ##
ggplot(dat) +
  geom_col(aes(x = site, y = Ntotal_site)) +
  geom_errorbar(aes(x = site, ymin = Ntotal_site - Ntotal_site_se, ymax = Ntotal_site + Ntotal_site_se), width = 0) +
  theme(text = element_text(size = 18), axis.ticks = element_line(size = 2)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

## time and eelgrass ##
ggplot(dat) +
  geom_point(aes(x = date_julian, y = (abvgnd_mass + blwgnd_mass)), size = 5) +
  labs(x = "Julian Day", y = bquote("Eelgrass biomass" ~(g/m^2))) +
  theme(text = element_text(size = 18), axis.ticks = element_line(size = 2)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

