---
title: "Eelgrass_community_structure_analyses_glmm"
author: "Wendel Raymond"
date: "February 18, 2018"
output: html_document
editor_options: 
  chunk_output_type: console
---
```{r}
library(dplyr)
library(tidyr)
library(ggplot2)
library(vegan)
library(nlme)
library(lme4)
library(MASS)
library(lmerTest)
library(DT)
library(ggplot2)
library(sjPlot)
library(cowplot)

theme_set(theme_classic())
```

## Data
**Response metrics**
1. eelgrass aboveground biomass density (g / m^2^)
2. eelgrass belowground biomass density (g / m^2^)
3. eelgrass shoot density (count / m^2^)
4. ratio of aboveground to belowground biomass density (g / m^2^)
5. epiphyte load (g epiphyte / g eelgrass)
6. total grazer load (g grazers/ g eelgrass)
    + gastropod load (g grazers/ g eelgrass)
    + crustaecean load (g grazers/ g eelgrass)
7. crab biomass (g) - can also be counts
8. fish biomass (g) - can also be counts

**Primary explanatory factors**
Not all these fators will necessarily be used in all models
1. Time
2. Sediment type (primary sediment type from the "inside" eelgrass transect)
3. Percent light

**Secondary explanatory factors**
Factors that are more specific to certain tests
1. crab biomass (g)
2. fish biomass (g)
3. grazer biomass (g)

```{r import data, echo = FALSE, message = FALSE, warning = FALSE}
## Transect ##
tran.dat <- read.csv("../ALL_DATA/eelgrass_and_grazer_2017_derived.csv", header = TRUE, stringsAsFactors = FALSE)

## Sea Otter Impact Index ##
so.index <- read.csv("../ALL_DATA/sea_otter_impact_index_2017_new.csv", stringsAsFactors = FALSE, header = TRUE)

## Sediment ##
sed.site <- read.csv("../ALL_DATA/seagrass_seaotter_pit_sediment_2017_RAW.csv", stringsAsFactors = FALSE, header = TRUE)

## Crab ##
crab.dat <- read.csv("../All_DATA/eelgrass_crab_pot_derived.csv", header = TRUE, stringsAsFactors = FALSE)
crab.dat$string <- as.character(crab.dat$string)

## Fish ##
fish.dat <- read.csv("../ALL_DATA/eelgrass_beach_seine_derived.csv", header = TRUE, stringsAsFactors = FALSE)

## Fish Taxonomy ##
fish.tax <- read.csv("../ALL_DATA/fish_taxonomy_RAW.csv", header = TRUE, stringsAsFactors = FALSE)
```

### Data Prep
Sediment data preparation. Average by site.
```{r seds by site}
seds <- sed.site %>% 
  filter(trans_type == "Inside") %>% 
  group_by(site) %>% 
  summarise(sed_inside_prim = mean(sed1_no, na.rm = TRUE))

dat <- merge(tran.dat, seds, by = "site")
```

Light availability calculation
```{r light avail}
dat$light_avail <- (dat$light_intensity_umol.m2.sec_transect / dat$light_intensity_umol.m2.sec_surface)
```

Crab data preparation. This needs to be done to summarise by site and string (i.e. loose species information). Average by site.
```{r crab sites string, echo=FALSE}
crab.site <- crab.dat %>% 
  group_by(site) %>% 
  summarise(crab_count = mean(count, na.rm = TRUE),
            crab_mass = mean(mass_g, na.rm = TRUE))

dat <- merge(dat, crab.site, by = "site")

crab.site.fuk <- crab.dat %>% 
  filter()
```

Crab data preparation. Summarize counts and mass of cancer/rock crabs. Average by site.
```{r rock crabs string, echo=FALSE}
crab.rock <- crab.dat %>% 
  filter(sp_code == "CRABDUN" | sp_code == "CRABRR" | sp_code == "CRAGRA"| sp_code == "UNRKCB") %>% 
  group_by(site) %>% 
    summarise(rock_count = mean(count, na.rm = TRUE),
            rock_mass = mean(mass_g, na.rm = TRUE))

dat <- merge(dat, crab.rock, by = "site")
```

Fish data preparation. 
append taxonomy
```{r}
fish.dat <- merge(fish.dat, fish.tax, by.x = "species_scientific", by.y = "scientific_name", all = TRUE)
```


This needs to be done to summarise by site across all species.
```{r fish site, echo = FALSE}
## Full species List ##
# prep #
fish.site <- fish.dat %>% 
  group_by(site) %>% 
  summarise(fish_count = n(),
            fish_mass = sum(mass_g))

fish.site.sp <- fish.dat %>% 
  group_by(site, sp_code) %>% 
  summarise(count = n()) %>% 
  spread(key = sp_code, value = count)

fish.site.sp[is.na(fish.site.sp)] <- 0

fish.site.sp$fish_SW_diverse <- diversity(fish.site.sp[,2:56], index = "shannon")
fish.site.sp$fish_rich <- rowSums(fish.site.sp[, 2:56] != 0)

fish.site <- merge(fish.site, fish.site.sp[, c(1, 57:58)], by = "site")

dat <- merge(dat, fish.site, by = "site")

# biomass community matirx #
fishmass.site.sp <- fish.dat %>% 
  group_by(site, sp_code) %>% 
  summarise(mass = sum(mass_g)) %>% 
  spread(key = sp_code, value = mass)

fishmass.site.sp[is.na(fishmass.site.sp)] <- 0

## Group by family counts ##
fish.site.fam <- fish.dat %>% 
  group_by(site, family) %>% 
  summarise(count = n()) %>% 
  spread(key = family, value = count)

fish.site.fam[is.na(fish.site.fam)] <- 0

## Group by family Mass ##
fishmass.site.fam <- fish.dat %>% 
  group_by(site, family) %>% 
  summarise(mass = sum(mass_g)) %>% 
  spread(key = family, value = mass)

fishmass.site.fam[is.na(fishmass.site.fam)] <- 0

dat <- merge(dat, fishmass.site.fam, by = "site")
```

## Models
Each model will get its own individual hypothesis and set up but will follow the same general framework. Initially I will be copying and learning from example code from Tim Tinker. Models will use a mixed effects Bayesian modeling stucture. Fixed effects and the random effect of site will be modeled with normally distribution density funtions. Response variables will be paramterized in a way that best fits their distribution (see above). Count data (shoot density) will be modeled with a negative binomial distrbution.

### Model 1 - Aboveground biomass
Response  - log normally distributed. We hypothesise that time (as julian day), sea otter index, sediment type, and light availability may effect aboveground biomass of eelgrass.

We generated a global model that includes linear and quadratic effects of julian day and sea otter index, and linear effects of sediment type, light availability, and total surface water nutirents.
```{r model 1}
## Global Model ##
mod1 <- stepAIC(glm(log(dat$abvgnd_mass) ~ 1), scope = list(upper = ~dat$date_julian + dat$sea_otter_index + poly(dat$date_julian, 2) + poly(dat$sea_otter_index, 2) + log(dat$epiphmass_shootmass) + dat$sed_inside_prim + dat$light_avail + dat$Ntotal_site, lower = ~ 1), direction = "both")
```

### Best Model 1
```{r model 1 best}
mod1.best <- glm(log(abvgnd_mass) ~  poly(date_julian, 2) + poly(sea_otter_index, 2) + log(epiphmass_shootmass), data = dat) 
summary(mod1.best)
par(mfrow = c(2, 2))
plot(mod1.best)
par(mfrow = c(1, 1))
```

### Model 1 Plots
Calculate predicted values and plot
```{r plots}
## Predicted Values ##
# Julian Day #
newdata.1.jday <- data.frame(date_julian = seq(min(dat$date_julian), max(dat$date_julian)), sea_otter_index = rep(median(dat$sea_otter_index), 116), epiphmass_shootmass = rep(median(dat$epiphmass_shootmass), 116))
pred.1.jday <- predict(mod1.best, se.fit = TRUE, type = "response", newdata = newdata.1.jday)
newdata.1.jday$Predict <- exp(pred.1.jday$fit)
newdata.1.jday$Lwr <- exp(pred.1.jday$fit - pred.1.jday$se.fit)
newdata.1.jday$Upr <- exp(pred.1.jday$fit + pred.1.jday$se.fit)

# Sea Otter Index #
newdata.1.soi <- data.frame(date_julian = rep(median(dat$date_julian), 100), sea_otter_index = seq(min(dat$sea_otter_index), max(dat$sea_otter_index), length.out = 100), epiphmass_shootmass = rep(median(dat$epiphmass_shootmass), 100)) 
pred.1.soi <- predict(mod1.best, se.fit = TRUE, type = "response", newdata = newdata.1.soi)
newdata.1.soi$Predict <- exp(pred.1.soi$fit)
newdata.1.soi$Lwr <- exp(pred.1.soi$fit - pred.1.soi$se.fit)
newdata.1.soi$Upr <- exp(pred.1.soi$fit + pred.1.soi$se.fit)

## Plots ##
# Julian Day #
p1.jday <- ggplot(newdata.1.jday) +
  geom_line(aes(x = date_julian, y = Predict), size = 1) +
  geom_ribbon(aes(x = date_julian, ymin = Lwr, ymax = Upr), alpha = 0.2) +
  labs(x = "Julian day", y = bquote("Aboveground mass +/- se"  ~(g/m^2))) +
  scale_x_continuous(breaks = seq(120, 240, by = 20)) +
  scale_y_continuous(lim = c(0, 130), breaks = seq(0, 130, by = 30)) +
  theme(text = element_text(size = 12), axis.ticks = element_line(size = 1), legend.position = "none")

# Sea Otter Index #
p1.soi <- ggplot(newdata.1.soi) +
  geom_line(aes(x = sea_otter_index, y = Predict), size = 1) +
  geom_ribbon(aes(x = sea_otter_index, ymin = Lwr, ymax = Upr), alpha = 0.2) +
  labs(x = "Sea otter index", y = bquote("Aboveground mass +/- se"  ~(g/m^2))) +
  scale_x_continuous(breaks = seq(-0.8, 1.2, by = 0.4)) +
  scale_y_continuous(lim = c(0,100), breaks = seq(0, 100, by = 20)) +
  theme(text = element_text(size = 12), axis.ticks = element_line(size = 1), legend.position = "none")
```

### Model 2 - Belowground biomass
Response  - log normally distributed. We hypothesise that time (as julian day), sea otter index, sediment type, and light availability may effect aboveground biomass of eelgrass.

We generated a global model that includes linear and quadratic effects of julian day and sea otter index, and linear effects of sediment type,light availability, and total surface water nutirents.
```{r model 2}
## Global Model ##
mod2 <- stepAIC(glm(log(dat$blwgnd_mass) ~ 1), scope = list(upper = ~dat$date_julian + dat$sea_otter_index + poly(dat$date_julian, 2) + poly(dat$sea_otter_index, 2) + log(dat$epiphmass_shootmass) + dat$sed_inside_prim + dat$light_avail + dat$Ntotal_site, lower = ~ 1), direction = "both")

mod2$anova
```

### Best Model 2
```{r}
mod2.best <- glm(log(blwgnd_mass) ~  date_julian + log(epiphmass_shootmass), data = dat) 
summary(mod2.best)
par(mfrow = c(2, 2))
plot(mod1.best)
par(mfrow = c(1, 1))
```

### Model 2 Plots
Calculate predicted values and plot
```{r}
## Predicted Values ##
# Julian Day #
newdata.2.jday <- data.frame(date_julian = seq(min(dat$date_julian), max(dat$date_julian)), epiphmass_shootmass = rep(median(dat$epiphmass_shootmass), 116))
pred.2.jday <- predict(mod2.best, se.fit = TRUE, type = "response", newdata = newdata.2.jday)
newdata.2.jday$Predict <- exp(pred.2.jday$fit)
newdata.2.jday$Lwr <- exp(pred.2.jday$fit - pred.2.jday$se.fit)
newdata.2.jday$Upr <- exp(pred.2.jday$fit + pred.2.jday$se.fit)

# Epiphyte Load #
newdata.2.epi <- data.frame(date_julian = rep(median(dat$date_julian), 100), epiphmass_shootmass = seq(min(dat$epiphmass_shootmass), max(dat$epiphmass_shootmass), length.out = 100))
pred.2.epi <- predict(mod2.best, se.fit = TRUE, type = "response", newdata = newdata.2.epi)
newdata.2.epi$Predict <- exp(pred.2.epi$fit)
newdata.2.epi$Lwr <- exp(pred.2.epi$fit - pred.2.epi$se.fit)
newdata.2.epi$Upr <- exp(pred.2.epi$fit + pred.2.epi$se.fit)

## Plots ##
# Julian Day #
p2.jday <- ggplot(newdata.2.jday) +
  geom_line(aes(x = date_julian, y = Predict), size = 1) +
  geom_ribbon(aes(x = date_julian, ymin = Lwr, ymax = Upr), alpha = 0.2) +
  labs(x = "Julian day", y = bquote("Belowground mass +/- se"  ~(g/m^2))) +
  scale_x_continuous(breaks = seq(120, 240, by = 20)) +
  scale_y_continuous(lim = c(0,40), breaks = seq(0, 40, by = 10)) +
  theme(text = element_text(size = 12), axis.ticks = element_line(size = 1), legend.position = "none")

p2.epi <- ggplot(newdata.2.epi) +
  geom_line(aes(x = epiphmass_shootmass, y = Predict), size = 1) +
  geom_ribbon(aes(x = epiphmass_shootmass, ymin = Lwr, ymax = Upr), alpha = 0.2) +
  labs(x = bquote("Epiphyte load" ~g/g), y = bquote("Belowground mass +/- se"  ~(g/m^2))) +
  scale_x_continuous(breaks = seq(0, 0.2, by = 0.05)) +
  scale_y_continuous(lim = c(0,40), breaks = seq(0, 40, by = 10)) +
  theme(text = element_text(size = 12), axis.ticks = element_line(size = 1), legend.position = "none")
```


### Model 3 - Shoot density
Response  - negative binomial. We hypothesise that time (as julian day), sea otter index, sediment type, light availability and total surface nitrogen may effect aboveground biomass of eelgrass.

We generated a global model that includes linear and quadratic effects of julian day and sea otter index, and linear effects of sediment type,light availability, and total surface water nutirents. 
```{r model 3}
## Count need to integers ##
dat$shoot_dens_rnd <- round(dat$shoot_dens, 0)

## Global Model ##
mod3 <- stepAIC(glm.nb(dat$shoot_dens_rnd ~ 1, link = "log"), scope = list(upper = ~dat$date_julian + dat$sea_otter_index + poly(dat$date_julian, 2) + log(dat$epiphmass_shootmass) + poly(dat$sea_otter_index, 2) + dat$sed_inside_prim + dat$light_avail + dat$Ntotal_site, lower = ~ 1), direction = "both")

mod3$anova
```

### Best Model 3
```{r model 3 best}
mod3.best <- glm.nb(shoot_dens_rnd ~  poly(date_julian, 2) + poly(sea_otter_index, 2) + log(epiphmass_shootmass), link = "log", data = dat)
summary(mod3.best)
par(mfrow = c(2, 2))
plot(mod3.best)
par(mfrow = c(1, 1))
```

### Model 3 Plots
```{r}
## Predicted Values ##
# Julian Day #
newdata.3.jday <- data.frame(date_julian = seq(min(dat$date_julian), max(dat$date_julian)), sea_otter_index = rep(median(dat$sea_otter_index), 116), epiphmass_shootmass = rep(median(dat$epiphmass_shootmass), 116))
pred.3.jday <- predict(mod3.best, se.fit = TRUE, type = "response", newdata = newdata.3.jday)
newdata.3.jday$Predict <- (pred.3.jday$fit)
newdata.3.jday$Lwr <- (pred.3.jday$fit - pred.3.jday$se.fit)
newdata.3.jday$Upr <- (pred.3.jday$fit + pred.3.jday$se.fit)

# Sea Otter Index #
newdata.3.soi <- data.frame(date_julian = rep(median(dat$date_julian), 100), sea_otter_index = seq(min(dat$sea_otter_index), max(dat$sea_otter_index), length.out = 100), epiphmass_shootmass = rep(median(dat$epiphmass_shootmass), 100)) 
pred.3.soi <- predict(mod3.best, se.fit = TRUE, type = "response", newdata = newdata.3.soi)
newdata.3.soi$Predict <- (pred.3.soi$fit)
newdata.3.soi$Lwr <- (pred.3.soi$fit - pred.3.soi$se.fit)
newdata.3.soi$Upr <- (pred.3.soi$fit + pred.3.soi$se.fit)

## Plots ##
# Julian Day #
p3.jday <- ggplot(newdata.3.jday) +
  geom_line(aes(x = date_julian, y = Predict), size = 1) +
  geom_ribbon(aes(x = date_julian, ymin = Lwr, ymax = Upr), alpha = 0.2) +
  labs(x = "Julian day", y = bquote("Shoot density +/- se"  ~(m^-2))) +
  scale_x_continuous(breaks = seq(120, 240, by = 20)) +
  scale_y_continuous(lim = c(0, 500), breaks = seq(0, 500, by = 100)) +
  theme(text = element_text(size = 12), axis.ticks = element_line(size = 1), legend.position = "none")

# Sea Otter Index #
p3.soi <- ggplot(newdata.3.soi) +
  geom_line(aes(x = sea_otter_index, y = Predict), size = 1) +
  geom_ribbon(aes(x = sea_otter_index, ymin = Lwr, ymax = Upr), alpha = 0.2) +
  labs(x = "Sea otter index", y = bquote("Shoot density +/- se"  ~(m^-2))) +
  scale_x_continuous(breaks = seq(-0.8, 1.2, by = 0.4)) +
  scale_y_continuous(lim = c(0, 300), breaks = seq(0, 300, by = 50)) +
  theme(text = element_text(size = 12), axis.ticks = element_line(size = 1), legend.position = "none")
```


### Model 4 - Aboveground:Belowground Biomass
Response  - log normally distributed. We hypothesise that time (as julian day), sea otter index, sediment type, light availability, and total surface water nitrogen may effect belowground biomass of eelgrass.

We generated a global model that includes linear and quadratic effects of julian day and sea otter index, and linear effects of sediment type,light availability, and total surface water nutirents.
```{r model 4}
## Global Model ##
mod4 <- stepAIC(glm(log(dat$abvgnd_mass / dat$blwgnd_mass) ~ 1), scope = list(upper = ~dat$date_julian + dat$sea_otter_index + poly(dat$date_julian, 2) + log(dat$epiphmass_shootmass) + poly(dat$sea_otter_index, 2) + dat$sed_inside_prim + dat$light_avail + dat$Ntotal_site, lower = ~ 1), direction = "both")

mod4$anova
```

### Best Model 4
```{r model 4 best}
mod4.best <- glm(log(abvgnd_mass / blwgnd_mass) ~  poly(date_julian, 2) + sea_otter_index, data = dat)
summary(mod4.best)
par(mfrow = c(2, 2))
plot(mod4.best)
par(mfrow = c(1, 1))
```

### Model 4 Plots
Calculate predicted values and plot
```{r plots}
## Predicted Values ##
# Julian Day #
newdata.4.jday <- data.frame(date_julian = seq(min(dat$date_julian), max(dat$date_julian)), sea_otter_index = rep(median(dat$sea_otter_index), 116))
pred.4.jday <- predict(mod4.best, se.fit = TRUE, type = "response", newdata = newdata.4.jday)
newdata.4.jday$Predict <- exp(pred.4.jday$fit)
newdata.4.jday$Lwr <- exp(pred.4.jday$fit - pred.4.jday$se.fit)
newdata.4.jday$Upr <- exp(pred.4.jday$fit + pred.4.jday$se.fit)

# Sea Otter Index #
newdata.4.soi <- data.frame(date_julian = rep(median(dat$date_julian), 100), sea_otter_index = seq(min(dat$sea_otter_index), max(dat$sea_otter_index), length.out = 100)) 
pred.4.soi <- predict(mod4.best, se.fit = TRUE, type = "response", newdata = newdata.4.soi)
newdata.4.soi$Predict <- exp(pred.4.soi$fit)
newdata.4.soi$Lwr <- exp(pred.4.soi$fit - pred.4.soi$se.fit)
newdata.4.soi$Upr <- exp(pred.4.soi$fit + pred.4.soi$se.fit)

## Plots ##
# Julian Day #
p4.jday <- ggplot(newdata.4.jday) +
  geom_line(aes(x = date_julian, y = Predict), size = 1) +
  geom_ribbon(aes(x = date_julian, ymin = Lwr, ymax = Upr), alpha = 0.2) +
  labs(x = "Julian day", y = "Aboveground : Belowground biomass +/- se") +
  scale_x_continuous(breaks = seq(120, 240, by = 20)) +
  scale_y_continuous(lim = c(0,4), breaks = seq(0, 4, by = 1)) +
  theme(text = element_text(size = 12), axis.ticks = element_line(size = 1), legend.position = "none")

# Sea Otter Index #
p4.soi <- ggplot(newdata.4.soi) +
  geom_line(aes(x = sea_otter_index, y = Predict), size = 1) +
  geom_ribbon(aes(x = sea_otter_index, ymin = Lwr, ymax = Upr), alpha = 0.2) +
  labs(x = "Sea otter index", y =  "Aboveground : Belowground biomass +/- se") +
  scale_x_continuous(breaks = seq(-0.8, 1.2, by = 0.4)) +
  scale_y_continuous(lim = c(0,6), breaks = seq(0, 6, by = 1)) +
  theme(text = element_text(size = 12), axis.ticks = element_line(size = 1), legend.position = "none")
```

### Model 5 - Node 2 distance
Responce - log normal. We hypothesise that time (as julian day), sea otter index, sediment type, light availability, and total surface water nitrogen may effect 2nd internode distance of eelgrass rhizomes.

We generated a global model that includes linear and quadratic effects of julian day and sea otter index, and linear effects of sediment type,light availability, and total surface water nutirents.
```{r model 5}
## Global Model ##
mod5 <- stepAIC(glm(log(dat$node2) ~ 1), scope = list(upper = ~dat$date_julian + dat$sea_otter_index + poly(dat$date_julian, 2) + poly(dat$sea_otter_index, 2) + log(dat$epiphmass_shootmass) + dat$sed_inside_prim + dat$light_avail + dat$Ntotal_site, lower = ~ 1), direction = "both")

mod5$anova
```

### Best Model 5
```{r model 5 best}
mod5.best <- glm(log(node2) ~  poly(date_julian, 2) + light_avail + Ntotal_site, data = dat)
summary(mod5.best)
par(mfrow = c(2, 2))
plot(mod5.best)
par(mfrow = c(1, 1))
```

### Model 5 Plots
Plots of predicted values.
```{r}
## Predicted Values ##
# Julian Day #
newdata.5.jday <- data.frame(date_julian = seq(min(dat$date_julian), max(dat$date_julian)), light_avail = rep(median(dat$light_avail), 116), Ntotal_site = rep(median(dat$Ntotal_site), 116))
pred.5.jday <- predict(mod5.best, se.fit = TRUE, type = "response", newdata = newdata.5.jday)
newdata.5.jday$Predict <- exp(pred.5.jday$fit)
newdata.5.jday$Lwr <- exp(pred.5.jday$fit - pred.5.jday$se.fit)
newdata.5.jday$Upr <- exp(pred.5.jday$fit + pred.5.jday$se.fit)

# Light Availability #
newdata.5.light <- data.frame(date_julian = rep(median(dat$date_julian), 100), light_avail = seq(min(dat$light_avail), max(dat$light_avail), length.out = 100), Ntotal_site = rep(median(dat$Ntotal_site), 100))
pred.5.light <- predict(mod5.best, se.fit = TRUE, type = "response", newdata = newdata.5.light)
newdata.5.light$Predict <- exp(pred.5.light$fit)
newdata.5.light$Lwr <- exp(pred.5.light$fit - pred.5.light$se.fit)
newdata.5.light$Upr <- exp(pred.5.light$fit + pred.5.light$se.fit)

## Plots ##
# Julian Day #
p5.jday <- ggplot(newdata.5.jday) +
  geom_line(aes(x = date_julian, y = Predict), size = 1) +
  geom_ribbon(aes(x = date_julian, ymin = Lwr, ymax = Upr), alpha = 0.2) +
  labs(x = "Julian day", y = "Rhizome second internode length +/- se (cm)") +
  scale_x_continuous(breaks = seq(120, 240, by = 20)) +
  scale_y_continuous(lim = c(0,2), breaks = seq(0, 2, by = 0.5)) +
  theme(text = element_text(size = 12), axis.ticks = element_line(size = 1), legend.position = "none")

# Light Availability #
p5.light <- ggplot(newdata.5.light) +
  geom_line(aes(x = light_avail, y = Predict), size = 1) +
  geom_ribbon(aes(x = light_avail, ymin = Lwr, ymax = Upr), alpha = 0.2) +
  labs(x = "Light availability ", y = "Rhizome second internode length +/- se (cm)") +
  scale_y_continuous(lim = c(0,3), breaks = seq(0, 3, by = 0.5)) +
  theme(text = element_text(size = 12), axis.ticks = element_line(size = 1), legend.position = "none")
```

### Model 6 - Epiphyte load
Response  - log normally distributed. We hypothesise that time (as julian day), sea otter index, sediment type, light availability, and grazer load may effect piephyte load on eelgrass.

We generated a global model that includes the lienar effects of date, sea otter index, sediment type, light availability, log grazer load, and total surface water nitrogen.
```{r model 6}
## Global Model ##
mod6 <- stepAIC(glm(log(dat$epiphmass_shootmass) ~ 1), scope = list(upper = ~dat$date_julian + dat$sea_otter_index + dat$sed_inside_prim + dat$light_avail + log(dat$grazermass_shootmass) + dat$Ntotal_site), direction = "both")

mod6$anova
```

### Best Model 6
```{r model 6 best}
mod6.best <- glm(log(epiphmass_shootmass) ~ log(grazermass_shootmass) + sed_inside_prim + light_avail, data = dat)
summary(mod6.best)
par(mfrow = c(2, 2))
plot(mod6.best)
par(mfrow = c(1, 1))
```

### Model 6 Plots
```{r}
## Predicted Values ##
# Grazer Load #
newdata.6.grz <- data.frame(grazermass_shootmass = seq(min(dat$grazermass_shootmass), max(dat$grazermass_shootmass), length.out = 100), sed_inside_prim = rep(median(dat$sed_inside_prim), 100), light_avail = rep(median(dat$light_avail), 100))
pred.6.grz <- predict(mod6.best, se.fit = TRUE, type = "response", newdata = newdata.6.grz)
newdata.6.grz$Predict <- exp(pred.6.grz$fit)
newdata.6.grz$Lwr <- exp(pred.6.grz$fit - pred.6.grz$se.fit)
newdata.6.grz$Upr <- exp(pred.6.grz$fit + pred.6.grz$se.fit)

# Sediment type #
newdata.6.sed <- data.frame(grazermass_shootmass = rep(median(dat$grazermass_shootmass), 100), sed_inside_prim = seq(min(dat$sed_inside_prim), max(dat$sed_inside_prim), length.out = 100), light_avail = rep(median(dat$light_avail), 100))
pred.6.sed <- predict(mod6.best, se.fit = TRUE, type = "response", newdata = newdata.6.sed)
newdata.6.sed$Predict <- exp(pred.6.sed$fit)
newdata.6.sed$Lwr <- exp(pred.6.sed$fit - pred.6.sed$se.fit)
newdata.6.sed$Upr <- exp(pred.6.sed$fit + pred.6.sed$se.fit)

## Plots ##
# Grazer load #
p6.grz <- ggplot(newdata.6.grz) +
  geom_line(aes(x = grazermass_shootmass, y = Predict), size = 1) +
  geom_ribbon(aes(x = grazermass_shootmass, ymin = Lwr, ymax = Upr), alpha = 0.2) +
  labs(x = "Grazer load (g/g)", y = "Epiphyte load +/- se (g/g)") +
  scale_x_continuous(breaks = seq(0, 0.15, by = 0.05)) +
  scale_y_continuous(lim = c(0,0.1), breaks = seq(0, 0.1, by = 0.025)) +
  theme(text = element_text(size = 12), axis.ticks = element_line(size = 1), legend.position = "none")

# Sediment Type #
p6.sed <- ggplot(newdata.6.sed) +
  geom_line(aes(x = sed_inside_prim, y = Predict), size = 1) +
  geom_ribbon(aes(x = sed_inside_prim, ymin = Lwr, ymax = Upr), alpha = 0.2) +
  labs(x = "Sediment type", y = "Epiphyte load +/- se (g/g)") +
  scale_x_continuous(breaks = seq(0, 6, by = 1)) +
  scale_y_continuous(lim = c(0,0.06), breaks = seq(0, 0.06, by = 0.02)) +
  theme(text = element_text(size = 12), axis.ticks = element_line(size = 1), legend.position = "none")
```

### Model 7 - Grazer load
Response - Log normally distributed. We hypothesise that time (as julian day), sea otter index, epiphyte load, log crab biomass may affect grazer load on eelgrass.

We generated a global model that includes the linear effects of date, sea otter index, log epiphyte load, and log crab biomass.
```{r model 7}
## Global Model ##
mod7 <- stepAIC(glm(log(dat$grazermass_shootmass) ~ 1), scope = list(upper = ~dat$date_julian + dat$sea_otter_index + log(dat$epiphmass_shootmass) + log(dat$crab_mass)), direction = "both")

mod7$anova
```

### Best Model 7
```{r model 7 best}
mod7.best <- glm(log(grazermass_shootmass) ~  log(epiphmass_shootmass), data = dat)
summary(mod7.best)
par(mfrow = c(2, 2))
plot(mod7.best)
par(mfrow = c(1, 1))
```

### Model 7 Plots
```{r}
## Predicted Values ##
# Epiphyte Load #
newdata.7.epi <- data.frame(epiphmass_shootmass = seq(min(dat$epiphmass_shootmass), max(dat$epiphmass_shootmass), length.out = 100))
pred.7.epi <- predict(mod7.best, se.fit = TRUE, type = "response", newdata = newdata.7.epi)
newdata.7.epi$Predict <- exp(pred.7.epi$fit)
newdata.7.epi$Lwr <- exp(pred.7.epi$fit - pred.7.epi$se.fit)
newdata.7.epi$Upr <- exp(pred.7.epi$fit + pred.7.epi$se.fit)

## Plots ##
# Epiphyte Load #
p7.epi <- ggplot(newdata.7.epi) +
  geom_line(aes(x = epiphmass_shootmass, y = Predict), size = 1) +
  geom_ribbon(aes(x = epiphmass_shootmass, ymin = Lwr, ymax = Upr), alpha = 0.2) +
  labs(x = "Epiphyte load (g/g)", y = "Grazer load +/- se (g/g)") +
  scale_x_continuous(breaks = seq(0, 0.15, by = 0.05)) +
  scale_y_continuous(lim = c(0, 0.08), breaks = seq(0, 0.08, by = 0.02)) +
  theme(text = element_text(size = 12), axis.ticks = element_line(size = 1), legend.position = "none")
```


### Model 8 - Crabs
Response - Log normally distributed. We hypothesise that time (as julian day), sea otter index, grazer biomass, may affect grazer load on eelgrass.

We generated a global model that includes the linear effects of date, sea oter index and log grazer load. 
```{r model 8}
## Global Model ##
mod8 <- stepAIC(glm(log(dat$crab_mass) ~ 1), scope = list(upper = ~dat$date_julian + dat$sea_otter_index + log(dat$grazermass_shootmass)), direction = "both")

mod8$anova
```

### Best Model 8
```{r model 8 best}
mod8.best <- glm(log(crab_mass) ~ sea_otter_index, data = dat)
summary(mod8.best)
par(mfrow = c(2, 2))
plot(mod8.best)
par(mfrow = c(1, 1))
```

### Model 8 Plots
Calculate predicted vales and plot
```{r plots}
## Predicted Values ##
newdata.8 <- data.frame(sea_otter_index = seq(min(dat$sea_otter_index), max(dat$sea_otter_index), length.out = 100))
pred.8 <- predict(mod8.best, se.fit = TRUE, type = "response", newdata = newdata.8)
newdata.8$Predict <- exp(pred.8$fit)
newdata.8$Lwr <- exp(pred.8$fit - pred.8$se.fit)
newdata.8$Upr <- exp(pred.8$fit + pred.8$se.fit)

## Plot ##
p8.crb <- ggplot(newdata.8) +
  geom_line(aes(x = sea_otter_index, y = Predict), size = 1) +
  geom_ribbon(aes(x = sea_otter_index, ymin = Lwr, ymax = Upr), alpha = 0.2) +
  labs(x = "Sea otter index", y = "Crab biomass (g)") +
  scale_y_continuous(breaks = seq(0, 150, by = 20)) +
  theme(text = element_text(size = 12), axis.ticks = element_line(size = 1), legend.position = "none")
```

### Fishes
Since we only sampled fishes with one beach seine at each site we have a limited ability to draw meaningful inference about fish dynamics. However, we can at least repost our findings and demonstrate the biomass and diversity of fishes in eelgrass beds, to point out that they are likley a strong driver in the ecosystem and may be the cause of our "decoupled" trophic cascade.

#### Multivariate
First values should be standardized and transformed. We will use a 4th root tranformation which is often used with hihgly abundant variable species data. 
```{r multivariate prep fish}
## Fish by species ##
str(fish.site.sp)

## Tranformation ##
fish.sp.trsfrm <- (fish.site.sp[, 2:56]^0.25)

## Standardize to column maximum i.e. species maximum ##
fish.std <- as.data.frame(scale(fish.sp.trsfrm, center = FALSE, scale = apply(fish.sp.trsfrm, 2, max)))
```

```{r multivariate mass}
## Transform ##
fishmass.sp.trsfrm <- (fishmass.site.sp[,2:56]^0.25)

## Standardize to column maximum i.e. species maximum ##
fishmass.std <- as.data.frame(scale(fishmass.sp.trsfrm, center = FALSE, scale = apply(fishmass.sp.trsfrm, 2, max)))
```

Transform fish family counts
```{r}
## Transform ##
fish.fam.trsnfrm <- (fish.site.fam[,2:20]^0.25)

## Standardize to column maximum i.e. species maximum ##
fish.fam.std <- as.data.frame(scale(fish.fam.trsnfrm, center = FALSE, scale = apply(fish.fam.trsnfrm, 2, max)))
```

Transform fish family mass
```{r}
## Transform ##
fishmass.fam.trsnfrm <- (fishmass.site.fam[,2:20]^0.25)

## Standardize to column maximum i.e. species maximum ##
fishmass.fam.std <- as.data.frame(scale(fishmass.fam.trsnfrm, center = FALSE, scale = apply(fishmass.fam.trsnfrm, 2, max)))
```

Multivariate analysis of fish counts
```{r}
## Dissimilarity matirx ##
fish.diss <- vegdist(fish.std, method = "bray")
round(fish.diss, 2)

## PCA ##
fish.pca <- prcomp(fish.std)
summary(fish.pca)
biplot(fish.pca, cex = 0.5)

## PERMDISP ##
fish.disp <- betadisper(fish.diss, fish.site.sp$site)
fish.disp
anova(fish.disp)
plot(fish.disp)

## PERMANOVA ##
mod9 <- adonis2(fish.diss ~ site, data = fish.site.sp, permutations = 9999)
mod9

## MDS ##
mod9.mds <- metaMDS(fish.diss, k = 2)
plot(mod9.mds$points, asp = 1)
mod9.mds

```

Multivariate analysis of fish mass
```{r}
## Dissimilarity matirx ##
fishmass.diss <- vegdist(fishmass.std, method = "bray")
round(fishmass.diss, 2)

## PCA ##
fishmass.pca <- prcomp(fishmass.std)
summary(fishmass.pca)
biplot(fishmass.pca, cex = 0.5)
screeplot(fishmass.pca)

# Nice plot #
autoplot(fishmass.pca, loadings = TRUE, loadings.label = TRUE)

## PERMDISP ##
fishmass.disp <- betadisper(fishmass.diss, fish.site.sp$site)
fishmass.disp
anova(fishmass.disp)

## PERMANOVA ##
mod9b <- adonis2(fishmass.diss ~ site, data = fishmass.site.sp, permutations = 9999)
mod9b

## MDS ##
mod9b.mds <- metaMDS(fishmass.diss, k = 2)
plot(mod9b.mds$points, asp = 1)
mod9b.mds
```

Multivariate analysis of fish family counts
```{r}
## Dissimilarity matirx ##
fish.fam.diss <- vegdist(fish.fam.std, method = "bray")
round(fish.fam.diss, 2)

## PCA ##
fish.fam.pca <- prcomp(fish.fam.std)
summary(fish.fam.pca)
biplot(fish.fam.pca, cex = 0.5)
screeplot(fish.fam.pca)
```

Multivariate analysis of fish family mass
```{r}
## Dissimilarity matirx ##
fishmass.fam.diss <- vegdist(fishmass.fam.std, method = "bray")
round(fish.fam.diss, 2)

## PCA ##
fishmass.fam.pca <- prcomp(fishmass.fam.std)
summary(fishmass.fam.pca)
biplot(fishmass.fam.pca, cex = 0.5)
screeplot(fish.fam.pca)
```
#### Simple models and summaries
Simple models
```{r}
mod10 <- stepAIC(glm(log(dat$fish_mass) ~ 1), 
                scope = list(upper = ~dat$date_julian + dat$sea_otter_index + log(dat$grazermass_shootmass) + log(dat$crab_mass) + log(dat$abvgnd_mass) + log(dat$shoot_dens)), direction = "both")

mod10$anova


mod11 <- stepAIC(glm(log(dat$fish_count) ~ 1), 
                scope = list(upper = ~dat$date_julian + dat$sea_otter_index + log(dat$grazermass_shootmass) + log(dat$crab_mass) + log(dat$abvgnd_mass) + log(dat$shoot_dens)), direction = "both")

mod11$anova

mod12 <- stepAIC(glm(dat$fish_SW_diverse ~ 1), 
                scope = list(upper = ~dat$date_julian + dat$sea_otter_index + log(dat$grazermass_shootmass) + log(dat$crab_mass) + log(dat$abvgnd_mass) + log(dat$shoot_dens)), direction = "both")

mod12$anova

mod13 <- stepAIC(glm(dat$fish_rich ~ 1), 
                scope = list(upper = ~dat$date_julian + dat$sea_otter_index + log(dat$grazermass_shootmass) + log(dat$crab_mass) + log(dat$abvgnd_mass) + log(dat$shoot_dens)), direction = "both")

mod13$anova

```

Given that fish are not well explained by any of our data, lets take a look at all the data together. First we will look at basic summary statistics, and the average relative fq by species.
```{r}
## Basic summar yastats of all seines ##
fish.sum <- dat %>% 
  summarise(abundance = mean(fish_count),
            abundance_se = (sd(fish_count) / sqrt(21)),
            biomass = mean(fish_mass / 1000),
            biomass_se = (sd(fish_mass / 1000) / sqrt(21)),
            richness = mean(fish_rich),
            richness_se = (sd(fish_rich) / sqrt(21)),
            SW = mean(fish_SW_diverse),
            SW_se = (sd(fish_SW_diverse) / sqrt(21)))

write.csv(fish.sum, "Eelgrass_structure_MS_results/fish_summary_stats.csv", row.names =  FALSE)

## Average relative fq of species ##
fish.site.sp$total <- rowSums(fish.site.sp[, 2:56])

fish.sp.relfq <- (fish.site.sp[,2:56] / fish.site.sp$total)

fish.relfq.mean <- as.data.frame(lapply(fish.sp.relfq, FUN = mean))
fish.relfq.mean <- data.frame(sp_code = colnames(fish.relfq.mean),
                              mean_rel_freq = t(fish.relfq.mean[1,]))
colnames(fish.relfq.mean) <- c("sp_code", "mean_rel_freq")

fish.relfq.mean$mean_rel_freq <- round(fish.relfq.mean$mean_rel_freq, 4)
```


## Collating Model results
### Modeling results table
Table to look at result from best models
```{r full results best model, echo = FALSE}
all.results.simp <- sjt.glm(mod1.best, mod2.best, mod3.best, mod4.best, mod5.best, mod6.best, mod7.best, mod8.best, group.pred = FALSE, depvar.labels = c("Aboveground", "Belowground", "Shoot density", "Aboveground/Belowground", "Second internode distance", "Epiphyte Load", "Grazer Load", "Crab biomass"), exp.coef = FALSE, show.r2 = TRUE)

all.results.simp
```

Another type of table to look at model results
```{r}
summary(mod1.best)

sjt.glm(mod1.best, mod2.best, mod3.best, mod4.best, mod5.best, mod6.best, mod7.best, mod8.best, group.pred = FALSE, depvar.labels = c("Aboveground", "Belowground", "Shoot density", "Aboveground/Belowground", "Second internode distance", "Epiphyte Load", "Grazer Load", "Crab biomass"), pred.labels = c("Day", "Day^2", "SO Index", "SO Index^2", "Epiphyte Load", "Day", "SO Index", "Total N", "Grazer Load", "Sediment Type", "Light Avail."), exp.coef = FALSE, show.r2 = TRUE)
```

### Predicted Values Plots
Above and below ground biomass
```{r}
plot_grid(p1.jday, p1.soi, p2.jday, p2.epi, p4.jday, p4.soi, nrow = 3, ncol = 2)
```

Shoot Density, 2nd internode
```{r}
plot_grid(p3.jday, p3.soi, p5.jday, p5.light)
```

Epiphyte load, grazer load, crabs
```{r}
plot_grid(p6.grz, p6.sed, p7.epi, p8.crb)
```

## Site characterization data
Summary information on site characterization including date, sea otter index, envi conditions, sediment characteristics.
```{r}
## Collate environmental data ##
site.envi <- cbind.data.frame(dat[,2:3], round(dat[, 5:6], 2), round(dat[, c(15,17,19,21,23,25,27,29,31,33)],2), round(dat[,45:51], 2), round(dat[, 57:61], 2), round(dat[, 115], 2), round(dat[, 116], 2))
colnames(site.envi)[27] <- "sediment"
colnames(site.envi)[28] <- "light_availability"

## Export ##
write.csv(site.envi, "Eelgrass_structure_MS_results/site_summary_stats.csv", row.names =  FALSE)

```


#### Plots
```{r}
ggplot(dat) +
  geom_point(aes(x = sea_otter_index, y = log(Embiotocidae + 1)), size = 3)
```

