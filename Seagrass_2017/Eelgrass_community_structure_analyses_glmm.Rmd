---
title: "Eelgrass_community_structure_analyses_glmm"
author: "Wendel Raymond"
date: "February 18, 2018"
output: html_document
editor_options: 
  chunk_output_type: console
---
```{r}
library(dplyr)
library(tidyr)
library(ggplot2)
library(vegan)
library(nlme)
library(lme4)
library(MASS)
library(lmerTest)
```

## Data
**Response metrics**
1. eelgrass aboveground biomass density (g / m^2^)
2. eelgrass belowground biomass density (g / m^2^)
3. eelgrass shoot density (count / m^2^)
4. ratio of aboveground to belowground biomass density (g / m^2^)
5. epiphyte load (g epiphyte / g eelgrass)
6. total grazer load (g grazers/ g eelgrass)
    + gastropod load (g grazers/ g eelgrass)
    + crustaecean load (g grazers/ g eelgrass)
7. crab biomass (g) - can also be counts
8. fish biomass (g) - can also be counts

**Primary explanatory factors**
Not all these fators will necessarily be used in all models
1. Time
2. Sediment type (primary sediment type from the "inside" eelgrass transect)
3. Percent light

**Secondary explanatory factors**
Factors that are more specific to certain tests
1. crab biomass (g)
2. fish biomass (g)
3. grazer biomass (g)

```{r import data, echo = FALSE, message = FALSE, warning = FALSE}
tran.dat <- read.csv( "../ALL_DATA/eelgrass_bio_sed_transect_derived.csv", header = TRUE, stringsAsFactors = FALSE)

crab.dat <- read.csv("../All_DATA/eelgrass_crab_pot_derived.csv", header = TRUE, stringsAsFactors = FALSE)
crab.dat$string <- as.character(crab.dat$string)

fish.dat <- read.csv("../ALL_DATA/eelgrass_beach_seine_derived.csv", header = TRUE, stringsAsFactors = FALSE)
```

### Data Prep
Crab data preparation. This needs to be done to summarise by site and string (i.e. loose species information).
```{r crab sites string, echo=FALSE}
crab.string <- crab.dat %>% 
  group_by(site, string) %>% 
  summarise(count = sum(count),
            mass = sum(mass_g))
```

Crab data preparation. Summarize counts and mass of cancer/rock crabs.
```{r rock crabs string, echo=FALSE}
crab.rock <- crab.dat %>% 
  filter(sp_code == "CRABDUN" | sp_code == "CRABRR" | sp_code == "CRAGRA"| sp_code == "UNRKCB") %>% 
  group_by(site, string) %>% 
  summarise(count = sum(count),
            mass = sum(mass_g))
```

Fish data preparation. This needs to be done to summarise by site across all species.
```{r fish site, echo = FALSE}
fish.site <- fish.dat %>% 
  group_by(site) %>% 
  summarise(count = n(),
            mass_g = sum(mass_g))

fish.site$mass_kg <- fish.site$mass_g / 1000
fish.site$gperfish <- fish.site$mass_g / fish.site$count
```

Fish data preparation. Calculate diversity measures by site.
```{r fish diversity}
fish.site.sp <- fish.dat %>% 
  group_by(site, sp_code) %>% 
  summarise(count = n()) %>% 
  spread(key = sp_code, value = count)

fish.site.sp[is.na(fish.site.sp)] <- 0

fish.site.sp$SW.diverse <- diversity(fish.site.sp[,2:56], index = "shannon")
fish.site.sp$rarefy.rich <- rarefy(fish.site.sp[,2:56], sample = min(rowSums(fish.site.sp[,2:56])))

# merge back to fish.site ##
fish.site <- merge(fish.site, fish.site.sp[, c(1, 57:58)], by = "site")
```

Fish data preparation. Summarise by functional groups by site. What are these funcitonal groups?
1. Benthic predators = sculpins, gunnels, flatfish
2. Water column predators = greenlings, shiner perch, three spines


## Models
Each model will get its own individual hypothesis and set up but will follow the same general framework. Initially I will be copying and learning from example code from Tim Tinker. Models will use a mixed effects Bayesian modeling stucture. Fixed effects and the random effect of site will be modeled with normally distribution density funtions. Response variables will be paramterized in a way that best fits their distribution (see above). Count data (shoot density) will be modeled with a negative binomial distrbution.

### Model 1 - Aboveground biomass
Response  - log normally distributed. We hypothesise that time (as julian day), sea otter index, sediment type, and light attenuation may effect aboveground biomass of eelgrass.

```{r}
# Dependent observed variable: this should be whatever numeric variable you wish to analyze 
Obs <- as.numeric(log(tran.dat$ag_mass))

# select only oberved variables that are not NA
ii <- which(!is.na(Obs))
Obs <- Obs[ii]

# Variables to use as independent or identifier variables
Ottindx <- as.numeric(tran.dat$sea_otter_index)[ii]
Sedtype <- as.numeric(tran.dat$sed1_no)[ii]
Julianday <- as.numeric(tran.dat$date_julian)[ii]
Light <- as.numeric(tran.dat$light_attenu)[ii]
Sitetxt <- tran.dat$site[ii]

mod1a <- summary(lmer(Obs ~  Julianday + (1 | Sitetxt), REML = FALSE))

mod1b <- summary(lmer(Obs ~  Julianday + Ottindx + (1 | Sitetxt), REML = FALSE))

mod1c <- summary(lmer(Obs ~  Julianday + Ottindx + Sedtype + (1 | Sitetxt), REML = FALSE))

mod1d <- summary(lmer(Obs ~  Julianday + Ottindx + Sedtype + Light + (1 | Sitetxt), REML = FALSE))

mod1e <- summary(lmer(Obs ~  Julianday + poly(Ottindx, 2) + (1 | Sitetxt), REML = FALSE))

mod1f <- summary(lmer(Obs ~  Julianday + poly(Ottindx, 2) + Sedtype + (1 | Sitetxt), REML = FALSE))

mod1g <- summary(lmer(Obs ~  poly(Julianday, 2) + Ottindx + (1 | Sitetxt), REML = FALSE))

mod1h <- summary(lmer(Obs ~  poly(Julianday, 2) + poly(Ottindx, 2) + (1 | Sitetxt), REML = FALSE))

Model.1.Comp <- data.frame(model = c("mod1a", "mod1b", "mod1c", "mod1d", "mod1e", "mod1f", "mod1g", "mod1h"),
                           AIC = numeric(length = 8),
                           BIC = numeric(length = 8),
                           logLik = numeric(length = 8),
                           deviance = numeric(length = 8),
                           df.resid = numeric(length = 8))

Model.1.Comp[1, 2:6] <- mod1a$AICtab
Model.1.Comp[2, 2:6] <- mod1b$AICtab
Model.1.Comp[3, 2:6] <- mod1c$AICtab
Model.1.Comp[4, 2:6] <- mod1d$AICtab
Model.1.Comp[5, 2:6] <- mod1e$AICtab
Model.1.Comp[6, 2:6] <- mod1f$AICtab
Model.1.Comp[7, 2:6] <- mod1g$AICtab
Model.1.Comp[8, 2:6] <- mod1h$AICtab

```

