---
title: "LME - Prey"
output: html_document
---

LME for prey with Site and Season as Fixed effects and Species as random effect.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, libraries and data, warning= FALSE, message=FALSE}
library(tidyverse)
library(ggthemes)
library(nlme) #lme model
library(emmeans)
library(MuMIn) #r.squaredGLMM
library(forcats) # condense factors
library(broom)
library(minpack.lm)
```

```{r, load data, message=FALSE, warning=FALSE}
#load prey data
si.prey <- read.csv("sifinal.csv")
si.prey <- si.prey %>% 
  filter(PreyCat != "Star" & Species != "map" & PreyCat != "Snail" & Species != "squid eggs")

si.prey$PreyCat <- fct_collapse(si.prey$PreyCat, Cucumber.Snail = c("Cucumber","Tegula"))
```

## Carbon by functional prey group
this is for each functional prey group by season for the two sites. 
```{r carbon graph, echo=FALSE}
si.prey %>%
  filter(Site == "Craig" | Site == "Soda Bay") %>%
  ggplot(aes(x=Season, y=Cnorm, fill=Site)) +
  geom_boxplot() +   theme_few() +
  labs(y=expression(paste(delta^13, "C" )), x= NULL) +
  scale_fill_brewer(palette = "Set2") +
  facet_wrap(vars(PreyCat), labeller = labeller(PreyCat = c("Clam" = "Clam", "Crab" = "Crab", 
                                                            "Cucumber.Snail" = "Cucumber and Snail", 
                                                            "Mussel" = "Mussel", "Urchin" = "Urchin"))) 
```

## Nitrogen by functional prey group
this is for each functional prey group by season for the two sites. 
```{r nitrogen graph, echo=FALSE}
si.prey %>%
  filter(Site == "Craig" | Site == "Soda Bay") %>%
  ggplot(aes(x=Season, y=N, fill=Site)) +
  geom_boxplot() +   theme_few() +
  labs(y=expression(paste(delta^15, "N" )), x=NULL) +
  scale_fill_brewer(palette = "Set2") +
  facet_wrap(vars(PreyCat),labeller = labeller(PreyCat = c("Clam" = "Clam", "Crab" = "Crab", 
                                                           "Cucumber.Snail" = "Cucumber and Snail", 
                                                           "Mussel" = "Mussel", "Urchin" = "Urchin")))
```


## Linear Mixed Effects Model

First, I am making a model for carbon with season and site as factors with prey catagory as a random factor

```{r lmmc}
lmmc <- lme(Cnorm ~ Season+Site, data=si.prey,
random = ~1|PreyCat)
anova(lmmc)
summary(lmmc)
r.squaredGLMM(lmmc)
```

#### Takeaways from this model: 

* Both site and season are significant (p < 0.01)
* Residual from random effects are lower than the fixed effects (model = 1.74, residual = 1.14)
* Fixed effects explain about 60%
* Craig is higher for filter feeders, but not for grazers and higher level consumers


Next, a model for nitrogen with the same factors 

```{r lmmn}
lmmn <- lme(N ~ Season+Site, data=si.prey,
random = ~1|PreyCat)
anova(lmmn)
summary(lmmn)
r.squaredGLMM(lmmn)
```

#### Takeaways from this model: 

* Season is not significant (p > 0.01)
* Site is significant (p < 0.01)
* Residual from random effects are lower than the fixed effects (model = 1.39, residual = .91)
* % of explaination from fixed effects is about the same as carbon (60%)
* Craig is higher for filter feeders, but not for grazers and higher level consumers (same as carbon!)



#### Residuals and QQ plots from original C and N LMEs

```{r residuals}
plot(lmmc)
plot(lmmn)
```

```{r qq plot}
qqnorm(resid(lmmc, type = "normalized"), main = "lmmc")
qqnorm(resid(lmmn, type = "normalized"), main = "lmmn")
```

This is where things start to confuse me. I don't understand why the predictors are so far off of the 1:1 line (in black) that it should theoretically follow. 

```{r predict and ranef for lmmn}
fixef(lmmn)
ranef(lmmn)
si.prey$predictN <- predict(lmmn, level=1)
ggplot(data=si.prey, aes(x=N, y=predictN)) +
    geom_abline(slope = 1, intercept = 0) +
  geom_point() +
      xlim(6, 14) + ylim(6, 14) +
  geom_smooth(se=FALSE, method= "lm") +
    facet_wrap(vars(PreyCat)) +
  theme_few()

fixef(lmmc)
ranef(lmmc)
si.prey$predictC <- predict(lmmc, level=1)
ggplot(data=si.prey, aes(x=C, y=predictC)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  geom_smooth(se=FALSE, method= "lm") +
    xlim(-21, -11) + ylim(-21, -11) +
  facet_wrap(vars(PreyCat)) +
  theme_few()
```

### Post hoc Tukey's procedure

```{r tukey ton}
lsmeans(lmmc, pairwise~Season, adjust="tukey")
lsmeans(lmmn, pairwise~Season, adjust="tukey")
```

### LM with separate models for each Prey Cat

this is a linear model where I separated out each prey catagory. It looks as if the season and site only have one predicted value so it does not follow the 1:1 line (gray) that it theoretically should.

```{r seaparate Prey Cats, message=FALSE, warning=FALSE}
si.prey.2 <- si.prey %>% select(SIN, Cnorm, N, Season, Site, PreyCat)
si.prey.2 %>%
  nest(-PreyCat) %>%
  mutate(fit=map(data, ~lm(Cnorm ~ Season*Site,data=.)),
                 results = map(fit, augment)) %>% 
  unnest(results) %>% 
  ggplot(aes(x = Cnorm, y = .fitted)) +
  geom_abline(intercept = 0, slope = 1, alpha = .2) +  # Line of perfect fit
  geom_point() +
  facet_wrap(vars(PreyCat), scales = "free") +
  labs(x = "Normalized carbon", y = "Predicted Value") +
  theme_bw()
```

