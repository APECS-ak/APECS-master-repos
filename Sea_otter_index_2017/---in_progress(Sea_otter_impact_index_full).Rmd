---
title: '---in_progress(Sea_otter_impact_index_full)'
author: "Wendel Raymond"
date: "December 14, 2017"
output: html_document
editor_options: 
  chunk_output_type: console
---

# Sea otter impact index
Sea otters are hard to keep track of. Until the 2017 field season the most reliable measure of sea otters in the Prince of Wales Island region were the USFWS aerial surveys. These data provided densities and time since occupation of sea otters. However the most recent survey was done in 2011. In an effort to add more resolution to how we think about sea otters we collected a variety of sea otter impact measures over the 2017 field season. This script summaries and then combined these measures to create a sea otter impact index. 

In this script we will calcualte the sea otter impact index from raw data to final index. This will be in contrast to relying on hard to track ArcGIS processing. The original index uses the folloing data that will be attributed to each site.

1. Sea otter density from 2017 boat based sea otter surveys (otters/km2)
2. The duration of sea otter occupation based in USFWS aerial surveys (years)
3. Sea otter density derived from Tinker et al. population model estimates (otters/km2)
4. Number of sea otter pits counted at a site (count)
5. Proportion of sea otter cracked shells (proportion)

## Packages
Since we will be working with spatial data we need to load a bunch of packages that deal with spatial data.
```{r libraries}
library(dplyr)
library(dplyr)
library(ggplot2)
library(spatstat)
library(maptools)
library(rgdal)
library(rgeos)
library(raster)
library(gdistance)
library(leaflet)
```

# 1. Sea otter density from boat based surveys
Two replicate surveys were conducted, a density will be calculated for each survey.

## Data
You will need data on.
1. Sites from which sea otter surveys were centered from (points)
2. Sea otter survey data (points with an "n sea otter" data attribute)
3. The 2003 and 2010 USFWS aerial surveys distribution polygons
4. Tim's, in review, survey population density polygons 
5. Southeast Alaska water polygon
```{r data}
## Sites ##
sites <- readOGR(dsn = "E:/wraymond2/My Documents/Graduate School/Eelgrass/Data/2017 Field Season/GIS", layer = "Otter_Survey_Sites_2017_All_UTM")
sites.eg <- subset(sites, site_type %in% "Eelgrass")

## Sea otters that where observed ##
otts <- readOGR(dsn = "E:/wraymond2/My Documents/Graduate School/Eelgrass/Data/2017 Field Season/GIS", layer = "Otter_Survey_All_17Oct17_UTM")
otts@data$n_otters <- as.numeric(otts@data$n_otters) # data is imported as a factor

## Prince of Wales Water Polygon
h2o.utm <- readOGR(dsn = "E:/wraymond2/My Documents/Graduate School/Eelgrass/Data/2017 Field Season/GIS", layer = "POW_water_UTM")
h2o.latlong <- spTransform(h2o.utm, CRS("+init=epsg:4326"))
```

## Plot sites and sea otters
```{r plotting everything}
leaflet() %>% 
  addTiles() %>% 
  addPolygons(data = h2o.latlong, stroke = NA, fillColor = "blue", fillOpacity = 0.8, group = "POW") %>% 
  addMarkers(data = sites.eg, ~longitude, ~latitude, label = ~site) %>% 
  addCircleMarkers(data = otts, ~longitude, ~latitude, color = "red", stroke = FALSE, radius = 5, fillOpacity = ~(n_otters/max(n_otters)))

```

## Calculating survey density
The general steps are as follows
1. Calculate survey area centered at each survey site and bounded by 2 nm "as the otter swims"
2. Calculate area of above survey area
3. Calculate density by counting number of otters in each area (and each survey instance if necessary) and dividing by the survey area

### Calcualte / generate survey area
Using the site points we will generate a unique polygon for each site that is bounded by 2 nm from the site "as the otter swims". The other way to think about this 2 nm over water.

Create raster of water area for each site.
1. Create generitc 2, buffer from each site
2. Clip **that** buffer by water so that the resulting polygon is just the water within 2nm of each site
3. Covert water buffer polygons (made above) to rasters so we can do a cost distnace analysis
```{r clip water by 2nm}
## First, create generic 2nm buffer from each site ##
buff <- gBuffer(sites.eg, byid = TRUE, width = 3704, quadsegs = 10)
buff <- spTransform(buff, CRS("+init=epsg:4326"))

# Lets see how it looks
leaflet() %>% 
  addTiles() %>% 
  addPolygons(data = buff, stroke = NA, fillColor = "red", fillOpacity = 0.8, group = "POW")

## Second, clip generic buffer so that its only water ##
buff.water <- gIntersection(h2o.latlong, buff, byid = TRUE)

# Let see how it looks
leaflet() %>% 
  addTiles() %>% 
  addPolygons(data = buff.water, stroke = NA, fillColor = "blue", fillOpacity = 0.8, group = "POW")

## Make raster of water area ##
# Covert back to UTMs for each measurment
buff.water.utm <- spTransform(buff.water, CRS("+proj=utm +zone=8 +ellps=GRS80 +towgs84=0,0,0"))

# Save extent
water.ext <- extent(buff.water.utm)

# create raster with appropriate dimensions. Not that dividing by 50 means that each cell will be 50 by 50 meters
r <- raster(xmn = water.ext@xmin, xmx = water.ext@xmax, ymn = water.ext@ymin, ymx = water.ext@ymax, ncol = (water.ext@xmax - water.ext@xmin) / 50, nrow = (water.ext@ymax - water.ext@ymin) / 50, crs = "+proj=utm +zone=8 +ellps=GRS80 +towgs84=0,0,0")

# Rasterize, append data essentially, confirm projection
water.rast <- rasterize(buff.water.utm, r, crs = "+proj=utm +zone=8 +ellps=GRS80 +towgs84=0,0,0")

# Clip again to make sure
water.rast <- mask(water.rast, h2o.utm)

# assign raster values, 50 because each cell is 50 by 50 meters
water.rast[water.rast%in%c(1:21)] <- 50
plot(water.rast)

# create lat/long version
water.rast.latlong <- projectRaster(water.rast, crs ="+init=epsg:4326")

# Let see how it looks
leaflet() %>% 
  addTiles() %>% 
  addRasterImage(water.rast.latlong, colors = "green", opacity = 0.8)
```

Create the as the water swims survey area, i.e. the actual survey area.
```{r survey area}
## First, make a transition layer to use in cummulative cost distance ##
# Transition layer
water.trans <- transition(water.rast, transitionFunction = function(x){50}, directions = 8)
water.trans <- geoCorrection(water.trans, type = "r", scl = FALSE)

## Second, calculate cummulative cost distance
# Calculation
surv.area <- accCost(water.trans, sites.eg)
surv.area
plot(surv.area)

# Multiply by 50 to get real cost haves in terms of distance (meters)
values(surv.area) <- (values(surv.area) * 50)
plot(surv.area)
hist(values(surv.area), breaks = 10)

# "Crop"" raster to only retain values <= 3700
surv.area[values(surv.area) > 3700] <- NA
plot(surv.area)
hist(values(surv.area), breaks = 50, xlim = c(0,4000))
```

Split raster up so that there are individual polygons for each site. 
```{r}
## START HERE NEXT TIME ##
```

# 2. Duration of sea otter occupation

```{r}
## USFWS polygons ##
# 2003 Sea Otters
sd2003 <- readOGR(dsn = "E:/wraymond2/My Documents/Graduate School/GIS General/Sea Otter Distribution Polygons/South SEAK Sea Otter Distribution Polygons", layer="Clipped sea otter dist_2003") 

# 2010 Sea Otters
sd2010 <- readOGR(dsn = "E:/wraymond2/My Documents/Graduate School/GIS General/Sea Otter Distribution Polygons/South SEAK Sea Otter Distribution Polygons", layer="Clipped sea otter dist_2010") 

```

# 3. Sea otter density from Tinker et. al
```{r}
## Tim's survey density blocks ##
poparea <- readOGR(dsn = "E:/wraymond2/My Documents/Graduate School/Sea Otter Harvest/GIS Files/Hab_All_1.27.2017", layer = "Hab_All_UTM")
poparea <- spTransform(poparea, CRS("+init=epsg:4326"))
```


# 4. Number of sea otter pits

# 5. Proportion of sea otter crakced clam shells