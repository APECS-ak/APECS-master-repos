---
title: "Seagrass_biomass_regression_2017"
author: "Lia Domke"
date: "10/21/2019"
output: html_document
---
We're curious to see if there is a relationship between *longest* leaf length to *total* shoot biomass. 
Data available: In 2017 21 sites were surveyed for seagrass. At each site, 8 0.25m^2 quadrats were surveyed and 5 entire shoots (i.e. multiple leaves) were removed and brought back to the lab to be measured. Each shoot (n = 840) was weighed to get total fresh and dry biomass and each leaf on the shoot had its length and width measured. 

We are interested in the length of the longest leaf and the dry biomass. 
# Data import
```{r}
eelgrass <- read.csv("..//ALL_DATA/seagrass_biometrics_CLEAN.csv")
```
# Libraries
```{r, echo = FALSE}
library(tidyverse)
library(MASS)
```
# Data Cleaning
```{r}
# extract what we're interested in 
str(eelgrass)
eel <- eelgrass %>%
  mutate(shoot_dw = shoot_foil_dw-shoot_foil)  # calculate dry weight
# determin max leaf length
eel2 <- eel %>% 
  rowwise() %>%
  mutate(max_length = max(leaf_length1, leaf_length2, leaf_length3, leaf_length4, leaf_length5, leaf_length6, leaf_length7, leaf_length8, leaf_length9, leaf_length10, na.rm=TRUE)) %>%
  mutate(mean_length = mean(leaf_length1, leaf_length2, leaf_length3, leaf_length4, leaf_length5, leaf_length6, leaf_length7, leaf_length8, leaf_length9, leaf_length10, na.rm=TRUE))
str(eel2)

# subset only the data that was collected before July (the main part of the growing season)

eel_sub <- eel2 %>%
  filter(YYYYMMDD < 20170701)
str(eel_sub)
levels(as.factor(eel_sub$YYYYMMDD))
summary(eel_sub)
eel_sub2 <- na.omit(data.frame(eel_sub$shoot_dw, eel_sub$max_length, eel_sub$mean_length, eel_sub$shoot_mass_fw))
names(eel_sub2) <- c("shoot_dw", "max_length", "mean_length", "shoot_mass_fw")
```

# Look at data
```{r}
plot(eel_sub2$max_length, eel_sub2$shoot_dw)
# Looks like the variance in shoot dw might be increasing with the the length (mm) of the longest blade. 
plot(eel_sub2$mean_length, eel_sub2$shoot_dw)
plot(eel_sub2$max_length, eel_sub2$shoot_mass_fw)
# not as tight as a correlation
cor(eel_sub2$max_length, eel_sub2$shoot_dw, use = "complete.obs")
cor(eel_sub2$mean_length, eel_sub2$shoot_dw, use = "complete.obs")
cor(eel_sub2$mean_length, eel_sub2$shoot_mass_fw, use = "complete.obs")
# stronger positive linear relationship with max length than average length (makes sense)
par(mfrow=c(1,2))
boxplot(eel_sub2$max_length)
boxplot(eel_sub2$shoot_dw)
# Looks like both varibles may have some outliers, in particular the shoot dry weight. 

par(mfrow=c(1,2))
plot(density(eel_sub2$max_length), ylab = "Frequency")
plot(density(eel_sub2$shoot_dw, na.rm = T), ylab = "Frequency")

hist(eel_sub2$max_length)
# max length looks pretty normal with some slight right? skew
hist(eel_sub2$shoot_dw)
# heavily right skewed does log make it look better?
hist(log(eel_sub2$shoot_dw))
# skews it the other way... 



```

# Linear models
## data only before july
```{r}

dat <- na.omit(data.frame(eel_sub2$shoot_dw, eel_sub2$max_length))
names(dat) <- c("dw", "max_length")

plot(dat$dw, dat$max_length)
# Lets fit an untransformed linear model 
fit.lm <- lm(dw ~ max_length, data = dat)
plot(fit.lm)
# looks like there might be some funky stuff happening with the residuals -- maybe an increase in variance along the fitted values. And the QQ plot looks real gross with some concavity (i.e. skewness) and some possible outliers. The cooks plot makes it look like there case numbers (171, 230, 498) could be influencial outliers. Some of this is consisten with the histogram of the data (see above)
summary(fit.lm)
AIC(fit.lm); BIC(fit.lm)
# looks like max length is significantly different than 0
# Has an adjusted r2 of 69%... pretty good for ecology. Model is significant, coefficients for the model are not equal to zero (p value =~0)
library(e1071)
skewness(dat$dw)
skewness(dat$max_length)
# the response variable is skewed.... highly skewed

e <- residuals(fit.lm)
shapiro.test(e)
n <- length(dat$dw)

ggplot(dat, aes(x = max_length, y = dw)) + geom_point() + theme_classic() +
  geom_smooth(method = "lm", se = TRUE)


# Does a boxcox indicate a transformation is necessary? 
library(MASS)
boxcox(fit.lm)
boxcox(fit.lm, lambda=seq(from=0, to=0.6, by=.01)) 
# Umm of like square root?
# Could also try a log



hist(dat$dw^0.5)
y.2 <- dat$y^(0.5)
# looks way better with a fourth root transformation, normal distribution
fit2 <- lm(dw^(0.5) ~ max_length, data = dat)
plot(fit2)
# looks a lot better, homoscedascity is good, qq plot tails are a little weird, still some outliers
summary(fit2)
# r squared is better, model is still significant
plot(dat$max_length, dat$dw^(0.5))

# Plot the square root transformed data
ggplot(dat, aes(x = max_length, y = dw^(0.5))) + geom_point() + geom_smooth(method = "lm", se = TRUE)

# Compare to a logtransformed model (easier to understand)

fit3 <- lm(log(dw) ~ max_length, data = dat)
plot(fit3)
summary(fit3)
hist(log(dat$dw))

plot(dat$max_length, log(dat$dw))

# log-log transformation
lm2 <- lm(log(shoot_dw) ~ log(max_length), data = eel_sub2)
summary(lm2)
plot(lm2)
```



