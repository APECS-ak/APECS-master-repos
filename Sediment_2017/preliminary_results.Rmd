---
title: "Preliminary sedimentary OM and IM results"
author: "Tiff Stephens"
date: "26 Jan 2018"
output: html_document
editor_options: 
chunk_output_type: console
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)
```

```{r, include=FALSE}
library(dplyr); library(tidyr); library(plyr); library(reshape2); library(lubridate); library(ggplot2); library(DT); library(leaflet); library(htmlwidgets); library(htmltools); library(shiny); library(mapview); library(sp); library(sf); library(knitr); library(cowplot); library(ggpmisc); library(DT); library(plyr); library(magick)

theme_set(theme_classic())
```





### 1. Import cleaned .csv file and look at dataframe.
```{r, echo = FALSE, include = FALSE}
# read clean file from github
df.core <- read.csv("https://raw.githubusercontent.com/APECS-ak/APECS-master-repos/master/ALL_DATA/core_matter_2017_CLEAN.csv", stringsAsFactors = FALSE, header = TRUE)

# check 
str(df.core)
```





### 2. Remove excess columns and calcuate other factors of interest.
```{r, echo = FALSE, include = FALSE}
# remove pan, crucible, and sediment combo weights not necessary here
df.core = df.core %>% 
  select(-pan_weight, -pan_sed_ww_pre_60C, -pan_sed_dw_post_60C, -pan_sed_dw_pre_450C, -pan_sed_dw_post450C, -crucible_weight, -crucible_sed_dw_pre_950C, -crucible_sed_dw_post_950C)
```

```{r, echo = FALSE, include = FALSE}
df.core = df.core %>% 
  mutate(om_percent_dw = (om_dw / sed_dw_pre_450C) * 100, na.rm = TRUE) %>%
  mutate(im_percent_dw = (im_dw / sed_dw_pre_950C) * 100, na.rm = TRUE) %>%
  mutate(om.im_ratio = om_dw / im_dw, na.rm = TRUE) %>%
  mutate(om_density = om_dw * dry_bulk_density, na.rm = TRUE) %>%
  mutate(im_density = im_dw * dry_bulk_density, na.rm = TRUE) %>%
  mutate(porewater_volume_cm3 = sed_ww_pre_60C - sed_dw_post_60C, na.rm = TRUE)
```

```{r, echo = FALSE, include = FALSE}
df.core = df.core %>% 
  select(-sed_ww_pre_60C, -sed_dw_post_60C, -sed_dw_pre_450C, -sed_dw_post_450C, -sed_dw_pre_950C, -sed_dw_post_950C, -na.rm)
```

```{r}
# add site numbers so can be used as factors later
newsitenames <- mapvalues(df.core$site, from = c("2017_L_01","2017_L_02","2017_L_03","2017_L_04","2017_L_05","2017_L_06","2017_L_07","2017_M_02","2017_M_03","2017_M_04","2017_M_05","2017_M_06","2017_M_07","2017_M_08","2017_H_01","2017_H_02","2017_H_03","2017_H_04","2017_H_05","2017_H_06","2017_H_07"), to = c("1","2","3","4","5","6","7","2","3","4","5","6","7","8","1","2","3","4","5","6","7"))

df.newsitenames <- data.frame(newsitenames)
df.newsitenames <- tibble::rowid_to_column(df.newsitenames, "X") # add order column for joining
df.core <- left_join(df.core, df.newsitenames, by = "X") 

names(df.core)[names(df.core) == 'newsitenames'] <- 'site_n' # rename site columns
```

```{r, echo = FALSE, include = FALSE}
# TEMPORARILY remove these rows...clear mistake in data collection or data entry.
df.core <- df.core[-c(52,195,206,276,365,403,470,481,482,484,513,515,516),]
```





### 3. Where are the processed cores from?
```{r, echo = FALSE}
# new data frame for all cores
locations_all = df.core %>%
  distinct(df.core, latitude, longitude, site) %>%
  drop_na()

# map "locations_all"
leaflet(locations_all) %>%
  addTiles() %>%
  addMarkers(~longitude, ~latitude, popup = ~site, label = ~site)
```
<br><br><br><br><br>











### 4. Plotting by site and region
<br>

#### Below, the depth profile for organic matter (right) and inorganic mater (left) from each site is roughly plotted to compare the overall matter content. You will notice that site L06 is way different than the rest
```{r, fig.height = 30, fig.width = 8, echo = FALSE, warning = FALSE}
df.core$site=factor(df.core$site, levels=c("2017_L_01","2017_L_02","2017_L_03","2017_L_04","2017_L_05","2017_L_06","2017_L_07","2017_M_02","2017_M_03","2017_M_04","2017_M_05","2017_M_06","2017_M_07","2017_M_08","2017_H_01","2017_H_02","2017_H_03","2017_H_04","2017_H_05","2017_H_06","2017_H_07")) # order sites

df.core$otter_region=factor(df.core$otter_region, levels=c("Low","Mid","High")) # order zones


# plot organic matter
plot_om_all = ggplot(df.core, aes(layer_depth, om_density)) +
  stat_summary(fun.y=mean, geom="point")+
  stat_summary(fun.data=mean_se, geom="errorbar", width=0.5) +
  coord_flip() +
  scale_x_reverse() +
  xlab("Core Depth (cm)") +
  ylab("Organic Matter (g cm^3)") +
  #scale_x_continuous(position = "top") +
  #scale_y_continuous(position = "left") +
  facet_wrap(~site, ncol = 1)

# plot inorganic matter
plot_im_all = ggplot(df.core, aes(layer_depth, im_density)) +
  stat_summary(fun.y=mean, geom="point")+
  stat_summary(fun.data=mean_se, geom="errorbar", width=0.5) +
  coord_flip() +
  scale_x_reverse() +
  xlab("Core Depth (cm)") +
  ylab("Organic Matter (g cm^3)") +
  #scale_x_continuous(position = "top") +
  #scale_y_continuous(position = "left") +
  facet_wrap(~site, ncol = 1)

# organize om and im side-by-side
plot_grid(plot_om_all, plot_im_all, align = "hv", ncol = 2)
```
<br><br><br>

#### The core from L06 was loaded with chunky woody debris; in general, this site had a lot of woody debris at the surface of the sediment (see notes). The data are real but an outlier compared to the other sites. Here are two images of the sliced core from site L06:
```{r, include = FALSE}
img1_path = "images/woodchunk1.JPG"
img2_path = "images/woodchunk2.JPG"
```

```{r out.width = "50%", echo = FALSE}
include_graphics(img1_path)
include_graphics(img2_path)
```
<br>


#### For the sake of looking at regional patterns, I've removed Site L06 for further analysis. 
```{r}
df.core_noL06 = df.core[-c(1:30),] # remove L06 (for now) because organic matter is off the scale
```
<br><br><br><br><br><br><br><br>













#### Here the data are plotted again but grouped by sea otter region. In plots on the right, the sites are color coded to demonstrate the variance across sites (and in which sites); the mean values + standard error are shown on the left. <span style="color:red">The red lines represent the mean values for the entire length of the respective core.</span>

<br>

### Organic matter
```{r, fig.height = 10, fig.width = 8, echo = FALSE, warning = FALSE}
df.core_noL06$site=factor(df.core_noL06$site, levels=c("2017_L_01","2017_L_02","2017_L_03","2017_L_04","2017_L_05","2017_L_06","2017_L_07","2017_M_02","2017_M_03","2017_M_04","2017_M_05","2017_M_06","2017_M_07","2017_M_08","2017_H_01","2017_H_02","2017_H_03","2017_H_04","2017_H_05","2017_H_06","2017_H_07")) # order zones

df.core_noL06$otter_region=factor(df.core_noL06$otter_region, levels=c("Low","Mid","High")) # order zones



hlinedat_om <- ddply(df.core_noL06, "otter_region", summarize, regionmean_om = mean(om_density, na.rm = TRUE))

# plot organic matter with sites
plot_oma = ggplot(df.core_noL06, aes(layer_depth, om_density, color = site_n)) +
  stat_summary(fun.y=mean, geom="point") +
  stat_summary(fun.data=mean_se, geom="errorbar", width=0.5) +
  coord_flip() +
  scale_x_reverse() +
  xlab("Core Depth (cm)") +
  ylab("Organic Matter (g cm^3)") +
  #scale_x_continuous(position = "top") +
  #scale_y_continuous(position = "left") +
  facet_wrap(~otter_region, ncol = 1) +
  geom_hline(aes(yintercept = regionmean_om), hlinedat_om, color = "red") +
  theme(legend.position = c(0.9, 0.13), legend.background = element_rect(color = "black", fill = "grey90", size = 1, linetype = "solid"))

# plot organic matter averaged across sites
plot_omb = ggplot(df.core_noL06, aes(layer_depth, om_density)) +
  stat_summary(fun.y=mean, geom="point")+
  stat_summary(fun.data=mean_se, geom="errorbar", width=0.5) +
  coord_flip() +
  scale_x_reverse() +
  xlab("Core Depth (cm)") +
  ylab("Organic Matter (g cm^3)") +
  #scale_x_continuous(position = "top") +
  #scale_y_continuous(position = "left") +
  facet_wrap(~otter_region, ncol = 1) +
  geom_hline(aes(yintercept = regionmean_om), hlinedat_om, color = "red")


# organize om and im side-by-side
plot_grid(plot_oma, plot_omb, align = "hv", ncol = 2)
```
<br><br><br>

### Inorganic matter
```{r, fig.height = 10, fig.width = 8, echo = FALSE, warning = FALSE}
hlinedat_im <- ddply(df.core_noL06, "otter_region", summarize, regionmean_im = mean(im_density, na.rm = TRUE))

#plopt inorganic matter with sites
plot_ima = ggplot(df.core_noL06, aes(layer_depth, im_density, color = site_n)) +
  stat_summary(fun.y=mean, geom="point")+
  stat_summary(fun.data=mean_se, geom="errorbar", width=0.5) +
  coord_flip() +
  scale_x_reverse() +
  xlab("Core Depth (cm)") +
  ylab("Inorganic Matter (g cm^3)") +
  #scale_x_continuous(position = "top") +
  #scale_y_continuous(position = "left") +
  facet_wrap(~otter_region, ncol = 1) +
  geom_hline(aes(yintercept = regionmean_im), hlinedat_im, color = "red") +
  theme(legend.position = c(0.9, 0.13), legend.background = element_rect(color = "black", fill = "grey90", size = 1, linetype = "solid"))




#plopt inorganic matter averaged across sites
plot_imb = ggplot(df.core_noL06, aes(layer_depth, im_density)) +
  stat_summary(fun.y=mean, geom="point")+
  stat_summary(fun.data=mean_se, geom="errorbar", width=0.5) +
  coord_flip() +
  scale_x_reverse() +
  xlab("Core Depth (cm)") +
  ylab("Inorganic Matter (g cm^3)") +
  #scale_x_continuous(position = "top") +
  #scale_y_continuous(position = "left") +
  facet_wrap(~otter_region, ncol = 1) +
  geom_hline(aes(yintercept = regionmean_im), hlinedat_im, color = "red")

# organize om and im side-by-side
plot_grid(plot_ima, plot_imb, align = "hv", ncol = 2)
```
<br><br><br><br><br><br><br><br><br>




#### Looking at the means, it appears that OM and IM decrease as sea otters become more abundant in a region. The distribution across sites, however, looks bimodal (particularly for the Low region). Let's look at their distributions using density plots:  

<br><br><br><br>

```{r, echo = FALSE, fig.width = 5, fig.height = 5}
# split region factors for bimodal looksies
Low <- df.core_noL06[df.core_noL06$otter_region=="Low",]
Mid <- df.core_noL06[df.core_noL06$otter_region=="Mid",]
High <- df.core_noL06[df.core_noL06$otter_region=="High",]



# plot distributions
biom1 <- ggplot(Low) +
  geom_density(aes(x = om_density)) +
  geom_rug(aes(x = om_density, y = 0), position = position_jitter(height = 0))

biom2 <- ggplot(Mid) +
  geom_density(aes(x = om_density)) +
  geom_rug(aes(x = om_density, y = 0), position = position_jitter(height = 0))

biom3 <- ggplot(High) +
  geom_density(aes(x = om_density)) +
  geom_rug(aes(x = om_density, y = 0), position = position_jitter(height = 0))
```

```{r, echo = FALSE, fig.width = 12, fig.height = 5}
title.cpbom <- ggdraw() + draw_label("Organic Matter Distributions", fontface='bold')

cpbiom <- plot_grid(biom1, biom2, biom3, labels=c('Low', 'Mid', 'High'), align = 'h', ncol=3, nrow=1, rel_widths = c(1,1,1))

plot_grid(title.cpbom, cpbiom, ncol=1, rel_heights=c(0.1, 1))
```
<br><br><br><br>


```{r, echo = FALSE, fig.width = 5, fig.height = 5}
# plot distributions
biim1 <- ggplot(Low) +
  geom_density(aes(x = im_density)) +
  geom_rug(aes(x = im_density, y = 0), position = position_jitter(height = 0))

biim2 <- ggplot(Mid) +
  geom_density(aes(x = im_density)) +
  geom_rug(aes(x = im_density, y = 0), position = position_jitter(height = 0))

biim3 <- ggplot(High) +
  geom_density(aes(x = im_density)) +
  geom_rug(aes(x = im_density, y = 0), position = position_jitter(height = 0))
```

```{r, echo = FALSE, fig.width = 12, fig.height = 5}
title.cpbiim <- ggdraw() + draw_label("Inorganic Matter Distributions", fontface='bold')

cpbiim <- plot_grid(biim1, biim2, biim3, labels=c('Low', 'Mid', 'High'), align = 'h', ncol=3, nrow=1, rel_widths = c(1,1,1))

plot_grid(title.cpbiim, cpbiim, ncol=1, rel_heights=c(0.1, 1))
```
<br><br><br><br>


```{r, echo = FALSE, fig.width = 5, fig.height = 5}
# plot distributions
biomim1 <- ggplot(Low) +
  geom_density(aes(x = om.im_ratio)) +
  geom_rug(aes(x = im_density, y = 0), position = position_jitter(height = 0))

biomim2 <- ggplot(Mid) +
  geom_density(aes(x = om.im_ratio)) +
  geom_rug(aes(x = im_density, y = 0), position = position_jitter(height = 0))

biomim3 <- ggplot(High) +
  geom_density(aes(x = om.im_ratio)) +
  geom_rug(aes(x = im_density, y = 0), position = position_jitter(height = 0))
```

```{r, include = FALSE, echo = FALSE, fig.width = 12, fig.height = 5}
title.cpbiomim <- ggdraw() + draw_label("OM:IM Matter Ratio", fontface='bold')

cpbiomim <- plot_grid(biomim1, biomim2, biomim3, labels=c('Low', 'Mid', 'High'), align = 'h', ncol=3, nrow=1, rel_widths = c(1,1,1))

plot_grid(title.cpbiomim, cpbiomim, ncol=1, rel_heights=c(0.1, 1))
```
<br><br><br><br>









```{r, include = FALSE}
df.core_noL06$otter_region <- as.factor(df.core_noL06$otter_region)
df.core_noL06$site_n <- as.factor(df.core_noL06$site_n)


p04 <- ggplot(df.core_noL06, aes(otter_region, om_density, color = site_n)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(alpha = 0.3, width = 0.15) +
  theme(legend.position="none")
plot(p04)

p05 <- ggplot(df.core_noL06, aes(otter_region, im_density, color = site_n)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(alpha = 0.3, width = 0.15) +
  theme(legend.position="none")
plot(p05)

p06 <- ggplot(df.core_noL06, aes(otter_region, om.im_ratio, color = site_n)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(alpha = 0.3, width = 0.15)
plot(p06)
```

```{r, include = FALSE, echo = FALSE, fig.width = 12, fig.height = 5}
title.cp02 <- ggdraw() + draw_label("Trends with SO zone?", fontface='bold')

cp02 <- plot_grid(p04, p05, p06, labels=c('A', 'B', 'C'), align = 'h', ncol=3, nrow=1, rel_widths = c(1,1,1.2))

plot_grid(title.cp02, cp02, ncol=1, rel_heights=c(0.1, 1))
```
<br>

## For proper analysis, we need to decide how to deal with the bimodal distributions. 


<br><br><br><br><br><br><br><br>














### 4. Other things? Plotting general patterns of mean core matter versus factors
```{r, echo = FALSE, include = FALSE, warning = FALSE}
colnames(df.core)

om <- df.core %>% 
  select(otter_region, site, om_density)

m.om <- melt(om, id = 1:2, na.rm = TRUE)

trim_om <- dcast(m.om, otter_region + site ~ ., mean)
colnames(trim_om)[which(names(trim_om) == ".")] <- "om_density"






im <- df.core %>% 
  select(otter_region, site, im_density)

m.im <- melt(im, id = 1:2, na.rm = TRUE)

trim_im <- dcast(m.im, otter_region + site ~ ., mean)
colnames(trim_im)[which(names(trim_im) == ".")] <- "im_density"






om.im <- df.core %>% 
  select(otter_region, site, om.im_ratio)

m.om.im <- melt(om.im, id = 1:2, na.rm = TRUE)

trim_om.im <- dcast(m.om.im, otter_region + site ~ ., mean)
colnames(trim_om.im)[which(names(trim_om.im) == ".")] <- "om.im_ratio"





# join trimmed data of interest into one df
df.trim <- left_join(trim_om, trim_im, by = c("otter_region","site"))
df.trim <- left_join(df.trim, trim_om.im, by = c("otter_region","site"))
```

```{r, echo = FALSE, include = FALSE, warning = FALSE}
df.soi <- read.csv("https://raw.githubusercontent.com/APECS-ak/APECS-master-repos/master/ALL_DATA/sea_otter_impact_index_2017_new.csv", stringsAsFactors = FALSE, header = TRUE)

df.all <- read.csv("https://raw.githubusercontent.com/APECS-ak/APECS-master-repos/master/Seagrass_2017/Tiff_explore_sed_DERIVED_DF.csv", stringsAsFactors = FALSE, header = TRUE)
```

```{r, echo = FALSE, include = FALSE, warning = FALSE}
# join core data with soi data

df.core.trim <- left_join(df.trim, df.soi, by = c("site"))
df.core.trim <- left_join(df.core.trim, df.all, by = c("site"))

colnames(df.core.trim)

colnames(df.core.trim)[which(names(df.core.trim) == "latitude.x")] <- "latitude"
colnames(df.core.trim)[which(names(df.core.trim) == "longitude.x")] <- "longitude"


df.core.trim <- df.core.trim %>% 
  select(otter_region, site, place_name, latitude, longitude, sea_otter_index, sea_otter_duration, pop_mod_dens, depth_m, pits_tot_site, sed1_in, sed2_in, sedmean_in, sed1_site, sed2_site, sedmean_site, om_density, im_density, om.im_ratio, shoot_mass_perplant, shoot_mass_m2, shoot_density_m2, rhi_mass_percm, rhi_mass_percm_m2)
```

```{r, echo = FALSE, include = FALSE, warning = FALSE}
# remove L06
df.core.trim <- df.core.trim[-6,]
```
<br><br>






#### Matter content * sea otter duration
I do have a question about the duration factor...there are only two year groups, 7 and 14. I don't understand why the low sites are grouped in the 7-yr bin because some/most of those sites haven't had sea otters at all; I would have expected a third "0-yr" category. I know that these spatial data are derived from elsewhere, but... 
```{r, echo = FALSE, include = FALSE, warning = FALSE}
str(df.core.trim)
df.core.trim$sea_otter_duration <- as.factor(df.core.trim$sea_otter_duration)


p7 <- ggplot(df.core.trim, aes(sea_otter_duration, om_density)) +
  geom_boxplot() +
  geom_point(size = 3, alpha = 0.6)
plot(p7)



p8 <- ggplot(df.core.trim, aes(sea_otter_duration, im_density)) +
  geom_boxplot() +
  geom_point(size = 3, alpha = 0.6)
plot(p8)



p9 <- ggplot(df.core.trim, aes(sea_otter_duration, om.im_ratio)) +
  geom_boxplot() +
  geom_point(size = 3, alpha = 0.6)
plot(p9)
```

```{r, echo = FALSE, fig.width = 12, fig.height = 5}
title.cp2 <- ggdraw() + draw_label(".", fontface='bold')

cp2 <- plot_grid(p7, p8, p9, labels=c('A', 'B', 'C'), align = 'h', ncol=3, nrow=1, rel_widths = c(1,1,1))

plot_grid(title.cp2, cp2, ncol=1, rel_heights=c(0.1, 1))
```
<br><br><br><br><br><br>







#### Matter content * sea otter index
I wouldn't expect the buried OM and IM would interact with the sea otter index; burial relects a long/big temporal scale, where the sea otter index incorporates short-term data (e.g. cracked shells, pits).
```{r, echo = FALSE, include = FALSE, warning = FALSE}
# plotting in scatter
my.formula <- y ~ x # defined formula (linear regression) for stats labels on plot

# shoot_mass_m2
p10 = ggplot(df.core.trim, aes(sea_otter_index, log(om_density))) +
  geom_point(size=3) +
  theme(legend.position="none")
plot(p10)




p11 = ggplot(df.core.trim, aes(sea_otter_index, log(im_density))) +
  geom_point(size=3) +
  theme(legend.position="none")
plot(p11)




p12 = ggplot(df.core.trim, aes(sea_otter_index, log(om.im_ratio))) +
  geom_point(size=3) +
  geom_smooth(method=lm, formula=y~x, se=FALSE, fullrange=FALSE) +
  theme(legend.position="none") +
  stat_poly_eq(formula = my.formula, 
               aes(label = paste(..rr.label.., sep = "~~~")), 
               label.x.npc = 'right', label.y.npc = 'top', size = 4, parse = TRUE) +
  stat_fit_glance(method = 'lm', method.args = list(formula = my.formula), geom = 'text',
                  aes(label = paste("P-value = ", signif(..p.value.., digits = 3), sep = "")),
                  label.x.npc = 'left', label.y.npc = 'top', size = 4)
plot(p12)

```
<br>

```{r, echo = FALSE, fig.width = 12, fig.height = 5}
title.cp3 <- ggdraw() + draw_label(".", fontface='bold')

cp3 <- plot_grid(p10, p11, p12, labels=c('A', 'B', 'C'), align = 'h', ncol=3, nrow=1, rel_widths = c(1,1,1))

plot_grid(title.cp3, cp3, ncol=1, rel_heights=c(0.1, 1))
```
<br><br><br><br><br><br><br><br>

















### 5. Top 15 cm: might sediment type help explain OM and IM content?
##### A. This section only includes the top 15 cm of each core. This was decided because our qualitative assessment of sediment type at the surface is unlikely to be accurate for deeper sediment profiles. 
##### B. This section also takes the bimodal data into account. In the first set of plots, I exclude the upper clusters (Sites L01, L05, L06, M08, H06), which were identified by comparing the curves of the density plots to the sites that were plotted higher than the mean core matter. Treating each modal cluster as independent is one way to further explore patterns in the data. The second set of plots shows data from the cluster above the mean.

```{r, echo = FALSE, include = FALSE, warning = FALSE}
df.core.top <- subset(df.core, layer_depth <= 15) # select only top 20cm of core



colnames(df.core.top)

om.top <- df.core.top %>% 
  select(otter_region, site, om_density)

m.om.top <- melt(om.top, id = 1:2, na.rm = TRUE)

trim.top_om.top <- dcast(m.om.top, otter_region + site ~ ., mean)
colnames(trim.top_om.top)[which(names(trim.top_om.top) == ".")] <- "om.top_density"






im.top <- df.core.top %>% 
  select(otter_region, site, im_density)

m.im.top <- melt(im.top, id = 1:2, na.rm = TRUE)

trim.top_im.top <- dcast(m.im.top, otter_region + site ~ ., mean)
colnames(trim.top_im.top)[which(names(trim.top_im.top) == ".")] <- "im.top_density"






om.im.top <- df.core.top %>% 
  select(otter_region, site, om.im_ratio)

m.om.im.top <- melt(om.im.top, id = 1:2, na.rm = TRUE)

trim.top_om.im.top <- dcast(m.om.im.top, otter_region + site ~ ., mean)
colnames(trim.top_om.im.top)[which(names(trim.top_om.im.top) == ".")] <- "om.im.top_ratio"





# join trim.topmed data of interest into one df
df.trim.top <- left_join(trim.top_om.top, trim.top_im.top, by = c("otter_region","site"))
df.trim.top <- left_join(df.trim.top, trim.top_om.im.top, by = c("otter_region","site"))





```

```{r, echo = FALSE, include = FALSE, warning = FALSE}
df.soi <- read.csv("https://raw.githubusercontent.com/APECS-ak/APECS-master-repos/master/ALL_DATA/sea_otter_impact_index_2017_new.csv", stringsAsFactors = FALSE, header = TRUE)

df.all <- read.csv("https://raw.githubusercontent.com/APECS-ak/APECS-master-repos/master/Seagrass_2017/Tiff_explore_sed_DERIVED_DF.csv", stringsAsFactors = FALSE, header = TRUE)
```

```{r, echo = FALSE, include = FALSE, warning = FALSE}
# join core data with soi data

df.core.trimtop <- left_join(df.trim.top, df.soi, by = c("site"))
df.core.trimtop <- left_join(df.core.trimtop, df.all, by = c("site"))

colnames(df.core.trimtop)

colnames(df.core.trimtop)[which(names(df.core.trimtop) == "latitude.x")] <- "latitude"
colnames(df.core.trimtop)[which(names(df.core.trimtop) == "longitude.x")] <- "longitude"
colnames(df.core.trimtop)[which(names(df.core.trimtop) == "om.top_density")] <- "om_density"
colnames(df.core.trimtop)[which(names(df.core.trimtop) == "im.top_density")] <- "im_density"
colnames(df.core.trimtop)[which(names(df.core.trimtop) == "om.im.top_ratio")] <- "om.im_ratio"

df.core.trimtop <- df.core.trimtop %>% 
  select(otter_region, site, place_name, latitude, longitude, sea_otter_index, sea_otter_duration, pop_mod_dens, depth_m, sed1_in, sed2_in, sedmean_in, sed1_site, sed2_site, sedmean_site, om_density, im_density, om.im_ratio, shoot_mass_perplant, shoot_mass_m2, shoot_density_m2, rhi_mass_percm, rhi_mass_percm_m2)
```

```{r, echo = FALSE, include = FALSE, warning = FALSE}
# remove L06
df.core.trimtop <- df.core.trimtop[-c(1,5,6,14,15,20),]
```
<br><br><br>





#### Data clustered below the mean
```{r, echo = FALSE, include = FALSE, warning = FALSE}
# plotting in scatter
my.formula <- y ~ x # defined formula (linear regression) for stats labels on plot


pt1 = ggplot(df.core.trimtop, aes(sed1_in, om_density)) +
  geom_point(size=3) +
  geom_smooth(method=lm, formula=y~x, se=FALSE, fullrange=FALSE) +
  #xlab("Secondary sediment class (inside transect)\n")+ylab("\nBG biomass per cm rhizome (g per msq, DW)") +
  theme(legend.position="none") +
  stat_poly_eq(formula = my.formula, 
               aes(label = paste(..rr.label.., sep = "~~~")), 
               label.x.npc = 'right', label.y.npc = 'top', size = 4, parse = TRUE) +
  stat_fit_glance(method = 'lm', method.args = list(formula = my.formula), geom = 'text',
                  aes(label = paste("P-value = ", signif(..p.value.., digits = 3), sep = "")),
                  label.x.npc = 'left', label.y.npc = 'top', size = 4)
plot(pt1)



pt2 = ggplot(df.core.trimtop, aes(sed1_in, im_density)) +
  geom_point(size=3) +
  geom_smooth(method=lm, formula=y~x, se=FALSE, fullrange=FALSE) +
  #xlab("Secondary sediment class (inside transect)\n")+ylab("\nBG biomass per cm rhizome (g per msq, DW)") +
  theme(legend.position="none") +
  stat_poly_eq(formula = my.formula, 
               aes(label = paste(..rr.label.., sep = "~~~")), 
               label.x.npc = 'right', label.y.npc = 'top', size = 4, parse = TRUE) +
  stat_fit_glance(method = 'lm', method.args = list(formula = my.formula), geom = 'text',
                  aes(label = paste("P-value = ", signif(..p.value.., digits = 3), sep = "")),
                  label.x.npc = 'left', label.y.npc = 'top', size = 4)
plot(pt2)


pt3 = ggplot(df.core.trimtop, aes(sed1_in, om.im_ratio)) +
  geom_point(size=3) +
  geom_smooth(method=lm, formula=y~x, se=FALSE, fullrange=FALSE) +
  #xlab("Secondary sediment class (inside transect)\n")+ylab("\nBG biomass per cm rhizome (g per msq, DW)") +
  theme(legend.position="none") +
  stat_poly_eq(formula = my.formula, 
               aes(label = paste(..rr.label.., sep = "~~~")), 
               label.x.npc = 'right', label.y.npc = 'top', size = 4, parse = TRUE) +
  stat_fit_glance(method = 'lm', method.args = list(formula = my.formula), geom = 'text',
                  aes(label = paste("P-value = ", signif(..p.value.., digits = 3), sep = "")),
                  label.x.npc = 'left', label.y.npc = 'top', size = 4)
plot(pt3)
```

```{r, echo = FALSE, fig.width = 12, fig.height = 5}
title.pt1 <- ggdraw() + draw_label(".", fontface='bold')

cppt1 <- plot_grid(pt1, pt2, pt3, labels=c('OM', 'IM', 'OM:IM'), align = 'h', ncol=3, nrow=1, rel_widths = c(1,1,1))

plot_grid(title.pt1, cppt1, ncol=1, rel_heights=c(0.1, 1))
```
<br><br><br><br><br><br><br><br>











#### Data clustered above the mean
Note: there will eventually be 5 datapoints. There is a bug in this section of code that I need to iron out...other data are not effected. 
```{r, echo = FALSE, include = FALSE, warning = FALSE}
df.core.top <-subset(df.core, layer_depth <= 14) # select only top 20cm of core



colnames(df.core.top)

om.top <- df.core.top %>% 
  select(otter_region, site, om_density)

m.om.top <- melt(om.top, id = 1:2, na.rm = TRUE)

trim.top_om.top <- dcast(m.om.top, otter_region + site ~ ., mean)
colnames(trim.top_om.top)[which(names(trim.top_om.top) == ".")] <- "om.top_density"






im.top <- df.core.top %>% 
  select(otter_region, site, im_density)

m.im.top <- melt(im.top, id = 1:2, na.rm = TRUE)

trim.top_im.top <- dcast(m.im.top, otter_region + site ~ ., mean)
colnames(trim.top_im.top)[which(names(trim.top_im.top) == ".")] <- "im.top_density"






om.im.top <- df.core.top %>% 
  select(otter_region, site, om.im_ratio)

m.om.im.top <- melt(om.im.top, id = 1:2, na.rm = TRUE)

trim.top_om.im.top <- dcast(m.om.im.top, otter_region + site ~ ., mean)
colnames(trim.top_om.im.top)[which(names(trim.top_om.im.top) == ".")] <- "om.im.top_ratio"





# join trim.topmed data of interest into one df
df.trim.top <- left_join(trim.top_om.top, trim.top_im.top, by = c("otter_region","site"))
df.trim.top <- left_join(df.trim.top, trim.top_om.im.top, by = c("otter_region","site"))





```

```{r, echo = FALSE, include = FALSE, warning = FALSE}
df.soi <- read.csv("https://raw.githubusercontent.com/APECS-ak/APECS-master-repos/master/ALL_DATA/sea_otter_impact_index_2017_new.csv", stringsAsFactors = FALSE, header = TRUE)

df.all <- read.csv("https://raw.githubusercontent.com/APECS-ak/APECS-master-repos/master/Seagrass_2017/Tiff_explore_sed_DERIVED_DF.csv", stringsAsFactors = FALSE, header = TRUE)
```

```{r, echo = FALSE, include = FALSE, warning = FALSE}
# join core data with soi data

df.core.trimtop <- left_join(df.trim.top, df.soi, by = c("site"))
df.core.trimtop <- left_join(df.core.trimtop, df.all, by = c("site"))

colnames(df.core.trimtop)

colnames(df.core.trimtop)[which(names(df.core.trimtop) == "latitude.x")] <- "latitude"
colnames(df.core.trimtop)[which(names(df.core.trimtop) == "longitude.x")] <- "longitude"
colnames(df.core.trimtop)[which(names(df.core.trimtop) == "om.top_density")] <- "om_density"
colnames(df.core.trimtop)[which(names(df.core.trimtop) == "im.top_density")] <- "im_density"
colnames(df.core.trimtop)[which(names(df.core.trimtop) == "om.im.top_ratio")] <- "om.im_ratio"

df.core.trimtop <- df.core.trimtop %>% 
  select(otter_region, site, place_name, latitude, longitude, sea_otter_index, sea_otter_duration, pop_mod_dens, depth_m, sed1_in, sed2_in, sedmean_in, sed1_site, sed2_site, sedmean_site, om_density, im_density, om.im_ratio, shoot_mass_perplant, shoot_mass_m2, shoot_density_m2, rhi_mass_percm, rhi_mass_percm_m2)
```

```{r, echo = FALSE, include = FALSE, warning = FALSE}
# remove L06
df.core.trimtop <- df.core.trimtop[-c(2,3,4,6,7,8,9,10,11,12,13,16,17,18,19,21),]
```



```{r, echo = FALSE, include = FALSE, warning = FALSE}
# plotting in scatter
my.formula <- y ~ x # defined formula (linear regression) for stats labels on plot


pt4 = ggplot(df.core.trimtop, aes(sed1_site, om_density)) +
  geom_point(size=3) +
  #geom_smooth(method=lm, formula=y~x, se=FALSE, fullrange=FALSE) +
  #xlab("Secondary sediment class (inside transect)\n")+ylab("\nBG biomass per cm rhizome (g per msq, DW)") +
  theme(legend.position="none")
  #stat_poly_eq(formula = my.formula, 
               #aes(label = paste(..rr.label.., sep = "~~~")), 
              #label.x.npc = 'right', label.y.npc = 'top', size = 4, parse = TRUE) +
  #stat_fit_glance(method = 'lm', method.args = list(formula = my.formula), geom = 'text',
                  #aes(label = paste("P-value = ", signif(..p.value.., digits = 3), sep = "")),
                 # label.x.npc = 'left', label.y.npc = 'top', size = 4)
plot(pt4)



pt5 = ggplot(df.core.trimtop, aes(sed1_site, im_density)) +
  geom_point(size=3) +
  #geom_smooth(method=lm, formula=y~x, se=FALSE, fullrange=FALSE) +
  #xlab("Secondary sediment class (inside transect)\n")+ylab("\nBG biomass per cm rhizome (g per msq, DW)") +
  theme(legend.position="none")
  #stat_poly_eq(formula = my.formula, 
               #aes(label = paste(..rr.label.., sep = "~~~")), 
              #label.x.npc = 'right', label.y.npc = 'top', size = 4, parse = TRUE) +
  #stat_fit_glance(method = 'lm', method.args = list(formula = my.formula), geom = 'text',
                  #aes(label = paste("P-value = ", signif(..p.value.., digits = 3), sep = "")),
                 # label.x.npc = 'left', label.y.npc = 'top', size = 4)
plot(pt5)


pt6 = ggplot(df.core.trimtop, aes(sed1_site, om.im_ratio)) +
  geom_point(size=3) +
  #geom_smooth(method=lm, formula=y~x, se=FALSE, fullrange=FALSE) +
  #xlab("Secondary sediment class (inside transect)\n")+ylab("\nBG biomass per cm rhizome (g per msq, DW)") +
  theme(legend.position="none")
  #stat_poly_eq(formula = my.formula, 
               #aes(label = paste(..rr.label.., sep = "~~~")), 
              #label.x.npc = 'right', label.y.npc = 'top', size = 4, parse = TRUE) +
  #stat_fit_glance(method = 'lm', method.args = list(formula = my.formula), geom = 'text',
                  #aes(label = paste("P-value = ", signif(..p.value.., digits = 3), sep = "")),
                 # label.x.npc = 'left', label.y.npc = 'top', size = 4)
plot(pt6)
```

```{r, echo = FALSE, fig.width = 12, fig.height = 5}
title.pt2 <- ggdraw() + draw_label(".", fontface='bold')

cppt2 <- plot_grid(pt4, pt5, pt6, labels=c('OM', 'IM', 'OM:IM'), align = 'h', ncol=3, nrow=1, rel_widths = c(1,1,1))

plot_grid(title.pt2, cppt2, ncol=1, rel_heights=c(0.1, 1))
```
<br><br><br><br><br><br><br><br>




